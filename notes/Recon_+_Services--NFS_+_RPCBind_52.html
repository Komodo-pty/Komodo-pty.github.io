<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>NFS + RPCBind</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>NFS + RPCBind</h1><br/><p><h1>Background</h1></p><p>[SVCs 11-12]</p><p></p><p>Def Port <strong>2049</strong>.</p><p></p><p><a href="https://book.hacktricks.xyz/network-services-pentesting/nfs-service-pentesting">HackTricks</a></p><p></p><p>Network File System if a Client/Server System allowing users to access files across a network, &amp; treats them as if they were in a local dir. Runs on *Nix &amp; Windows. Doesn&#39;t have native support for encryption.</p><p></p><p>NFS is <span style="color:#ff0000;">implemented as a set of RPC calls</span> in which the server services certain types of calls made by the client. Ergo, there will likely be an <span style="color:#ff0000;">RPC port used in conjunction with NFS</span>. For ex-</p><p></p><p><strong>111/tcp  open  rpcbind</strong></p><p></p><p><h2>Authentication</h2></p><p>Doesn&#39;t have any Authentication mechanisms by default. Instead uses 1 or both of the following-</p><p><ol><li>IP / Hostname Whitelist</li><li>User / Group Permissions to access FS once connected</li></ol></p><p></p><p>Can also be implemented with Kerberos?</p><p></p><p><h3>Permissions Vulnerability</h3></p><p>Also see <a href="Recon_+_Services--NFS_+_RPCBind_52.html#Root Squashing">Root Squashing</a> for a potential Privilege Escalation vector.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: This applies to Linux targets, idk about Windows. Maybe you could do the same using a local Windows host?</p><p></p><p>If FS access is restricted to specific UID / GID, you can locally create an Acct with the neccesary values &amp; bypass these access controls. For ex-</p><p></p><p>Only the use bob (UID 1100) can access the files. The attacker can create the Acct “bob” with that UID &amp; use it to interact with the FS via NFS.</p><p></p><p><h1>RPCBind</h1></p><p>“This is just a server that converts remote procedure call (RPC) program number into universal addresses. When an RPC service is started, it tells rpcbind the address at which it is listening and the RPC program number its prepared to serve. ”</p><p></p><p>RPCBind may be <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-rpcbind">Portmapper</a>. An implementation of RPCBind? The same thing?</p><p></p><p><h2>NFS + RPCBind Recon</h2></p><p>The Nmap command typically reveals more info, but you can <span style="color:#ff0000;">run both</span> to be thorough.</p><p></p><p><em>nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount -v IP</em></p><p></p><p><em>showmount -e IP</em></p><p></p><p><h1>Mounting</h1></p><p>It&#39;s good practice to create a new directory to mount the target&#39;s FS on.</p><p></p><p>★<span style="color:#f66151;text-decoration:underline;">IMPORTANT</span>★: <span style="color:#ff0000;">Don&#39;t navigate to that directory after mounting</span> there!</p><p></p><p>★<span style="color:#f66151;text-decoration:underline;">WARNING</span>★: If you lose access to host while the volume is mounted, you could encounter issues! I was unable to unmount it, or even list the parent directory!</p><p></p><p>For ex, Recon showed the output <strong>nfs-ls: Volume /users</strong>.</p><p></p><p><em>mkdir /dev/shm/nfs</em></p><p></p><p><em>sudo mount 10.10.188.205:/users /dev/shm/nfs</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: If you were using a different local port, you&#39;d need to specify it (e.g. <strong>-o port=1337</strong>)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: May be able to mount using the <a href="https://community.hpe.com/t5/operating-system-linux/nfs-nolock-option/td-p/4474666">nolock option</a>, like-</p><p></p><p><em>sudo mount -t nfs 10.10.58.55:/users /home/kali/mnt/users -o nolock</em></p><p></p><p><h2>Combining with SSH PF</h2></p><p>IDK why this worked, since NFS can utilize both TCP &amp; UDP, &amp; SSH only supports TCP by default. See the <a href="Pivoting_22.html#Protocols & the OSI Model">pivoting section</a> for more info.</p><p></p><p><em>ssh -L 2049:localhost:2049 bob@IP -i id_rsa -N -f</em></p><p><em>sudo mount -f nfs localhost: /tmp/mount</em></p><p></p><p><h3>★</h3><h3>Specifying Mount Point</h3></p><p>In the aforementioned example, I didn&#39;t specify the target directory that I was mounting on my system. This is because I was directly accessing the target&#39;s port 2049 (NFS) where only 1 volume was available (<strong>/home/james</strong>).</p><p></p><p>I believe that the mount point you&#39;re specifying here is relative to <strong>/home/james</strong> which is why it needs to be blank (IDK for sure, but it only worked when no mount point was specified).</p><p></p><p>In this case, Linpeas showed the following output.</p><p></p><p><strong>/home/james *</strong> ...</p><p></p><p><h2>Accessing Volume</h2></p><p>Target may have specific ACLs (as described in the Background). If that isn&#39;t the case, you can access it with <strong>sudo</strong> (even if dir perms are something like <strong>drwx------ 2 nobody nogroup</strong>).</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: When my pwd was <strong>/dev/shm/nfs</strong>, I got no output from <em>sudo ls -la</em>. <span style="color:#ff0000;">Needed to be in a diff dir to run the command</span>!</p><p></p><p><em>sudo ls -la /dev/shm/nfs</em></p><p></p><p><em>sudo cat /dev/shm/nfs/sbradley.txt</em></p><p></p><p><h3>Open Excel File (XLSX)</h3></p><p>Can use <a href="PrivEsc--Linux--SysAdmin_Stuff_43.html#Use XLSX File">LibreOffice Calc</a> (<strong>sudo libreoffice</strong>). May be prompted to open Read Only (R/O) or open a Local Copy. I think it&#39;s best to just <span style="color:#ff0000;">open a Local Copy</span>.</p><p></p><p><a name="Root Squashing"></a><h1>Root Squashing</h1></p><p>By default, when a user on a client machine (particularly the root user) accesses a file or directory shared via NFS, the server doesn&#39;t allow the client&#39;s root user to have full admin privileges on the shared files.</p><p></p><p>This security feature is called Root Squashing, because you&#39;re “Squashing” their “Root” privileges. As a result, access to the FS by the client&#39;s root user will be mapped to an anonymous user (typically the <strong>nfsnobody</strong> user).</p><p></p><p><h2>Vulnerable Configuration</h2></p><p>When you use the <strong>no_root_squash</strong> option in the NFS server&#39;s export config file (typically <strong>/etc/exports</strong>), the client&#39;s root user will be treated as the root user on the target machine.</p><p></p><p>This gives the client full admin privileges over all NFS mounted files &amp; directories.</p><p></p><p><h3>Creating Vulnerability</h3></p><p>If the target uses an NFS server (or you can start it), &amp; you control the config file (i.e. <strong>/etc/exports</strong>), you can edit the file to disable Root Squashing to get a root shell on the system.</p><p></p><p><h3>Exploitation</h3></p><p>You&#39;ll only have access to the FS relative to the NFS volume&#39;s mount point (e.g. you cant access <strong>/etc/passwd</strong> if the server is run out of <strong>/home/james</strong>).</p><p></p><p>An easy method is to create a new SUID binary in the NFS volume that belongs to root, &amp; then run it on the client machine.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: I had issues when trying to copy my version of <strong>/bin/bash</strong> to the target machine (maybe bc of version mismatch), so you&#39;ll often have better luck if you use the target&#39;s version of the binary.</p><p></p><p><span class="subheading">Example</span>: I had access to <strong>/home/james</strong>, so I was able to steal or create an SSH key for that user. I used this SSH access in conjunction with my access to the NFS volume via my machine&#39;s root user.</p><p></p><p><strong>{Attacker}</strong> <em>cp /tmp/mount/.ssh/id_rsa ./james.ssh</em></p><p></p><p><strong>{SSH}</strong> <em>cp /bin/bash ~/evil</em></p><p></p><p><strong>{Attacker}</strong> <em>chown root:root /tmp/mount/evil &amp;&amp; chmod +s /tmp/mount/evil</em></p><p></p><p><strong>{SSH}</strong> <em>~/evil -p</em></p></div>
</body>
</html>
