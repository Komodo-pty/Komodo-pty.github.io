<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>LDAP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>LDAP</h1><br/><p><h1>Background</h1></p><p>[Win 13-17 &amp; 58]</p><p></p><p>LDAP can be queried using a host in the LAN (e.g SharpHound will do this automatically. Some of the Powersploit scripts may also), or it can be queried remotely if can access the DC.</p><p></p><p><h1>Enumeration</h1></p><p><span style="color:#f66151;text-decoration:underline;">IMPORTANT</span>: Use a <span style="color:#ff0000;">FQDN</span> instead of an IP Address, especially if you&#39;re querying LDAPS (port 636) or Kerberos (using an IP will likely cause Auth failure).</p><p></p><p><h2>Basic Enumeration</h2></p><p>Both of these commands should provide the exact same output.</p><p></p><p><em>nmap -n -sV --script &quot;ldap* and not brute&quot; -p389 DC_IP -Pn</em></p><p></p><p><em>ldapsearch -H ldap://10.10.188.191:389 -x -s base -b &#39;&#39; &quot;(objectClass=*)&quot; &quot;*&quot; +</em></p><p></p><p><a name="Kerberos Info"></a><h3>Kerberos Info</h3></p><p>[Network 32-34]</p><p></p><p>Use a FQDN that&#39;s hardcoded into<strong> /etc/hosts</strong>. The LDAP Schema can vary, so start with a broad query if you don&#39;t know it. Then you can try adding extra filters.</p><p></p><p><em>ldapsearch -x -H ldap://kerberos.example.com -b “dc=example,dc=com”</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Filters</span>: Append filters to the query. The <strong>objectClass</strong> may vary, &amp; can be omitted, but the attributes after that should remain consistent. The <a href="PrivEsc--Windows--Sysadmin_Stuff--Kerberos_104.html#Admin Server">Admin Server</a> is usually the same as the KDC, but you can verify that with the <strong>krbAdminServer</strong> attribute.</p><p></p><p><em>ldapsearch -x -H ldap://kerberos.example.com -b “dc=example,dc=com”</em> <em>“(objectClass=krbPrincipal)” krbRealm krbKDC krbAdminServer</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Authenticated</span>: In this example, everything following the <strong>-W</strong> is a filter which can be omitted.</p><p></p><p><em>ldapsearch -x -H ldap://kerberos.example.com -b “dc=example,dc=com” -D “CN=bob,CN=Users,DC=example,DC=com” -W “(krbKDC=*)” krbRealm krbKDC</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Example Output</span>: Use this to create the <strong>/etc/krb5.conf</strong> <a href="PrivEsc--Linux--SysAdmin_Stuff--Linux_in_AD_103.html#krb5.conf">KRB Configuration</a> file.</p><p></p><p><strong>dn: krbRealm=EXAMPLE.COM, dc=example, dc=com</strong><strong></strong></p><p><strong>krbRealm: EXAMPLE.COM</strong><strong></strong></p><p><strong>krbKDC: kerberos.example.com</strong><strong></strong></p><p><strong>krbAdminServer: kerberos.example.com</strong></p><p></p><p><h2>User Enumeration</h2></p><p><h3>Unauthenticated</h3></p><p>Connecting anonymously (unauthenticated) may work on misconfigured or CTFs, but not in properly secured domains.</p><p></p><p><em>ldapsearch -H ldap://frizzdc.frizz.htb -x -b &quot;DC=frizz,DC=htb&quot; &quot;(objectClass=user)&quot; sAMAccountNam</em>e <em>displayName mail userPrincipalName</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: The following output indicates that authentication is required.</p><p></p><p><strong>text: 000004DC: LdapErr: DSID-0C090CB6, comment: In order to perform this operation a successful bind must be completed on the connection., data 0, v4f7c</strong></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Unauthenticated Machine Account Enumeration</span>: <em>ldapsearch -H ldap://frizzdc.frizz.htb -x -b &quot;DC=frizz,DC=htb&quot; &quot;(objectClass=computer)&quot; sAMAccountName</em></p><p></p><p><h3>Authenticated</h3></p><p><strong>-x </strong>use Simple Auth instead of SASL</p><p></p><p><strong>-D</strong> the Distinguished Name (DN) of the user you&#39;re authenticating as (no spaces between the values).</p><p></p><p><strong>-W</strong> interactively prompts for a passwd. You can specify one instead with <strong>-w</strong>.</p><p></p><p><em>ldapsearch -H ldap://frizzdc.frizz.htb -x -D &quot;CN=someuser,CN=Users,DC=frizz,DC=htb&quot; -w &#39;password&#39; -b &quot;DC=frizz,DC=htb&quot; &quot;(objectClass=user)&quot; sAMAccountName</em></p></div>
</body>
</html>
