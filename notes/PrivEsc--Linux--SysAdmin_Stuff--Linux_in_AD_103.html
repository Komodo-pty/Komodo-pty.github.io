<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Linux in AD</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Linux in AD</h1><br/><p><h1>Attacking an AD Domain</h1></p><p>[CTF D 46-47]</p><p></p><p>Some Linux tools can utilize tickets to interact with an AD Domain (e.g. impacket&#39;s <strong>-k</strong> arg), but some setup is needed.</p><p></p><p><a name="Obtain a TGT"></a><h2>Obtain a TGT</h2></p><p><em>impacket-getTGT frizz.htb/&#39;f.frizzle&#39;:&#39;Jenni_Luvs_Magic23&#39; -dc-ip frizzdc.frizz.htb  </em></p><p></p><p><h3>Troubleshooting- Clock Skew</h3></p><p>If the UTC time on your machine varies too much from the UTC time on the Domain Controller, many tools will throw an error like:</p><p></p><p><strong>Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)</strong></p><p></p><p>You should be able to fix this by temperarily setting your system&#39;s time to be the same as the DC&#39;s. This only affects RAM, so no changes should persist after reboot.</p><p></p><p><em>sudo ntpdate frizzdc.frizz.htb</em></p><p></p><p><span class="subheading">Alternate Solution</span>: For tools that rely on <a href="PrivEsc--Linux--SysAdmin_Stuff--Linux_in_AD_103.html#krb5.conf">krb5.conf</a> (i.e. not Impacket), you can try to increase the allowable Clock Skew time in your config file (in seconds).</p><p></p><p><strong>[libdefaults]</strong><strong></strong></p><p><strong>    clockskew = 300</strong></p><p>    </p><p><span class="subheading">Persistent Changes</span>: If all else fails, specify the FQDN for the Domain&#39;s Time Server (typically the DC) in <strong>/etc/hosts</strong>, edit <strong>/etc/systemd/timesyncd.conf</strong> to use it, &amp; then enable NTP based time sync.</p><p></p><p><span style="color:#f66151;text-decoration:underline;">IMPORTANT</span>: There cannot be spaces around the equals signs in <strong>timesyncd.conf</strong></p><p></p><p><em>vim /etc/systemd/timesyncd.conf</em></p><p></p><p><strong>[Time]</strong><strong></strong></p><p><strong>NTP=dc1.example.com</strong><strong></strong></p><p><strong>FallbackNTP=pool.ntp.org</strong></p><p></p><p><em>sudo timedatectl set-ntp true</em></p><p></p><p><em>sudo systemctl restart systemd-timesyncd</em><em></em></p><p><em></em><em></em></p><p><em>timedatectl status</em></p><p></p><p>You should get output like:</p><p></p><p><strong>NTP synchronized: yes</strong><strong></strong></p><p><strong>NTP server: dc1.example.com</strong></p><p></p><p><a name="Specifying TGT"></a><h2>Specifying TGT</h2></p><p>Use the <strong>KRB5CCNAME</strong> Environment Variable to tell tools where to find the TGT. Temporarily set this value for your current terminals session &amp; <span style="color:#ff0000;">run the tools in that terminal session</span>.</p><p></p><p><em>export KRB5CCNAME=/PATH/ticket.ccache</em></p><p></p><p><h3>Convert KIRBI to CCACHE</h3></p><p>KIRBI is a binary file, so some tools like Rubeus will Base64 Encode them. If this occured, decode it &amp; ensure you&#39;re using the raw binary file.</p><p></p><p><em>impacket-ticketConverter ticket.kirbi ticket.ccache</em></p><p></p><p><a name="krb5.conf"></a><h2>Kerberos Configuration (krb5.conf)</h2></p><p>[Network 31-34]</p><p></p><p>The Global system-wide Kerberos configuration file is<strong> /etc/krb5.conf</strong>. It&#39;s the Linux equivilant of <strong>krb5.ini</strong> on Windows hosts.</p><p></p><p>Without a valid config, you will likely get errors like <strong>Cannot resolve network address for KDC</strong>.</p><p></p><p>You can get the necessary information via <a href="Recon_+_Services--LDAP_106.html#Kerberos Info">LDAP Enumeration</a> and use it to create the config file.</p><p></p><p><h3>Sections</h3><ol><li><span class="subheading">[libdefaults]</span>: Default config settings, like the default KRB Realm.</li></ol></p><p><ol><li><span class="subheading">[realms]</span>: The Domain / Realm specific config, including the KDC.</li></ol></p><p></p><p>You can specify &gt;1 KDC. If there&#39;s an issue with Clock Skew, it may help to add <strong>time_server</strong>.</p><p><ol><li><span class="subheading">[domain_realm]</span>: Maps Domain Names to KRB Realms</li></ol></p><p></p><p>Contains at least 2 entries. The entry with a period prepended maps any subdomain to the Realm (e.g.  <strong>host.example.com</strong>). The other entry is for the Root Domain itself (e.g. <strong>example.com</strong>)</p><p></p><p><h3>Examples</h3></p><p><span class="subheading">Simple Config</span>: This contains only the required fields. See this <a href="PrivEsc--Linux--SysAdmin_Stuff--Linux_in_AD_103.html#Obtain a TGT">section</a> if you have troubles with Time Synchronization.</p><p></p><p><strong>[libdefaults]</strong></p><p><strong>	default_realm = EXAMPLE.COM</strong><strong></strong></p><p><strong>	</strong><strong></strong></p><p><strong>[realms]</strong><strong></strong></p><p><strong>	EXAMPLE.COM = {</strong><strong></strong></p><p><strong>		kdc = kerberos.example.com</strong><strong></strong></p><p><strong>		admin_server = kerberos.example.com</strong><strong></strong></p><p><strong>		</strong><strong></strong></p><p><strong>[domain_realm]</strong><strong></strong></p><p><strong>	.example.com = EXAMPLE.COM</strong><strong></strong></p><p><strong>	example.com = EXAMPLE.COM</strong></p><p></p><p><span class="subheading">Example 2</span>: If you&#39;re manually specifying the KDC, you don&#39;t need query DNS for the KDC or the Realm &amp; can omit the DNS fields.</p><p></p><p><strong>[libdefaults]</strong><strong></strong></p><p><strong>    default_realm = FRIZZ.HTB</strong><strong></strong></p><p><strong>    dns_lookup_realm = false</strong><strong></strong></p><p><strong>    dns_lookup_kdc = false</strong><strong></strong></p><p><strong>    ticket_lifetime = 24h</strong><strong></strong></p><p><strong>    forwardable = true</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>[realms]</strong><strong></strong></p><p><strong>    FRIZZ.HTB = {</strong><strong></strong></p><p><strong>        kdc = frizzdc.frizz.htb</strong><strong></strong></p><p><strong>        admin_server = frizzdc.frizz.htb</strong><strong></strong></p><p><strong>    }</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>[domain_realm]</strong><strong></strong></p><p><strong>    .frizz.htb = FRIZZ.HTB</strong><strong></strong></p><p><strong>    frizz.htb = FRIZZ.HTB</strong></p><p></p><p><h3>Purpose</h3></p><p>It tells your system:</p><p><ul><li>What Kerberos realms exist</li></ul></p><p><ul><li>Which KDCs (Key Distribution Centers) to contact</li></ul></p><p><ul><li>How to resolve realm/domain mappings</li></ul></p><p><ul><li>How to behave (timeouts, encryption, etc.)</li></ul></p><p></p><p><span class="subheading">Importance</span>: Most tools require <strong>krb5.conf</strong> to properly interact with an AD Domain.</p><p></p><p>However, many <span style="color:#ff0000;">Impacket tools don&#39;t use it</span>. Impacket instead uses pure Python Kerberos libraries (e.g. pyasn1, pycryptodome, etc) and don&#39;t always depend on the system’s Kerberos configuration (e.g., <strong>/etc/krb5.conf</strong>). </p><p></p><p>As long as you set a TGT in the <strong>KRB5CCNAME</strong> variable, Impacket will often just use that ticket and skip needing DNS resolution or realm config from <strong>krb5.conf</strong>.</p><p></p><p><h3>Setting Alternate Config File</h3></p><p>You may be able to use the <strong>KRB5_CONFIG</strong> Environment Variable to specify an alternate config file for this terminal session.</p><p></p><p><span style="color:#f66151;text-decoration:underline;">WARNING</span>: Some tools don&#39;t support an alternate config file, so it&#39;s safest to just use <strong>/etc/krb5.conf</strong></p><p></p><p><em>export KRB5_CONFIG=/dev/shm/krb5.conf</em></p><p></p><p><a name="Using RDP"></a><h2>Using RDP</h2></p><p><h3>Setup</h3></p><p><span class="subheading">Dependencies</span>: The version of <strong>xfreerdp3</strong> installed on Kali should support KRB Auth, but you should ensure that the KRB Client Libraries are installed.</p><p></p><p><em>sudo apt update &amp;&amp; sudo apt install krb5-user libpam-krb5</em></p><p></p><p><span class="subheading">xfreerdp3 version</span>: Kali has <strong>xfreerdp3</strong> (FreeRDP 3.x introduced improved Kerberos support) &amp; <strong>xfreerdp</strong> (FreeRDP 2.x which may not have Kerberos support enabled by default).</p><p></p><p><span style="color:#f66151;text-decoration:underline;">IMPORTANT</span>: Ensure you&#39;re using <strong>xfreerdp3</strong> &amp; not <strong>xfreerdp</strong>.</p><p></p><p><em>xfreerdp3 /version</em></p><p></p><p><span class="subheading">Kerberos Config</span>: Setup <strong>/etc/krb5.conf</strong> &amp; Specify the <strong>.ccache</strong> TGT with the <strong>KRB5CCNAME</strong> Env variable.</p><p></p><p><h3>Username Syntax</h3></p><p>There are 3 methods for specifying a username (e.g. bob). If the UPN Format fails, try the other ones as a sanity check.</p><p><ol><li><span class="subheading">Simple Username</span>: Just <strong>bob</strong> MAY work if <strong>krb5</strong>.conf is properly config, but it&#39;s generally not recommended.</li></ol></p><p><ol><li><span style="color:#cdab8f;">★</span><span class="subheading">UPN Format</span>: The format <strong>USER@REALM</strong> (e.g. <strong>bob@example.com</strong>) avoids potential conflicts if there are &gt;1 Realms. It&#39;s the <span style="color:#ff0000;">preferred method</span> &amp; uses the Fully Qualified Kerberos Principal.</li></ol></p><p><ol><li><span class="subheading">NetBIOS Format</span>: This format is typically used for NTLM, but can work for KRB depending on the KRB config.. On a Linux host, you often need to use <strong>\\</strong> escape the backslash.</li></ol></p><p></p><p>You <span style="color:#ff0000;">do NOT specify the TLD</span> for the NetBIOS format. If you&#39;re working with <strong>example.com</strong> you&#39;d use <strong>example\\bob</strong> or <strong>example\bob</strong>.</p><p></p><p><h3>Specifying Remote Host</h3></p><p><strong>/v:</strong> specifies the machine you&#39;re connecting to. It&#39;s <span style="color:#ff0000;">better to use a FQDN</span> (e.g. <strong>hostname.example.com</strong>) as opposed to an IP Address when using kerberos.</p><p></p><p>Create an entry for the host using the FQDN in <strong>/etc/hosts</strong>.</p><p></p><p><strong>192.168.45.102 hostname.example.com</strong><strong></strong></p><p><strong>192.168.45.103 test.example.com</strong><strong></strong></p><p><strong>192.168.45.104 files.example.com</strong></p><p></p><p><h3>★</h3><h3>Connecting</h3><h3>★</h3></p><p>The<strong> /kerberos</strong> flag in <strong>xfreerdp3</strong> forces KRB Auth. Verify that you <a href="PrivEsc--Linux--SysAdmin_Stuff--Linux_in_AD_103.html#Specifying TGT">specifed the TGT</a> in this terminal &amp; it&#39;s in the CCACHE format as opposed to the KIRBI format.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: When specifying a KRB Realm, case may not matter, but it&#39;s better to use <span style="color:#ff0000;">uppercase</span> (which is the conventional usage).</p><p></p><p><em>xfreerdp3 /v:hostname.example.com /u:bob@EXAMPLE.COM /kerberos</em></p><p></p><p><em>xfreerdp3 /v:hostname.example.com /u:bob@example.com /kerberos</em></p><p></p><p><h2>Using SSH</h2></p><p>The Kerberos configuration file enables GSSAPI/SSO using Kerberos if the client is configured to support them.</p><p></p><p>Ensure you have the <strong>GSSAPIAuthentication</strong> option enabled in<strong> /etc/ssh/ssh_config</strong> or <strong>~/.ssh/config</strong>.</p><p></p><p>Ticket Delegation allows you to forward the Kerberos ticket to another machine (e.g. using ssh to access another system that also uses Kerberos authentication).</p><p></p><p><strong>GSSAPIAuthentication yes</strong><strong></strong></p><p><strong>GSSAPIDelegateCredentials yes</strong></p><p></p><p><h3>Connecting</h3></p><p>Unlike Impacket, SSH uses a capital <strong>-K</strong>.</p><p></p><p><em>ssh f.frizzle@frizz.htb -K</em></p><p></p><p><h1>Linux in Windows AD Domain</h1></p><p>Linux machines can be added to AD, which may result in unusual behavior.</p><p></p><p>There may be accessible Domain users in<strong> /home/</strong> that aren&#39;t in <strong>/etc/passwd</strong>, &amp; you may be able to <em>su</em> into them even if this machine isn&#39;t connected to Domain!</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Target has <strong>administrator@SKYLARK.com</strong> &amp; <strong>administrator@SKYLARK</strong>. Maybe Acct with .com TLD is def Dom Administrator &amp; other is def Local Administrator that&#39;s setup on Windows machines (i.e in SAM)?</p><p></p><p><h2>winbindd</h2></p><p>winbind daemon (aka <a href="https://www.samba.org/samba/docs/current/man-html/winbindd.8.html">winbindd</a>) is typically used along with Samba (SMB) to connect Linux machines to a Windows Domain.</p><p></p><p><h3>Interact with Domain</h3></p><p>To interact with Domain (e.g to setup connection) the main commands are <strong>net</strong> and <strong>wbinfo</strong> (See <a href="https://medium.com/hagridaaron/configuring-winbindd-on-linux-9d19a727297e">Basics</a> &amp; <a href="https://help.ubuntu.com/community/ActiveDirectoryWinbindHowto">More Info</a>).</p><p></p><p><em>net --help</em>			View modules</p><p></p><p><em>net help ads</em>			Submodules for “ads” module</p><p></p><p><em>net ads join --help</em>			Specific help on this command</p><p></p><p><em>wbinfo --all-domains</em>			Lists all domains you&#39;re connected to</p><p></p><p><h2>Search Ownership via Groups</h2></p><p>Use the group number, instead of the name. For ex-</p><p></p><p><em>id</em> returns<strong> groups=2000513(SKYLARK\domain users)</strong></p><p></p><p><em>find / -group 2000513 2&gt;/dev/null</em></p><p></p><p><h2>Troubleshooting</h2></p><p><h3>No logon servers</h3></p><p>Attempts to use <strong>sudo</strong> result in this error, even with stable shell. Could indicate that connection to DC (the Auth / “logon” server) has been severed.</p><p></p><p><span class="subheading">Use su</span>: May be able to sign into another Acct with<span style="color:#ff0000;"> </span><strong><span style="color:#ff0000;">su</span></strong><span style="color:#ff0000;">, even if </span><strong><span style="color:#ff0000;">sudo</span></strong><span style="color:#ff0000;"> doesn&#39;t work</span>! <em>su backup_service@SKYLARK.com</em></p><p></p><p><span class="subheading">Enable Offline Auth</span>: May be using SMB to send DC Auth attempts? <a href="https://askubuntu.com/questions/1008270/logon-failed-no-logon-server-ubuntu-16-04">Edit conf file</a>.</p><p></p><p><span class="subheading">DNS Resolution</span>: Host may be unable to locate the DC. <a href="https://serverfault.com/questions/798375/unable-to-log-in-as-root-or-domain-user">Check DNS</a> files.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: After editing a config file, stop winbind, restart SMB service(s), &amp; start winbind again. Specific names may vary, but likely in <strong>/etc/init.d/</strong>. See above “More info” for details.</p><p></p><p></p></div>
</body>
</html>
