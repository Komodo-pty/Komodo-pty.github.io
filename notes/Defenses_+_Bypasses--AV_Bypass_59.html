<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>AV Bypass</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>AV Bypass</h1><br/><p><h1>Background</h1></p><p>[OSCP 107-119]</p><p>AV is most commonly associated with Windows, but there are also AV solutions for other systems like Linux (e.g ClamAV).</p><p></p><p>AV functionality is divided into two categories: Dynamic (In-Memory) &amp; Static (On-Disk).</p><p></p><p>Files written to host (e.g an uploaded WebShell) will be scanned as part of the Static protections. These are simpler to bypass.</p><p></p><p>Scripts / commands executed on host will need to bypass Dynamic detection before being allowed to execute. For example, this could involve being executed from within a sandbox.</p><p></p><p><h1>On-Disk Evasion</h1></p><p><h2>Running in RAM</h2></p><p>Obviously running in RAM without saving anything to disk bypasses this static AV functionality. This is usually an ideal method for getting around AV &amp; being more stealthy.</p><p></p><p><h3>Reverse Shell</h3></p><p>For fileless malware that incorporates PS, obfuscation, &amp; stagers, see the “update_script” <a href="https://github.com/daniellowrie/update_script">Repo</a>. You need port <strong>8000</strong> available for stager, &amp; need to run a listener at port <strong>443</strong>.</p><p></p><p><h2>Obfuscation</h2></p><p>poly-webshells</p><p></p><p><h1>Dynamic Evasion</h1></p><p>evil-winrm AMSI Bypass</p><p></p><p>Mockingjay Proc Injection is currently unfixable?</p><p></p><p><h1>File Formats</h1></p><p>Some file formats (i.e. EXE) are more likely to be blocked than others (e.g. BAT). For example, <strong>winpeas.exe</strong> may be blocked but not <strong>winpeas.bat</strong></p><p></p><p><a name="AV PtH PrivEsc"></a><h1>PtH Admin to SYSTEM PrivEsc</h1></p><p>Normally can use Local Administrator&#39;s NTLM hash with <a href="PrivEsc--Windows--RCE_33.html#impacket-psexec">impacket-psexec</a>, but this was blocked by AV.</p><p></p><p>The first time I used impacket-psexec, it gave most of the normal output before an error &amp; subsequent attempts gave a connection error.</p><p></p><p><h2>Admin RCE</h2></p><p><strong>evil-winrm</strong> should get around AV &amp; let you PtH for the Local Administrator, since it doesn&#39;t upload any payload to the target by default (AFAIK).</p><p></p><p><em>evil-winrm -u Administrator  -H NTLM -i 10.10.100.250</em></p><p></p><p><h3>Admin to SYSTEM</h3></p><p>One method is to use your Admin privs to create a service (which will run as SYSTEM by default), &amp; when that service starts, it will trigger a payload.</p><p></p><p>To do this, you could use a payload that won&#39;t be detected by the AV, OR you can get AV to ignore a payload that it&#39;d otherwise flag.</p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Add AV Exception</span>: Create an exclusion path, meaning AV won&#39;t look at the contents of the specified directory. You <span style="color:#ff0000;">MUST include the trailing backslash</span> in the directory name &amp; use the aboslute path.</p><p></p><p><em>Add-MpPreference -ExclusionPath C:\Users\Administrator\Documents\</em></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Upload payload</span>: Ensure that you&#39;re uploading te payload to the specified exclusion path. For example, can use a stageless executable created by Msfvenom.</p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Create the Service</span>: Ensure you specify the absolute path to the binary. These commands must run from CMD, which can still be done via PS as follows.</p><p></p><p><em>cmd /c “sc create PrivSvc binPath=C:\Users\Administrator\Documents\shell.exe”</em><em></em></p><p><em>cmd /c “sc start PrivSvc”</em></p><p></p><p><h1>Creating Payloads</h1></p><p><h2>Msfvenom</h2></p><p><a href="Metasploit_7.html#AV Bypass">msfvenom</a> is typically detected by AV, but you may be to use encoding techniques to bypass defenses.</p></div>
</body>
</html>
