<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>AD CS + PKI</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>AD CS + PKI</h1><br/><p>[Win 81-82 &amp; 130-133, CTF D 39-43]</p><p></p><p><h1>Background</h1></p><p>See <a href="PrivEsc--Windows--Active_Directory_10.html#Exploit AD CS">AD CS Exploitation</a>.</p><p></p><p>An overly permissive <strong>certificate template</strong> security descriptor grants <strong>certificate enrolment rights</strong> to low-privileged users.</p><p></p><p>The certificate template allows requesters to specify a <strong>subjectAltName</strong> (<strong>SAN</strong>) in the <strong>CSR</strong> (Certificate Signing Request).</p><p></p><p><span style="color:#ff0000;">AD will authenticate users using</span> the <span style="color:#ff0000;">identity specified</span> in the cert&#39;s <span style="color:#ff0000;">SAN field</span>, if it&#39;s present.</p><p></p><p><h2>Exploitation</h2></p><p>Therefore, a vulnerable config allows a low pirv user to request a cert for any Domain User (e.g. Domain Admin).</p><p></p><p>You can then authenticate as that principal in the Domain via <strong>Kerberos</strong> or <strong>Schannel</strong> (<a href="https://www.thehacker.recipes/ad/movement/schannel/passthecert">Pass-the-Cert</a> Attack).</p><p></p><p>You can extract a target account&#39;s NTLM (e.g. for PtH), or you may be able to use <a href="https://github.com/AlmondOffSec/PassTheCert/">PassTheCert</a> to remotely spawn an LDAP shell or perform other actions.</p><p></p><p><h1>Misconfigurations</h1></p><p>Identified by a number (I believe there are 10), from <strong>ESC1</strong> to <strong>ESC10</strong></p><p></p><p><a name="ESC4"></a><h2>ESC4 (Vulnerable Certificate Template Access Control)</h2></p><p>Certificate templates have a security descriptor that specifies which AD principals have specific permissions over the template.</p><p></p><p>If an attacker has enough permissions to modify a template and create any of the exploitable misconfigurations from the previous sections, he will be able to exploit it and escalate privileges.</p><p></p><p><strong>ESC4</strong> is when a user has write privileges over a certificate template. This can for instance be abused to overwrite the configuration of the certificate template to make the template vulnerable to <strong>ESC1</strong>.</p><p></p><p><h3>Interesting Template Rights</h3></p><p><ul><li><strong>Owner</strong>: Implicit full control of the object, can edit any properties.</li></ul></p><p><ul><li><strong>FullControl</strong>: Full control of the object, can edit any properties.</li></ul></p><p><ul><li><strong>WriteOwner</strong>: Can modify the owner to an attacker-controlled principal.</li></ul></p><p><ul><li><strong>WriteDacl</strong>: Can modify access control to grant an attacker FullControl.</li></ul></p><p><ul><li><strong>WriteProperty</strong>: Can edit any properties</p><p></li></ul></p></div>
</body>
</html>
